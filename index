<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>THE DAILY NUTHATCH | Geostrategic Terminal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-main: #0a0e14;
            --bg-column: #12161e;
            --bg-card: #1a1f2b;
            --border: #2a3040;
            --text-primary: #e6e8eb;
            --text-secondary: #6B8BA4;
            --text-dim: #5a6070;
            --accent-green: #00ff88;
            --accent-red: #ff4466;
            --accent-yellow: #ffbb33;
            --accent-blue: #3399ff;
            --accent-purple: #bb66ff;
            --accent-moss: #8fbc8f;
            --accent-orange: #D4714A;
        }

        body {
            font-family: 'IBM Plex Sans', sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            overflow: hidden;
            line-height: 1.4;
            height: 100vh;
            caret-color: transparent;
        }
        
        input, textarea {
            caret-color: auto;
        }
        
        html {
            overflow: hidden;
            height: 100vh;
            /* Fluid typography - base font scales with viewport width */
            font-size: clamp(11px, calc(10px + 0.35vw), 16px);
        }
        
        /* 17-19 inch screens (1200-1599px) - tighter scaling */
        @media (min-width: 1200px) and (max-width: 1599px) {
            html {
                font-size: clamp(11px, calc(9px + 0.4vw), 14px);
            }
        }
        
        /* Smaller laptops and tablets (768-1199px) */
        @media (min-width: 768px) and (max-width: 1199px) {
            html {
                font-size: clamp(10px, calc(8px + 0.5vw), 13px);
            }
        }
        
        /* Mobile screens */
        @media (max-width: 767px) {
            html {
                font-size: clamp(11.5px, calc(10.5px + 0.6vw), 15.5px);
            }
        }
        
        /* Large screens (1600px+) */
        @media (min-width: 1600px) {
            html {
                font-size: 16px;
            }
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1a1f2b 0%, #0f1319 100%);
            border-bottom: 2px solid var(--accent-orange);
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(212, 113, 74, 0.15);
            gap: 1rem;
        }

        .header-left, .header-right {
            flex: 0 0 auto;
            min-width: 80px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* Glass-like connection orb */
        .connection-orb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.4), transparent 60%),
                        radial-gradient(circle at center, #ef4444, #991b1b);
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.6),
                        0 0 16px rgba(239, 68, 68, 0.3),
                        inset 0 -2px 4px rgba(0,0,0,0.3),
                        inset 0 2px 4px rgba(255,255,255,0.2);
            cursor: default;
            transition: all 0.3s ease;
        }

        .connection-orb.connected {
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.5), transparent 60%),
                        radial-gradient(circle at center, #22c55e, #15803d);
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.7),
                        0 0 20px rgba(34, 197, 94, 0.4),
                        0 0 30px rgba(34, 197, 94, 0.2),
                        inset 0 -2px 4px rgba(0,0,0,0.3),
                        inset 0 2px 4px rgba(255,255,255,0.3);
            animation: orb-pulse 2s ease-in-out infinite;
        }

        @keyframes orb-pulse {
            0%, 100% { 
                box-shadow: 0 0 10px rgba(34, 197, 94, 0.7),
                            0 0 20px rgba(34, 197, 94, 0.4),
                            0 0 30px rgba(34, 197, 94, 0.2),
                            inset 0 -2px 4px rgba(0,0,0,0.3),
                            inset 0 2px 4px rgba(255,255,255,0.3);
            }
            50% { 
                box-shadow: 0 0 14px rgba(34, 197, 94, 0.9),
                            0 0 28px rgba(34, 197, 94, 0.5),
                            0 0 40px rgba(34, 197, 94, 0.3),
                            inset 0 -2px 4px rgba(0,0,0,0.3),
                            inset 0 2px 4px rgba(255,255,255,0.4);
            }
        }

        .header-center {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .logo-box {
            background: #e6e8eb;
            color: #0a0e14;
            font-family: 'IBM Plex Sans', sans-serif;
            font-weight: 800;
            font-size: 1.1rem;
            padding: 0.35rem 0.6rem;
            border-radius: 3px;
            letter-spacing: -1px;
            flex-shrink: 0;
        }

        .brand-text {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .site-title {
            font-family: 'IBM Plex Sans', sans-serif;
            font-weight: 800;
            font-size: 1.15rem;
            letter-spacing: 2px;
            color: #e6e8eb;
            text-transform: uppercase;
        }

        .site-subtitle {
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 0.55rem;
            color: #6B8BA4;
            letter-spacing: 1.5px;
            margin-top: 1px;
            text-transform: uppercase;
        }

        .status-cluster {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-left: 1rem;
            padding-left: 1rem;
            border-left: 1px solid rgba(255,255,255,0.1);
        }

        .defcon-indicator {
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--accent-orange);
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: color 0.3s ease;
        }

        .defcon-indicator span {
            color: #fff;
            font-weight: 800;
            transition: color 0.3s ease;
        }

        .defcon-indicator.level-5 { color: #22c55e; }
        .defcon-indicator.level-5 span { color: #22c55e; }
        .defcon-indicator.level-4 { color: var(--accent-orange); }
        .defcon-indicator.level-4 span { color: #fff; }
        .defcon-indicator.level-3 { color: #f59e0b; }
        .defcon-indicator.level-3 span { color: #f59e0b; }
        .defcon-indicator.level-2 { color: #ef4444; }
        .defcon-indicator.level-2 span { color: #ef4444; }
        .defcon-indicator.level-1 { color: #dc2626; animation: defcon-flash 0.5s ease infinite; }
        .defcon-indicator.level-1 span { color: #dc2626; }

        @keyframes defcon-flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #22c55e;
            animation: dot-pulse 1.5s ease-in-out infinite;
        }

        @keyframes dot-pulse {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        /* Gradient pulsing text for CONNECT */
        .connect-text {
            font-family: 'IBM Plex Sans', sans-serif;
            font-weight: 700;
            font-size: 0.65rem;
            letter-spacing: 1px;
            background: linear-gradient(90deg, #6b7280, #9ca3af, #d1d5db, #9ca3af, #6b7280);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradient-pulse-gray 2s ease-in-out infinite;
        }
        
        .connect-text.connected {
            background: linear-gradient(90deg, #22c55e, #4ade80, #86efac, #4ade80, #22c55e);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradient-pulse-green 1.5s ease-in-out infinite;
        }
        
        @keyframes gradient-pulse-gray {
            0%, 100% { 
                background-position: 0% 50%;
                opacity: 0.5;
            }
            50% { 
                background-position: 100% 50%;
                opacity: 1;
            }
        }
        
        @keyframes gradient-pulse-green {
            0%, 100% { 
                background-position: 0% 50%;
                opacity: 0.8;
            }
            50% { 
                background-position: 100% 50%;
                opacity: 1;
            }
        }

        /* GLOBAL WATCHTOWER CLOCK */
        .global-clock-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 80px;
        }

        .global-clock-city {
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 0.55rem;
            color: var(--accent-orange);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 700;
            opacity: 0;
            transition: opacity 1.5s ease-in-out;
        }

        .global-clock-time {
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 0.85rem;
            color: var(--text-primary);
            font-weight: 600;
            opacity: 0;
            transition: opacity 1.5s ease-in-out;
        }

        .clock-visible {
            opacity: 1 !important;
        }

        .time-display {
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 0.9rem;
            color: var(--text-secondary);
            letter-spacing: 1px;
        }

        .info-button {
            background: rgba(212, 113, 74, 0.1);
            border: 1px solid rgba(212, 113, 74, 0.3);
            color: var(--accent-orange);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .info-button:hover {
            background: rgba(212, 113, 74, 0.2);
            border-color: var(--accent-orange);
            transform: translateY(-1px);
        }

        /* Ticker Container - Two Tickers */
        .ticker-container {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
        }

        /* News Ticker (Top) */
        .news-ticker {
            background: var(--bg-card);
            padding: 0.5rem 2rem;
            overflow: hidden;
            position: relative;
            height: 47px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border);
            box-shadow: inset 40px 0 35px -25px rgba(0, 0, 0, 0.8),
                        inset -40px 0 35px -25px rgba(0, 0, 0, 0.8),
                        inset 0 0 40px rgba(107, 139, 164, 0.1);
        }

        .news-ticker-content {
            display: flex;
            gap: 4rem;
            animation: scroll-slow 144s linear infinite;
            white-space: nowrap;
        }

        @keyframes scroll-slow {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        .ticker-item {
            display: flex;
            gap: 1rem;
            align-items: center;
            font-size: 1rem;
        }

        .ticker-time {
            color: var(--accent-orange);
            font-weight: 600;
            font-size: 0.8rem;
        }

        .ticker-text {
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .ticker-text.top-story {
            color: #ffffff;
            font-weight: 700;
        }
        
        .top-story-badge {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
            font-size: 0.8rem;
            font-weight: 800;
            padding: 0.25rem 0.6rem;
            border-radius: 4px;
            margin-right: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            animation: topStoryPulse 2s ease-in-out infinite;
        }
        
        @keyframes topStoryPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes highlight-pulse {
            0% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0.6); }
            50% { box-shadow: 0 0 20px 5px rgba(168, 85, 247, 0.4); }
            100% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0); }
        }
        
        .ticker-item.top-story {
            background: rgba(255, 68, 68, 0.1);
            border-left: 2px solid #ff4444;
            padding-left: 0.75rem;
        }

        .ticker-impact {
            display: flex;
            gap: 2px;
        }

        .impact-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-dim);
        }

        .impact-dot.active {
            background: var(--accent-yellow);
        }

        /* Market Ticker (Bottom) */
        .market-ticker {
            background: var(--bg-card);
            padding: 0.1rem 2rem;
            overflow-x: auto;
            overflow-y: hidden;
            position: relative;
            height: 21px;
            display: flex;
            align-items: center;
            scrollbar-width: none;
            -ms-overflow-style: none;
            cursor: grab;
            box-shadow: inset 40px 0 35px -25px rgba(0, 0, 0, 0.8),
                        inset -40px 0 35px -25px rgba(0, 0, 0, 0.8),
                        inset 0 0 35px rgba(107, 139, 164, 0.12);
            border-bottom: 1px solid var(--accent-orange);
        }

        .market-ticker::-webkit-scrollbar {
            display: none;
        }

        .market-ticker:active {
            cursor: grabbing;
        }

        .ticker-search-popup {
            display: none;
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            border: 1px solid var(--accent-blue);
            border-radius: 6px;
            padding: 0.75rem 1rem;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            min-width: 280px;
        }

        .ticker-search-popup.active {
            display: block;
        }

        .ticker-search-popup input {
            width: 100%;
            background: rgba(42, 48, 64, 0.8);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.5rem;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: 'IBM Plex Sans', sans-serif;
        }

        .ticker-search-popup input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .ticker-search-popup label {
            display: block;
            font-size: 0.7rem;
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .ticker-search-popup button {
            margin-top: 0.5rem;
            width: 100%;
            background: var(--accent-blue);
            border: none;
            border-radius: 4px;
            padding: 0.5rem;
            color: var(--bg-primary);
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .ticker-search-popup button:hover {
            background: var(--accent-orange);
        }

        .market-ticker-content {
            display: flex;
            gap: 1rem;
            animation: scroll-fast 240s linear infinite;
            white-space: nowrap;
            cursor: grab;
        }

        .market-ticker-content:active {
            cursor: grabbing;
        }

        .market-ticker-content.dragging {
            animation-play-state: paused;
        }

        @keyframes scroll-fast {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        .market-ticker-item {
            display: flex;
            gap: 0.4rem;
            align-items: center;
            font-size: 0.7rem;
        }

        .market-ticker-label {
            color: var(--text-secondary);
            font-weight: 600;
            min-width: 55px;
            text-align: right;
            font-size: 0.65rem;
        }

        .market-ticker-value {
            color: var(--text-primary);
            font-family: 'IBM Plex Sans', sans-serif;
            font-weight: 700;
            margin-left: 0.1rem;
            font-size: 0.7rem;
        }

        .market-ticker-change {
            font-size: 0.6rem;
            font-weight: 600;
            margin-left: 0.1rem;
        }

        .market-ticker-up {
            color: var(--accent-green);
        }

        .market-ticker-down {
            color: var(--accent-red);
        }

        .market-ticker-neutral {
            color: var(--text-dim);
        }

        /* ========================================
           RESPONSIVE TYPOGRAPHY SYSTEM
           Fluid scaling for tickers & dashboards
           ======================================== */
        
        /* Large Desktop 1920px+ (21"+ monitors) */
        @media (min-width: 1920px) {
            /* Column Headers - LARGEST */
            .column-title { font-size: 1.6rem; }
            .column-subtitle { font-size: 0.85rem; }
            /* Tickers */
            .news-ticker { height: 49px; padding: 0.65rem 2.5rem; }
            .ticker-item { font-size: 1.35rem; gap: 1.75rem; }
            .ticker-time { font-size: 1.25rem; }
            .ticker-text { font-size: 1.35rem; }
            .market-ticker { height: 43px; }
            .market-ticker-item { font-size: 1.25rem; gap: 0.85rem; }
            .market-ticker-label { font-size: 1.15rem; min-width: 110px; }
            .market-ticker-value { font-size: 1.25rem; }
            .market-ticker-change { font-size: 1.05rem; }
            /* Card Content - PROMINENT */
            .card-headline { font-size: 1.2rem; font-weight: 700; }
            .card-implications { font-size: 0.95rem; }
            .card-implications li { font-size: 0.95rem; }
            .next-events-title { font-size: 0.85rem; }
            .next-event-item { font-size: 0.88rem; }
            /* Dashboard Titles - SMALLER than column */
            .macro-dashboard-title { font-size: 1rem; }
            .macro-dashboard-subtitle { font-size: 0.85rem; }
            .commodity-dashboard-title { font-size: 1rem; }
            .commodity-dashboard-subtitle { font-size: 0.85rem; }
            .fx-dashboard-title { font-size: 1rem; }
            .fx-dashboard-subtitle { font-size: 0.85rem; }
            .dashboard-title { font-size: 1rem; }
            .dashboard-section-subtitle { font-size: 0.85rem; }
            /* Dashboard Column Titles & Subtitles - Match dashboard-section-subtitle */
            .commodity-column-title { font-size: 0.85rem; }
            .fx-column-title { font-size: 0.85rem; }
            .commodity-column-subtitle { font-size: 0.75rem; }
            .fx-column-subtitle { font-size: 0.75rem; }
            /* Dashboard Values - Readable */
            .macro-item-label { font-size: 0.7rem; }
            .macro-item-value { font-size: 0.95rem; }
            .macro-item-change { font-size: 0.75rem; }
            .commodity-item-label { font-size: 0.7rem; }
            .commodity-item-price { font-size: 0.95rem; }
            .commodity-item-change { font-size: 0.75rem; }
            .systemic-item-label { font-size: 0.7rem; }
            .systemic-item-price { font-size: 0.95rem; }
            .systemic-item-change { font-size: 0.75rem; }
            .systemic-item { padding: 0.45rem 0.6rem; min-height: 3.4rem; }
            .systemic-item-arrow { font-size: 0.6rem; }
            .fx-pair-label { font-size: 0.7rem; }
            .fx-pair-price { font-size: 0.95rem; }
            .fx-pair-change { font-size: 0.75rem; }
            .cb-rate-item { font-size: 0.7rem; }
        }

        /* Standard Desktop 1600-1919px (19-21" monitors) */
        @media (min-width: 1600px) and (max-width: 1919px) {
            /* Column Headers - LARGEST */
            .column-title { font-size: 1.45rem; }
            .column-subtitle { font-size: 0.78rem; }
            /* Tickers */
            .news-ticker { height: 44px; padding: 0.6rem 2rem; }
            .ticker-item { font-size: 1.2rem; gap: 1.4rem; }
            .ticker-time { font-size: 1.1rem; }
            .ticker-text { font-size: 1.2rem; }
            .market-ticker { height: 39px; }
            .market-ticker-item { font-size: 1.1rem; gap: 0.7rem; }
            .market-ticker-label { font-size: 1rem; min-width: 95px; }
            .market-ticker-value { font-size: 1.1rem; }
            .market-ticker-change { font-size: 0.95rem; }
            /* Card Content - PROMINENT */
            .card-headline { font-size: 1.05rem; font-weight: 700; }
            .card-implications { font-size: 0.85rem; }
            .card-implications li { font-size: 0.85rem; }
            .next-events-title { font-size: 0.78rem; }
            .next-event-item { font-size: 0.8rem; }
            /* Dashboard Titles - SMALLER than column */
            .macro-dashboard-title { font-size: 0.88rem; }
            .macro-dashboard-subtitle { font-size: 0.78rem; }
            .commodity-dashboard-title { font-size: 0.88rem; }
            .commodity-dashboard-subtitle { font-size: 0.78rem; }
            .fx-dashboard-title { font-size: 0.88rem; }
            .fx-dashboard-subtitle { font-size: 0.78rem; }
            .dashboard-title { font-size: 0.88rem; }
            .dashboard-section-subtitle { font-size: 0.78rem; }
            /* Dashboard Column Titles & Subtitles - Match dashboard-section-subtitle */
            .commodity-column-title { font-size: 0.78rem; }
            .fx-column-title { font-size: 0.78rem; }
            .commodity-column-subtitle { font-size: 0.68rem; }
            .fx-column-subtitle { font-size: 0.68rem; }
            /* Dashboard Values - Readable */
            .macro-item-label { font-size: 0.62rem; }
            .macro-item-value { font-size: 0.85rem; }
            .macro-item-change { font-size: 0.68rem; }
            .macro-grid-item { padding: 0.2rem 0.25rem; min-height: 1.6rem; }
            .commodity-item-label { font-size: 0.62rem; }
            .commodity-item-price { font-size: 0.85rem; }
            .commodity-item-change { font-size: 0.68rem; }
            .commodity-item { padding: 0.18rem 0.28rem; }
            .systemic-item-label { font-size: 0.62rem; }
            .systemic-item-price { font-size: 0.85rem; }
            .systemic-item-change { font-size: 0.68rem; }
            .systemic-item { padding: 0.25rem 0.35rem; min-height: 3rem; }
            .systemic-item-arrow { font-size: 0.55rem; }
            .fx-pair-label { font-size: 0.62rem; }
            .fx-pair-price { font-size: 0.85rem; }
            .fx-pair-change { font-size: 0.68rem; }
            .fx-pair-item { padding: 0.18rem 0.28rem; }
            .cb-rate-item { font-size: 0.6rem; }
            .cb-rate-value { font-size: 0.65rem; }
        }

        /* Compact Desktop 1400-1599px (17-19" monitors / 20" screens) */
        @media (min-width: 1400px) and (max-width: 1599px) {
            /* Column Headers - LARGEST - Significantly boosted for 20" screens */
            .column-title { font-size: 1.8rem !important; }
            .column-subtitle { font-size: 1.0rem !important; }
            /* Tickers */
            .news-ticker { height: 40px !important; padding: 0.5rem 1.75rem !important; }
            .ticker-item { font-size: 1.05rem !important; gap: 1.2rem !important; }
            .ticker-time { font-size: 0.95rem !important; }
            .ticker-text { font-size: 1.05rem !important; }
            .market-ticker { height: 35px !important; }
            .market-ticker-item { font-size: 0.95rem !important; gap: 0.6rem !important; }
            .market-ticker-label { font-size: 0.88rem !important; min-width: 85px !important; }
            .market-ticker-value { font-size: 0.95rem !important; }
            .market-ticker-change { font-size: 0.85rem !important; }
            /* Card Content - Headlines MUCH LARGER than bullet points */
            .card-headline { font-size: 1.15rem !important; font-weight: 700 !important; }
            .card-implications { font-size: 0.7rem !important; }
            .card-implications li { font-size: 0.7rem !important; }
            .next-events-title { font-size: 0.72rem !important; }
            .next-event-item { font-size: 0.75rem !important; }
            /* Dashboard Titles - SMALLER than column */
            .macro-dashboard-title { font-size: 0.78rem !important; }
            .macro-dashboard-subtitle { font-size: 0.7rem !important; }
            .commodity-dashboard-title { font-size: 0.78rem !important; }
            .commodity-dashboard-subtitle { font-size: 0.7rem !important; }
            .fx-dashboard-title { font-size: 0.78rem !important; }
            .fx-dashboard-subtitle { font-size: 0.7rem !important; }
            .dashboard-title { font-size: 0.78rem !important; }
            .dashboard-section-subtitle { font-size: 0.7rem !important; }
            /* Dashboard Column Titles & Subtitles - Match dashboard-section-subtitle */
            .commodity-column-title { font-size: 0.7rem !important; }
            .fx-column-title { font-size: 0.7rem !important; }
            .commodity-column-subtitle { font-size: 0.6rem !important; }
            .fx-column-subtitle { font-size: 0.6rem !important; }
            /* Dashboard Values - Compact but Readable */
            .macro-item-label { font-size: 0.58rem !important; }
            .macro-item-value { font-size: 0.78rem !important; }
            .macro-item-change { font-size: 0.62rem !important; }
            .macro-grid-item { padding: 0.18rem 0.22rem !important; min-height: 1.5rem !important; gap: 0.1rem !important; }
            .commodity-item-label { font-size: 0.58rem !important; }
            .commodity-item-price { font-size: 0.78rem !important; }
            .commodity-item-change { font-size: 0.62rem !important; }
            .commodity-item { padding: 0.15rem 0.22rem !important; }
            .systemic-item-label { font-size: 0.58rem !important; }
            .systemic-item-price { font-size: 0.78rem !important; }
            .systemic-item-change { font-size: 0.62rem !important; }
            .systemic-item { padding: 0.22rem 0.3rem !important; min-height: 2.8rem !important; }
            .systemic-item-arrow { font-size: 0.52rem !important; }
            .fx-pair-label { font-size: 0.58rem !important; }
            .fx-pair-price { font-size: 0.78rem !important; }
            .fx-pair-change { font-size: 0.62rem !important; }
            .fx-pair-item { padding: 0.15rem 0.22rem !important; }
            .cb-rate-item { font-size: 0.55rem !important; }
            .cb-rate-value { font-size: 0.58rem !important; }
        }

        /* Small Desktop 1200-1399px (15-17" monitors) */
        @media (min-width: 1200px) and (max-width: 1399px) {
            /* Column Headers - LARGEST - Significantly boosted */
            .column-title { font-size: 1.45rem; }
            .column-subtitle { font-size: 0.82rem; }
            /* Tickers */
            .news-ticker { height: 36px; padding: 0.45rem 1.5rem; }
            .ticker-item { font-size: 0.95rem; gap: 1rem; }
            .ticker-time { font-size: 0.85rem; }
            .ticker-text { font-size: 0.95rem; }
            .market-ticker { height: 32px; }
            .market-ticker-item { font-size: 0.85rem; gap: 0.5rem; }
            .market-ticker-label { font-size: 0.78rem; min-width: 75px; }
            .market-ticker-value { font-size: 0.85rem; }
            .market-ticker-change { font-size: 0.75rem; }
            /* Card Content - Headlines MUCH LARGER than bullet points */
            .card-headline { font-size: 1.05rem; font-weight: 700; }
            .card-implications { font-size: 0.65rem; }
            .card-implications li { font-size: 0.65rem; }
            .next-events-title { font-size: 0.65rem; }
            .next-event-item { font-size: 0.68rem; }
            /* Dashboard Titles - SMALLER than column */
            .macro-dashboard-title { font-size: 0.72rem; }
            .macro-dashboard-subtitle { font-size: 0.62rem; }
            .commodity-dashboard-title { font-size: 0.72rem; }
            .commodity-dashboard-subtitle { font-size: 0.62rem; }
            .fx-dashboard-title { font-size: 0.72rem; }
            .fx-dashboard-subtitle { font-size: 0.62rem; }
            .dashboard-title { font-size: 0.72rem; }
            .dashboard-section-subtitle { font-size: 0.62rem; }
            /* Dashboard Column Titles & Subtitles - Match dashboard-section-subtitle */
            .commodity-column-title { font-size: 0.62rem; }
            .fx-column-title { font-size: 0.62rem; }
            .commodity-column-subtitle { font-size: 0.55rem; }
            .fx-column-subtitle { font-size: 0.55rem; }
            /* Dashboard Values - Compact but Readable */
            .macro-item-label { font-size: 0.55rem; }
            .macro-item-value { font-size: 0.72rem; }
            .macro-item-change { font-size: 0.58rem; }
            .macro-grid-item { padding: 0.15rem 0.18rem; min-height: 1.4rem; gap: 0.08rem; }
            .commodity-item-label { font-size: 0.55rem; }
            .commodity-item-price { font-size: 0.72rem; }
            .commodity-item-change { font-size: 0.58rem; }
            .commodity-item { padding: 0.12rem 0.18rem; }
            .systemic-item-label { font-size: 0.55rem; }
            .systemic-item-price { font-size: 0.72rem; }
            .systemic-item-change { font-size: 0.58rem; }
            .systemic-item { padding: 0.18rem 0.25rem; min-height: 2.6rem; }
            .systemic-item-arrow { font-size: 0.48rem; }
            .fx-pair-label { font-size: 0.55rem; }
            .fx-pair-price { font-size: 0.72rem; }
            .fx-pair-change { font-size: 0.58rem; }
            .fx-pair-item { padding: 0.12rem 0.18rem; }
            .cb-rate-item { font-size: 0.5rem; }
            .cb-rate-value { font-size: 0.55rem; }
        }

        /* Tablet Landscape 768-1199px */
        @media (min-width: 768px) and (max-width: 1199px) {
            /* Column Headers */
            .column-title { font-size: 1.15rem; }
            .column-subtitle { font-size: 0.62rem; }
            /* Tickers */
            .news-ticker { height: 34px; padding: 0.4rem 1.25rem; }
            .ticker-item { font-size: 0.88rem; gap: 0.9rem; }
            .ticker-time { font-size: 0.78rem; }
            .ticker-text { font-size: 0.88rem; }
            .top-story-badge { font-size: 0.65rem; padding: 0.2rem 0.4rem; }
            .market-ticker { height: 29px; }
            .market-ticker-item { font-size: 0.78rem; gap: 0.4rem; }
            .market-ticker-label { font-size: 0.7rem; min-width: 65px; }
            .market-ticker-value { font-size: 0.78rem; }
            .market-ticker-change { font-size: 0.68rem; }
            /* Card Content - PROMINENT */
            .card-headline { font-size: 0.92rem; font-weight: 700; }
            .card-implications { font-size: 0.75rem; }
            .card-implications li { font-size: 0.75rem; }
            .next-events-title { font-size: 0.65rem; }
            .next-event-item { font-size: 0.68rem; }
            /* Dashboard Titles - SMALLER than column */
            .macro-dashboard-title { font-size: 0.75rem; }
            .macro-dashboard-subtitle { font-size: 0.62rem; }
            .commodity-dashboard-title { font-size: 0.75rem; }
            .commodity-dashboard-subtitle { font-size: 0.62rem; }
            .fx-dashboard-title { font-size: 0.75rem; }
            .fx-dashboard-subtitle { font-size: 0.62rem; }
            .dashboard-title { font-size: 0.75rem; }
            .dashboard-section-subtitle { font-size: 0.62rem; }
            /* Dashboard Column Titles & Subtitles - Match dashboard-section-subtitle */
            .commodity-column-title { font-size: 0.62rem; }
            .fx-column-title { font-size: 0.62rem; }
            .commodity-column-subtitle { font-size: 0.55rem; }
            .fx-column-subtitle { font-size: 0.55rem; }
            /* Dashboard Values - Readable for tablet */
            .macro-item-label { font-size: 0.62rem; }
            .macro-item-value { font-size: 0.8rem; }
            .macro-item-change { font-size: 0.65rem; }
            .commodity-item-label { font-size: 0.62rem; }
            .commodity-item-price { font-size: 0.8rem; }
            .commodity-item-change { font-size: 0.65rem; }
            .systemic-item-label { font-size: 0.62rem; }
            .systemic-item-price { font-size: 0.8rem; }
            .systemic-item-change { font-size: 0.65rem; }
            .systemic-item { padding: 0.25rem 0.35rem; min-height: 2.8rem; }
            .systemic-item-arrow { font-size: 0.5rem; }
            .fx-pair-label { font-size: 0.62rem; }
            .fx-pair-price { font-size: 0.8rem; }
            .fx-pair-change { font-size: 0.65rem; }
        }

        /* Mobile Portrait <768px */
        @media (max-width: 767px) {
            /* Column Headers */
            .column-title { font-size: 1.25rem; }
            .column-subtitle { font-size: 0.72rem; }
            /* Tickers */
            .news-ticker { height: 31px; padding: 0.35rem 1rem; }
            .ticker-item { font-size: 0.82rem; gap: 0.8rem; }
            .ticker-time { font-size: 0.72rem; }
            .ticker-text { font-size: 0.82rem; }
            .top-story-badge { font-size: 0.6rem; padding: 0.15rem 0.35rem; }
            .market-ticker { height: 27px; padding: 0.25rem 1rem; }
            .market-ticker-item { font-size: 0.72rem; gap: 0.35rem; }
            .market-ticker-label { font-size: 0.65rem; min-width: 55px; }
            .market-ticker-value { font-size: 0.72rem; }
            .market-ticker-change { font-size: 0.62rem; }
            /* Card Content - PROMINENT */
            .card-headline { font-size: 1.05rem; font-weight: 700; }
            .card-implications { font-size: 0.85rem; }
            .card-implications li { font-size: 0.85rem; }
            .next-events-title { font-size: 0.75rem; }
            .next-event-item { font-size: 0.78rem; }
            /* Dashboard Titles - SMALLER than column */
            .macro-dashboard-title { font-size: 0.92rem; }
            .macro-dashboard-subtitle { font-size: 0.72rem; }
            .commodity-dashboard-title { font-size: 0.92rem; }
            .commodity-dashboard-subtitle { font-size: 0.72rem; }
            .fx-dashboard-title { font-size: 0.92rem; }
            .fx-dashboard-subtitle { font-size: 0.72rem; }
            .dashboard-title { font-size: 0.92rem; }
            .dashboard-section-subtitle { font-size: 0.72rem; }
            /* Dashboard Column Titles & Subtitles - Match dashboard-section-subtitle */
            .commodity-column-title { font-size: 0.72rem; }
            .fx-column-title { font-size: 0.72rem; }
            .commodity-column-subtitle { font-size: 0.62rem; }
            .fx-column-subtitle { font-size: 0.62rem; }
            /* Dashboard Values - larger on mobile */
            .macro-item-label { font-size: 0.72rem; }
            .macro-item-value { font-size: 0.88rem; }
            .macro-item-change { font-size: 0.68rem; }
            .commodity-item-label { font-size: 0.72rem; }
            .commodity-item-price { font-size: 0.88rem; }
            .commodity-item-change { font-size: 0.68rem; }
            .fx-pair-label { font-size: 0.72rem; }
            .fx-pair-price { font-size: 0.88rem; }
            .fx-pair-change { font-size: 0.68rem; }
        }

        /* Small Mobile <480px */
        @media (max-width: 479px) {
            /* Column Headers */
            .column-title { font-size: 1.15rem; }
            .column-subtitle { font-size: 0.65rem; }
            /* Tickers */
            .news-ticker { height: 29px; padding: 0.25rem 0.75rem; }
            .ticker-item { font-size: 0.75rem; gap: 0.6rem; }
            .ticker-time { font-size: 0.65rem; }
            .ticker-text { font-size: 0.75rem; }
            .top-story-badge { font-size: 0.55rem; padding: 0.12rem 0.3rem; }
            .market-ticker { height: 24px; padding: 0.2rem 0.75rem; }
            .market-ticker-item { font-size: 0.65rem; gap: 0.3rem; }
            .market-ticker-label { font-size: 0.58rem; min-width: 48px; }
            .market-ticker-value { font-size: 0.65rem; }
            .market-ticker-change { font-size: 0.55rem; }
            /* Card Content - PROMINENT */
            .card-headline { font-size: 0.95rem; font-weight: 700; }
            .card-implications { font-size: 0.78rem; }
            .card-implications li { font-size: 0.78rem; }
            .next-events-title { font-size: 0.68rem; }
            .next-event-item { font-size: 0.72rem; }
            /* Dashboard Titles - SMALLER than column */
            .macro-dashboard-title { font-size: 0.85rem; }
            .macro-dashboard-subtitle { font-size: 0.65rem; }
            .commodity-dashboard-title { font-size: 0.85rem; }
            .commodity-dashboard-subtitle { font-size: 0.65rem; }
            .fx-dashboard-title { font-size: 0.85rem; }
            .fx-dashboard-subtitle { font-size: 0.65rem; }
            .dashboard-title { font-size: 0.85rem; }
            .dashboard-section-subtitle { font-size: 0.65rem; }
            /* Dashboard Column Titles & Subtitles - Match dashboard-section-subtitle */
            .commodity-column-title { font-size: 0.65rem; }
            .fx-column-title { font-size: 0.65rem; }
            .commodity-column-subtitle { font-size: 0.58rem; }
            .fx-column-subtitle { font-size: 0.58rem; }
        }

        /* Main Grid - 4 Columns */
        .main-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1px;
            background: var(--border);
            padding: 1px;
            height: calc(100vh - 150px);
            overflow: hidden;
        }

        .column {
            background: var(--bg-column);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            max-height: 100%;
        }

        .column-header {
            padding: 0.75rem;
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            background: var(--bg-card);
            z-index: 10;
        }

        .column-title {
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 1.15rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            margin-bottom: 0.15rem;
            text-align: center;
        }

        .column-subtitle {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
        }

        .col-breaking .column-title { color: var(--accent-red); }
        .col-macro .column-title { color: var(--accent-blue); }
        .col-geo .column-title { color: var(--accent-purple); }
        .col-commodity .column-title { color: var(--accent-yellow); }
        .col-fx .column-title { color: #00D9FF; }
        .col-prediction .column-title { color: var(--accent-moss); }
        .col-market .column-title { color: var(--accent-green); }

        
        /* Live pulse indicator */
        .live-pulse {
            display: inline-block;
            width: 6px;
            height: 6px;
            background: #D4714A;
            border-radius: 50%;
            margin-right: 4px;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(212, 113, 74, 0.7); }
            50% { opacity: 0.6; box-shadow: 0 0 0 4px rgba(212, 113, 74, 0); }
        }

        .column-content {
            padding: 1rem;
            padding-bottom: 4rem;
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1;
            /* Thin CSS3 scrollbars */
            scrollbar-width: thin;
            scrollbar-color: rgba(212, 113, 74, 0.3) transparent;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 1rem;
            animation: slideIn 0.4s ease-out;
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: var(--accent-orange);
            transform: translateX(2px);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card-timestamp {
            font-size: 0.65rem;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
        }

        .card-source {
            font-size: 0.7rem;
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
        }

        .card-headline {
            /* font-size and font-weight set by responsive breakpoints */
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }

        .card-implications {
            /* font-size set by responsive breakpoints */
            color: var(--text-secondary);
            line-height: 1.3;
            margin-bottom: 0.5rem;
        }

        .card-implications li {
            margin-left: 1rem;
            margin-bottom: 0.15rem;
        }

        /* Card Meta */
        .card-meta {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            font-size: 0.65rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .meta-label {
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .meta-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .impact-indicator {
            display: flex;
            gap: 2px;
        }

        /* Tripwire Section - Key Levels */
        .tripwire-section {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.12) 0%, rgba(255, 152, 0, 0.06) 100%);
            border: 1px solid rgba(255, 193, 7, 0.4);
            border-left: 4px solid #FFC107;
            border-radius: 6px;
            padding: 0.6rem 0.8rem;
            margin-top: 0.8rem;
        }

        .tripwire-title {
            font-size: 0.7rem;
            color: #FFC107;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            margin-bottom: 0.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            text-shadow: 0 0 10px rgba(255, 193, 7, 0.3);
        }

        .tripwire-item {
            font-size: 0.75rem;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            line-height: 1.4;
            font-family: 'IBM Plex Sans', sans-serif;
            background: rgba(0, 0, 0, 0.3);
            padding: 0.35rem 0.5rem;
            border-radius: 4px;
            display: flex;
            align-items: center;
            border-left: 2px solid rgba(255, 193, 7, 0.5);
        }
        
        .tripwire-item::before {
            content: "!";
            margin-right: 0.5rem;
            font-size: 0.65rem;
        }

        /* Macro Plumbing Grid - 2x4 Layout (Rates Dashboard) */
        .macro-grid-container {
            background: linear-gradient(135deg, rgba(51, 153, 255, 0.1) 0%, rgba(51, 153, 255, 0.05) 100%);
            border: 1px solid var(--accent-blue);
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 1rem;
            max-width: 100%;
            overflow: hidden;
            box-sizing: border-box;
        }

        .macro-dashboard-title {
            font-family: 'IBM Plex Sans', sans-serif;
            /* font-size set by responsive breakpoints */
            font-weight: 700;
            color: var(--accent-blue);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.3rem;
            text-align: center;
        }
        .macro-dashboard-subtitle {
            /* font-size set by responsive breakpoints */
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            text-align: center;
        }

        .macro-grid {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
            gap: 0.5rem;
            max-width: 100%;
        }

        .macro-grid-column {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            min-width: 0;
            overflow: hidden;
        }

        .macro-grid-item {
            background: rgba(42, 48, 64, 0.3);
            border: 1px solid rgba(51, 153, 255, 0.25);
            border-radius: 4px;
            padding: 0.3rem 0.4rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            gap: 0.25rem;
            min-height: 2.2rem;
            min-width: 0;
            overflow: hidden;
        }

        .macro-grid-item:hover {
            border-color: var(--accent-blue);
            background: rgba(51, 153, 255, 0.15);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(51, 153, 255, 0.2);
        }

        .macro-grid-item.tripwire-hit {
            border-left: 3px solid var(--accent-red);
            background: rgba(255, 68, 102, 0.05);
        }

        .macro-item-left {
            display: flex;
            flex-direction: column;
            gap: 0.1rem;
            min-width: 0;
            flex-shrink: 1;
        }

        .macro-item-label {
            /* font-size set by responsive breakpoints */
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.2px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .macro-item-value {
            /* font-size set by responsive breakpoints */
            font-family: 'IBM Plex Sans', sans-serif;
            font-weight: 700;
            color: var(--accent-blue);
            white-space: nowrap;
        }

        .macro-item-right {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.1rem;
            flex-shrink: 0;
        }

        .macro-item-change {
            /* font-size set by responsive breakpoints */
            font-weight: 600;
            white-space: nowrap;
        }

        .macro-up {
            color: var(--accent-green);
        }

        .macro-down {
            color: var(--accent-red);
        }

        .macro-neutral {
            color: var(--text-dim);
        }


        /* Commodities Dashboard - Yellow/Gold Theme */
        .commodity-dashboard-container {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 152, 0, 0.1) 100%);
            border: 1px solid var(--accent-yellow);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            max-width: 100%;
            overflow: hidden;
            box-sizing: border-box;
        }

        .commodity-dashboard-title {
            font-family: 'IBM Plex Sans', sans-serif;
            /* font-size set by responsive breakpoints */
            font-weight: 700;
            color: var(--accent-yellow);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.3rem;
            text-align: center;
        }
        
        .commodity-dashboard-subtitle {
            /* font-size set by responsive breakpoints */
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .commodity-grid-3col {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
            grid-template-rows: auto auto;
            gap: 0.5rem;
            max-width: 100%;
        }

        .commodity-grid-3col .commodity-grid-column:nth-child(3) {
            grid-column: 1 / -1;
        }

        .commodity-grid-3col .commodity-grid-column:nth-child(3) #commodityAgriculture {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .commodity-grid-column {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-width: 0;
            overflow: hidden;
        }

        .commodity-column-title {
            /* font-size set by responsive breakpoints */
            color: var(--accent-yellow);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 700;
            margin-bottom: 0.25rem;
            text-align: center;
        }

        .commodity-column-subtitle {
            /* font-size set by responsive breakpoints - matches .dashboard-section-subtitle */
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255, 193, 7, 0.25);
        }

        .commodity-item {
            background: rgba(42, 48, 64, 0.4);
            border: 1px solid rgba(255, 193, 7, 0.35);
            border-radius: 5px;
            padding: 0.45rem 0.6rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            min-width: 0;
            word-break: keep-all;
        }

        .commodity-item:hover {
            border-color: var(--accent-yellow);
            background: rgba(255, 193, 7, 0.18);
        }

        .commodity-item-left {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }

        .commodity-item-label {
            /* font-size set by responsive breakpoints */
            color: var(--text-secondary);
            font-weight: 600;
        }

        .commodity-ticker {
            font-size: 0.6rem;
            color: rgba(255, 193, 7, 0.6);
            font-weight: 400;
            margin-left: 0.25rem;
        }

        .commodity-item-price {
            /* font-size set by responsive breakpoints */
            font-family: 'IBM Plex Sans', sans-serif;
            font-weight: 700;
            color: var(--accent-yellow);
        }

        .commodity-item-right {
            text-align: right;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .commodity-item-change {
            /* font-size set by responsive breakpoints */
            font-weight: 600;
        }

        .commodity-up {
            color: var(--accent-green);
        }

        .commodity-down {
            color: var(--accent-red);
        }

        .commodity-neutral {
            color: var(--text-dim);
        }

        /* Systemic Watchlist Dashboard - Blue Theme (matches Commodity/FX structure) */
        .systemic-watchlist-container {
            background: linear-gradient(135deg, rgba(51, 153, 255, 0.1) 0%, rgba(0, 120, 215, 0.1) 100%);
            border: 1px solid #3399FF;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 15px;
            margin-bottom: 1rem;
            max-width: 100%;
            overflow: hidden;
            box-sizing: border-box;
        }

        .systemic-watchlist-title {
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 0.7rem;
            font-weight: 700;
            color: #3399FF;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .systemic-grid-2x2 {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
            grid-template-rows: auto auto;
            gap: 0.5rem;
            max-width: 100%;
        }

        .systemic-grid-quadrant {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-width: 0;
            overflow: hidden;
        }

        .systemic-quadrant-title {
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 0.58rem;
            font-weight: 700;
            color: #3399FF;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 0.25rem;
            text-align: center;
        }

        .systemic-item {
            background: rgba(42, 48, 64, 0.4);
            border: 1px solid rgba(51, 153, 255, 0.35);
            border-radius: 5px;
            padding: 0.6rem 0.75rem;
            display: flex;
            justify-content: flex-start;
            align-items: flex-start;
            transition: all 0.2s ease;
            cursor: pointer;
            min-width: 0;
            word-break: keep-all;
            min-height: 3.2rem;
        }

        .systemic-item:hover {
            border-color: #3399FF;
            background: rgba(51, 153, 255, 0.18);
            transform: translateY(-1px);
        }

        .systemic-item-left {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
            width: 100%;
        }

        .systemic-item-label {
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 0.65rem;
            color: var(--text-secondary);
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .systemic-item-change {
            font-size: 0.6rem;
            font-weight: 600;
        }

        .systemic-item-price {
            font-size: 0.85rem;
            font-family: 'IBM Plex Sans', sans-serif;
            font-weight: 700;
            color: #3399FF;
        }

        .systemic-item-arrow {
            font-size: 0.55rem;
        }

        /* FX Pairs Dashboard - Cyan/Teal Theme */
        .fx-dashboard-container {
            background: linear-gradient(135deg, rgba(0, 217, 255, 0.1) 0%, rgba(0, 180, 216, 0.1) 100%);
            border: 1px solid #00D9FF;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            max-width: 100%;
            overflow: hidden;
            box-sizing: border-box;
        }

        .fx-dashboard-title {
            font-family: 'IBM Plex Sans', sans-serif;
            /* font-size set by responsive breakpoints */
            font-weight: 700;
            color: #00D9FF;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.3rem;
            text-align: center;
        }
        
        .fx-dashboard-subtitle {
            /* font-size set by responsive breakpoints */
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .fx-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .fx-grid-3col {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
            grid-template-rows: auto auto;
            gap: 0.5rem;
            max-width: 100%;
        }
        
        .fx-grid-3col .fx-grid-column:nth-child(3) {
            grid-column: 1 / -1;
        }
        
        .fx-grid-3col .fx-grid-column:nth-child(3) #fxCommodity {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .fx-grid-column {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-width: 0;
            overflow: hidden;
        }

        .fx-column-title {
            /* font-size set by responsive breakpoints */
            color: #00D9FF;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 700;
            margin-bottom: 0.25rem;
            text-align: center;
        }

        .fx-column-subtitle {
            /* font-size set by responsive breakpoints - matches .dashboard-section-subtitle */
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(0, 217, 255, 0.25);
        }

        .fx-pair-item {
            background: rgba(42, 48, 64, 0.4);
            border: 1px solid rgba(0, 217, 255, 0.35);
            border-radius: 5px;
            padding: 0.45rem 0.6rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            cursor: pointer;
            min-width: 0;
            word-break: keep-all;
        }

        .fx-pair-item:hover {
            border-color: #00D9FF;
            background: rgba(0, 217, 255, 0.18);
            transform: translateY(-1px);
        }

        .fx-pair-left {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }

        .fx-pair-label {
            /* font-size set by responsive breakpoints */
            color: var(--text-secondary);
            font-weight: 600;
        }

        .fx-pair-price {
            /* font-size set by responsive breakpoints */
            font-family: 'IBM Plex Sans', sans-serif;
            font-weight: 700;
            color: #00D9FF;
        }

        .fx-pair-right {
            text-align: right;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .fx-pair-change {
            /* font-size set by responsive breakpoints */
            font-weight: 600;
        }

        .fx-up {
            color: var(--accent-green);
        }

        .fx-down {
            color: var(--accent-red);
        }

        .fx-neutral {
            color: var(--text-dim);
        }

        /* Central Bank Rates Section */
        .cb-rates-container {
            background: rgba(42, 48, 64, 0.2);
            border: 1px solid rgba(0, 217, 255, 0.2);
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 1rem;
        }

        .cb-rates-title {
            font-size: 0.65rem;
            color: #00D9FF;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            font-weight: 700;
            text-align: center;
        }

        .cb-rate-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0;
            border-bottom: 1px solid rgba(0, 217, 255, 0.1);
            font-size: 0.65rem;
        }

        .cb-rate-item:last-child {
            border-bottom: none;
        }

        .cb-rate-left {
            display: flex;
            gap: 0.3rem;
            align-items: center;
        }

        .cb-rate-bank {
            font-weight: 700;
            color: var(--text-secondary);
        }

        .cb-rate-currency {
            color: var(--text-dim);
            font-size: 0.6rem;
        }

        .cb-rate-right {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .cb-rate-value {
            font-family: 'IBM Plex Sans', sans-serif;
            font-weight: 700;
            color: #00D9FF;
        }

        .cb-rate-next {
            color: var(--text-dim);
            font-size: 0.6rem;
        }

        /* Probability Nudge */
        .probability-nudge {
            display: flex;
            gap: 0.75rem;
            margin-top: 0.75rem;
            font-size: 0.7rem;
        }

        .prob-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .prob-arrow {
            font-weight: 700;
        }

        .prob-up { color: var(--accent-green); }
        .prob-down { color: var(--accent-red); }

        /* News Tags - Minimalist Style */
        .news-tags {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
            margin-top: 1rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border);
        }

        .news-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
            padding: 0.2rem 0.45rem;
            background: rgba(42, 48, 64, 0.4);
            border: 1px solid var(--border);
            border-radius: 3px;
            font-size: 0.6rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .news-tag:hover {
            border-color: var(--accent-orange);
            background: rgba(212, 113, 74, 0.05);
        }

        /* Tag Type Colors */
        .news-tag.flash {
            border-color: var(--accent-red);
            color: var(--accent-red);
            background: rgba(255, 68, 102, 0.05);
        }

        .news-tag.risk-on {
            border-color: #22c55e;
            color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }

        .news-tag.risk-off {
            border-color: var(--accent-red);
            color: var(--accent-red);
            background: rgba(255, 68, 102, 0.05);
        }

        .news-tag.multi-asset {
            border-color: var(--accent-purple);
            color: var(--accent-purple);
            background: rgba(187, 102, 255, 0.05);
        }

        .news-tag.rates,
        .news-tag.equities,
        .news-tag.commodities,
        .news-tag.fx,
        .news-tag.credit {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
            background: rgba(51, 153, 255, 0.05);
        }

        /* Horizon Tags - Time to Impact */
        .news-tag.horizon-now {
            border-color: #ff4466;
            color: #ff4466;
            background: rgba(255, 68, 102, 0.15);
            font-weight: 700;
            animation: pulse-now 1.5s ease-in-out infinite;
        }
        @keyframes pulse-now {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 68, 102, 0.4); }
            50% { box-shadow: 0 0 8px 2px rgba(255, 68, 102, 0.3); }
        }
        .news-tag.horizon-intraday {
            border-color: #ff9933;
            color: #ff9933;
            background: rgba(255, 153, 51, 0.1);
        }
        .news-tag.horizon-days {
            border-color: #ffcc00;
            color: #ffcc00;
            background: rgba(255, 204, 0, 0.08);
        }
        .news-tag.horizon-weeks {
            border-color: #3399ff;
            color: #3399ff;
            background: rgba(51, 153, 255, 0.08);
        }
        .news-tag.horizon-na {
            border-color: #6a7585;
            color: #6a7585;
            background: rgba(106, 117, 133, 0.08);
        }

        /* Regime Badge */
        .regime-badge {
            display: inline-block;
            padding: 0.3rem 0.6rem;
            margin-bottom: 0.5rem;
            background: rgba(187, 102, 255, 0.1);
            border: 1px solid var(--accent-purple);
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--accent-purple);
        }

        /* Market Risk Indicator */
        .confidence-bar {
            margin-top: 1rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border);
        }

        .confidence-label {
            font-size: 0.6rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 0.3rem;
        }

        .confidence-track {
            height: 4px;
            background: rgba(42, 48, 64, 0.5);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .confidence-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        /* Dynamic risk colors set via inline style from JS */
        .confidence-fill.risk-low {
            background: linear-gradient(90deg, #00ff88 0%, #33ff99 100%);
        }
        .confidence-fill.risk-medium {
            background: linear-gradient(90deg, #00ff88 0%, #88cc44 40%, #ffbb33 100%);
        }
        .confidence-fill.risk-elevated {
            background: linear-gradient(90deg, #00ff88 0%, #ffbb33 50%, #ff8833 100%);
        }
        .confidence-fill.risk-high {
            background: linear-gradient(90deg, #00ff88 0%, #ffbb33 30%, #ff8833 60%, #ff4466 100%);
        }
        .confidence-fill.risk-critical {
            background: linear-gradient(90deg, #00ff88 0%, #ffbb33 20%, #ff8833 40%, #ff4466 70%, #dd2244 100%);
        }

        /* Next Events Section */
        .next-events {
            margin-top: 1rem;
            padding: 0.5rem 0.6rem;
            background: rgba(51, 153, 255, 0.05);
            border: 1px solid rgba(51, 153, 255, 0.2);
            border-radius: 4px;
        }

        .next-events-title {
            /* font-size set by responsive breakpoints */
            color: var(--accent-blue);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
            font-weight: 700;
        }

        .next-event-item {
            /* font-size set by responsive breakpoints */
            color: var(--text-secondary);
            margin-left: 0.5rem;
            margin-bottom: 0.1rem;
            line-height: 1.3;
        }

        .next-event-item:before {
            content: " ";
            color: var(--accent-blue);
            font-weight: 700;
        }

        /* 4-Pillar Horizon Scanner Catalyst Badges */
        .watch-next-global {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 8px;
            max-height: 280px;
            overflow-y: auto;
        }
        /* Thin scrollbar for catalyst scanner */
        .watch-next-global::-webkit-scrollbar {
            width: 4px;
        }
        .watch-next-global::-webkit-scrollbar-track {
            background: transparent;
        }
        .watch-next-global::-webkit-scrollbar-thumb {
            background: #6B8BA4;
            border-radius: 2px;
        }
        .watch-next-global::-webkit-scrollbar-thumb:hover {
            background: #8aa8c0;
        }
        .catalyst-item {
            display: flex;
            align-items: center;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.65rem;
            gap: 8px;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
            background: linear-gradient(135deg, rgba(32, 178, 170, 0.15), rgba(32, 178, 170, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.08);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        .catalyst-item:hover {
            background: linear-gradient(135deg, rgba(32, 178, 170, 0.3), rgba(32, 178, 170, 0.15));
            border-color: rgba(0, 217, 255, 0.5);
            transform: translateY(-1px);
            box-shadow: 0 0 8px rgba(32, 178, 170, 0.3);
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        .catalyst-item:active {
            transform: scale(0.98);
            background: rgba(0, 217, 255, 0.2);
        }
        .cat-badge {
            font-size: 0.5rem;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 3px;
            text-align: center;
            color: #0a0e14;
            flex-shrink: 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .cat-badge.kinetic { background: linear-gradient(135deg, #ff4466, #ef4444); }
        .cat-badge.macro { background: linear-gradient(135deg, #00D9FF, #3b82f6); }
        .cat-badge.statecraft { background: linear-gradient(135deg, #bf5af2, #a855f7); }
        .cat-badge.systemic { background: linear-gradient(135deg, #ffbb33, #f59e0b); }
        
        .catalyst-text-wrapper {
            flex: 1;
            overflow: hidden;
            min-width: 0;
        }
        .catalyst-text {
            color: #ffffff;
            line-height: 1.3;
            font-size: 0.7rem;
            white-space: nowrap;
            display: inline-block;
        }
        
        /* Desktop: scroll on hover */
        @media (min-width: 769px) {
            .catalyst-item:hover .catalyst-text {
                animation: scrollText 5s linear infinite;
            }
            
            @keyframes scrollText {
                0%, 20% { transform: translateX(0); }
                80%, 100% { transform: translateX(-100%); }
            }
        }
        .catalyst-source {
            color: var(--text-muted);
            font-size: 0.55rem;
            margin-left: auto;
            flex-shrink: 0;
        }

        /* Market Cards */
        .market-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .market-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .market-value {
            font-size: 1rem;
            font-weight: 700;
            font-family: 'IBM Plex Sans', sans-serif;
        }

        .market-change {
            font-size: 0.7rem;
            margin-top: 0.2rem;
        }

        .market-up { color: var(--accent-green); }
        .market-down { color: var(--accent-red); }
        .market-neutral { color: var(--text-dim); }

        /* Thin CSS3 Scrollbars for columns */
        .column-content::-webkit-scrollbar {
            width: 5px;
        }

        .column-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .column-content::-webkit-scrollbar-thumb {
            background: rgba(212, 113, 74, 0.25);
            border-radius: 3px;
        }

        .column-content::-webkit-scrollbar-thumb:hover {
            background: rgba(212, 113, 74, 0.5);
        }
        
        /* Column-specific scrollbar colors */
        .col-breaking .column-content { scrollbar-color: rgba(255, 68, 102, 0.3) transparent; }
        .col-breaking .column-content::-webkit-scrollbar-thumb { background: rgba(255, 68, 102, 0.25); }
        .col-breaking .column-content::-webkit-scrollbar-thumb:hover { background: rgba(255, 68, 102, 0.5); }
        
        .col-macro .column-content { scrollbar-color: rgba(51, 153, 255, 0.3) transparent; }
        .col-macro .column-content::-webkit-scrollbar-thumb { background: rgba(51, 153, 255, 0.25); }
        .col-macro .column-content::-webkit-scrollbar-thumb:hover { background: rgba(51, 153, 255, 0.5); }
        
        .col-geo .column-content { scrollbar-color: rgba(187, 102, 255, 0.3) transparent; }
        .col-geo .column-content::-webkit-scrollbar-thumb { background: rgba(187, 102, 255, 0.25); }
        .col-geo .column-content::-webkit-scrollbar-thumb:hover { background: rgba(187, 102, 255, 0.5); }
        
        .col-commodity .column-content { scrollbar-color: rgba(255, 187, 51, 0.3) transparent; }
        .col-commodity .column-content::-webkit-scrollbar-thumb { background: rgba(255, 187, 51, 0.25); }
        .col-commodity .column-content::-webkit-scrollbar-thumb:hover { background: rgba(255, 187, 51, 0.5); }
        
        .col-fx .column-content { scrollbar-color: rgba(0, 217, 255, 0.3) transparent; }
        .col-fx .column-content::-webkit-scrollbar-thumb { background: rgba(0, 217, 255, 0.25); }
        .col-fx .column-content::-webkit-scrollbar-thumb:hover { background: rgba(0, 217, 255, 0.5); }
        
        .col-prediction .column-content { scrollbar-color: rgba(143, 188, 143, 0.3) transparent; }
        .col-prediction .column-content::-webkit-scrollbar-thumb { background: rgba(143, 188, 143, 0.25); }
        .col-prediction .column-content::-webkit-scrollbar-thumb:hover { background: rgba(143, 188, 143, 0.5); }

        /* Prediction Dashboard - Mossy Green Theme */
        .prediction-dashboard {
            background: linear-gradient(135deg, rgba(143, 188, 143, 0.12) 0%, rgba(85, 120, 85, 0.08) 100%);
            border: 1px solid #8fbc8f;
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: visible;
        }
        .dashboard-section {
            padding: 10px;
            border-bottom: 1px solid rgba(143, 188, 143, 0.15);
        }
        .dashboard-section:last-child {
            border-bottom: none;
        }
        .dashboard-title {
            font-family: 'IBM Plex Sans', sans-serif;
            /* font-size set by responsive breakpoints */
            font-weight: 700;
            color: var(--accent-moss);
            text-transform: uppercase;
            letter-spacing: 1.2px;
            margin-bottom: 0.3rem;
            text-align: center;
        }
        .dashboard-section-subtitle {
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            text-align: center;
        }
        
        /* Sentiment Dashboard Grid */
        .sentiment-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }
        .sentiment-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            padding: 6px 8px;
            text-align: center;
            border-left: 3px solid rgba(143, 188, 143, 0.6);
        }
        .sentiment-label {
            font-size: 0.6rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .sentiment-value {
            font-size: 0.85rem;
            font-weight: 700;
            line-height: 1.2;
        }
        .sentiment-sub {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 2px;
        }
        .sentiment-loading {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
            padding: 16px;
        }
        
        /* Polymarket Container - no scrollbar, show all */
        .polymarket-container {
            max-height: none;
            overflow-y: visible;
        }
        .polymarket-empty {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
            padding: 16px;
        }
        
        /* Game Theory Dashboard Container - for GEOPOLITICS column */
        .game-theory-dashboard-container {
            background: linear-gradient(135deg, rgba(187, 102, 255, 0.12) 0%, rgba(139, 92, 246, 0.08) 100%);
            border: 1px solid #a855f7;
            border-radius: 8px;
            margin-bottom: 12px;
            padding: 10px;
        }
        /* Game Theory Engine Styles */
        .game-theory-section {
            margin-top: 1rem;
            border-top: 1px solid rgba(187, 102, 255, 0.3);
            padding-top: 1rem;
        }
        .game-theory-container {
            max-height: none;
            overflow-y: visible;
        }
        .game-theory-loading {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
            padding: 16px;
        }
        .game-card {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 10px;
            border-left: 3px solid;
        }
        .game-card.status-green { border-left-color: #22c55e; }
        .game-card.status-yellow { border-left-color: #f59e0b; }
        .game-card.status-red { border-left-color: #ef4444; }
        
        .proxy-decoder-row {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 6px;
        }
        .proxy-badge {
            font-size: 0.6rem;
            padding: 2px 6px;
            border: 1px solid #4a5568;
            border-radius: 3px;
            color: #e2e8f0;
            background: rgba(74, 85, 104, 0.3);
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .resource-badge {
            font-size: 0.6rem;
            padding: 2px 6px;
            border: 1px solid #ffbb33;
            border-radius: 3px;
            color: #ffbb33;
            background: rgba(255, 187, 51, 0.15);
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .escalation-level {
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .game-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #fff;
        }
        .game-phase {
            font-size: 0.65rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 3px;
            text-transform: uppercase;
        }
        .game-phase.phase-green { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .game-phase.phase-yellow { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .game-phase.phase-red { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        
        .game-players {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 6px;
        }
        
        .game-last-move {
            background: rgba(255, 255, 255, 0.05);
            padding: 6px 8px;
            border-radius: 4px;
            margin-bottom: 6px;
        }
        .game-move-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 2px;
        }
        .game-move-text {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        .game-move-type {
            font-size: 0.6rem;
            font-weight: 600;
            padding: 1px 4px;
            border-radius: 2px;
            margin-left: 4px;
        }
        .move-type-defect { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .move-type-cooperate { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .move-type-signal { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        
        .game-equilibrium {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }
        .equilibrium-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .equilibrium-dot.eq-green { background: #22c55e; box-shadow: 0 0 6px #22c55e; }
        .equilibrium-dot.eq-yellow { background: #f59e0b; box-shadow: 0 0 6px #f59e0b; }
        .equilibrium-dot.eq-red { background: #ef4444; box-shadow: 0 0 6px #ef4444; animation: pulse-red 1.5s infinite; }
        
        @keyframes pulse-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .equilibrium-text {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .game-next-move {
            font-size: 0.7rem;
            color: var(--accent-orange);
            font-style: italic;
        }
        .game-next-move::before {
            content: " ";
        }
        
        /* Strategic Intelligence Panel Styles */
        
        /* Full-width legend buttons */
        .statecraft-legend-btn {
            width: 100%;
            background: rgba(168, 85, 247, 0.15);
            border: 1px solid rgba(168, 85, 247, 0.4);
            border-radius: 8px;
            padding: 8px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
            animation: purplePulse 3s ease-in-out infinite;
        }
        .statecraft-legend-btn:hover {
            background: rgba(168, 85, 247, 0.25);
            border-color: rgba(168, 85, 247, 0.6);
            box-shadow: 0 0 8px rgba(168, 85, 247, 0.3);
            transform: translateY(-1px);
        }
        .statecraft-legend-btn .legend-text {
            font-size: 0.75rem;
            font-weight: 600;
            color: #a78bfa;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Statecraft Section Labels - match .macro-dashboard-subtitle exactly */
        .statecraft-section-label {
            font-size: 0.65rem;
            font-weight: 400;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
            margin-bottom: 10px;
            margin-top: 6px;
        }
        .statecraft-section-label:first-of-type {
            margin-top: 0;
        }
        
        .strategic-intel-container {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.12) 0%, rgba(168, 85, 247, 0.08) 100%);
            border: 1px solid rgba(168, 85, 247, 0.35);
            border-radius: 8px;
            margin-bottom: 12px;
            padding: 10px;
        }
        .strategic-intel-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: #a855f7;
            text-align: center;
            margin-bottom: 2px;
            letter-spacing: 0.5px;
        }
        .strategic-intel-subtitle {
            font-size: 0.65rem;
            color: #6a7585;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 10px;
        }
        .strategic-intel-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .intel-widget {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(168, 85, 247, 0.25);
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .intel-widget:hover {
            border-color: rgba(168, 85, 247, 0.6);
            background: rgba(168, 85, 247, 0.15);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(168, 85, 247, 0.3);
        }
        .intel-widget-header {
            font-size: 0.6rem;
            color: #6a7585;
            font-weight: 700;
            letter-spacing: 0.03em;
            margin-bottom: 4px;
            text-transform: uppercase;
        }
        .intel-widget-value {
            font-size: 0.75rem;
            font-weight: 700;
            color: #e6e8eb;
            margin-bottom: 2px;
            font-family: 'IBM Plex Sans', sans-serif;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        .intel-widget-sub {
            font-size: 0.55rem;
            color: #5a6070;
            text-transform: uppercase;
        }
        .intel-meter {
            width: 100%;
            height: 3px;
            background: rgba(255, 255, 255, 0.1);
            margin-top: 6px;
            border-radius: 2px;
        }
        .intel-meter-fill {
            height: 100%;
            width: 0%;
            background: #22c55e;
            transition: width 0.5s ease, background 0.5s ease;
            border-radius: 2px;
        }
        .intel-fragmentation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
            padding: 6px 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
            border: 1px solid rgba(168, 85, 247, 0.4);
            transition: all 0.3s ease;
        }
        .intel-fragmentation:hover {
            background: rgba(168, 85, 247, 0.15);
            box-shadow: 0 2px 8px rgba(168, 85, 247, 0.3);
        }
        .intel-frag-label {
            color: #6a7585;
            font-weight: 600;
            text-transform: uppercase;
        }
        .intel-frag-value {
            color: #22c55e;
            font-weight: 700;
        }
        .intel-frag-hits {
            color: #5a6070;
            font-size: 0.6rem;
        }
        
        /* --- GRAND STRATEGY COMMAND CENTER --- */
        .sc-matrix-container {
            background: #0f131a;
            border: 1px solid #2a3040;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        /* GAME STATE HEADER */
        .gs-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 10px;
        }
        .gs-title { font-size: 0.85rem; color: #bbb; letter-spacing: 1.5px; font-weight: 700; }
        .gs-status { font-size: 1rem; font-weight: 800; letter-spacing: 0.5px; text-shadow: 0 0 15px rgba(255,255,255,0.3); text-align: right; line-height: 1.2; }
        .gs-status.multi-line { font-size: 0.8rem; }
        .gs-desc { font-size: 0.7rem; color: #999; font-style: italic; margin-bottom: 14px; line-height: 1.4; }

        /* THE 5x3 MATRIX GRID */
        .matrix-grid {
            display: grid;
            grid-template-columns: 85px repeat(5, 1fr); 
            gap: 4px;
            margin-bottom: 14px;
        }
        .matrix-col-head { 
            text-align: center; color: #aaa; font-size: 0.8rem; font-weight: 600; padding-bottom: 6px; border-bottom: 1px solid #333; margin-bottom: 3px;
        }
        .matrix-row-label { 
            display: flex; align-items: center; color: #ccc; font-weight: 700; font-size: 0.7rem; letter-spacing: 0.5px;
        }

        /* THE CELLS (The Lightbulbs) */
        .matrix-cell {
            background: rgba(255,255,255,0.04);
            border: 1px solid #333;
            height: 28px;
            display: flex; align-items: center; justify-content: center;
            color: #555;
            font-size: 0.8rem;
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ACTIVE CELL GLOWS */
        /* Kinetic = RED GLOW */
        .cell-kinetic-active {
            background: rgba(255, 68, 102, 0.15); border-color: #ff4466; color: #ff4466;
            box-shadow: 0 0 8px rgba(255, 68, 102, 0.4);
        }
        /* Economic = GREEN GLOW */
        .cell-econ-active {
            background: rgba(34, 197, 94, 0.15); border-color: #22c55e; color: #22c55e;
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.4);
        }
        /* Monetary = GOLD GLOW */
        .cell-mon-active {
            background: rgba(255, 187, 51, 0.15); border-color: #ffbb33; color: #ffbb33;
            box-shadow: 0 0 8px rgba(255, 187, 51, 0.4);
        }
        /* Diplo/Info = BLUE GLOW */
        .cell-soft-active {
            background: rgba(90, 170, 255, 0.15); border-color: #5aaaff; color: #5aaaff;
            box-shadow: 0 0 8px rgba(90, 170, 255, 0.4);
        }

        /* FRACTURE METER */
        .fracture-box {
            margin-top: 10px; padding-top: 8px; border-top: 1px dashed #333;
        }
        .fracture-track {
            height: 6px; background: rgba(255,255,255,0.1); margin: 8px 0; border-radius: 3px; overflow: hidden; border: 1px solid #333;
        }
        .fracture-fill { height: 100%; transition: width 0.6s ease-out; min-width: 8px; border-radius: 2px; }

        /* THE PIVOT BUTTON - Purple theme matching Column 3 */
        .pivot-btn {
            display: block; width: 100%; margin-top: 12px; padding: 10px;
            background: rgba(168, 85, 247, 0.1); border: 1px solid rgba(168, 85, 247, 0.4);
            color: #a855f7; text-align: center; cursor: pointer;
            transition: all 0.2s; border-radius: 4px;
        }
        .pivot-btn:hover { background: rgba(168, 85, 247, 0.2); border-color: #a855f7; box-shadow: 0 0 12px rgba(168, 85, 247, 0.3); }
        
        /* DEFCON Panel Wrapper with Orbiting Sentinel Text */
        .defcon-panel-wrapper {
            position: relative;
            margin-bottom: 10px;
            padding: 14px 2px 2px 2px;
        }
        
        .sentinel-orbit {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: visible;
            z-index: 10;
        }
        
        .sentinel-letter {
            position: absolute;
            font-size: 0.55rem;
            font-weight: 700;
            color: #a78bfa;
            text-transform: uppercase;
            text-shadow: 0 0 8px rgba(167, 139, 250, 0.9), 0 0 16px rgba(167, 139, 250, 0.5);
            animation: train-orbit 44s linear infinite;
            white-space: nowrap;
        }
        
        /* Train orbit - 30s stall at top, then 14s orbit around edges */
        @keyframes train-orbit {
            /* STALL at top center for 30 seconds (0% to 68%) */
            0% { top: 4px; left: 50%; transform: translateX(-50%) rotate(0deg); }
            68% { top: 4px; left: 50%; transform: translateX(-50%) rotate(0deg); }
            /* Top edge: center to right corner */
            72% { top: 4px; left: 90%; transform: rotate(0deg); }
            /* Right edge: top to bottom */
            72.01% { top: 4px; left: calc(100% - 6px); transform: rotate(90deg); }
            81% { top: calc(100% - 14px); left: calc(100% - 6px); transform: rotate(90deg); }
            /* Bottom edge: right to left */
            81.01% { top: calc(100% - 6px); left: 90%; transform: rotate(180deg); }
            90% { top: calc(100% - 6px); left: 5%; transform: rotate(180deg); }
            /* Left edge: bottom to top */
            90.01% { top: calc(100% - 14px); left: 6px; transform: rotate(270deg); }
            97% { top: 4px; left: 6px; transform: rotate(270deg); }
            /* Top edge: left corner back to center */
            97.01% { top: 4px; left: 5%; transform: rotate(0deg); }
            100% { top: 4px; left: 50%; transform: translateX(-50%) rotate(0deg); }
        }
        
        /* Mobile adjustments for sentinel orbit */
        @media (max-width: 768px) {
            .sentinel-letter {
                font-size: 0.5rem;
            }
        }
        
        @media (max-width: 480px) {
            .sentinel-letter {
                font-size: 0.45rem;
            }
            .defcon-panel-wrapper {
                padding-top: 12px;
            }
        }
        
        /* DEFCON Panel Styles - The Michael Every Fourteen */
        .defcon-panel {
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            background: rgba(0, 0, 0, 0.2);
        }
        .defcon-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s ease;
            gap: 8px;
        }
        .defcon-header:hover {
            background: rgba(168, 85, 247, 0.1);
        }
        .defcon-header-top {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
        }
        .defcon-title {
            font-size: 0.85rem;
            font-weight: 700;
            color: #a78bfa;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .defcon-summary {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            width: 100%;
            padding: 4px 0;
        }
        .defcon-count-group {
            display: flex !important;
            align-items: center;
            justify-content: center;
            gap: 8px;
            white-space: nowrap;
        }
        .defcon-count-number {
            font-size: 1rem;
            font-weight: 700;
            min-width: 20px;
            text-align: right;
        }
        .defcon-count-label {
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .defcon-count-group.safe .defcon-count-number { color: #22c55e; }
        .defcon-count-group.safe .defcon-count-label { color: #22c55e; }
        .defcon-count-group.arming .defcon-count-number { color: #f59e0b; }
        .defcon-count-group.arming .defcon-count-label { color: #f59e0b; }
        .defcon-count-group.breached .defcon-count-number { color: #ef4444; }
        .defcon-count-group.breached .defcon-count-label { color: #ef4444; }
        .compound-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            cursor: help;
            width: 100%;
        }
        .compound-status {
            font-size: 0.75rem;
        }
        .compound-status.isolated { color: #6a7585; }
        .compound-status.correlating { color: #3b82f6; }
        .compound-status.clustering { color: #f59e0b; background: rgba(245, 158, 11, 0.15); padding: 2px 8px; border-radius: 4px; }
        .compound-status.systemic { color: #ef4444; background: rgba(239, 68, 68, 0.2); padding: 2px 8px; border-radius: 4px; animation: pulse-red 1.5s infinite; }
        .defcon-toggle {
            color: #a78bfa;
            font-size: 0.7rem;
            transition: transform 0.3s ease;
        }
        .defcon-toggle.expanded {
            transform: rotate(180deg);
        }
        .defcon-body {
            padding: 0;
            border-top: 1px solid rgba(168, 85, 247, 0.2);
        }
        
        /* KINETIC THEATERS Collapsible Widget */
        .kinetic-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 8px 10px;
            border-radius: 6px;
            background: rgba(168, 85, 247, 0.08);
            transition: background 0.2s ease;
        }
        .kinetic-header:hover {
            background: rgba(168, 85, 247, 0.15);
        }
        .kinetic-header-top {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .kinetic-toggle {
            color: #a855f7;
            font-size: 0.6rem;
            transition: transform 0.3s ease;
        }
        .kinetic-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: #a855f7;
            letter-spacing: 0.5px;
        }
        .kinetic-summary {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 4px;
        }
        .kinetic-count-group {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .kinetic-count-number {
            font-size: 0.85rem;
            font-weight: 700;
        }
        .kinetic-count-label {
            font-size: 0.6rem;
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        .kinetic-count-group.active .kinetic-count-number { color: #ef4444; }
        .kinetic-count-group.active .kinetic-count-label { color: #ef4444; }
        .kinetic-count-group.emerging .kinetic-count-number { color: #f59e0b; }
        .kinetic-count-group.emerging .kinetic-count-label { color: #f59e0b; }
        .kinetic-count-group.emerging {
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            animation: pulse-amber 2s infinite;
        }
        .kinetic-count-group.emerging:hover {
            background: rgba(245, 158, 11, 0.2);
        }
        @keyframes pulse-amber {
            0%, 100% { background: rgba(245, 158, 11, 0.1); }
            50% { background: rgba(245, 158, 11, 0.25); }
        }
        .kinetic-body {
            display: none;
            max-height: 840px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(168, 85, 247, 0.3) transparent;
            border-top: 1px solid rgba(168, 85, 247, 0.2);
            margin-top: 8px;
            padding-top: 8px;
        }
        .kinetic-body::-webkit-scrollbar {
            width: 6px;
        }
        .kinetic-body::-webkit-scrollbar-track {
            background: transparent;
        }
        .kinetic-body::-webkit-scrollbar-thumb {
            background: rgba(168, 85, 247, 0.3);
            border-radius: 3px;
        }
        .kinetic-body::-webkit-scrollbar-thumb:hover {
            background: rgba(168, 85, 247, 0.5);
        }
        
        .defcon-grid {
            display: flex;
            flex-direction: column;
        }
        .defcon-tripwire {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 8px 10px;
            border-bottom: 1px solid rgba(100, 100, 120, 0.2);
            transition: all 0.2s ease;
        }
        .defcon-tripwire:last-child {
            border-bottom: none;
        }
        .defcon-tripwire:hover {
            background: rgba(168, 85, 247, 0.08);
        }
        .defcon-tripwire-left {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
            min-width: 0;
        }
        .defcon-tripwire-name {
            font-size: 0.75rem;
            font-weight: 600;
            color: #e5e5e5;
            letter-spacing: 0.3px;
        }
        .defcon-tripwire-info {
            font-size: 0.6rem;
            color: #8a8a9a;
            line-height: 1.2;
        }
        .defcon-tripwire-status {
            font-size: 0.55rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 3px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        .defcon-tripwire.safe .defcon-tripwire-status { 
            background: rgba(34, 197, 94, 0.15); 
            color: #22c55e;
        }
        .defcon-tripwire.arming { 
            background: rgba(245, 158, 11, 0.08);
        }
        .defcon-tripwire.arming .defcon-tripwire-status { 
            background: rgba(245, 158, 11, 0.2); 
            color: #f59e0b;
        }
        .defcon-tripwire.breached { 
            background: rgba(239, 68, 68, 0.1);
        }
        .defcon-tripwire.breached .defcon-tripwire-status { 
            background: rgba(239, 68, 68, 0.2); 
            color: #ef4444;
        }
        .defcon-emoji {
            font-size: 1rem;
            width: 24px;
            text-align: center;
        }
        .defcon-info {
            flex: 1;
            min-width: 0;
        }
        .defcon-name {
            font-size: 0.7rem;
            font-weight: 700;
            color: #e6e8eb;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .defcon-desc {
            font-size: 0.6rem;
            color: #6a7585;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .defcon-status {
            font-size: 0.6rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 3px;
            text-transform: uppercase;
        }
        .defcon-status.safe { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .defcon-status.arming { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .defcon-status.breached { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .defcon-loading {
            text-align: center;
            color: #6a7585;
            font-size: 0.7rem;
            padding: 10px;
        }
        
        /* Conflict Tooltip Container */
        .badge-with-tooltip {
            position: relative;
            display: inline-block;
        }
        
        .conflict-tooltip {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #1a1f2b 0%, #0f1319 100%);
            border: 1px solid rgba(239, 68, 68, 0.4);
            border-radius: 8px;
            padding: 10px 12px;
            min-width: 220px;
            max-width: 280px;
            z-index: 1000;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5), 0 0 20px rgba(239, 68, 68, 0.15);
        }
        
        .conflict-tooltip::before {
            content: '';
            position: absolute;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 6px solid rgba(239, 68, 68, 0.4);
        }
        
        .badge-with-tooltip:hover .conflict-tooltip {
            display: block;
        }
        
        .tooltip-title {
            font-size: 0.6rem;
            font-weight: 700;
            color: #ef4444;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(239, 68, 68, 0.2);
        }
        
        .tooltip-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .tooltip-item:last-child {
            border-bottom: none;
        }
        
        .tooltip-emoji {
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        
        .tooltip-content {
            flex: 1;
            min-width: 0;
        }
        
        .tooltip-name {
            font-size: 0.7rem;
            font-weight: 600;
            color: #e6e8eb;
            line-height: 1.3;
        }
        
        .tooltip-detail {
            font-size: 0.6rem;
            color: #6a7585;
            margin-top: 2px;
        }
        
        .tooltip-phase {
            font-size: 0.55rem;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 3px;
            display: inline-block;
            margin-top: 3px;
        }
        
        .tooltip-phase.escalation { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .tooltip-phase.brinkmanship { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .tooltip-phase.conflict { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .tooltip-phase.standoff { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .tooltip-phase.posturing { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .tooltip-phase.stable { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        
        .tooltip-empty {
            font-size: 0.65rem;
            color: #6a7585;
            text-align: center;
            padding: 8px;
        }
        
        .tooltip-region-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .tooltip-region-row:last-child {
            border-bottom: none;
        }
        
        .tooltip-region-name {
            font-size: 0.7rem;
            font-weight: 600;
            color: #e6e8eb;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .tooltip-region-count {
            font-size: 0.75rem;
            font-weight: 700;
            color: #a855f7;
            background: rgba(168, 85, 247, 0.15);
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 24px;
            text-align: center;
        }
        
        .conflict-tooltip .tooltip-region-count {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.15);
        }
        
        .conflict-tooltip.active-tooltip .tooltip-region-count {
            color: #a855f7;
            background: rgba(168, 85, 247, 0.15);
        }
        
        /* Active tooltip purple theme */
        .conflict-tooltip.active-tooltip {
            border-color: rgba(168, 85, 247, 0.4);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5), 0 0 20px rgba(168, 85, 247, 0.15);
        }
        
        .conflict-tooltip.active-tooltip::before {
            border-bottom-color: rgba(168, 85, 247, 0.4);
        }
        
        .conflict-tooltip.active-tooltip .tooltip-title {
            color: #a855f7;
            border-bottom-color: rgba(168, 85, 247, 0.2);
        }

        /* Active Badge Styles */
        .active-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 3px 8px;
            background: rgba(168, 85, 247, 0.2);
            border: 1px solid rgba(168, 85, 247, 0.5);
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 700;
            color: #a855f7;
            cursor: default;
            animation: pulse-purple 2s infinite;
        }
        
        @keyframes pulse-purple {
            0%, 100% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0.4); }
            50% { box-shadow: 0 0 0 4px rgba(168, 85, 247, 0); }
        }

        /* Emerging Conflict Styles */
        .emerging-badge {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 3px 8px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 700;
            color: #ef4444;
            cursor: pointer;
            animation: pulse-red 1.5s infinite;
        }
        .emerging-badge.visible {
            display: flex;
        }
        .emerging-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(239, 68, 68, 0.3);
        }
        .emerging-section.hidden {
            display: none;
        }
        .emerging-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
        }
        .emerging-header:hover {
            background: rgba(239, 68, 68, 0.15);
        }
        .emerging-title {
            font-size: 0.7rem;
            font-weight: 700;
            color: #ef4444;
            text-transform: uppercase;
        }
        .emerging-count {
            font-size: 0.65rem;
            color: #6a7585;
        }
        .emerging-proposals {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        /* Emerging cards now use same structure as game-card */
        .emerging-card {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 0;
            border-left: 3px solid #ff6b6b;
            position: relative;
        }
        .emerging-card::before {
            content: 'EMERGING';
            position: absolute;
            top: 6px;
            right: 8px;
            font-size: 0.5rem;
            font-weight: 700;
            padding: 2px 5px;
            background: rgba(255, 107, 107, 0.25);
            color: #ff6b6b;
            border-radius: 3px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .emerging-card .game-header {
            padding-right: 55px;
        }
        .emerging-card .game-phase {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }
        .emerging-card .game-equilibrium {
            margin-bottom: 8px;
        }
        .emerging-card .equilibrium-dot {
            background: #ff6b6b;
            box-shadow: 0 0 6px #ff6b6b;
            animation: pulse-emerging 1.5s infinite;
        }
        @keyframes pulse-emerging {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }
        .emerging-card .game-last-move {
            background: rgba(255, 107, 107, 0.08);
            border-left: 2px solid rgba(255, 107, 107, 0.4);
        }
        .emerging-decision-row {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 107, 107, 0.2);
        }
        .emerging-btn {
            flex: 1;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }
        .emerging-btn.accept {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.4);
        }
        .emerging-btn.accept:hover {
            background: rgba(34, 197, 94, 0.3);
        }
        .emerging-btn.dismiss {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
            border: 1px solid rgba(107, 114, 128, 0.4);
        }
        .emerging-btn.dismiss:hover {
            background: rgba(107, 114, 128, 0.3);
        }
        
        .game-analyze-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            background: linear-gradient(135deg, rgba(212, 113, 74, 0.2), rgba(212, 113, 74, 0.1));
            border: 1px solid rgba(212, 113, 74, 0.4);
            border-radius: 4px;
            padding: 6px 10px;
            margin-top: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--accent-orange);
            text-transform: uppercase;
            animation: orangePulse 3s ease-in-out infinite;
            letter-spacing: 0.5px;
            width: 100%;
            box-sizing: border-box;
        }
        @keyframes orangePulse {
            0%, 100% {
                border-color: rgba(212, 113, 74, 0.4);
                box-shadow: 0 0 3px rgba(212, 113, 74, 0.15);
            }
            50% {
                border-color: rgba(212, 113, 74, 0.6);
                box-shadow: 0 0 6px rgba(212, 113, 74, 0.25);
            }
        }
        .game-analyze-btn:hover {
            background: linear-gradient(135deg, rgba(212, 113, 74, 0.3), rgba(212, 113, 74, 0.2));
            border-color: var(--accent-orange);
            box-shadow: 0 0 8px rgba(212, 113, 74, 0.3);
            transform: translateY(-1px);
        }
        
        /* Blue pulse for KNOW MORE button */
        @keyframes bluePulse {
            0%, 100% {
                border-color: rgba(59, 130, 246, 0.4);
                box-shadow: 0 0 3px rgba(59, 130, 246, 0.15);
            }
            50% {
                border-color: rgba(59, 130, 246, 0.6);
                box-shadow: 0 0 6px rgba(59, 130, 246, 0.25);
            }
        }
        .know-more-btn {
            background: transparent;
            border: 1px solid #3b82f6;
            color: #3b82f6;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 9px;
            cursor: pointer;
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 4px;
            animation: bluePulse 3s ease-in-out infinite;
            transition: all 0.2s ease;
        }
        .know-more-btn:hover {
            background: rgba(59, 130, 246, 0.1);
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.3);
            transform: translateY(-1px);
        }
        .game-analyze-btn-icon {
            font-size: 0.8rem;
        }
        
        /* Game Theory Button Row */
        .game-buttons-row {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }
        .game-buttons-row .game-analyze-btn {
            flex: 1;
            margin-top: 0;
            text-align: center;
        }
        .game-map-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            background: linear-gradient(135deg, rgba(212, 113, 74, 0.2), rgba(212, 113, 74, 0.1));
            border: 1px solid rgba(212, 113, 74, 0.4);
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--accent-orange);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex: 1;
            box-sizing: border-box;
            animation: orangePulse 3s ease-in-out infinite;
            text-align: center;
        }
        .game-map-btn:hover {
            background: linear-gradient(135deg, rgba(212, 113, 74, 0.3), rgba(212, 113, 74, 0.2));
            border-color: var(--accent-orange);
            box-shadow: 0 0 8px rgba(212, 113, 74, 0.3);
            transform: translateY(-1px);
        }

        /* Globe Modal Hologram Style - Square */
        .globe-modal-content {
            width: min(75vh, 85vw);
            height: min(75vh, 85vw);
            background: radial-gradient(circle at center, #161a22 0%, #0e1116 100%);
            border: 1px solid rgba(212, 113, 74, 0.4);
            border-radius: 0;
            box-shadow: 
                0 0 0 1px rgba(212, 113, 74, 0.15),
                0 20px 80px rgba(0, 0, 0, 0.7),
                0 0 40px rgba(212, 113, 74, 0.1);
            position: relative;
            animation: hologramPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            flex-direction: column;
            overflow: visible;
        }
        @keyframes hologramPop {
            0% { transform: scale(0.9) translateY(20px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        
        /* Game Theory Tooltip for Globe - Float above everything with drop shadow */
        .am5-tooltip-container {
            background: rgba(14, 17, 22, 0.98) !important;
            border: 1px solid var(--accent-orange) !important;
            backdrop-filter: blur(8px);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.8),
                0 4px 16px rgba(0, 0, 0, 0.6),
                0 0 60px rgba(0, 0, 0, 0.4);
            border-radius: 4px;
            padding: 12px;
            max-width: 280px;
            font-family: 'IBM Plex Sans', sans-serif;
            z-index: 2147483647 !important;
            pointer-events: none;
            text-align: left;
            position: relative;
        }
        /* Hide empty tooltip containers */
        .am5-tooltip-container:empty,
        .am5-tooltip-container:not(:has(.gt-title)) {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }
        /* Force amCharts tooltip layer to max z-index */
        [class*="am5-layer-30"],
        [class*="am5-tooltip"],
        .am5-html-container {
            z-index: 2147483647 !important;
        }
        /* Hide amCharts focus-trap input (causes blinking cursor) */
        input[class*="am5-focus"],
        .am5-focus-container,
        [class*="am5-reader"] {
            position: absolute !important;
            opacity: 0 !important;
            pointer-events: none !important;
            width: 0 !important;
            height: 0 !important;
            overflow: hidden !important;
        }
        .gt-title { color: #fff; font-weight: 700; font-size: 1.1rem; margin-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 6px; }
        .gt-type { font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; display: inline-block; padding: 3px 8px; border-radius: 3px; }
        .gt-desc { color: #a0aec0; font-size: 0.9rem; line-height: 1.5; margin-bottom: 10px; }
        .gt-theory { color: var(--accent-orange); font-size: 0.85rem; font-weight: 600; border-left: 2px solid var(--accent-orange); padding-left: 10px; line-height: 1.4; }
        
        /* Cluster tooltip styling */
        .gt-cluster-list {
            max-height: 200px;
            overflow-y: auto;
            padding-right: 6px;
            margin: 8px 0;
        }
        .gt-cluster-list::-webkit-scrollbar {
            width: 4px;
        }
        .gt-cluster-list::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 2px;
        }
        .gt-cluster-list::-webkit-scrollbar-thumb {
            background: rgba(212, 113, 74, 0.5);
            border-radius: 2px;
        }
        .gt-cluster-list::-webkit-scrollbar-thumb:hover {
            background: rgba(212, 113, 74, 0.7);
        }
        .gt-cluster-item {
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        .gt-cluster-item:last-child {
            border-bottom: none;
        }
        .gt-cluster-item-title {
            font-weight: 600;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .gt-cluster-item-type {
            font-size: 0.75rem;
            color: #888;
            margin-top: 3px;
        }
        
        /* Globe Marker Info Panel - Clean Modern Design */
        .globe-marker-info {
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            background: rgba(18, 22, 30, 0.96);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(107, 139, 164, 0.25);
            border-radius: 12px;
            padding: 16px 18px;
            min-width: 280px;
            max-width: 340px;
            z-index: 200;
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.5),
                0 4px 12px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease, transform 0.25s ease;
        }
        
        .globe-marker-info.visible {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(-50%) translateY(0);
        }
        
        .globe-marker-info-close {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 28px;
            height: 28px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 6px;
            color: #94a3b8;
            font-size: 1rem;
            font-weight: 300;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            z-index: 10;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        .globe-marker-info-close:hover,
        .globe-marker-info-close:active {
            background: rgba(212, 113, 74, 0.2);
            border-color: rgba(212, 113, 74, 0.4);
            color: #D4714A;
        }
        
        .globe-marker-info-title {
            color: #e2e8f0;
            font-weight: 700;
            font-size: 0.9rem;
            line-height: 1.3;
            margin-bottom: 6px;
            padding-right: 32px;
        }
        
        .globe-marker-info-location {
            color: #6a7585;
            font-size: 0.7rem;
            margin-bottom: 10px;
            letter-spacing: 0.3px;
        }
        
        .globe-marker-info-type {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }
        
        .globe-marker-info-desc {
            color: #94a3b8;
            font-size: 0.75rem;
            line-height: 1.5;
        }
        
        .globe-marker-info-theory {
            color: #6a7585;
            font-size: 0.68rem;
            margin-top: 8px;
            font-style: italic;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.06);
        }
        
        .globe-marker-info-cluster-header {
            text-align: center;
            padding: 8px 14px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.8rem;
            margin-bottom: 10px;
            letter-spacing: 0.5px;
        }
        
        .globe-marker-info-cluster-list {
            max-height: 160px;
            overflow-y: auto;
        }
        
        .globe-marker-info-cluster-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .globe-marker-info-cluster-item:last-child {
            border-bottom: none;
        }
        
        @media (max-width: 480px) {
            .globe-marker-info {
                min-width: 260px;
                max-width: 300px;
                padding: 14px 16px;
                bottom: 16px;
            }
            
            .globe-marker-info-close {
                width: 36px;
                height: 36px;
                font-size: 1.2rem;
                top: 8px;
                right: 8px;
            }
            
            .globe-marker-info-title {
                padding-right: 40px;
            }
        }
        
        /* Mobile-Responsive Globe Modal */
        @media (max-width: 768px) {
            .globe-modal-content {
                width: min(85vh, 95vw);
                height: min(85vh, 95vw);
                border-radius: 0;
            }
            .globe-modal-content .chart-close-btn {
                width: 44px;
                height: 44px;
                font-size: 1.5rem;
                top: 10px;
                right: 10px;
            }
            .am5-tooltip-container {
                max-width: 220px;
                padding: 10px;
            }
            .gt-title { font-size: 1rem; }
            .gt-type { font-size: 0.7rem; }
            .gt-desc { font-size: 0.8rem; }
            .gt-theory { font-size: 0.75rem; }
        }
        
        @media (max-width: 480px) {
            .globe-modal-content {
                width: 95vw;
                height: 95vw;
                border-radius: 0;
                margin-top: 10%;
            }
            .game-buttons-row {
                flex-direction: column;
                gap: 4px;
            }
            .game-buttons-row .game-analyze-btn,
            .game-buttons-row .game-map-btn {
                flex: 1 1 auto;
                width: 100%;
            }
            .game-map-btn {
                flex: 1 1 auto !important;
            }
        }
        
        .polymarket-item {
            cursor: pointer;
            background: rgba(0, 0, 0, 0.3);
            border-left: 3px solid rgba(143, 188, 143, 0.6);
            border-radius: 6px;
            padding: 8px 10px;
            transition: all 0.2s ease;
        }
        .polymarket-item:hover {
            border-left-color: var(--accent-orange);
            background: rgba(212, 113, 74, 0.15);
        }
        .polymarket-item:last-child {
            margin-bottom: 0;
        }
        .polymarket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        .polymarket-category {
            font-size: 0.6rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 3px;
            text-transform: uppercase;
        }
        .cat-macro { background: rgba(143, 188, 143, 0.25); color: #93c5fd; }
        .cat-crypto { background: rgba(143, 188, 143, 0.25); color: #fcd34d; }
        .cat-politics { background: rgba(143, 188, 143, 0.25); color: #fca5a5; }
        .cat-geo { background: rgba(143, 188, 143, 0.25); color: #c4b5fd; }
        .cat-commodity { background: rgba(143, 188, 143, 0.25); color: #fde68a; }
        .cat-other { background: rgba(143, 188, 143, 0.25); color: #d1d5db; }
        .polymarket-prob {
            font-size: 0.85rem;
            font-weight: 700;
        }
        .polymarket-question {
            font-size: 0.7rem;
            color: var(--text-secondary);
            line-height: 1.3;
        }

        /* QUANT STRATEGIST ACCORDION & CARDS */
        .quant-accordion-section {
            margin-bottom: 4px;
        }
        .quant-accordion-header {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: rgba(15, 19, 26, 0.95);
            border: 1px solid rgba(42, 48, 64, 0.8);
            border-radius: 4px;
            color: #fff;
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s ease;
        }
        .quant-accordion-header:hover {
            background: rgba(30, 38, 52, 0.95);
        }
        .quant-accordion-arrow {
            color: var(--accent-moss);
            font-size: 10px;
            transition: transform 0.2s ease;
        }
        .quant-accordion-arrow.expanded {
            transform: rotate(90deg);
        }
        .quant-accordion-count {
            margin-left: auto;
            background: rgba(0, 217, 255, 0.15);
            color: #00D9FF;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
        }
        .quant-accordion-body {
            padding: 6px 4px 0 0;
            max-height: 280px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 217, 255, 0.4) rgba(15, 19, 26, 0.6);
        }
        .quant-accordion-body::-webkit-scrollbar {
            width: 6px;
        }
        .quant-accordion-body::-webkit-scrollbar-track {
            background: rgba(15, 19, 26, 0.6);
            border-radius: 3px;
        }
        .quant-accordion-body::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, rgba(0, 217, 255, 0.5) 0%, rgba(0, 180, 220, 0.3) 100%);
            border-radius: 3px;
            border: 1px solid rgba(0, 217, 255, 0.2);
        }
        .quant-accordion-body::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, rgba(0, 217, 255, 0.7) 0%, rgba(0, 180, 220, 0.5) 100%);
        }

        .quant-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 6px;
            margin-top: 8px;
            max-height: 400px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 217, 255, 0.4) rgba(15, 19, 26, 0.6);
        }
        .quant-grid::-webkit-scrollbar {
            width: 6px;
        }
        .quant-grid::-webkit-scrollbar-track {
            background: rgba(15, 19, 26, 0.6);
            border-radius: 3px;
        }
        .quant-grid::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, rgba(0, 217, 255, 0.5) 0%, rgba(0, 180, 220, 0.3) 100%);
            border-radius: 3px;
        }

        .quant-card {
            background: rgba(15, 19, 26, 0.9);
            border: 1px solid rgba(42, 48, 64, 0.8);
            border-left: 3px solid #4a5568;
            padding: 8px 10px;
            border-radius: 4px;
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 0.7rem;
            position: relative;
            cursor: pointer;
            transition: background 0.2s ease, border-color 0.2s ease;
        }
        .quant-card:hover {
            background: rgba(25, 32, 45, 0.95);
            border-color: rgba(100, 116, 139, 0.6);
        }

        .quant-card.coiling { border-left-color: #ffbb33; }
        .quant-card.exhaustion { border-left-color: #ff4466; }
        .quant-card.capitulation { border-left-color: #00D9FF; }

        .quant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        .quant-symbol {
            font-weight: 700;
            color: #fff;
            font-size: 0.75rem;
        }

        .quant-price {
            color: var(--text-secondary);
            font-size: 0.7rem;
        }

        .quant-structure {
            text-align: center;
            font-weight: 700;
            font-size: 0.65rem;
            margin-bottom: 6px;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .quant-structure.coiling { background: rgba(255, 187, 51, 0.15); color: #ffbb33; }
        .quant-structure.exhaustion { background: rgba(255, 68, 102, 0.15); color: #ff4466; }
        .quant-structure.capitulation { background: rgba(0, 217, 255, 0.15); color: #00D9FF; }
        .quant-structure.trending { background: rgba(255,255,255,0.05); color: #8b9cb3; }

        .quant-levels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
        }

        .quant-level-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.65rem;
            color: #6a7585;
            padding: 2px 0;
        }

        .quant-level-val {
            font-weight: 600;
            color: #e6e8eb;
        }

        .quant-resist { color: #ff6b6b !important; }
        .quant-support { color: #4cd137 !important; }
        .quant-pivot { color: #4ec9b0 !important; }
        .quant-liquidity { 
            background: rgba(255, 68, 102, 0.12);
            color: #ff4466;
            padding: 1px 4px;
            border-radius: 2px;
            font-size: 0.6rem;
        }

        .quant-sigma {
            font-size: 0.55rem;
            color: #4a5568;
            text-align: right;
            margin-top: 4px;
            padding-top: 4px;
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        .quant-news-badge {
            font-size: 0.55rem;
            color: #22c55e;
            margin-left: 3px;
        }

        .quant-divider {
            border-bottom: 1px dashed rgba(255,255,255,0.1);
            margin: 4px 0;
        }

        /* Universal Modal Mobile Fixes */
        .chart-modal-overlay * {
            box-sizing: border-box;
        }

        /* TradingView Chart Modal */
        .chart-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.66);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(6px);
            animation: fadeIn 0.2s ease;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            overflow-y: auto;
            padding: 1rem;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .chart-modal-content {
            width: 95%;
            height: 85%;
            max-width: 1400px;
            background: #131722;
            border: 2px solid #00D9FF;
            border-radius: 8px;
            position: relative;
            box-shadow: 0 0 40px rgba(0, 217, 255, 0.3);
            animation: slideIn 0.3s ease;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        
        /* Mobile chart - X button visible at top */
        @media (max-width: 768px) {
            .chart-modal-content {
                width: 95%;
                height: 75%;
                max-height: 500px;
            }
            
            .chart-close-btn {
                top: 8px;
                right: 8px;
                width: 44px;
                height: 44px;
                font-size: 28px;
                background: rgba(0, 0, 0, 0.9);
                z-index: 10;
            }
        }
        
        /* Portrait mode on phones */
        @media (max-width: 480px) and (orientation: portrait) {
            .chart-modal-content {
                width: 95%;
                height: 70%;
                max-height: 450px;
            }
        }

        /* Info Modal specific styles */
        #infoModal .chart-modal-content {
            height: auto;
            max-height: 85vh;
            padding: 1rem;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-orange) var(--bg-column);
            border-color: var(--accent-orange);
        }

        #infoModal .chart-close-btn {
            border-color: var(--accent-orange);
            color: var(--accent-orange);
        }

        #infoModal .chart-modal-content::-webkit-scrollbar {
            width: 6px;
        }

        #infoModal .chart-modal-content::-webkit-scrollbar-track {
            background: var(--bg-column);
            border-radius: 3px;
        }

        #infoModal .chart-modal-content::-webkit-scrollbar-thumb {
            background: var(--accent-orange);
            border-radius: 3px;
        }

        #infoModal .chart-modal-content::-webkit-scrollbar-thumb:hover {
            background: #e08050;
        }

        /* Game Theory Legend Modal specific styles */
        #gameLegendModal .chart-modal-content {
            height: auto;
            max-height: 85vh;
            padding: 1rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border-color: #9333ea;
        }

        #gameLegendModal .modal-title {
            flex-shrink: 0;
            padding-bottom: 0.5rem;
        }

        #gameLegendModal .modal-analysis {
            flex: 1;
            overflow-y: auto;
            max-height: none;
            scrollbar-width: thin;
            scrollbar-color: #a855f7 var(--bg-column);
        }

        #gameLegendModal .modal-analysis::-webkit-scrollbar {
            width: 6px;
        }

        #gameLegendModal .modal-analysis::-webkit-scrollbar-track {
            background: var(--bg-column);
            border-radius: 3px;
        }

        #gameLegendModal .modal-analysis::-webkit-scrollbar-thumb {
            background: #a855f7;
            border-radius: 3px;
        }

        @media (max-width: 768px) {
            #gameLegendModal .chart-modal-content {
                width: 94%;
                max-height: 80vh;
                padding: 0.75rem;
                margin: 1rem;
            }

            #gameLegendModal .modal-analysis {
                padding: 0.5rem;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            #gameLegendModal .chart-modal-content {
                width: 96%;
                max-height: 85vh;
                padding: 0.5rem;
            }

            #gameLegendModal .modal-analysis {
                font-size: 0.8rem;
                padding: 0.25rem;
            }

            #gameLegendModal .modal-title {
                font-size: 1rem;
            }
        }

        /* Briefing Modal shared styles */
        #commandBriefingModal .chart-modal-content,
        #riskBriefingModal .chart-modal-content,
        #supplyBriefingModal .chart-modal-content,
        #flowsBriefingModal .chart-modal-content,
        #signalsBriefingModal .chart-modal-content {
            height: auto;
            max-height: 85vh;
            padding: 1rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border-color: #9333ea;
        }

        #commandBriefingModal .modal-title,
        #riskBriefingModal .modal-title,
        #supplyBriefingModal .modal-title,
        #flowsBriefingModal .modal-title,
        #signalsBriefingModal .modal-title {
            flex-shrink: 0;
            padding-bottom: 0.5rem;
        }

        #commandBriefingModal .modal-analysis,
        #riskBriefingModal .modal-analysis,
        #supplyBriefingModal .modal-analysis,
        #flowsBriefingModal .modal-analysis,
        #signalsBriefingModal .modal-analysis {
            flex: 1;
            overflow-y: auto;
            max-height: none;
            scrollbar-width: thin;
            scrollbar-color: #a855f7 var(--bg-column);
        }

        #commandBriefingModal .modal-analysis::-webkit-scrollbar,
        #riskBriefingModal .modal-analysis::-webkit-scrollbar,
        #supplyBriefingModal .modal-analysis::-webkit-scrollbar,
        #flowsBriefingModal .modal-analysis::-webkit-scrollbar,
        #signalsBriefingModal .modal-analysis::-webkit-scrollbar {
            width: 6px;
        }

        #commandBriefingModal .modal-analysis::-webkit-scrollbar-track,
        #riskBriefingModal .modal-analysis::-webkit-scrollbar-track,
        #supplyBriefingModal .modal-analysis::-webkit-scrollbar-track,
        #flowsBriefingModal .modal-analysis::-webkit-scrollbar-track,
        #signalsBriefingModal .modal-analysis::-webkit-scrollbar-track {
            background: var(--bg-column);
            border-radius: 3px;
        }

        #commandBriefingModal .modal-analysis::-webkit-scrollbar-thumb,
        #riskBriefingModal .modal-analysis::-webkit-scrollbar-thumb,
        #supplyBriefingModal .modal-analysis::-webkit-scrollbar-thumb,
        #flowsBriefingModal .modal-analysis::-webkit-scrollbar-thumb,
        #signalsBriefingModal .modal-analysis::-webkit-scrollbar-thumb {
            background: #a855f7;
            border-radius: 3px;
        }

        #commandBriefingModal h3,
        #riskBriefingModal h3,
        #supplyBriefingModal h3,
        #flowsBriefingModal h3,
        #signalsBriefingModal h3 {
            color: var(--accent-orange);
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }

        #commandBriefingModal h3:first-of-type,
        #riskBriefingModal h3:first-of-type,
        #supplyBriefingModal h3:first-of-type,
        #flowsBriefingModal h3:first-of-type,
        #signalsBriefingModal h3:first-of-type {
            margin-top: 0;
        }

        #commandBriefingModal .legend-item,
        #riskBriefingModal .legend-item,
        #supplyBriefingModal .legend-item,
        #flowsBriefingModal .legend-item,
        #signalsBriefingModal .legend-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        #commandBriefingModal .legend-icon,
        #riskBriefingModal .legend-icon,
        #supplyBriefingModal .legend-icon,
        #flowsBriefingModal .legend-icon,
        #signalsBriefingModal .legend-icon {
            flex-shrink: 0;
            width: 20px;
            text-align: center;
        }

        #commandBriefingModal .legend-text,
        #riskBriefingModal .legend-text,
        #supplyBriefingModal .legend-text,
        #flowsBriefingModal .legend-text,
        #signalsBriefingModal .legend-text {
            color: #94a3b8;
        }

        @media (max-width: 768px) {
            #commandBriefingModal .chart-modal-content {
                width: 94%;
                max-height: 80vh;
                padding: 0.75rem;
                margin: 1rem;
            }

            #commandBriefingModal .modal-analysis {
                padding: 0.5rem;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            #commandBriefingModal .chart-modal-content {
                width: 96%;
                max-height: 85vh;
                padding: 0.5rem;
            }

            #commandBriefingModal .modal-analysis {
                font-size: 0.8rem;
                padding: 0.25rem;
            }

            #commandBriefingModal .modal-title {
                font-size: 1rem;
            }
        }

        /* Tactical Structure Legend Modal - responsive */
        #tacticalLegendModal .chart-modal-content {
            height: auto;
            max-height: 85vh;
            padding: 1rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border-color: #22c55e;
        }

        #tacticalLegendModal .modal-title {
            flex-shrink: 0;
            padding-bottom: 0.5rem;
        }

        #tacticalLegendModal .modal-analysis {
            flex: 1;
            overflow-y: auto;
            max-height: none;
            scrollbar-width: thin;
            scrollbar-color: #22c55e var(--bg-column);
        }

        #tacticalLegendModal .modal-analysis::-webkit-scrollbar {
            width: 6px;
        }

        #tacticalLegendModal .modal-analysis::-webkit-scrollbar-track {
            background: var(--bg-column);
            border-radius: 3px;
        }

        #tacticalLegendModal .modal-analysis::-webkit-scrollbar-thumb {
            background: #22c55e;
            border-radius: 3px;
        }

        #tacticalLegendModal h3 {
            color: var(--accent-orange);
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }

        #tacticalLegendModal h3:first-of-type {
            margin-top: 0;
        }

        #tacticalLegendModal .legend-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        #tacticalLegendModal .legend-icon {
            flex-shrink: 0;
            width: 20px;
            text-align: center;
        }

        #tacticalLegendModal .legend-text {
            color: #94a3b8;
        }

        #tacticalLegendModal .category-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 6px;
        }

        @media (max-width: 768px) {
            #tacticalLegendModal .chart-modal-content {
                width: 94%;
                max-height: 80vh;
                padding: 0.75rem;
                margin: 1rem;
            }

            #tacticalLegendModal .modal-analysis {
                padding: 0.5rem;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            #tacticalLegendModal .chart-modal-content {
                width: 96%;
                max-height: 85vh;
                padding: 0.5rem;
            }

            #tacticalLegendModal .modal-analysis {
                font-size: 0.8rem;
                padding: 0.25rem;
            }

            #tacticalLegendModal .modal-title {
                font-size: 1rem;
            }
        }

        /* Beam Analysis Modal - Mobile Responsive Fixes */
        #beamAnalysisModal .chart-modal-content {
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            box-sizing: border-box;
            overflow: hidden;
        }

        #beamAnalysisModal #beamModalBody {
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            overflow-y: auto;
            overflow-x: hidden;
            box-sizing: border-box;
        }

        #beamAnalysisModal #beamModalBody p,
        #beamAnalysisModal #beamModalBody div,
        #beamAnalysisModal #beamModalBody span,
        #beamAnalysisModal #beamModalBody li,
        #beamAnalysisModal #beamModalBody ul,
        #beamAnalysisModal #beamModalBody ol,
        #beamAnalysisModal #beamModalBody h3,
        #beamAnalysisModal #beamModalBody h4 {
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            max-width: 100%;
            box-sizing: border-box;
        }

        @media (max-width: 768px) {
            #beamAnalysisModal .chart-modal-content {
                width: 94%;
                max-width: 94vw;
                max-height: 85vh;
                padding: 1rem;
                margin: 0.5rem;
                box-sizing: border-box;
                left: 50%;
                transform: translateX(-50%);
            }

            #beamAnalysisModal #beamModalBody {
                max-height: 55vh;
                padding: 0.5rem;
                padding-right: 8px;
                font-size: 0.85rem;
                line-height: 1.5;
            }

            #beamAnalysisModal #beamModalTitle {
                font-size: 0.95rem;
                padding-right: 2rem;
            }

            #beamAnalysisModal #beamModalStatus {
                font-size: 0.8rem;
            }
        }

        @media (max-width: 480px) {
            #beamAnalysisModal .chart-modal-content {
                width: 96%;
                max-width: 96vw;
                max-height: 90vh;
                padding: 0.6rem;
                margin: 0.25rem;
            }

            #beamAnalysisModal #beamModalBody {
                max-height: 50vh;
                font-size: 0.8rem;
                line-height: 1.45;
                padding: 0.25rem;
            }

            #beamAnalysisModal #beamModalTitle {
                font-size: 0.85rem;
                letter-spacing: 0.5px;
            }

            #beamAnalysisModal #beamModalStatus {
                font-size: 0.75rem;
            }

            #beamAnalysisModal .chart-close-btn {
                top: 8px;
                right: 8px;
                width: 36px;
                height: 36px;
                font-size: 1.1rem;
            }
        }

        /* Intel Legend Modal specific styles - match Games Legend */
        #intelLegendModal .chart-modal-content,
        #statecraftExplainerModal .chart-modal-content {
            height: auto;
            max-height: 85vh;
            padding: 1rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border-color: #9333ea;
        }

        #intelLegendModal .modal-title,
        #statecraftExplainerModal .modal-title {
            flex-shrink: 0;
            padding-bottom: 0.5rem;
        }

        #intelLegendModal .modal-analysis,
        #statecraftExplainerModal .modal-analysis {
            flex: 1;
            overflow-y: auto;
            max-height: none;
            scrollbar-width: thin;
            scrollbar-color: #a855f7 var(--bg-column);
            padding: 0 0.5rem;
        }

        #intelLegendModal .modal-analysis::-webkit-scrollbar,
        #statecraftExplainerModal .modal-analysis::-webkit-scrollbar {
            width: 6px;
        }

        #intelLegendModal .modal-analysis::-webkit-scrollbar-track,
        #statecraftExplainerModal .modal-analysis::-webkit-scrollbar-track {
            background: var(--bg-column);
            border-radius: 3px;
        }

        #intelLegendModal .modal-analysis::-webkit-scrollbar-thumb,
        #statecraftExplainerModal .modal-analysis::-webkit-scrollbar-thumb {
            background: #a855f7;
            border-radius: 3px;
        }

        @media (max-width: 768px) {
            #intelLegendModal .chart-modal-content,
            #statecraftExplainerModal .chart-modal-content {
                width: 94%;
                max-height: 80vh;
                padding: 0.75rem;
                margin: 1rem;
            }

            #intelLegendModal .modal-analysis,
            #statecraftExplainerModal .modal-analysis {
                padding: 0.5rem;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            #intelLegendModal .chart-modal-content,
            #statecraftExplainerModal .chart-modal-content {
                width: 96%;
                max-height: 85vh;
                padding: 0.5rem;
            }

            #intelLegendModal .modal-analysis,
            #statecraftExplainerModal .modal-analysis {
                font-size: 0.8rem;
                padding: 0.25rem;
            }

            #intelLegendModal .modal-title,
            #statecraftExplainerModal .modal-title {
                font-size: 1rem;
            }
        }

        /* Individual Intel Widget Modal styles */
        #revRiskModal .chart-modal-content,
        #liarModal .chart-modal-content,
        #paperRockModal .chart-modal-content,
        #mercantilismModal .chart-modal-content,
        #vassalModal .chart-modal-content {
            height: auto;
            max-height: 85vh;
            width: 90%;
            max-width: 650px;
            padding: 1.5rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #revRiskModal .modal-title,
        #liarModal .modal-title,
        #paperRockModal .modal-title,
        #mercantilismModal .modal-title,
        #vassalModal .modal-title {
            flex-shrink: 0;
            padding-bottom: 0.5rem;
            font-size: 1.2rem;
            font-weight: 700;
            text-align: center;
        }

        #revRiskModal .modal-analysis,
        #liarModal .modal-analysis,
        #paperRockModal .modal-analysis,
        #mercantilismModal .modal-analysis,
        #vassalModal .modal-analysis {
            flex: 1;
            overflow-y: auto;
            max-height: none;
            scrollbar-width: thin;
            padding: 0 0.5rem;
            font-size: 0.9rem;
            line-height: 1.6;
            color: #e2e8f0;
        }

        #revRiskModal .modal-analysis::-webkit-scrollbar,
        #liarModal .modal-analysis::-webkit-scrollbar,
        #paperRockModal .modal-analysis::-webkit-scrollbar,
        #mercantilismModal .modal-analysis::-webkit-scrollbar,
        #vassalModal .modal-analysis::-webkit-scrollbar {
            width: 6px;
        }

        #revRiskModal .modal-analysis::-webkit-scrollbar-track,
        #liarModal .modal-analysis::-webkit-scrollbar-track,
        #paperRockModal .modal-analysis::-webkit-scrollbar-track,
        #mercantilismModal .modal-analysis::-webkit-scrollbar-track,
        #vassalModal .modal-analysis::-webkit-scrollbar-track {
            background: var(--bg-column);
            border-radius: 3px;
        }

        #revRiskModal .modal-analysis::-webkit-scrollbar-thumb { background: #ef4444; border-radius: 3px; }
        #liarModal .modal-analysis::-webkit-scrollbar-thumb { background: #f59e0b; border-radius: 3px; }
        #paperRockModal .modal-analysis::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 3px; }
        #mercantilismModal .modal-analysis::-webkit-scrollbar-thumb { background: #22c55e; border-radius: 3px; }
        #vassalModal .modal-analysis::-webkit-scrollbar-thumb { background: #a855f7; border-radius: 3px; }

        @media (max-width: 768px) {
            #revRiskModal .chart-modal-content,
            #liarModal .chart-modal-content,
            #paperRockModal .chart-modal-content,
            #mercantilismModal .chart-modal-content,
            #vassalModal .chart-modal-content {
                width: 94%;
                max-height: 80vh;
                padding: 1rem;
            }
            
            #revRiskModal .modal-analysis,
            #liarModal .modal-analysis,
            #paperRockModal .modal-analysis,
            #mercantilismModal .modal-analysis,
            #vassalModal .modal-analysis {
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            #revRiskModal .chart-modal-content,
            #liarModal .chart-modal-content,
            #paperRockModal .chart-modal-content,
            #mercantilismModal .chart-modal-content,
            #vassalModal .chart-modal-content {
                width: 96%;
                max-height: 85vh;
                padding: 0.75rem;
            }
            
            #revRiskModal .modal-title,
            #liarModal .modal-title,
            #paperRockModal .modal-title,
            #mercantilismModal .modal-title,
            #vassalModal .modal-title {
                font-size: 1rem;
            }
            
            #revRiskModal .modal-analysis,
            #liarModal .modal-analysis,
            #paperRockModal .modal-analysis,
            #mercantilismModal .modal-analysis,
            #vassalModal .modal-analysis {
                font-size: 0.8rem;
            }
        }

        /* Rates Dashboard Legend Modal specific styles */
        #ratesLegendModal .chart-modal-content {
            height: auto;
            max-height: 85vh;
            padding: 1rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border-color: #3b82f6;
        }

        #ratesLegendModal .modal-title {
            flex-shrink: 0;
            padding-bottom: 0.5rem;
        }

        #ratesLegendModal .modal-analysis {
            flex: 1;
            overflow-y: auto;
            max-height: none;
            scrollbar-width: thin;
            scrollbar-color: #3b82f6 var(--bg-column);
            padding: 0 0.5rem;
        }

        #ratesLegendModal .modal-analysis::-webkit-scrollbar {
            width: 6px;
        }

        #ratesLegendModal .modal-analysis::-webkit-scrollbar-track {
            background: var(--bg-column);
            border-radius: 3px;
        }

        #ratesLegendModal .modal-analysis::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 3px;
        }

        @media (max-width: 768px) {
            #ratesLegendModal .chart-modal-content {
                width: 94%;
                max-height: 80vh;
                padding: 0.75rem;
                margin: 1rem;
            }

            #ratesLegendModal .modal-analysis {
                padding: 0.5rem;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            #ratesLegendModal .chart-modal-content {
                width: 96%;
                max-height: 85vh;
                padding: 0.5rem;
            }

            #ratesLegendModal .modal-analysis {
                font-size: 0.8rem;
                padding: 0.25rem;
            }

            #ratesLegendModal .modal-title {
                font-size: 1rem;
            }
        }

        #infoModal .modal-title {
            padding-right: 2rem;
        }

        #infoModal .modal-analysis {
            padding: 0 0.5rem;
        }
        
        /* Legend item styling for aligned bullets */
        .legend-item {
            display: grid;
            grid-template-columns: 2.5rem 1fr;
            gap: 0.5rem;
            margin-bottom: 0.35rem;
            align-items: start;
        }
        
        .legend-item .legend-icon {
            text-align: center;
            flex-shrink: 0;
        }
        
        .legend-item .legend-text {
            line-height: 1.4;
        }

        .info-modal-scroll {
            scrollbar-width: thin;
            scrollbar-color: var(--accent-orange) var(--bg-column);
        }

        .info-modal-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .info-modal-scroll::-webkit-scrollbar-track {
            background: var(--bg-column);
            border-radius: 3px;
        }

        .info-modal-scroll::-webkit-scrollbar-thumb {
            background: var(--accent-orange);
            border-radius: 3px;
        }

        .info-modal-scroll::-webkit-scrollbar-thumb:hover {
            background: #e08050;
        }

        @media (max-width: 768px) {
            #infoModal .chart-modal-content {
                width: 92%;
                max-width: 100%;
                max-height: 80vh;
                padding: 0.75rem;
                margin: 1rem;
            }

            #infoModal .modal-analysis {
                max-height: 65vh !important;
                padding: 0;
                font-size: 0.85rem;
            }

            #infoModal .modal-analysis p {
                margin-bottom: 0.5rem;
            }

            #infoModal .modal-analysis h3 {
                font-size: 0.9rem;
                margin-top: 1rem !important;
            }
        }

        @media (max-width: 480px) and (orientation: portrait) {
            #infoModal .chart-modal-content {
                width: 94%;
                max-height: 75vh;
                padding: 0.5rem;
                margin: 0.5rem;
            }

            #infoModal .modal-analysis {
                max-height: 60vh !important;
                font-size: 0.8rem;
            }

            #infoModal .modal-title {
                font-size: 1rem;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .chart-close-btn {
            position: absolute;
            top: -45px;
            right: 0;
            background: transparent;
            border: 2px solid #00D9FF;
            color: #00D9FF;
            font-size: 28px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: 300;
            line-height: 1;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chart-close-btn:hover {
            background: var(--accent-orange);
            color: #000;
            transform: rotate(90deg);
        }

        #tradingview_widget {
            width: 100%;
            height: 100%;
            border-radius: 6px;
            overflow: hidden;
        }

        /* Mobile Tab Navigation */
        .mobile-tabs {
            display: none;
            background: var(--bg-card);
            border-bottom: 2px solid var(--border);
            padding: 0.5rem;
            gap: 0.25rem;
            position: sticky;
            top: 60px;
            z-index: 999;
        }

        .mobile-tab {
            flex: 1;
            padding: 0.5rem 0.25rem;
            background: var(--bg-column);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 0.55rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 4px;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mobile-tab:active {
            transform: scale(0.98);
        }

        .mobile-tab.active {
            background: var(--accent-red);
            color: #ffffff;
            border-color: var(--accent-red);
            font-size: 0.63rem;
        }
        
        /* Column-specific mobile tab colors */
        .mobile-tab[data-column="breaking"].active {
            background: var(--accent-red);
            border-color: var(--accent-red);
        }
        .mobile-tab[data-column="macro"].active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
        }
        .mobile-tab[data-column="geo"].active {
            background: var(--accent-purple);
            border-color: var(--accent-purple);
        }
        .mobile-tab[data-column="commodity"].active {
            background: var(--accent-yellow);
            border-color: var(--accent-yellow);
        }
        .mobile-tab[data-column="fx"].active {
            background: #00D9FF;
            border-color: #00D9FF;
        }
        .mobile-tab[data-column="prediction"].active {
            background: var(--accent-purple);
            border-color: var(--accent-purple);
        }

        /* Responsive - Force 6 columns on larger screens */
        
        /* Large desktop (1600px+): Full 6 columns with normal spacing */
        @media (min-width: 1600px) {
            .main-grid {
                grid-template-columns: repeat(6, 1fr);
            }
        }
        
        /* Medium desktop (1200-1600px): Compact 6 columns */
        @media (min-width: 1200px) and (max-width: 1599px) {
            .main-grid {
                grid-template-columns: repeat(6, 1fr);
                gap: 1px;
            }
            
            .column-title { font-size: 0.65rem; }
            .column-subtitle { font-size: 0.5rem; }
            .card { padding: 0.5rem; margin-bottom: 0.4rem; }
            .card-headline { font-size: 0.7rem; }
            .card-timestamp { font-size: 0.55rem; }
            .card-implications { font-size: 0.55rem; }
            .news-tags { font-size: 0.5rem; }
        }
        
        /* Medium screens (768-1199px) - use accordion row toggle */
        @media (min-width: 768px) and (max-width: 1199px) {
            /* Hide mobile tabs, show accordion row buttons */
            .mobile-tabs {
                display: none !important;
            }
            
            .accordion-toggle-row {
                display: flex !important;
            }
            
            .main-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            /* Hide second row by default in accordion mode */
            .column.accordion-collapsed {
                display: none;
            }
            
            .column.accordion-expanded {
                display: flex;
            }
        }
        
        /* Accordion toggle row (hidden by default, shown on medium screens) */
        .accordion-toggle-row {
            display: none;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 0.5rem;
            gap: 0.5rem;
            justify-content: center;
        }
        
        .accordion-toggle-btn {
            background: var(--bg-column);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 0.65rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
        }
        
        .accordion-toggle-btn.active {
            background: var(--accent-orange);
            color: #fff;
            border-color: var(--accent-orange);
        }
        
        .accordion-toggle-btn:hover {
            border-color: var(--accent-orange);
        }

        @media (max-width: 767px) {
            .mobile-tabs {
                display: flex;
            }
            
            .accordion-toggle-row {
                display: none !important;
            }

            .main-grid {
                grid-template-columns: 1fr;
            }
            
            /* Mobile prediction market fixes */
            .risk-grid-4 {
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
            }
            
            .risk-grid-column {
                padding: 0.3rem;
                gap: 0.15rem;
            }
            
            .risk-item {
                padding: 0.2rem 0.3rem;
            }
            
            .risk-item-label {
                font-size: 0.45rem;
                max-width: 60px;
            }
            
            .risk-item-odds {
                font-size: 0.55rem;
            }
            
            .risk-item-change {
                font-size: 0.4rem;
            }
            
            .risk-column-title {
                font-size: 0.5rem;
                padding-bottom: 0.2rem;
            }

            /* Reset accordion classes for mobile - mobile-active takes precedence */
            .column {
                display: none;
            }
            
            .column.accordion-expanded,
            .column.accordion-collapsed {
                display: none;
            }

            .column.mobile-active {
                display: flex !important;
            }

            .column-header {
                display: none;
            }

            .header {
                padding: 0.5rem 0.75rem;
                flex-wrap: nowrap;
            }

            .header-left {
                display: none;
            }

            .header-center {
                flex: 1;
                gap: 0.5rem;
            }

            .logo-box {
                font-size: 0.9rem;
                padding: 0.25rem 0.5rem;
            }

            .site-title {
                font-size: 0.85rem;
                letter-spacing: 1px;
            }

            .site-subtitle {
                display: none;
            }

            .status-cluster {
                margin-left: 0.5rem;
                padding-left: 0.5rem;
                gap: 0.5rem;
            }

            .defcon-indicator {
                font-size: 0.6rem;
            }

            .connection-status {
                display: none;
            }

            .info-button {
                padding: 0.35rem 0.6rem;
                font-size: 0.65rem;
            }

            .time-display {
                display: none;
            }
        }
        
        /* Mobile landscape mode - keep tabs visible */
        @media (max-width: 900px) and (orientation: landscape) {
            /* Boost base font size for landscape */
            html {
                font-size: clamp(14px, 2.5vw, 20px) !important;
            }
            
            .mobile-tabs {
                display: flex !important;
                padding: 0.3rem;
                gap: 0.2rem;
            }
            
            /* Hide row toggle buttons in landscape - only show 6 tabs */
            .accordion-toggle-row {
                display: none !important;
            }
            
            .mobile-tab {
                padding: 0.4rem 0.3rem;
                font-size: 12px !important;
            }
            
            /* AGGRESSIVE font sizes for landscape reading - use px not rem */
            .card-headline {
                font-size: 15px !important;
                line-height: 1.4 !important;
            }
            
            .card-source {
                font-size: 12px !important;
            }
            
            .card-timestamp {
                font-size: 11px !important;
            }
            
            .card-implications {
                font-size: 13px !important;
                line-height: 1.4 !important;
            }
            
            .news-tags {
                font-size: 10px !important;
            }
            
            /* Dashboard/sentiment cards - LARGE for readability */
            .dashboard-card {
                padding: 10px !important;
            }
            
            .dashboard-title {
                font-size: 14px !important;
                font-weight: 700 !important;
            }
            
            .sentiment-label {
                font-size: 12px !important;
            }
            
            .sentiment-value {
                font-size: 18px !important;
                font-weight: 700 !important;
            }
            
            .sentiment-sub {
                font-size: 11px !important;
            }
            
            .polymarket-category {
                font-size: 10px !important;
            }
            
            .polymarket-prob {
                font-size: 18px !important;
                font-weight: 700 !important;
            }
            
            .polymarket-question {
                font-size: 13px !important;
                line-height: 1.3 !important;
            }
            
            /* Key levels dashboard */
            .key-level-item {
                font-size: 13px !important;
            }
            
            .key-level-value {
                font-size: 16px !important;
                font-weight: 600 !important;
            }
            
            /* Sentiment dashboard grid */
            .sentiment-item {
                padding: 8px !important;
            }
            
            /* Collapsible header in landscape */
            .header {
                padding: 0.25rem 0.5rem;
                transition: transform 0.3s ease, opacity 0.3s ease;
            }
            
            .header.header-hidden {
                transform: translateY(-100%);
                opacity: 0;
                pointer-events: none;
            }
            
            .header .title {
                font-size: 14px !important;
            }
            
            /* Compact super ticker in landscape */
            .super-ticker-wrapper {
                padding: 0.15rem 0;
                transition: transform 0.3s ease, opacity 0.3s ease;
            }
            
            .super-ticker-wrapper.ticker-hidden {
                transform: translateY(-100%);
                height: 0;
                padding: 0;
                opacity: 0;
                overflow: hidden;
            }
            
            .super-ticker-item {
                font-size: 10px !important;
                padding: 0 0.4rem;
            }
            
            .main-grid {
                grid-template-columns: 1fr;
            }

            .column {
                display: none;
                max-height: calc(100vh - 80px);
                overflow-y: auto;
            }

            .column.mobile-active {
                display: flex;
            }

            .column-header {
                display: none;
            }
            
            .header {
                padding: 0.4rem 0.75rem;
            }
            
            .header-left {
                display: none;
            }
            
            .logo-box {
                font-size: 0.85rem;
                padding: 0.2rem 0.4rem;
            }
            
            .site-title {
                font-size: 0.8rem !important;
            }
            
            .site-subtitle {
                display: none;
            }
            
            .status-cluster {
                display: none;
            }
            
            .time-display {
                display: none;
            }
            
            /* Global clock centered on mobile */
            .global-clock-container {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                min-width: auto;
            }
            
            .global-clock-city {
                font-size: 0.55rem;
                letter-spacing: 1.5px;
            }
            
            .global-clock-time {
                font-size: 0.75rem;
            }
            
            .info-button {
                padding: 0.35rem 0.6rem;
                font-size: 11px !important;
            }
        }

        @media (max-width: 900px) and (min-width: 769px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Clickable Headlines */
        .card-headline {
            text-decoration: none;
            display: block;
        }
        
        a.card-headline {
            cursor: pointer;
            transition: color 0.2s ease;
        }
        
        a.card-headline:hover {
            color: var(--accent-orange);
        }

        /* Deep Analysis Button - Full width, centered like Game Theory Legend */
        .deep-analysis-btn {
            cursor: pointer;
            background: linear-gradient(135deg, rgba(32, 178, 170, 0.15), rgba(32, 178, 170, 0.05));
            border: 1px solid rgba(32, 178, 170, 0.4);
            border-radius: 4px;
            padding: 6px 10px;
            margin-top: 8px;
            transition: all 0.2s ease;
            animation: borderPulse 3s ease-in-out infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
            box-sizing: border-box;
        }
        
        @keyframes borderPulse {
            0%, 100% {
                border-color: rgba(32, 178, 170, 0.4);
                box-shadow: 0 0 3px rgba(32, 178, 170, 0.15);
            }
            50% {
                border-color: rgba(0, 217, 255, 0.5);
                box-shadow: 0 0 6px rgba(0, 217, 255, 0.25);
            }
        }
        
        .deep-analysis-btn:hover {
            background: linear-gradient(135deg, rgba(32, 178, 170, 0.3), rgba(32, 178, 170, 0.15));
            box-shadow: 0 0 8px rgba(32, 178, 170, 0.3);
            transform: translateY(-1px);
        }
        
        .analysis-text {
            color: #20b2aa;
            font-weight: 700;
            font-size: 0.65rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        /* Game Theory Legend Button - Purple/Violet */
        .game-legend-btn {
            cursor: pointer;
            background: linear-gradient(135deg, rgba(147, 51, 234, 0.15), rgba(139, 92, 246, 0.05));
            border: 1px solid;
            border-image: linear-gradient(90deg, #9333ea, #a855f7, #9333ea) 1;
            border-radius: 4px;
            padding: 6px 10px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
            animation: purplePulse 3s ease-in-out infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        @keyframes purplePulse {
            0%, 100% {
                border-image: linear-gradient(90deg, #9333ea, #a855f7, #9333ea) 1;
                box-shadow: 0 0 3px rgba(147, 51, 234, 0.15);
            }
            50% {
                border-image: linear-gradient(90deg, #a855f7, #9333ea, #a855f7) 1;
                box-shadow: 0 0 6px rgba(168, 85, 247, 0.25);
            }
        }
        
        .game-legend-btn:hover {
            background: linear-gradient(135deg, rgba(147, 51, 234, 0.3), rgba(139, 92, 246, 0.15));
            box-shadow: 0 0 8px rgba(147, 51, 234, 0.3);
            transform: translateY(-1px);
        }
        
        .game-legend-text {
            color: #a855f7;
            font-weight: 700;
            font-size: 0.65rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        /* Dashboard Section Subtitles */
        .dashboard-subtitle {
            font-size: 0.6rem;
            color: #6a7585;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: -2px;
            margin-bottom: 8px;
        }

        /* AI Analysis Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 20, 0.95);
            z-index: 2000;
            overflow-y: auto;
            backdrop-filter: blur(8px);
        }

        .modal-overlay.active {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 2rem;
        }

        @media (max-width: 768px) {
            .modal-overlay.active {
                padding: 1rem;
            }
            
            .modal-content {
                max-height: 95vh;
            }
            
            .modal-header {
                padding: 1rem;
            }
            
            .modal-body {
                padding: 1rem;
            }
        }

        .modal-content {
            background: var(--bg-card);
            border: 2px solid var(--accent-orange);
            border-radius: 8px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(212, 113, 74, 0.2);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            position: sticky;
            top: 0;
            background: var(--bg-card);
            z-index: 10;
        }

        .modal-title {
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 0.8rem;
            color: var(--accent-orange);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }

        .modal-headline {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.4;
        }

        .modal-close {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            width: 36px;
            height: 36px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            margin-left: 1rem;
        }

        .modal-close:hover {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            gap: 1rem;
        }

        .modal-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .modal-loading-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .thinking-status {
            margin-top: 1.5rem;
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 0.7rem;
            color: #00ff00;
            line-height: 1.6;
            opacity: 0.8;
        }

        .thinking-status::before {
            content: '> ';
            color: #00ff00;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 49% { opacity: 1; }
            50%, 100% { opacity: 0; }
        }

        .modal-analysis {
            font-size: 0.85rem;
            line-height: 1.8;
            color: var(--text-secondary);
        }

        .modal-analysis h1, .modal-analysis h2, .modal-analysis h3 {
            color: var(--accent-orange);
            font-family: 'IBM Plex Sans', sans-serif;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal-analysis h1:first-child, .modal-analysis h2:first-child {
            margin-top: 0;
        }

        .modal-analysis ul, .modal-analysis ol {
            margin-left: 0;
            margin-bottom: 0.75rem;
            padding-left: 1.5rem;
            list-style-position: outside;
        }

        .modal-analysis li {
            margin-bottom: 0.35rem;
            padding-left: 0.3rem;
            line-height: 1.5;
        }
        
        .modal-analysis ul li {
            list-style-type: disc;
        }
        
        .modal-analysis ol li {
            list-style-type: decimal;
        }

        .modal-analysis strong {
            color: var(--text-primary);
        }
        
        /* Section headers - IMPACT, TRADE, etc. */
        .analysis-section-header {
            display: block;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-orange);
            margin-top: 1.5rem;
            margin-bottom: 0.6rem;
            margin-left: 0;
            padding-left: 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: 'IBM Plex Sans', sans-serif;
        }
        
        .analysis-section-header:first-of-type {
            margin-top: 0;
        }
        
        /* Asset and price highlights */
        .asset-highlight {
            color: #ffffff;
            font-weight: 600;
        }

        .modal-analysis p {
            margin-bottom: 1rem;
        }

        .modal-error {
            color: var(--accent-red);
            text-align: center;
            padding: 2rem;
        }

        .modal-source {
            font-size: 0.75rem;
            color: var(--text-dim);
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            background: rgba(42, 48, 64, 0.3);
        }

        .modal-source-label {
            color: var(--accent-blue);
            margin-right: 0.5rem;
        }
    </style>
    
    <!-- amCharts 5 Libraries for 3D Globe -->
    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/map.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <div class="global-clock-container">
                <div class="global-clock-city clock-visible" id="clockCity">ZULU</div>
                <div class="global-clock-time clock-visible" id="clockTime">--:--:--</div>
            </div>
        </div>
        <div class="header-center">
            <div class="logo-box" style="padding: 0; overflow: hidden;">
                <svg viewBox="0 0 40 40" width="40" height="40" style="display: block;">
                    <!-- Nuthatch color palette - vertical bars, flush, proportional widths -->
                    <!-- Blue-gray: 45% = 18px -->
                    <rect x="0" y="0" width="18" height="40" fill="#6B8BA4"/>
                    <!-- Rusty-orange: 40% = 16px -->
                    <rect x="18" y="0" width="16" height="40" fill="#D4714A"/>
                    <!-- Black: 5% = 2px -->
                    <rect x="34" y="0" width="2" height="40" fill="#1a2332"/>
                    <!-- White: 10% = 4px -->
                    <rect x="36" y="0" width="4" height="40" fill="#ffffff"/>
                </svg>
            </div>
            <div class="brand-text">
                <div class="site-title">THE DAILY NUTHATCH</div>
                <div class="site-subtitle">SIGNAL | FORESIGHT | EDGE | SIGMA</div>
            </div>
            <div class="status-cluster">
                <div class="defcon-indicator">
                    SENTINEL <span id="defcon-level">4</span>
                </div>
            </div>
        </div>
        <div class="header-right">
            <button class="info-button" onclick="openInfoModal()">INFO</button>
            <div class="connection-orb connected" id="connectionOrb" title="Connected"></div>
        </div>
    </div>

    <!-- Dual Ticker System -->
    <div class="ticker-container">
        <!-- News Ticker (Top) -->
        <div class="news-ticker">
            <div class="news-ticker-content" id="newsTickerContent">
            </div>
        </div>
        
        <!-- Market Ticker (Bottom) -->
        <div class="market-ticker" id="marketTicker">
            <div class="market-ticker-content" id="marketTickerContent">
            </div>
            <div class="ticker-search-popup" id="tickerSearchPopup">
                <label>Looking for another symbol?</label>
                <input type="text" id="symbolSearchInput" placeholder="Enter symbol (e.g., AAPL, TSLA, BTC)" />
                <button onclick="searchSymbol()">Open TradingView Chart</button>
            </div>
        </div>
    </div>

    <!-- Mobile Tab Navigation (hidden on desktop) -->
    <div class="mobile-tabs" id="mobileTabs">
        <button class="mobile-tab active" data-column="breaking">WIRE</button>
        <button class="mobile-tab" data-column="geo">GEO</button>
        <button class="mobile-tab" data-column="macro">RISK</button>
        <button class="mobile-tab" data-column="commodity">COMMOD</button>
        <button class="mobile-tab" data-column="fx">FX</button>
        <button class="mobile-tab" data-column="prediction">PRED</button>
    </div>

    <!-- Accordion Toggle Row (for medium screens 768-1199px) -->
    <div class="accordion-toggle-row" id="accordionToggle">
        <button class="accordion-toggle-btn active" data-row="1">ROW 1: WIRE / GEO / RISK</button>
        <button class="accordion-toggle-btn" data-row="2">ROW 2: COMMOD / FX / PRED</button>
    </div>

    <!-- Main Grid - 6 Columns -->
    <div class="main-grid">
        <div class="column col-breaking accordion-expanded" data-accordion-row="1">
            <div class="column-header">
                <div class="column-title">THE WIRE</div>
                <div class="column-subtitle">Signal  News  Filter</div>
            </div>
            <div class="column-content" id="breakingColumn"></div>
        </div>

        <div class="column col-geo accordion-expanded" data-accordion-row="1">
            <div class="column-header">
                <div class="column-title">GEOPOLITICS</div>
                <div class="column-subtitle">Intel  Game Theory</div>
            </div>
            <div class="column-content" id="geoColumn">
                <!-- Command Briefing Button - Inside Column Content -->
                <div style="margin-bottom: 8px;">
                    <div class="statecraft-legend-btn" style="border-radius: 8px; border-color: #a855f7; background: rgba(168, 85, 247, 0.15); animation: none;" onclick="openCommandBriefing()">
                        <span class="legend-text" style="color: #a855f7;">COMMAND BRIEFING</span>
                    </div>
                </div>
                <!-- STATECRAFT Widget -->
                <div class="game-theory-dashboard-container" id="statecraftDashboard">
                    <div class="dashboard-title" style="color: #a855f7; margin-bottom: 10px;">STATECRAFT</div>
                    <div id="statecraft-matrix">
                        <div style="color:#6a7585;font-size:0.65rem;text-align:center;padding:8px;">Loading strategy matrix...</div>
                    </div>
                </div>
                
                <!-- CATALYST SCANNER Widget -->
                <div class="game-theory-dashboard-container" id="catalystScannerDashboard">
                    <div class="dashboard-title" style="color: #bf5af2;">CATALYST SCANNER</div>
                    <div class="watch-next-global" id="horizonScannerList">
                        <div style="color: #6a7585; font-size: 0.65rem; text-align: center;">Loading catalysts...</div>
                    </div>
                </div>
                
                <!-- STRUCTURAL BEAMS Widget -->
                <div class="game-theory-dashboard-container" id="structuralBeamsDashboard">
                    <div class="defcon-panel-wrapper">
                        <div class="sentinel-orbit" id="sentinelOrbit">
                            <!-- SVG train animation injected by JS -->
                        </div>
                        <div class="defcon-panel" id="defconPanel">
                            <div class="defcon-header" onclick="toggleDefconPanel()">
                            <div class="defcon-header-top">
                                <span class="defcon-toggle" id="defconToggle" style="color:#a855f7;font-size:0.6rem;margin-right:8px;">&#9658;</span>
                                <span class="defcon-title">STRUCTURAL BEAMS</span>
                            </div>
                            <div class="defcon-summary" id="defconSummary">
                                <div class="defcon-count-group safe">
                                    <span class="defcon-count-number">14</span>
                                    <span class="defcon-count-label">SAFE</span>
                                </div>
                                <div class="defcon-count-group arming">
                                    <span class="defcon-count-number">0</span>
                                    <span class="defcon-count-label">ARMING</span>
                                </div>
                                <div class="defcon-count-group breached">
                                    <span class="defcon-count-number">0</span>
                                    <span class="defcon-count-label">BREACHED</span>
                                </div>
                            </div>
                            <div class="compound-indicator" id="compoundIndicator" title="Compound stress level">
                                <span class="compound-status isolated">ISOLATED</span>
                            </div>
                        </div>
                        <div class="defcon-body" id="defconBody" style="display:none;">
                            <div class="defcon-grid" id="defconGrid">
                                <!-- Tripwires will be populated by JS -->
                                <div class="defcon-loading">Loading tripwires...</div>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>
                
                <!-- ACTIVE KINETIC THEATERS Widget -->
                <div class="game-theory-dashboard-container" id="kineticTheatersDashboard">
                    <div class="kinetic-header" onclick="toggleKineticPanel()">
                        <div class="kinetic-header-top">
                            <span class="kinetic-toggle" id="kineticToggle">&#9658;</span>
                            <span class="kinetic-title">ACTIVE KINETIC THEATERS</span>
                        </div>
                        <div class="kinetic-summary">
                            <div class="kinetic-count-group active">
                                <span class="kinetic-count-number" id="kineticActiveCount">0</span>
                                <span class="kinetic-count-label">ACTIVE</span>
                            </div>
                            <div class="kinetic-count-group emerging" onclick="event.stopPropagation(); expandAndScrollToEmerging();">
                                <span class="kinetic-count-number" id="kineticEmergingCount">0</span>
                                <span class="kinetic-count-label">EMERGING</span>
                            </div>
                        </div>
                    </div>
                    <div class="kinetic-body" id="kineticBody">
                        <!-- Game Theory Cards -->
                        <div id="gameTheoryList" class="game-theory-container">
                            <div class="game-theory-loading">Loading strategic games...</div>
                        </div>
                        <!-- Emerging Signals Section -->
                        <div class="emerging-section hidden" id="emergingSection">
                            <div class="emerging-header" onclick="toggleEmergingSection()">
                                <span class="emerging-title">EMERGING SIGNALS</span>
                                <span class="emerging-count" id="emergingCount">0 pending</span>
                            </div>
                            <div class="emerging-proposals" id="emergingProposals">
                                <!-- Proposals populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
                <!-- News Separator -->
                <div id="geoNewsSeparator" style="margin-top:16px;padding-top:10px;border-top:1px dashed #2a3548;margin-bottom:8px;">
                    <div style="font-size:0.58rem;color:#556;letter-spacing:1px;text-transform:uppercase;text-align:center;">News Feed</div>
                </div>
                <!-- Geo cards appear below -->
            </div>
        </div>

        <div class="column col-macro accordion-expanded" data-accordion-row="1">
            <div class="column-header">
                <div class="column-title">SYSTEMIC RISK</div>
                <div class="column-subtitle">Collateral  Plumbing</div>
            </div>
            <div class="column-content" id="macroColumn">
                <!-- Risk Briefing Button -->
                <div style="margin-bottom: 8px;">
                    <div class="statecraft-legend-btn" style="border-radius: 8px; border-color: #3399ff; background: rgba(51, 153, 255, 0.15); animation: none;" onclick="openRiskBriefing()">
                        <span class="legend-text" style="color: #3399ff;">RISK BRIEFING</span>
                    </div>
                </div>
                <!-- Unified Systemic Conditions Dashboard -->
                <div id="systemicDashboard" class="macro-grid-container">
                    <div class="macro-dashboard-title">SYSTEMIC CONDITIONS</div>
                    <div style="color:#6a7585;font-size:0.7rem;text-align:center;">Loading systemic data...</div>
                </div>
                <!-- BASE LAYER - Static placeholder updated by updateMacroData() -->
                <div id="baseLayerGrid" class="macro-grid-container" style="margin-top: 15px; border: 2px solid #3399FF;">
                    <div class="macro-dashboard-title" style="color: #3399FF;">BASE LAYER</div>
                    <div class="macro-dashboard-subtitle">Yields  Liquidity</div>
                    <div style="color:#6a7585;font-size:0.7rem;text-align:center;">Loading yield data...</div>
                </div>
                <!-- SYSTEMIC WATCHLIST - 36 symbols in 2x2 grid -->
                <div class="systemic-watchlist-container" id="systemicWatchlist">
                    <div class="systemic-watchlist-title">SYSTEMIC WATCHLIST</div>
                    <div class="systemic-grid-2x2">
                        <!-- Top-Left: US Core + War Sectors A (10) -->
                        <div class="systemic-grid-quadrant">
                            <div class="systemic-quadrant-title">US CORE + SECTORS</div>
                            <div id="systemicQuadrant1"></div>
                        </div>
                        <!-- Top-Right: War Sectors B (10) -->
                        <div class="systemic-grid-quadrant">
                            <div class="systemic-quadrant-title">WAR SECTORS</div>
                            <div id="systemicQuadrant2"></div>
                        </div>
                        <!-- Bottom-Left: Global Debt (8) -->
                        <div class="systemic-grid-quadrant">
                            <div class="systemic-quadrant-title">GLOBAL DEBT</div>
                            <div id="systemicQuadrant3"></div>
                        </div>
                        <!-- Bottom-Right: Global Indices (8) -->
                        <div class="systemic-grid-quadrant">
                            <div class="systemic-quadrant-title">GLOBAL INDICES</div>
                            <div id="systemicQuadrant4"></div>
                        </div>
                    </div>
                    <div style="display:flex;align-items:center;gap:6px;margin-top:8px;padding:4px 8px;font-size:9px;color:#6a7585;border-top:1px solid rgba(51,153,255,0.2);">
                        <span>* Click for TradingView chart</span>
                    </div>
                </div>
                <!-- News Separator -->
                <div id="macroNewsSeparator" style="margin-top:16px;padding-top:10px;border-top:1px dashed #2a3548;margin-bottom:8px;">
                    <div style="font-size:0.58rem;color:#556;letter-spacing:1px;text-transform:uppercase;text-align:center;">News Feed</div>
                </div>
            </div>
        </div>

        <div class="column col-commodity accordion-collapsed" data-accordion-row="2">
            <div class="column-header">
                <div class="column-title">COMMODITIES</div>
                <div class="column-subtitle">Inputs  Resources</div>
            </div>
            <div class="column-content" id="commodityColumn">
                <!-- Supply Briefing Button -->
                <div style="margin-bottom: 8px;">
                    <div class="statecraft-legend-btn" style="border-radius: 8px; border-color: var(--accent-yellow); background: rgba(255, 187, 51, 0.15); animation: none;" onclick="openSupplyBriefing()">
                        <span class="legend-text" style="color: var(--accent-yellow);">SUPPLY BRIEFING</span>
                    </div>
                </div>
                <!-- Commodities Dashboard Pinned at Top - 32 COMMODITIES -->
                <div class="commodity-dashboard-container" id="commodityDashboard">
                    <div class="commodity-grid-3col">
                        <!-- Column 1: METALS (8) -->
                        <div class="commodity-grid-column">
                            <div class="commodity-column-title">METALS</div>
                            <div id="commodityMetals"></div>
                        </div>
                        <!-- Column 2: ENERGY (8) -->
                        <div class="commodity-grid-column">
                            <div class="commodity-column-title">ENERGY</div>
                            <div id="commodityEnergy"></div>
                        </div>
                        <!-- Column 3: AGRICULTURE (16) -->
                        <div class="commodity-grid-column">
                            <div class="commodity-column-title">AGRICULTURE</div>
                            <div id="commodityAgriculture"></div>
                        </div>
                    </div>
                    <div style="display:flex;align-items:center;gap:6px;margin-top:8px;padding:4px 8px;font-size:9px;color:#6a7585;border-top:1px solid rgba(255,255,255,0.05);">
                        <span>* Click for TradingView chart (e.g. Silver)</span>
                    </div>
                </div>
                <!-- News Separator -->
                <div id="commodityNewsSeparator" style="margin-top:16px;padding-top:10px;border-top:1px dashed #2a3548;margin-bottom:8px;">
                    <div style="font-size:0.58rem;color:#556;letter-spacing:1px;text-transform:uppercase;text-align:center;">News Feed</div>
                </div>
                <!-- Commodity news cards appear below -->
            </div>
        </div>

        <div class="column col-fx accordion-collapsed" data-accordion-row="2">
            <div class="column-header">
                <div class="column-title">CURRENCIES</div>
                <div class="column-subtitle">FX  Flows  Value</div>
            </div>
            <div class="column-content" id="fxColumn">
                <!-- Flows Briefing Button -->
                <div style="margin-bottom: 8px;">
                    <div class="statecraft-legend-btn" style="border-radius: 8px; border-color: #00D9FF; background: rgba(0, 217, 255, 0.15); animation: none;" onclick="openFlowsBriefing()">
                        <span class="legend-text" style="color: #00D9FF;">FLOWS BRIEFING</span>
                    </div>
                </div>
                <!-- FX Pairs Dashboard Pinned at Top - 30 PAIRS -->
                <div class="fx-dashboard-container" id="fxDashboard">
                    <div class="fx-grid-3col">
                        <!-- Column 1: RESERVES (10 pairs) -->
                        <div class="fx-grid-column">
                            <div class="fx-column-title">RESERVES</div>
                            <div id="fxMacro"></div>
                        </div>
                        <!-- Column 2: FRICTION (10 pairs) -->
                        <div class="fx-grid-column">
                            <div class="fx-column-title">FRICTION</div>
                            <div id="fxGeo"></div>
                        </div>
                        <!-- Column 3: RESOURCE BLOC (10 pairs) -->
                        <div class="fx-grid-column">
                            <div class="fx-column-title">RESOURCE BLOC</div>
                            <div id="fxCommodity"></div>
                        </div>
                    </div>
                    <div style="display:flex;align-items:center;gap:6px;margin-top:8px;padding:4px 8px;font-size:9px;color:#6a7585;border-top:1px solid rgba(255,255,255,0.05);">
                        <span>* Click pair for TradingView chart (e.g. EUR/USD)</span>
                    </div>
                </div>
                <!-- News Separator -->
                <div id="fxNewsSeparator" style="margin-top:16px;padding-top:10px;border-top:1px dashed #2a3548;margin-bottom:8px;">
                    <div style="font-size:0.58rem;color:#556;letter-spacing:1px;text-transform:uppercase;text-align:center;">News Feed</div>
                </div>
                <!-- FX news cards appear below -->
            </div>
        </div>

        <div class="column col-prediction accordion-collapsed" data-accordion-row="2">
            <div class="column-header">
                <div class="column-title">PREDICTIONS</div>
                <div class="column-subtitle">Probabilities  Tail Risk</div>
            </div>
            <div class="column-content" id="predictionColumn">
                <!-- Signals Briefing Button -->
                <div style="margin-bottom: 8px;">
                    <div class="statecraft-legend-btn" style="border-radius: 8px; border-color: #8fbc8f; background: rgba(143, 188, 143, 0.15); animation: none;" onclick="openSignalsBriefing()">
                        <span class="legend-text" style="color: #8fbc8f;">SIGNALS BRIEFING</span>
                    </div>
                </div>
                <!-- TACTICAL STRUCTURE Widget -->
                <div class="prediction-dashboard" id="tacticalStructureDashboard">
                    <div class="dashboard-section">
                        <div class="dashboard-title" style="text-align: center;">TACTICAL STRUCTURE</div>
                        <div class="dashboard-section-subtitle">ENGINE  CIPHER  SIGMA</div>
                        <!-- ACCORDION STRUCTURE FOR 4 ASSET CATEGORIES -->
                        <div id="quantAccordion" style="margin-top:8px;">
                            <!-- GENERALS Section -->
                            <div class="quant-accordion-section">
                                <button class="quant-accordion-header" onclick="toggleQuantSection('generals')" id="quantHeaderGenerals">
                                    <span class="quant-accordion-arrow" id="quantArrowGenerals">&#9658;</span>
                                    <span>GENERALS</span>
                                    <span class="quant-accordion-count" id="quantCountGenerals">0</span>
                                </button>
                                <div class="quant-accordion-body" id="quantBodyGenerals" style="display:none;"></div>
                            </div>
                            <!-- METALS Section -->
                            <div class="quant-accordion-section">
                                <button class="quant-accordion-header" onclick="toggleQuantSection('metals')" id="quantHeaderMetals">
                                    <span class="quant-accordion-arrow" id="quantArrowMetals">&#9658;</span>
                                    <span>METALS</span>
                                    <span class="quant-accordion-count" id="quantCountMetals">0</span>
                                </button>
                                <div class="quant-accordion-body" id="quantBodyMetals" style="display:none;"></div>
                            </div>
                            <!-- ENERGY Section -->
                            <div class="quant-accordion-section">
                                <button class="quant-accordion-header" onclick="toggleQuantSection('energy')" id="quantHeaderEnergy">
                                    <span class="quant-accordion-arrow" id="quantArrowEnergy">&#9658;</span>
                                    <span>ENERGY</span>
                                    <span class="quant-accordion-count" id="quantCountEnergy">0</span>
                                </button>
                                <div class="quant-accordion-body" id="quantBodyEnergy" style="display:none;"></div>
                            </div>
                            <!-- AG/FX Section -->
                            <div class="quant-accordion-section">
                                <button class="quant-accordion-header" onclick="toggleQuantSection('agfx')" id="quantHeaderAgfx">
                                    <span class="quant-accordion-arrow" id="quantArrowAgfx">&#9658;</span>
                                    <span>AG / FX / CRYPTO</span>
                                    <span class="quant-accordion-count" id="quantCountAgfx">0</span>
                                </button>
                                <div class="quant-accordion-body" id="quantBodyAgfx" style="display:none;"></div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:6px;margin-top:6px;font-size:9px;color:#6a7585;">
                            <span>* Click arrows to expand categories - click any asset for 8-layer analysis</span>
                        </div>
                    </div>
                </div>
                <!-- POLYMARKET ODDS Widget -->
                <div class="prediction-dashboard" id="polymarketDashboard">
                    <div class="dashboard-section">
                        <div class="dashboard-title">POLYMARKET ODDS</div>
                        <div class="dashboard-section-subtitle">MACRO  CRYPTO  POLITICS</div>
                        <div id="polymarketList" class="polymarket-container">
                            <div class="polymarket-empty">Loading prediction markets...</div>
                        </div>
                        <div style="display:flex;align-items:center;gap:6px;margin-top:6px;font-size:9px;color:#6a7585;">
                            <span>* Click for Polymarket (e.g. Fed Cut 65%)</span>
                        </div>
                    </div>
                </div>
                <!-- News Separator - Predictions/Odds Focus -->
                <div id="predictionNewsSeparator" style="margin-top:16px;padding-top:10px;border-top:1px dashed #2a3548;margin-bottom:8px;">
                    <div style="font-size:0.58rem;color:#556;letter-spacing:1px;text-transform:uppercase;text-align:center;">Probability Feed</div>
                </div>
                <!-- Prediction cards appear here -->
            </div>
        </div>
    </div>

    <!-- AI Analysis Modal -->
    <div class="modal-overlay" id="analysisModal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <div class="modal-title">GEMINI AI DEEP ANALYSIS</div>
                    <div class="modal-headline" id="modalHeadline"></div>
                </div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="modal-loading" id="modalLoading">
                    <div class="modal-spinner"></div>
                    <div class="modal-loading-text" id="loadingText">Analyzing with Gemini AI...<br><span style="font-size: 0.85em; opacity: 0.8;">Something great is about to happen - just a moment!</span></div>
                    <div class="thinking-status" id="thinkingStatus"></div>
                </div>
            </div>
            <div class="modal-source" id="modalSource"></div>
        </div>
    </div>

    <script>
        // ========================================================================
        // CARD DATA STORE (for AI analysis)
        // ========================================================================
        const cardDataStore = {};

        // ========================================================================
        // GLOBAL WATCHTOWER ENGINE
        // ========================================================================

        const GLOBAL_CITIES = [
            // EAST -> WEST (Following the Sun)
            { label: 'AUCKLAND', timeZone: 'Pacific/Auckland' },
            { label: 'SYDNEY', timeZone: 'Australia/Sydney' },
            { label: 'TOKYO', timeZone: 'Asia/Tokyo' },
            { label: 'HONG KONG', timeZone: 'Asia/Hong_Kong' },
            { label: 'BANGKOK', timeZone: 'Asia/Bangkok' },
            { label: 'DELHI', timeZone: 'Asia/Kolkata' },
            { label: 'TEHRAN', timeZone: 'Asia/Tehran' },
            { label: 'MOSCOW', timeZone: 'Europe/Moscow' },
            { label: 'CAIRO', timeZone: 'Africa/Cairo' },
            { label: 'CAPE TOWN', timeZone: 'Africa/Johannesburg' },
            { label: 'BERLIN', timeZone: 'Europe/Berlin' },
            { label: 'LONDON', timeZone: 'Europe/London' },
            { label: 'SAO PAULO', timeZone: 'America/Sao_Paulo' },
            { label: 'NEW YORK', timeZone: 'America/New_York' },
            { label: 'CHICAGO', timeZone: 'America/Chicago' },
            { label: 'LOS ANGELES', timeZone: 'America/Los_Angeles' },
            { label: 'HAWAII', timeZone: 'Pacific/Honolulu' }
        ];

        let cityIndex = 0;

        function initGlobalClock() {
            const cityEl = document.getElementById('clockCity');
            const timeEl = document.getElementById('clockTime');
            
            // Update time every second for current city
            setInterval(() => {
                const city = GLOBAL_CITIES[cityIndex];
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', {
                    timeZone: city.timeZone,
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                if (cityEl.classList.contains('clock-visible')) {
                    timeEl.textContent = timeString;
                }
            }, 1000);

            // City cycle loop
            function cycleCity() {
                // Fade out
                cityEl.classList.remove('clock-visible');
                timeEl.classList.remove('clock-visible');

                setTimeout(() => {
                    // Swap city
                    cityIndex = (cityIndex + 1) % GLOBAL_CITIES.length;
                    const city = GLOBAL_CITIES[cityIndex];
                    
                    cityEl.textContent = city.label;
                    
                    const now = new Date();
                    timeEl.textContent = now.toLocaleTimeString('en-US', {
                        timeZone: city.timeZone,
                        hour12: false, 
                        hour: '2-digit', 
                        minute: '2-digit', 
                        second: '2-digit'
                    });

                    // Fade in
                    cityEl.classList.add('clock-visible');
                    timeEl.classList.add('clock-visible');

                    setTimeout(cycleCity, 3500);
                    
                }, 1500);
            }

            // Start first cycle
            const city = GLOBAL_CITIES[cityIndex];
            cityEl.textContent = city.label;
            const now = new Date();
            timeEl.textContent = now.toLocaleTimeString('en-US', {
                timeZone: city.timeZone,
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            setTimeout(cycleCity, 3500);
        }

        document.addEventListener('DOMContentLoaded', initGlobalClock);

        // ========================================================================
        // CENTRAL BANK MEETING DATE AUTO-UPDATER
        // ========================================================================
        
        const CENTRAL_BANK_MEETINGS = {
            Fed: ['2026-01-29', '2026-03-18', '2026-04-29', '2026-06-17', '2026-07-29', '2026-09-16', '2026-10-28', '2026-12-09'],
            ECB: ['2026-01-22', '2026-01-30', '2026-03-12', '2026-04-16', '2026-06-04', '2026-07-23', '2026-09-10', '2026-10-29', '2026-12-17'],
            BOE: ['2026-02-05', '2026-02-06', '2026-03-19', '2026-04-30', '2026-06-18', '2026-07-30', '2026-09-17', '2026-11-05', '2026-12-17'],
            BOJ: ['2026-01-23', '2026-03-19', '2026-04-28', '2026-06-16', '2026-07-31', '2026-09-18', '2026-10-30', '2026-12-18'],
            RBA: ['2026-02-03', '2026-04-01', '2026-05-20', '2026-07-08', '2026-08-19', '2026-10-07', '2026-11-25', '2026-12-09']
        };

        function getNextMeetingDate(bank) {
            const now = new Date();
            const meetings = CENTRAL_BANK_MEETINGS[bank] || [];
            for (const date of meetings) {
                const meetingDate = new Date(date);
                if (meetingDate >= now) {
                    const month = meetingDate.toLocaleString('en-US', { month: 'short' });
                    const day = meetingDate.getDate();
                    return `${month} ${day}`;
                }
            }
            return 'TBD';
        }

        function updateCentralBankDates() {
            const bankMapping = {
                'fed': 'Fed',
                'ecb': 'ECB',
                'boe': 'BOE',
                'boj': 'BOJ',
                'rba': 'RBA'
            };
            
            Object.entries(bankMapping).forEach(([domId, bankKey]) => {
                const element = document.getElementById(`${domId}-next`);
                if (element) {
                    const nextDate = getNextMeetingDate(bankKey);
                    element.textContent = ` ${nextDate}`;
                }
            });
        }

        updateCentralBankDates();
        setInterval(updateCentralBankDates, 3600000);

        // ========================================================================
        // MOBILE TAB NAVIGATION
        // ========================================================================
        
        const columnMap = {
            'breaking': '.col-breaking',
            'macro': '.col-macro',
            'geo': '.col-geo',
            'commodity': '.col-commodity',
            'fx': '.col-fx',
            'prediction': '.col-prediction'
        };

        function initMobileTabs() {
            const tabs = document.querySelectorAll('.mobile-tab');
            const columns = document.querySelectorAll('.column');
            
            // Set initial active column (Breaking)
            document.querySelector('.col-breaking').classList.add('mobile-active');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const columnKey = this.dataset.column;
                    
                    // Update tab states
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update column visibility
                    columns.forEach(c => c.classList.remove('mobile-active'));
                    document.querySelector(columnMap[columnKey]).classList.add('mobile-active');
                    
                    // Scroll to top of content
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            });
        }

        // Initialize accordion toggle for medium screens
        function initAccordionToggle() {
            const toggleBtns = document.querySelectorAll('.accordion-toggle-btn');
            const columns = document.querySelectorAll('.column');
            
            toggleBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetRow = this.dataset.row;
                    
                    // Update button states
                    toggleBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update column visibility for accordion mode
                    columns.forEach(col => {
                        const colRow = col.dataset.accordionRow;
                        if (colRow === targetRow) {
                            col.classList.remove('accordion-collapsed');
                            col.classList.add('accordion-expanded');
                        } else {
                            col.classList.remove('accordion-expanded');
                            col.classList.add('accordion-collapsed');
                        }
                    });
                });
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initMobileTabs();
            initAccordionToggle();
            initLandscapeScrollHide();
            initSentinelTrain();
        });
        
        // Sentinel Train Animation - Letters follow path like train cars
        function initSentinelTrain() {
            const container = document.getElementById('sentinelOrbit');
            if (!container) return;
            
            const text = "SENTINEL INDICATOR";
            const letterDelay = 0.13; // seconds between each letter (reduced by 67%)
            
            // Build HTML with individual letter spans
            let html = '';
            text.split('').forEach((char, i) => {
                const delay = i * letterDelay;
                html += `<span class="sentinel-letter" style="animation-delay: -${delay}s;">${char === ' ' ? '&nbsp;' : char}</span>`;
            });
            
            container.innerHTML = html;
        }
        
        // Landscape scroll-to-hide header
        function initLandscapeScrollHide() {
            let lastScrollY = 0;
            const header = document.querySelector('.header');
            const ticker = document.querySelector('.super-ticker-wrapper');
            
            function isLandscapeMobile() {
                return window.innerWidth <= 900 && window.innerHeight < window.innerWidth;
            }
            
            // Listen for scroll on active column
            document.addEventListener('scroll', handleScroll, true);
            
            function handleScroll(e) {
                if (!isLandscapeMobile()) {
                    // Reset visibility when not in landscape mobile
                    if (header) header.classList.remove('header-hidden');
                    if (ticker) ticker.classList.remove('ticker-hidden');
                    return;
                }
                
                const target = e.target;
                if (!target.classList || !target.classList.contains('column-content')) return;
                
                const currentScrollY = target.scrollTop;
                
                if (currentScrollY > lastScrollY && currentScrollY > 50) {
                    // Scrolling down - hide header
                    if (header) header.classList.add('header-hidden');
                    if (ticker) ticker.classList.add('ticker-hidden');
                } else if (currentScrollY < lastScrollY) {
                    // Scrolling up - show header
                    if (header) header.classList.remove('header-hidden');
                    if (ticker) ticker.classList.remove('ticker-hidden');
                }
                
                lastScrollY = currentScrollY;
            }
        }

        // ========================================================================
        // DUAL TICKER SYSTEM
        // ========================================================================
        
        let newsTickerItems = [];
        let marketTickerData = [];
        const seenTickerHeadlines = new Set();

        // HTML Sanitization - Prevent XSS attacks
        function sanitizeHTML(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // URL Sanitization - Block javascript: protocol
        function sanitizeURL(url) {
            if (!url) return '#';
            const urlStr = String(url).toLowerCase().trim();
            if (urlStr.startsWith('javascript:') || urlStr.startsWith('data:') || urlStr.startsWith('vbscript:')) {
                return '#';
            }
            return url;
        }

        // Convert ALL CAPS text to Title Case
        function toTitleCase(str) {
            if (!str) return str;
            // Check if string is mostly uppercase (>70% caps)
            const upperCount = (str.match(/[A-Z]/g) || []).length;
            const letterCount = (str.match(/[A-Za-z]/g) || []).length;
            if (letterCount > 0 && upperCount / letterCount > 0.7) {
                // Convert to title case - lowercase everything then capitalize first letter of each word
                return str.toLowerCase().replace(/(?:^|\s|[-"'(])\w/g, match => match.toUpperCase());
            }
            return str;
        }

        // TOP BADGE TRIGGER WORDS - Must match at least one
        const TOP_TRIGGERS = [
            // Tier 1 - Immediate Alerts
            /\bBREAKING\b/i, /\bFLASH\b/i, /\bURGENT\b/i, /\bALERT\b/i, /\bJUST IN\b/i, 
            /\bDEVELOPING\b/i, /\bBULLETIN\b/i, /\bNEWSWIRE\b/i,
            // Tier 2 - Major Event Verbs
            /\bEXPLODES?\b/i, /\bERUPTS?\b/i, /\bATTACK(?:ED|S)?\b/i, /\bINVASION\b/i, 
            /\bCOUP\b/i, /\bMOBILIZES?\b/i, /\bASSASSINAT(?:ED|ION)\b/i, /\bKILLED\b/i,
            /\bMASS RESIGNATION\b/i, /\bOVERTHROWN\b/i, /\bSEIZED\b/i,
            // Tier 3 - Market Structure Shocks
            /\bLIMIT DOWN\b/i, /\bLIMIT UP\b/i, /\bHALTED\b/i, /\bCIRCUIT BREAKER\b/i,
            /\bPLUNGE[DS]?\b/i, /\bPLUMMET[S]?\b/i, /\bSURGE[DS]?\b/i, /\bSOAR[S]?\b/i,
            /\bSPIKE[DS]?\b/i, /\bCOLLAPSE[DS]?\b/i, /\bFREEFALL\b/i, /\bCRASH(?:ES|ED)?\b/i, 
            /\bTUMBLE[DS]?\b/i,
            // Tier 4 - Central Bank / Credit Actions
            /\bEMERGENCY MEETING\b/i, /\bEMERGENCY CUT\b/i, /\bINTERVEN(?:TION|ES)\b/i,
            /\bQE\b/i, /\bLIQUIDITY INJECTION\b/i, /\bBAILOUT\b/i, /\bRATE HIKE\b/i, 
            /\bRATE CUT\b/i, /\bSTABILIZATION FUND\b/i,
            // Tier 5 - Corporate Bombshells
            /\bBANKRUPTCY\b/i, /\bDEFAULT[S]?\b/i, /\bCHAPTER 11\b/i, /\bLIQUIDATION\b/i,
            /\bCEO OUSTED\b/i, /\bFIRES CEO\b/i, /\bRESTATEMENT\b/i, /\bSEC PROBE\b/i,
            /\bSEC CHARGES\b/i, /\bDOJ CHARGES\b/i, /\bFRAUD\b/i, /\bTRADING HALTED\b/i, 
            /\bDELISTED\b/i,
            // Tier 6 - Geopolitical Escalation
            /\bMISSILE[S]?\b/i, /\bAIRSTRIKE[S]?\b/i, /\bMARTIAL LAW\b/i, 
            /\bSTATE OF EMERGENCY\b/i, /\bTERROR(?:IST|ISM)?\b/i, /\bHOSTILITIES\b/i,
            /\bBORDER CLOSED\b/i, /\bEVACUATION ORDER\b/i, /\bNUCLEAR\b/i,
            /\bSANCTIONS?\b/i, /\bEMBARGO\b/i, /\bBLOCKADE\b/i
        ];
        
        // EXCLUSION PATTERNS - If any match, no TOP badge
        const TOP_EXCLUSIONS = [
            // Future/Speculative Language
            /\bset to\b/i, /\bexpected to\b/i, /\bforecast\b/i, /\bprojection\b/i, 
            /\boutlook\b/i, /\blooking ahead\b/i,
            // Soft Probability
            /\bmay\b/i, /\bcould\b/i, /\bmight\b/i, /\blikely to\b/i, 
            /\bpossibly\b/i, /\bpotentially\b/i,
            // Attribution Hedges
            /\baccording to\b/i, /\breport says\b/i, /\bsources say\b/i, 
            /\bpeople familiar\b/i, /\banalysts say\b/i,
            // Long-Horizon Markers
            /\bby 202[5-9]\b/i, /\bin 202[5-9]\b/i, /\bover the next decade\b/i,
            // Routine Corporate
            /\bguidance\b/i, /\bcapex\b/i, /\bearnings call\b/i, 
            /\binvestor presentation\b/i, /\bannual report\b/i,
            // Opinion/Analysis
            /\banalysis\b/i, /\bop-ed\b/i, /\bcommentary\b/i, /\breview\b/i, 
            /\bperspective\b/i, /\bopinion\b/i
        ];
        
        function isTopStoryHeadline(headline, impact) {
            // Must have impact 3
            if (impact < 3) return false;
            
            // Must match at least one trigger
            const hasTrigger = TOP_TRIGGERS.some(regex => regex.test(headline));
            if (!hasTrigger) return false;
            
            // Must NOT match any exclusion
            const hasExclusion = TOP_EXCLUSIONS.some(regex => regex.test(headline));
            if (hasExclusion) return false;
            
            return true;
        }

        function addToNewsTicker(headline, impact, assets, link) {
            // Deduplicate - normalize headline for comparison
            const normalizedHeadline = headline.toLowerCase().trim().substring(0, 60);
            if (seenTickerHeadlines.has(normalizedHeadline)) {
                return; // Skip duplicate
            }
            seenTickerHeadlines.add(normalizedHeadline);
            
            // Limit seen headlines cache
            if (seenTickerHeadlines.size > 100) {
                const firstItem = seenTickerHeadlines.values().next().value;
                seenTickerHeadlines.delete(firstItem);
            }
            
            const time = new Date().toISOString().substr(11, 5);
            
            // Detect top stories - strict criteria
            const isTopStory = isTopStoryHeadline(headline, impact);
            
            newsTickerItems.unshift({
                time: time,
                text: headline.substring(0, 100),
                impact: impact,
                assets: assets,
                link: link || '',
                isTopStory: isTopStory
            });
            
            if (newsTickerItems.length > 20) {
                newsTickerItems = newsTickerItems.slice(0, 20);
            }
            
            updateNewsTicker();
        }

        function updateNewsTicker() {
            const ticker = document.getElementById('newsTickerContent');
            const doubled = [...newsTickerItems, ...newsTickerItems];
            
            ticker.innerHTML = doubled.map(item => {
                const topStoryBadge = item.isTopStory ? '<span class="top-story-badge">TOP</span>' : '';
                const topStoryClass = item.isTopStory ? 'top-story' : '';
                const displayText = sanitizeHTML(toTitleCase(item.text));
                const safeLink = sanitizeURL(item.link);
                const tickerContent = `
                    <span class="ticker-time">${sanitizeHTML(item.time)} UTC</span>
                    ${topStoryBadge}
                    <span class="ticker-text ${topStoryClass}">${displayText}</span>
                    <div class="ticker-impact">
                        ${Array(3).fill(0).map((_, i) => 
                            `<div class="impact-dot ${i < item.impact ? 'active' : ''}"></div>`
                        ).join('')}
                    </div>
                `;
                return safeLink && safeLink !== '#'
                    ? `<a href="${safeLink}" target="_blank" rel="noopener noreferrer" class="ticker-item ${topStoryClass}" style="text-decoration: none; color: inherit;">${tickerContent}</a>`
                    : `<div class="ticker-item ${topStoryClass}">${tickerContent}</div>`;
            }).join('');
        }

        let fxDataStore = { macro: [], geo: [], commodity: [] };

        function updateMarketTicker(marketData) {
            marketTickerData = marketData;
            updateSuperTicker();
        }

        function updateSuperTicker() {
            const ticker = document.getElementById('marketTickerContent');
            if (!ticker) return;

            let allItems = [];
            
            // Only show yields and DXY from market data (filter out indices, ETFs, stocks)
            const TICKER_ALLOWED_LABELS = [
                'US 30Y', 'US 10Y', 'US 5Y', 'US 2Y', 'DXY', 'VIX'
            ];
            
            if (marketTickerData && marketTickerData.length > 0) {
                const filteredMarket = marketTickerData.filter(item => 
                    TICKER_ALLOWED_LABELS.includes(item.label)
                );
                allItems = allItems.concat(filteredMarket.map(item => ({
                    label: item.label,
                    value: item.value,
                    change: item.change,
                    dir: item.dir,
                    tvSymbol: item.symbol || item.label,
                    type: 'market'
                })));
            }
            
            if (fxDataStore.macro) {
                allItems = allItems.concat(fxDataStore.macro.map(item => ({
                    label: item.label,
                    value: item.price,
                    change: item.change + '%',
                    dir: item.dir,
                    tvSymbol: item.tvSymbol || item.label,
                    type: 'fx'
                })));
            }
            if (fxDataStore.geo) {
                allItems = allItems.concat(fxDataStore.geo.map(item => ({
                    label: item.label,
                    value: item.price,
                    change: item.change + '%',
                    dir: item.dir,
                    tvSymbol: item.tvSymbol || item.label,
                    type: 'fx'
                })));
            }
            if (fxDataStore.commodity) {
                allItems = allItems.concat(fxDataStore.commodity.map(item => ({
                    label: item.label,
                    value: item.price,
                    change: item.change + '%',
                    dir: item.dir,
                    tvSymbol: item.tvSymbol || item.label,
                    type: 'fx'
                })));
            }
            
            const allCommodities = [
                ...(commodityDataStore.metals || []),
                ...(commodityDataStore.energy || []),
                ...(commodityDataStore.agriculture || [])
            ];
            allItems = allItems.concat(allCommodities.map(item => ({
                label: item.label,
                value: item.price,
                change: item.change + '%',
                dir: item.dir,
                tvSymbol: item.tvSymbol || item.ticker || item.label,
                type: 'commodity'
            })));

            const doubled = [...allItems, ...allItems];
            
            ticker.innerHTML = doubled.map(item => `
                <div class="market-ticker-item" onclick="openChart('${sanitizeHTML(item.tvSymbol)}')" style="cursor: pointer;" title="Click to open ${sanitizeHTML(item.label)} chart">
                    <span class="market-ticker-label">${sanitizeHTML(item.label)}</span>
                    <span class="market-ticker-value">${sanitizeHTML(item.value)}</span>
                    <span class="market-ticker-change ${getMarketTickerClass(item.dir)}">
                        ${sanitizeHTML(item.change)}
                    </span>
                </div>
            `).join('');
        }

        function getMarketTickerClass(dir) {
            return dir === 'up' ? 'market-ticker-up' : 
                   dir === 'down' ? 'market-ticker-down' : 
                   'market-ticker-neutral';
        }

        // ========================================================================
        // TICKER MOUSE/TOUCH SCROLL
        // ========================================================================
        
        function initTickerScroll() {
            const ticker = document.getElementById('marketTicker');
            const tickerContent = document.getElementById('marketTickerContent');
            if (!ticker || !tickerContent) return;
            
            let isDown = false;
            let startX;
            let scrollLeft;
            
            ticker.addEventListener('mousedown', (e) => {
                isDown = true;
                tickerContent.classList.add('dragging');
                startX = e.pageX - ticker.offsetLeft;
                scrollLeft = ticker.scrollLeft;
            });
            
            ticker.addEventListener('mouseleave', () => {
                if (isDown) {
                    isDown = false;
                    tickerContent.classList.remove('dragging');
                }
            });
            
            ticker.addEventListener('mouseup', () => {
                isDown = false;
                tickerContent.classList.remove('dragging');
            });
            
            ticker.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                const x = e.pageX - ticker.offsetLeft;
                const walk = (x - startX) * 3;
                ticker.scrollLeft = scrollLeft - walk;
            });
            
            ticker.addEventListener('touchstart', (e) => {
                isDown = true;
                tickerContent.classList.add('dragging');
                startX = e.touches[0].pageX - ticker.offsetLeft;
                scrollLeft = ticker.scrollLeft;
            }, { passive: true });
            
            ticker.addEventListener('touchend', () => {
                isDown = false;
                tickerContent.classList.remove('dragging');
            });
            
            ticker.addEventListener('touchmove', (e) => {
                if (!isDown) return;
                const x = e.touches[0].pageX - ticker.offsetLeft;
                const walk = (x - startX) * 3;
                ticker.scrollLeft = scrollLeft - walk;
            }, { passive: true });
        }
        
        document.addEventListener('DOMContentLoaded', initTickerScroll);

        // ========================================================================
        // WEBSOCKET CONNECTION
        // ========================================================================
        
        let ws;
        let reconnectInterval;

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocket connected');
                const orb = document.getElementById('connectionOrb');
                if (orb) {
                    orb.classList.add('connected');
                    orb.title = 'Connected';
                }
                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                }
            };

            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    handleMessage(message);
                } catch (error) {
                    console.error('Error parsing message:', error);
                }
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                const orb = document.getElementById('connectionOrb');
                if (orb) {
                    orb.classList.remove('connected');
                    orb.title = 'Disconnected';
                }
                
                if (!reconnectInterval) {
                    reconnectInterval = setInterval(connectWebSocket, 5000);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        connectWebSocket();

        // ========================================================================
        // MESSAGE HANDLERS
        // ========================================================================

        function handleMessage(message) {
            switch (message.type) {
                case 'initial':
                    handleInitialData(message);
                    break;
                case 'new_card':
                    handleNewCard(message);
                    break;
                case 'market_update':
                    updateMarketData(message.data);
                    break;
                case 'macro_update':
                    updateMacroData(message.data);
                    break;
                case 'fx_update':
                    updateFXData(message.data);
                    break;
                case 'commodity_update':
                    updateCommodityData(message.data);
                    break;
                case 'systemic_watchlist_update':
                    updateSystemicWatchlist(message.data);
                    break;
                case 'prediction_update':
                    updatePredictionData(message.data);
                    break;
                case 'game_theory_update':
                    updateGameTheoryData(message.data);
                    break;
                case 'strategic_intelligence':
                    updateStrategicIntelligence(message.data);
                    break;
                case 'emerging_conflict_update':
                    updateEmergingConflicts(message.data);
                    break;
                case 'quant_update':
                    console.log('QUANT UPDATE RECEIVED:', message.data ? message.data.length : 'null');
                    updateQuantLevels(message.data);
                    break;
                case 'systemic_update':
                    updateSystemicRisk(message.data);
                    break;
            }
        }
        
        // ========================================================================
        // SYSTEMIC CONDITIONS UNIFIED DASHBOARD
        // ========================================================================
        
        // Global caches for unified dashboard
        var cachedSystemicData = null;
        var cachedSentimentData = null;
        
        function updateSystemicRisk(data) {
            if (!data) return;
            cachedSystemicData = data;
            renderUnifiedDashboard();
        }
        
        function updateSentimentCache(sentiment) {
            if (!sentiment) return;
            cachedSentimentData = sentiment;
            renderUnifiedDashboard();
        }
        
        function renderUnifiedDashboard() {
            const container = document.getElementById('systemicDashboard');
            if (!container) return;
            
            const d = cachedSystemicData;
            const s = cachedSentimentData;
            
            // Consistent row style for all items
            const rowStyle = "display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(107,139,164,0.1);";
            const labelStyle = "color:#8a9bb3;font-size:0.72rem;font-family:'IBM Plex Sans',sans-serif;";
            const valueStyle = "font-family:'IBM Plex Mono',monospace;font-size:0.72rem;font-weight:600;text-align:right;";
            const subStyle = "color:#556;font-weight:400;font-size:0.62rem;margin-left:4px;";
            
            // Plumbing section
            let plumbingHtml = '';
            if (d) {
                const ycColor = parseFloat(d.yieldCurve) < 0 ? '#ff4466' : '#4ade80';
                const liqColor = d.liquidityStatus === 'DRAINING' ? '#ff4466' : d.liquidityStatus === 'FLUSH' ? '#4ade80' : '#00D9FF';
                const plumbColor = d.plumbingHealth === 'CLOGGED' ? '#ff4466' : d.plumbingHealth === 'STRESSED' ? '#ffbb33' : '#4ade80';
                const creditColor = d.creditHealth === 'STRESS' ? '#ff4466' : d.creditHealth === 'WIDENING' ? '#ffbb33' : '#4ade80';
                
                // Curve dynamics color coding
                const dynamicsColors = {
                    'BULL STEEPENER': '#4ade80',
                    'BEAR STEEPENER': '#ff4466',
                    'BULL FLATTENER': '#00D9FF',
                    'BEAR FLATTENER': '#ffbb33',
                    'STEEPENING': '#4ade80',
                    'FLATTENING': '#ffbb33',
                    'STABLE': '#6a7585',
                    'INITIALIZING': '#6a7585'
                };
                const dynColor = dynamicsColors[d.curveDynamics] || '#6a7585';
                
                plumbingHtml = `
                    <div style="margin-bottom:12px;">
                        <div style="${rowStyle}">
                            <span style="${labelStyle}">Yield Curve</span>
                            <span style="${valueStyle}color:${ycColor};">${d.yieldCurve}<span style="${subStyle}">${d.recessionRisk}</span></span>
                        </div>
                        <div style="${rowStyle}">
                            <span style="${labelStyle}">Curve Dynamics</span>
                            <span style="${valueStyle}color:${dynColor};font-size:0.65rem;">${d.curveDynamics || 'STABLE'}</span>
                        </div>
                        <div style="${rowStyle}">
                            <span style="${labelStyle}">Global Collateral</span>
                            <span style="${valueStyle}color:${liqColor};">${d.liquidityStatus}<span style="${subStyle}">HYG/TLT ${d.creditStress}</span></span>
                        </div>
                        <div style="${rowStyle}">
                            <span style="${labelStyle}">Plumbing Health</span>
                            <span style="${valueStyle}color:${plumbColor};">${d.plumbingHealth}<span style="${subStyle}">VIX ${d.vix}</span></span>
                        </div>
                        <div style="${rowStyle}border-bottom:none;">
                            <span style="${labelStyle}">Credit Spread</span>
                            <span style="${valueStyle}color:${creditColor};">${d.creditSpread}<span style="${subStyle}">${d.creditHealth}</span></span>
                        </div>
                    </div>
                `;
            }
            
            // Sentiment section
            let sentimentHtml = '';
            if (s) {
                sentimentHtml = `
                    <div style="margin-bottom:12px;">
                        <div class="macro-dashboard-title" style="margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid rgba(51,153,255,0.3);">
                            MARKET SENTIMENT
                        </div>
                        <div style="${rowStyle}">
                            <span style="${labelStyle}">VIX Regime</span>
                            <span style="${valueStyle}color:${s.vix.color};">${s.vix.regime}<span style="${subStyle}">${s.vix.value}</span></span>
                        </div>
                        <div style="${rowStyle}">
                            <span style="${labelStyle}">Fear / Greed</span>
                            <span style="${valueStyle}color:${s.fearGreed.color};">${s.fearGreed.value}<span style="${subStyle}">${s.fearGreed.label}</span></span>
                        </div>
                        <div style="${rowStyle}">
                            <span style="${labelStyle}">Dollar DXY</span>
                            <span style="${valueStyle}color:${s.dollar.color};">${s.dollar.signal}<span style="${subStyle}">${s.dollar.value}</span></span>
                        </div>
                        <div style="${rowStyle}border-bottom:none;">
                            <span style="${labelStyle}">Fed Cut Odds</span>
                            <span style="${valueStyle}color:#a78bfa;">${s.rateCut.value}</span>
                        </div>
                    </div>
                `;
            }
            
            // DragonBear section removed - now using Fracture Meter exclusively
            
            // Loading state
            if (!d && !s) {
                container.innerHTML = `
                    <div class="macro-dashboard-title">SYSTEMIC CONDITIONS</div>

                    <div style="color:#6a7585;font-size:0.7rem;text-align:center;">Loading systemic data...</div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="macro-dashboard-title">SYSTEMIC CONDITIONS</div>
                ${plumbingHtml}
                ${sentimentHtml}
                <div id="dragonbear-fracture-container"></div>
            `;
            
            // Re-render cached grandStrategy fracture meter if available
            if (cachedGrandStrategy) {
                renderGrandStrategyFracture(cachedGrandStrategy);
            }
        }
        
        // Render just the fracture meter portion (called from both places)
        function renderGrandStrategyFracture(gs) {
            if (!gs || !gs.fracture) return;
            var fractureContainer = document.getElementById('dragonbear-fracture-container');
            if (fractureContainer) {
                fractureContainer.innerHTML = '<div class="sc-matrix-container" style="border-left: 3px solid ' + gs.fracture.color + '; margin-top: 12px;">' +
                    '<div style="display:flex;justify-content:space-between;font-size:0.7rem;margin-bottom:4px;">' +
                        '<span style="color:#ccc;font-weight:700;">DRAGONBEAR FRACTURE</span>' +
                        '<span style="color:' + gs.fracture.color + ';font-weight:700;">' + gs.fracture.status + '</span>' +
                    '</div>' +
                    '<div class="fracture-track">' +
                        '<div class="fracture-fill" style="width:' + gs.fracture.score + '%;background:' + gs.fracture.color + ';"></div>' +
                    '</div>' +
                    '<div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">' +
                        '<span onclick="openFractureExplainer()" style="font-size:0.55rem;color:#a855f7;cursor:pointer;text-decoration:underline;">HOW THIS WORKS</span>' +
                        '<span style="font-size:0.6rem;color:#666;">USD/CNH: ' + gs.fracture.cnh + '</span>' +
                    '</div>' +
                '</div>';
            }
        }
        
        // DragonBear Fracture Explainer Modal
        function openFractureExplainer() {
            var modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.style.display = 'flex';
            modal.onclick = function(e) { if (e.target === modal) modal.remove(); };
            
            modal.innerHTML = '<div class="modal-content" style="max-width:550px;max-height:85vh;overflow-y:auto;">' +
                '<div class="modal-header">' +
                    '<h3 style="margin:0;color:#22c55e;">DRAGONBEAR FRACTURE METER</h3>' +
                    '<button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">[X]</button>' +
                '</div>' +
                '<div class="modal-body" style="padding:15px;font-size:0.85rem;line-height:1.6;color:#9ca3af;">' +
                    
                    '<div style="background:#1a1f2b;padding:12px;border-radius:6px;border-left:4px solid #22c55e;margin-bottom:15px;">' +
                        '<div style="color:#e2e8f0;font-weight:600;margin-bottom:8px;">What is this?</div>' +
                        '<p style="margin:0;">The <strong style="color:#22c55e;">DragonBear Fracture Meter</strong> measures the real-time bifurcation between the US-led Western financial system and the China-Russia axis. It answers: "How close are we to two separate global monetary systems?"</p>' +
                    '</div>' +
                    
                    '<div style="font-weight:700;color:#e2e8f0;margin:15px 0 10px 0;">THE SIGNAL: USD/CNH</div>' +
                    '<p>The offshore Chinese Yuan (CNH) against the US Dollar is the canary in the coal mine. When China lets CNH weaken significantly, it signals they are prioritizing domestic stability over Western economic integration.</p>' +
                    
                    '<div style="font-weight:700;color:#e2e8f0;margin:15px 0 10px 0;">FRACTURE LEVELS</div>' +
                    '<div style="display:grid;gap:8px;">' +
                        '<div style="background:#0f131a;padding:10px;border-radius:4px;border-left:3px solid #22c55e;">' +
                            '<strong style="color:#22c55e;">INTEGRATED (0-33%)</strong> - Systems are cooperating. Trade flows normally. Dollar hegemony intact. Risk-on environment.' +
                        '</div>' +
                        '<div style="background:#0f131a;padding:10px;border-radius:4px;border-left:3px solid #ffbb33;">' +
                            '<strong style="color:#ffbb33;">DIVERGING (34-66%)</strong> - Cracks appearing. Selective decoupling in tech, commodities. Watch for sanctions escalation. Hedge with gold.' +
                        '</div>' +
                        '<div style="background:#0f131a;padding:10px;border-radius:4px;border-left:3px solid #ff4466;">' +
                            '<strong style="color:#ff4466;">SYSTEM SPLIT (67-100%)</strong> - Full bifurcation. Two trading blocs. Dollar vs BRICS+. Critical for commodity supply chains. Maximum uncertainty.' +
                        '</div>' +
                    '</div>' +
                    
                    '<div style="font-weight:700;color:#e2e8f0;margin:15px 0 10px 0;">MARKET IMPLICATIONS</div>' +
                    '<ul style="margin:0;padding-left:18px;">' +
                        '<li><strong style="color:#ffbb33;">Rising Fracture:</strong> Long gold, short EM, long defense, long energy infrastructure</li>' +
                        '<li><strong style="color:#22c55e;">Falling Fracture:</strong> Risk-on, long EM, long tech, short safe havens</li>' +
                    '</ul>' +
                    
                    '<div style="background:rgba(0,0,0,0.3);padding:10px;border-radius:4px;font-size:0.75rem;color:#6a7585;margin-top:15px;">' +
                        '<strong style="color:#22c55e;">KEY THRESHOLD:</strong> USD/CNH above 7.35 signals accelerating fracture. Below 7.0 signals reintegration.' +
                    '</div>' +
                '</div>' +
            '</div>';
            
            document.body.appendChild(modal);
        }
        
        // ========================================================================
        // QUANT STRATEGIST LEVEL ENGINE UI
        // ========================================================================
        
        // Global quant data storage for expansion
        var quantDataCache = [];
        
        // Category mapping for assets
        var ASSET_CATEGORIES = {
            // GENERALS: Yield curve + indices + dollar (8 assets)
            'US 2Y YIELD': 'generals', 'US 5Y YIELD': 'generals', 
            'US 10Y YIELD': 'generals', 'US 30Y YIELD': 'generals',
            'DXY INDEX': 'generals', 'S&P 500': 'generals', 'NASDAQ': 'generals', 'VIX': 'generals',
            // METALS (8 assets)
            'GOLD': 'metals', 'SILVER': 'metals', 'COPPER': 'metals', 
            'PLATINUM': 'metals', 'PALLADIUM': 'metals',
            'ALUMINUM': 'metals', 'ZINC': 'metals', 'NICKEL': 'metals',
            // ENERGY (9 assets) - matches Column 4
            'WTI': 'energy', 'BRENT': 'energy', 'NAT GAS': 'energy', 'GASOLINE': 'energy',
            'HEATING OIL': 'energy', 'COAL': 'energy', 'ICLN': 'energy', 'URA': 'energy', 'XLE': 'energy',
            // AGRICULTURE (16 assets) - matches Column 4
            'WHEAT': 'ag', 'CORN': 'ag', 'SOYBEANS': 'ag', 'SOY MEAL': 'ag', 'SOY OIL': 'ag',
            'COFFEE': 'ag', 'COCOA': 'ag', 'SUGAR': 'ag', 'COTTON': 'ag',
            'LIVE CATTLE': 'ag', 'LEAN HOGS': 'ag', 'FEEDER CATTLE': 'ag',
            'RICE': 'ag', 'OATS': 'ag', 'ORANGE JUICE': 'ag', 'LUMBER': 'ag',
            // FX/CRYPTO (30 assets) - matches Column 5
            // MACRO (10)
            'BTC/USD': 'fxcrypto', 'ETH/USD': 'fxcrypto',
            'EUR/USD': 'fxcrypto', 'USD/JPY': 'fxcrypto', 'GBP/USD': 'fxcrypto', 'USD/CHF': 'fxcrypto',
            'EUR/JPY': 'fxcrypto', 'EUR/CHF': 'fxcrypto', 'CHF/JPY': 'fxcrypto',
            // GEO (10)
            'USD/CNH': 'fxcrypto', 'USD/ILS': 'fxcrypto', 'USD/MXN': 'fxcrypto', 'USD/PLN': 'fxcrypto',
            'USD/TRY': 'fxcrypto', 'USD/KRW': 'fxcrypto', 'USD/INR': 'fxcrypto', 'USD/SGD': 'fxcrypto',
            'EUR/GBP': 'fxcrypto', 'GBP/JPY': 'fxcrypto',
            // COMMODITY (10)
            'USD/CAD': 'fxcrypto', 'AUD/USD': 'fxcrypto', 'USD/NOK': 'fxcrypto', 'NZD/USD': 'fxcrypto',
            'USD/BRL': 'fxcrypto', 'USD/ZAR': 'fxcrypto', 'CAD/JPY': 'fxcrypto', 'AUD/JPY': 'fxcrypto',
            'AUD/NZD': 'fxcrypto', 'EUR/AUD': 'fxcrypto'
        };
        
        // Toggle accordion section
        function toggleQuantSection(section) {
            var body = document.getElementById('quantBody' + section.charAt(0).toUpperCase() + section.slice(1));
            var arrow = document.getElementById('quantArrow' + section.charAt(0).toUpperCase() + section.slice(1));
            if (body && arrow) {
                var isHidden = body.style.display === 'none';
                body.style.display = isHidden ? 'block' : 'none';
                arrow.classList.toggle('expanded', isHidden);
            }
        }
        
        // Toggle Quant Engine explainer in modal
        function toggleQuantExplainer(btn) {
            var content = btn.nextElementSibling;
            if (content) {
                var isHidden = content.style.display === 'none';
                content.style.display = isHidden ? 'block' : 'none';
                btn.textContent = isHidden ? 'HIDE QUANT ENGINE EXPLAINER' : 'SHOW QUANT ENGINE EXPLAINER';
            }
        }
        
        // Get regime color
        function getRegimeColor(regime) {
            switch(regime) {
                case 'BULLISH': return '#4ade80';
                case 'BEARISH': return '#ff6b6b';
                case 'DISTRIBUTION': return '#fbbf24';
                case 'ACCUMULATION': return '#3b82f6';
                default: return '#6a7585';
            }
        }
        
        // Get Z-Score symbol and color from value
        function getZScoreDisplay(zScore) {
            var z = parseFloat(zScore);
            if (isNaN(z)) return { symbol: '=', color: '#6a7585', label: 'N/A' };
            if (z > 2.0) return { symbol: '+++', color: '#ef4444', label: 'OVERBOUGHT EXTREME' };
            if (z > 1.0) return { symbol: '++', color: '#f59e0b', label: 'OVERBOUGHT' };
            if (z > 0.3) return { symbol: '+', color: '#22c55e', label: 'ABOVE MEAN' };
            if (z >= -0.3) return { symbol: '=', color: '#6a7585', label: 'FAIR VALUE' };
            if (z >= -1.0) return { symbol: '-', color: '#3b82f6', label: 'BELOW MEAN' };
            if (z >= -2.0) return { symbol: '--', color: '#f59e0b', label: 'OVERSOLD' };
            return { symbol: '---', color: '#ef4444', label: 'OVERSOLD EXTREME' };
        }
        
        // Build single asset card HTML
        function buildAssetCardHtml(item, index) {
            var regimeColor = getRegimeColor(item.qRegime);
            var distSign = parseFloat(item.qDistFromOpen) >= 0 ? '+' : '';
            
            var html = '<div class="quant-card" onclick="showQuantDetail(' + index + ')" style="cursor:pointer;">';
            
            // Macro Context Badge (The "Every" Layer)
            if (item.macroContext) {
                var macroColors = {
                    'WRECKING BALL': '#00D9FF',
                    'CHINA DEFLATION': '#ffbb33',
                    'DRAGONBEAR': '#a855f7',
                    'FED TRAP': '#ff4466',
                    'RISK-OFF': '#ff6b6b'
                };
                var macroColor = macroColors[item.macroContext] || '#ffbb33';
                html += '<div style="font-size:0.55rem;color:' + macroColor + ';text-align:center;margin-bottom:4px;font-weight:bold;border:1px solid ' + macroColor + ';border-radius:2px;padding:1px 3px;background:' + macroColor + '15;">' + item.macroContext + '</div>';
            }
            
            html += '<div class="quant-header">';
            html += '<span class="quant-symbol">' + item.symbol + '</span>';
            html += '<span class="quant-price">' + item.current + '</span>';
            html += '</div>';
            
            // Regime badge row
            html += '<div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:wrap;">';
            html += '<span style="background:' + regimeColor + '22;color:' + regimeColor + ';padding:1px 5px;border-radius:2px;font-size:9px;font-weight:600;">' + (item.qRegime || 'N/A') + '</span>';
            html += '<span style="background:#00D9FF22;color:#00D9FF;padding:1px 5px;border-radius:2px;font-size:9px;font-weight:600;">' + (item.structure || 'TREND') + '</span>';
            if (item.momentum && item.momentum !== 'NEUTRAL') {
                var momColor = item.momentum.includes('UP') ? '#4ade80' : '#ff6b6b';
                html += '<span style="background:' + momColor + '22;color:' + momColor + ';padding:1px 5px;border-radius:2px;font-size:9px;font-weight:600;">' + item.momentum + '</span>';
            }
            html += '</div>';
            
            // Key levels row
            html += '<div style="display:flex;justify-content:space-between;font-size:9px;color:#9ca3af;">';
            html += '<span style="color:#ff6b6b;">R1:' + item.resistance + '</span>';
            html += '<span style="color:#4ade80;">S1:' + item.support + '</span>';
            html += '</div>';
            
            // Q-Open row
            html += '<div style="font-size:8px;color:#6a7585;margin-top:3px;border-top:1px solid #333;padding-top:3px;">';
            html += 'Q-Open: ' + (item.qOpenAnchor || 'N/A') + ' (' + distSign + item.qDistFromOpen + '%)';
            html += '</div>';
            
            html += '</div>';
            return html;
        }
        
        function updateQuantLevels(data) {
            console.log('updateQuantLevels called with', data ? data.length : 0, 'items');
            if (!data || !Array.isArray(data) || data.length === 0) return;
            quantDataCache = data;
            
            // Get the accordion container - scope all queries to this
            var accordion = document.getElementById('quantAccordion');
            if (!accordion) {
                console.error('quantAccordion container not found');
                return;
            }
            
            // Bucket assets by category (5 categories)
            var buckets = { generals: [], metals: [], energy: [], ag: [], fxcrypto: [] };
            
            data.forEach(function(item, index) {
                var cat = ASSET_CATEGORIES[item.symbol] || 'fxcrypto';
                if (buckets[cat]) {
                    buckets[cat].push({ item: item, index: index });
                } else {
                    buckets.fxcrypto.push({ item: item, index: index });
                }
            });
            
            console.log('Bucket counts:', buckets.generals.length, buckets.metals.length, buckets.energy.length, buckets.ag.length, buckets.fxcrypto.length);
            
            // Category labels map
            var catLabels = {
                generals: 'GENERALS',
                metals: 'METALS', 
                energy: 'ENERGY',
                ag: 'AGRICULTURE',
                fxcrypto: 'FX / CRYPTO'
            };
            
            // Rebuild the entire accordion content to ensure fresh DOM
            var html = '';
            ['generals', 'metals', 'energy', 'ag', 'fxcrypto'].forEach(function(cat) {
                var capCat = cat.charAt(0).toUpperCase() + cat.slice(1);
                var label = catLabels[cat] || cat.toUpperCase();
                var count = buckets[cat].length;
                
                html += '<div class="quant-accordion-section">';
                html += '<button class="quant-accordion-header" onclick="toggleQuantSection(\'' + cat + '\')" id="quantHeader' + capCat + '">';
                html += '<span class="quant-accordion-arrow" id="quantArrow' + capCat + '">&#9658;</span>';
                html += '<span>' + label + '</span>';
                html += '<span class="quant-accordion-count" id="quantCount' + capCat + '">' + count + '</span>';
                html += '</button>';
                html += '<div class="quant-accordion-body" id="quantBody' + capCat + '" style="display:none;">';
                
                buckets[cat].forEach(function(entry) {
                    html += '<div class="quant-card" style="cursor:pointer;" data-index="' + entry.index + '" onclick="showQuantDetail(' + entry.index + ')">';
                    html += buildCardInnerHtml(entry.item);
                    html += '</div>';
                });
                
                if (count === 0) {
                    html += '<div style="color:#6a7585;font-size:10px;padding:8px;">No data available</div>';
                }
                
                html += '<div style="color:#6a7585;font-size:7px;font-style:italic;padding:6px 4px 2px 4px;border-top:1px solid rgba(255,255,255,0.05);margin-top:6px;line-height:1.3;">* DISCLAIMER: This is not financial advice. I am not a financial advisor. This content is for informational and educational purposes only. Investing involves risk, and you should always do your own due diligence (DYOR) and consult with a professional financial advisor before making any investment decisions.</div>';
                html += '</div></div>';
            });
            
            accordion.innerHTML = html;
            console.log('Quant accordion rebuilt with', data.length, 'assets');
        }
        
        // Helper to build card inner HTML
        function buildCardInnerHtml(item) {
            var regimeColor = getRegimeColor(item.qRegime);
            var distSign = parseFloat(item.qDistFromOpen) >= 0 ? '+' : '';
            
            // Calculate Z-Score from current price vs sigma bands
            var zScore = 0;
            if (item.sigmaHigh && item.sigmaLow && item.current) {
                var price = parseFloat(item.current.replace(/,/g, ''));
                var high = parseFloat(item.sigmaHigh);
                var low = parseFloat(item.sigmaLow);
                var mid = (high + low) / 2;
                var range = (high - low) / 4; // Range is 4 sigma total
                if (range > 0) {
                    zScore = (price - mid) / range;
                }
            }
            var zDisplay = getZScoreDisplay(zScore);
            
            var html = '<div class="quant-header">';
            html += '<span class="quant-symbol">' + item.symbol + '</span>';
            html += '<span class="quant-price">' + item.current + '</span>';
            html += '</div>';
            html += '<div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:wrap;">';
            html += '<span style="background:' + regimeColor + '22;color:' + regimeColor + ';padding:1px 5px;border-radius:2px;font-size:9px;font-weight:600;">' + (item.qRegime || 'N/A') + '</span>';
            html += '<span style="background:#00D9FF22;color:#00D9FF;padding:1px 5px;border-radius:2px;font-size:9px;font-weight:600;">' + (item.structure || 'TREND') + '</span>';
            html += '<span style="background:' + zDisplay.color + '22;color:' + zDisplay.color + ';padding:1px 5px;border-radius:2px;font-size:9px;font-weight:700;">' + zDisplay.symbol + '</span>';
            html += '</div>';
            html += '<div style="display:flex;justify-content:space-between;font-size:9px;color:#9ca3af;">';
            html += '<span style="color:#ff6b6b;">R1:' + item.resistance + '</span>';
            html += '<span style="color:#4ade80;">S1:' + item.support + '</span>';
            html += '</div>';
            return html;
        }
        
        // Show detailed quant modal for asset
        function showQuantDetail(index) {
            var item = quantDataCache[index];
            if (!item) return;
            
            var modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.style.display = 'flex';
            modal.onclick = function(e) { if (e.target === modal) modal.remove(); };
            
            var regimeColor = item.qRegime === 'BULLISH' ? '#4ade80' : item.qRegime === 'BEARISH' ? '#ff6b6b' : '#fbbf24';
            
            modal.innerHTML = '<div class="modal-content" style="max-width:500px;">' +
                '<div class="modal-header">' +
                    '<h3 style="margin:0;color:#00D9FF;">' + item.symbol + ' - 8-LAYER ENGINE</h3>' +
                    '<button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">[X]</button>' +
                '</div>' +
                '<div class="modal-body" style="padding:15px;">' +
                    '<div style="text-align:center;font-size:24px;font-weight:700;color:#fff;margin-bottom:10px;">' + item.current + '</div>' +
                    
                    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px;">' +
                        '<div style="background:#1a1f2b;padding:10px;border-radius:4px;border-left:3px solid ' + regimeColor + ';">' +
                            '<div style="font-size:10px;color:#6a7585;">REGIME CLASSIFIER</div>' +
                            '<div style="font-size:14px;font-weight:700;color:' + regimeColor + ';">' + item.qRegime + '</div>' +
                            '<div style="font-size:9px;color:#9ca3af;">Q-Open: ' + item.qOpenAnchor + ' (' + (parseFloat(item.qDistFromOpen) >= 0 ? '+' : '') + item.qDistFromOpen + '%)</div>' +
                        '</div>' +
                        '<div style="background:#1a1f2b;padding:10px;border-radius:4px;border-left:3px solid #00D9FF;">' +
                            '<div style="font-size:10px;color:#6a7585;">SIGNAL GENERATOR</div>' +
                            '<div style="font-size:14px;font-weight:700;color:#00D9FF;">' + item.confluenceRating + '</div>' +
                            '<div style="font-size:9px;color:#9ca3af;">Score: ' + item.confluenceScore + '</div>' +
                        '</div>' +
                    '</div>' +
                    
                    '<div style="font-size:11px;font-weight:600;color:#fff;margin-bottom:8px;">THE 8 LAYERS:</div>' +
                    
                    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:10px;">' +
                        '<div style="background:#1a1f2b;padding:8px;border-radius:4px;">' +
                            '<div style="color:#22c55e;font-weight:600;">1. MARKET DATA</div>' +
                            '<div style="color:#9ca3af;">Price: ' + item.current + '</div>' +
                        '</div>' +
                        '<div style="background:#1a1f2b;padding:8px;border-radius:4px;">' +
                            '<div style="color:#ec4899;font-weight:600;">2. VOLATILITY ENGINE</div>' +
                            '<div style="color:#9ca3af;">' + item.volStress + ' / ' + item.volState + '</div>' +
                        '</div>' +
                        '<div style="background:#1a1f2b;padding:8px;border-radius:4px;">' +
                            '<div style="color:#00D9FF;font-weight:600;">3. STRUCTURE DETECTOR</div>' +
                            '<div style="color:#9ca3af;">' + item.structure + '</div>' +
                        '</div>' +
                        '<div style="background:#1a1f2b;padding:8px;border-radius:4px;">' +
                            '<div style="color:#4ade80;font-weight:600;">4. QUARTERLY ANCHORS</div>' +
                            '<div style="color:#9ca3af;">Q-Open: ' + item.qOpenAnchor + ' (' + item.qDistFromOpen + '%)</div>' +
                        '</div>' +
                        '<div style="background:#1a1f2b;padding:8px;border-radius:4px;">' +
                            '<div style="color:' + regimeColor + ';font-weight:600;">5. REGIME CLASSIFIER</div>' +
                            '<div style="color:#9ca3af;">' + item.qRegime + '</div>' +
                        '</div>' +
                        '<div style="background:#1a1f2b;padding:8px;border-radius:4px;">' +
                            '<div style="color:#3b82f6;font-weight:600;">6. Z-SCORE NORMALIZER</div>' +
                            '<div style="color:#9ca3af;">+2s: ' + item.sigmaHigh + ' | -2s: ' + item.sigmaLow + '</div>' +
                        '</div>' +
                        '<div style="background:#1a1f2b;padding:8px;border-radius:4px;">' +
                            '<div style="color:#a855f7;font-weight:600;">7. SIGNAL GENERATOR</div>' +
                            '<div style="color:#9ca3af;">' + item.momentum + ' (' + (item.confluenceSignals || []).slice(0,2).join(', ') + ')</div>' +
                        '</div>' +
                        '<div style="background:#1a1f2b;padding:8px;border-radius:4px;">' +
                            '<div style="color:#ff6b6b;font-weight:600;">8. KEY LEVELS</div>' +
                            '<div style="color:#9ca3af;">R1: ' + item.resistance + ' | S1: ' + item.support + '</div>' +
                        '</div>' +
                    '</div>' +
                    
                    '<div style="margin-top:15px;padding-top:12px;border-top:1px solid #2a3040;">' +
                        '<div style="font-size:10px;color:#6B8BA4;margin-bottom:8px;">This engine transforms raw market data into regime-aware signals through 8 sequential layers.</div>' +
                        '<button onclick="toggleQuantExplainer(this)" style="background:#1a1f2b;border:1px solid #6B8BA4;color:#6B8BA4;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:10px;width:100%;font-family:IBM Plex Sans,sans-serif;">SHOW QUANT ENGINE EXPLAINER</button>' +
                        '<div class="quant-explainer-content" style="display:none;margin-top:12px;">' +
                            '<div style="background:#0f1218;border:1px solid #2a3040;border-radius:6px;padding:12px;margin-bottom:12px;">' +
                                '<div style="font-size:10px;font-weight:600;color:#fff;margin-bottom:10px;text-align:center;">DATA FLOW PIPELINE</div>' +
                                '<div style="display:flex;align-items:center;justify-content:center;gap:4px;flex-wrap:wrap;">' +
                                    '<div style="background:#22c55e;color:#000;padding:3px 6px;border-radius:3px;font-size:8px;font-weight:600;">DATA</div>' +
                                    '<div style="color:#4a5568;font-size:10px;">--></div>' +
                                    '<div style="background:#ec4899;color:#fff;padding:3px 6px;border-radius:3px;font-size:8px;font-weight:600;">VOL</div>' +
                                    '<div style="color:#4a5568;font-size:10px;">--></div>' +
                                    '<div style="background:#00D9FF;color:#000;padding:3px 6px;border-radius:3px;font-size:8px;font-weight:600;">STRUCT</div>' +
                                    '<div style="color:#4a5568;font-size:10px;">--></div>' +
                                    '<div style="background:#4ade80;color:#000;padding:3px 6px;border-radius:3px;font-size:8px;font-weight:600;">ANCHOR</div>' +
                                    '<div style="color:#4a5568;font-size:10px;">--></div>' +
                                    '<div style="background:#fbbf24;color:#000;padding:3px 6px;border-radius:3px;font-size:8px;font-weight:600;">REGIME</div>' +
                                    '<div style="color:#4a5568;font-size:10px;">--></div>' +
                                    '<div style="background:#3b82f6;color:#fff;padding:3px 6px;border-radius:3px;font-size:8px;font-weight:600;">Z-SCORE</div>' +
                                    '<div style="color:#4a5568;font-size:10px;">--></div>' +
                                    '<div style="background:#a855f7;color:#fff;padding:3px 6px;border-radius:3px;font-size:8px;font-weight:600;">SIGNAL</div>' +
                                    '<div style="color:#4a5568;font-size:10px;">--></div>' +
                                    '<div style="background:#ff6b6b;color:#fff;padding:3px 6px;border-radius:3px;font-size:8px;font-weight:600;">LEVELS</div>' +
                                '</div>' +
                            '</div>' +
                            '<div style="font-size:9px;line-height:1.5;color:#9ca3af;">' +
                                '<div style="margin-bottom:8px;padding:6px;background:#1a1f2b;border-radius:4px;border-left:2px solid #22c55e;">' +
                                    '<span style="color:#22c55e;font-weight:600;">1. MARKET DATA:</span> Ingests live price, volume, and OHLC data to establish the baseline series for analysis.' +
                                '</div>' +
                                '<div style="margin-bottom:8px;padding:6px;background:#1a1f2b;border-radius:4px;border-left:2px solid #ec4899;">' +
                                    '<span style="color:#ec4899;font-weight:600;">2. VOLATILITY ENGINE:</span> Measures realized volatility using Parkinson method. Flags NORMAL, ELEVATED, or EXTREME conditions to scale risk.' +
                                '</div>' +
                                '<div style="margin-bottom:8px;padding:6px;background:#1a1f2b;border-radius:4px;border-left:2px solid #00D9FF;">' +
                                    '<span style="color:#00D9FF;font-weight:600;">3. STRUCTURE DETECTOR:</span> Identifies whether price is TRENDING, RANGING, COILING (compressing), or at a BREAKOUT point.' +
                                '</div>' +
                                '<div style="margin-bottom:8px;padding:6px;background:#1a1f2b;border-radius:4px;border-left:2px solid #4ade80;">' +
                                    '<span style="color:#4ade80;font-weight:600;">4. QUARTERLY ANCHORS:</span> Aligns price to the quarterly open - a key institutional reference point. Shows distance from Q-Open.' +
                                '</div>' +
                                '<div style="margin-bottom:8px;padding:6px;background:#1a1f2b;border-radius:4px;border-left:2px solid #fbbf24;">' +
                                    '<span style="color:#fbbf24;font-weight:600;">5. REGIME CLASSIFIER:</span> Labels market state as BULLISH, BEARISH, ACCUMULATION, or DISTRIBUTION based on Q-Open and volatility buffers.' +
                                '</div>' +
                                '<div style="margin-bottom:8px;padding:6px;background:#1a1f2b;border-radius:4px;border-left:2px solid #3b82f6;">' +
                                    '<span style="color:#3b82f6;font-weight:600;">6. Z-SCORE NORMALIZER:</span> Calculates statistical deviation from fair value. +2 sigma = overbought, -2 sigma = oversold.' +
                                '</div>' +
                                '<div style="margin-bottom:8px;padding:6px;background:#1a1f2b;border-radius:4px;border-left:2px solid #a855f7;">' +
                                    '<span style="color:#a855f7;font-weight:600;">7. SIGNAL GENERATOR:</span> Combines structure + regime + momentum into a conviction score. Output: BULLISH, BEARISH, or NEUTRAL.' +
                                '</div>' +
                                '<div style="padding:6px;background:#1a1f2b;border-radius:4px;border-left:2px solid #ff6b6b;">' +
                                    '<span style="color:#ff6b6b;font-weight:600;">8. KEY LEVELS:</span> Derives tactical support (S1) and resistance (R1) levels for entry/exit decisions.' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    
                '</div>' +
            '</div>';
            
            document.body.appendChild(modal);
        }
        
        function updateStrategicIntelligence(data) {
            if (!data) return;
            
            // Update DEFCON Panel with tripwires data
            if (data.defcon) {
                updateDEFCONPanel(data.defcon);
            }
            
            // Update Global Catalyst Queue (Horizon Scanner)
            if (data.catalysts && data.catalysts.length > 0) {
                updateHorizonScanner(data.catalysts);
            }
            
            // Update Grand Strategy widgets if available
            if (data.grandStrategy) {
                renderGrandStrategy(data.grandStrategy);
            }
        }
        
        // Render Grand Strategy Command Center (Nash Equilibrium & Bifurcation)
        function renderGrandStrategy(gs) {
            if (!gs) return;
            
            // Cache for re-rendering after systemic dashboard updates
            cachedGrandStrategy = gs;
            
            // --- RENDER COLUMN 3: STATECRAFT MATRIX ---
            var col3 = document.getElementById('statecraft-matrix');
            if (col3) {
                // Helper to determine glow class
                var getCellClass = function(toolChar, count) {
                    if (count === 0) return '';
                    if (toolChar === '\u2020') return 'cell-kinetic-active';
                    if (toolChar === '$') return 'cell-econ-active';
                    if (toolChar === '\u00a4') return 'cell-mon-active';
                    return 'cell-soft-active';
                };

                var renderRow = function(label, key) {
                    var t = gs.matrix[key];
                    if (!t) return '';
                    return '<div class="matrix-row-label">' + label + '</div>' +
                        '<div class="matrix-cell ' + getCellClass('$', t['$']) + '" title="Economic">$</div>' +
                        '<div class="matrix-cell ' + getCellClass('\u2020', t['\u2020']) + '" title="Kinetic">\u2020</div>' +
                        '<div class="matrix-cell ' + getCellClass('\u25ce', t['\u25ce']) + '" title="Diplomatic">\u25ce</div>' +
                        '<div class="matrix-cell ' + getCellClass('\u2261', t['\u2261']) + '" title="Info">\u2261</div>' +
                        '<div class="matrix-cell ' + getCellClass('\u00a4', t['\u00a4']) + '" title="Monetary">\u00a4</div>';
                };

                // Format game state for display (stack long names)
                var formatGameState = function(state) {
                    if (state === 'STAG HUNT') {
                        return { html: 'STAG<br>HUNT', isMultiLine: true };
                    } else if (state === 'GAME OF CHICKEN') {
                        return { html: 'GAME OF<br>CHICKEN', isMultiLine: true };
                    } else if (state === 'ASYMMETRIC ESCALATION') {
                        return { html: 'ASYMMETRIC<br>ESCALATION', isMultiLine: true };
                    } else if (state === 'WAR OF ATTRITION') {
                        return { html: 'WAR OF<br>ATTRITION', isMultiLine: true };
                    }
                    return { html: state, isMultiLine: false };
                };
                
                var formattedState = formatGameState(gs.gameTheory.state);
                var statusClass = formattedState.isMultiLine ? 'gs-status multi-line' : 'gs-status';

                // Check saved collapsed state (default to collapsed)
                var isCollapsed = localStorage.getItem('statecraftExpanded') !== 'true';
                var arrowChar = isCollapsed ? '&#9658;' : '&#9660;';
                var bodyDisplay = isCollapsed ? 'none' : 'block';
                
                col3.innerHTML = '<div class="sc-matrix-container">' +
                    '<div class="gs-header" onclick="toggleStatecraftBody()" style="cursor:pointer;">' +
                        '<div style="display:flex;align-items:center;">' +
                            '<span class="statecraft-arrow" id="statecraftArrow" style="color:#a855f7;font-size:0.6rem;margin-right:8px;">' + arrowChar + '</span>' +
                            '<span class="gs-title">GAME STATE</span>' +
                        '</div>' +
                        '<span class="' + statusClass + '" style="color:' + gs.gameTheory.color + ';">' + formattedState.html + '</span>' +
                    '</div>' +
                    '<div id="statecraftBody" style="display:' + bodyDisplay + ';">' +
                        '<div class="gs-desc">' + gs.gameTheory.desc + '</div>' +
                        '<div class="matrix-grid">' +
                            '<div></div>' +
                            '<div class="matrix-col-head">$</div>' +
                            '<div class="matrix-col-head">\u2020</div>' +
                            '<div class="matrix-col-head">\u25ce</div>' +
                            '<div class="matrix-col-head">\u2261</div>' +
                            '<div class="matrix-col-head">\u00a4</div>' +
                            renderRow('HEGEMON', 'HEGEMON') +
                            renderRow('REVISIONIST', 'REVISIONIST') +
                            renderRow('SPOILER', 'SPOILER') +
                        '</div>' +
                        '<div onclick="openGameTheoryExplainer()" style="text-align:center;padding:10px;margin:10px 0;font-size:0.75rem;font-weight:600;color:#a855f7;cursor:pointer;border:1px solid rgba(168,85,247,0.4);border-radius:4px;background:rgba(168,85,247,0.1);transition:all 0.2s;" onmouseover="this.style.background=\'rgba(168,85,247,0.2)\';this.style.borderColor=\'#a855f7\';this.style.boxShadow=\'0 0 12px rgba(168,85,247,0.3)\';" onmouseout="this.style.background=\'rgba(168,85,247,0.1)\';this.style.borderColor=\'rgba(168,85,247,0.4)\';this.style.boxShadow=\'none\';">HOW THIS WORKS</div>' +
                        '<div class="pivot-btn">' +
                            '<div style="font-size:0.8rem;font-weight:700;">WATCH ' + gs.pivot.symbol + ' @ ' + gs.pivot.level + '</div>' +
                            '<div style="font-size:0.6rem;opacity:0.7;margin-top:2px;">CONTEXT: ' + gs.pivot.reason + '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }
            
            // --- RENDER COLUMN 2: DRAGONBEAR FRACTURE (inside bifurcation section) ---
            renderGrandStrategyFracture(gs);
        }
        
        // Store catalysts globally for detail access
        var catalystCache = [];
        
        // Store grandStrategy globally for re-rendering after systemic dashboard updates
        var cachedGrandStrategy = null;
        
        // Game Theory Explainer Modal
        function openGameTheoryExplainer() {
            var modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.style.display = 'flex';
            modal.onclick = function(e) { if (e.target === modal) modal.remove(); };
            
            modal.innerHTML = '<div class="modal-content" style="max-width:600px;max-height:85vh;overflow-y:auto;">' +
                '<div class="modal-header">' +
                    '<h3 style="margin:0;color:#a855f7;">NASH EQUILIBRIUM ENGINE</h3>' +
                    '<button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">[X]</button>' +
                '</div>' +
                '<div class="modal-body" style="padding:15px;font-size:0.85rem;line-height:1.6;color:#9ca3af;">' +
                    
                    '<div style="background:#1a1f2b;padding:12px;border-radius:6px;border-left:4px solid #a855f7;margin-bottom:15px;">' +
                        '<div style="color:#e2e8f0;font-weight:600;margin-bottom:8px;">What is this?</div>' +
                        '<p style="margin:0;">This engine maps every active conflict into a strategic grid, then applies <strong style="color:#a855f7;">Nash Equilibrium</strong> analysis to determine the global game state. It answers: "What game are the great powers actually playing?"</p>' +
                    '</div>' +
                    
                    '<div style="font-weight:700;color:#e2e8f0;margin:15px 0 10px 0;">THE PLAYERS (Rows)</div>' +
                    '<div style="display:grid;gap:8px;">' +
                        '<div style="background:#0f131a;padding:10px;border-radius:4px;border-left:3px solid #22c55e;">' +
                            '<strong style="color:#22c55e;">HEGEMON</strong> - US/NATO/West. The incumbent world order. Uses economic sanctions, dollar hegemony, and alliance networks.' +
                        '</div>' +
                        '<div style="background:#0f131a;padding:10px;border-radius:4px;border-left:3px solid #ff4466;">' +
                            '<strong style="color:#ff4466;">REVISIONIST</strong> - China/Russia. Seeks to reshape the global order. Uses Belt & Road, energy leverage, and regional proxies.' +
                        '</div>' +
                        '<div style="background:#0f131a;padding:10px;border-radius:4px;border-left:3px solid #ffbb33;">' +
                            '<strong style="color:#ffbb33;">SPOILER</strong> - Iran/North Korea/Non-state actors. Chaos agents. Uses asymmetric warfare and nuclear brinkmanship.' +
                        '</div>' +
                    '</div>' +
                    
                    '<div style="font-weight:700;color:#e2e8f0;margin:15px 0 10px 0;">THE TOOLS (Columns)</div>' +
                    '<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px;text-align:center;font-size:0.75rem;">' +
                        '<div style="background:rgba(34,197,94,0.15);padding:8px;border-radius:4px;border:1px solid #22c55e;"><strong style="color:#22c55e;">$</strong><div style="color:#888;margin-top:4px;">Economic</div><div style="color:#666;font-size:0.65rem;">Sanctions, Trade</div></div>' +
                        '<div style="background:rgba(255,68,102,0.15);padding:8px;border-radius:4px;border:1px solid #ff4466;"><strong style="color:#ff4466;">\u2020</strong><div style="color:#888;margin-top:4px;">Kinetic</div><div style="color:#666;font-size:0.65rem;">Military Force</div></div>' +
                        '<div style="background:rgba(90,170,255,0.15);padding:8px;border-radius:4px;border:1px solid #5aaaff;"><strong style="color:#5aaaff;">\u25ce</strong><div style="color:#888;margin-top:4px;">Diplomatic</div><div style="color:#666;font-size:0.65rem;">Alliances, UN</div></div>' +
                        '<div style="background:rgba(90,170,255,0.15);padding:8px;border-radius:4px;border:1px solid #5aaaff;"><strong style="color:#5aaaff;">\u2261</strong><div style="color:#888;margin-top:4px;">Info</div><div style="color:#666;font-size:0.65rem;">Propaganda</div></div>' +
                        '<div style="background:rgba(255,187,51,0.15);padding:8px;border-radius:4px;border:1px solid #ffbb33;"><strong style="color:#ffbb33;">\u00a4</strong><div style="color:#888;margin-top:4px;">Monetary</div><div style="color:#666;font-size:0.65rem;">Currency War</div></div>' +
                    '</div>' +
                    
                    '<div style="font-weight:700;color:#e2e8f0;margin:15px 0 10px 0;">THE GAME STATES</div>' +
                    '<div style="display:grid;gap:8px;">' +
                        '<div style="background:#0f131a;padding:10px;border-radius:4px;">' +
                            '<strong style="color:#22c55e;">STAG HUNT</strong> - Cooperation equilibrium. Powers collaborate to maintain stability. Best for markets.' +
                        '</div>' +
                        '<div style="background:#0f131a;padding:10px;border-radius:4px;">' +
                            '<strong style="color:#ffbb33;">ASYMMETRIC ESCALATION</strong> - East uses kinetic force; West responds with sanctions. Indirect conflict. Current normal.' +
                        '</div>' +
                        '<div style="background:#0f131a;padding:10px;border-radius:4px;">' +
                            '<strong style="color:#ff4466;">GAME OF CHICKEN</strong> - Both sides using kinetic force. Direct confrontation. High collision risk. Watch defense stocks.' +
                        '</div>' +
                        '<div style="background:#0f131a;padding:10px;border-radius:4px;">' +
                            '<strong style="color:#bf5af2;">WAR OF ATTRITION</strong> - Monetary/currency warfare dominant. Zero-sum waiting game. Watch gold, CNH.' +
                        '</div>' +
                    '</div>' +
                    
                    '<div style="font-weight:700;color:#e2e8f0;margin:15px 0 10px 0;">THE PIVOT</div>' +
                    '<p>Based on the current game state, the engine identifies the ONE asset that decides the winner. This is your "watch this level" signal.</p>' +
                    
                    '<div style="background:rgba(0,0,0,0.3);padding:10px;border-radius:4px;font-size:0.75rem;color:#6a7585;margin-top:15px;">' +
                        '<strong style="color:#a855f7;">SOURCE:</strong> Inspired by game theory concepts from Thomas Schelling, John Nash, and applied to geopolitics via the Michael Every framework.' +
                    '</div>' +
                '</div>' +
            '</div>';
            
            document.body.appendChild(modal);
        }
        
        // Render the 4-Pillar Horizon Scanner
        function updateHorizonScanner(catalysts) {
            catalystCache = catalysts;
            // Find the "Watch Next" sections across columns and update with global catalysts
            const watchNextSections = document.querySelectorAll('.watch-next-global');
            watchNextSections.forEach(section => {
                section.innerHTML = catalysts.slice(0, 6).map((c, idx) => {
                    const badgeClass = (c.type || 'SYSTEMIC').toLowerCase();
                    return '<div class="catalyst-item" onclick="showCatalystDetail(' + idx + ')" style="cursor:pointer;">' +
                        '<span class="cat-badge ' + badgeClass + '">' + (c.type || 'SYSTEMIC') + '</span>' +
                        '<div class="catalyst-text-wrapper"><span class="catalyst-text">' + c.text + '</span></div>' +
                    '</div>';
                }).join('');
            });
        }
        
        // Show detailed catalyst explanation modal with AI analysis
        function showCatalystDetail(index) {
            var c = catalystCache[index];
            if (!c) return;
            
            var modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.style.display = 'flex';
            modal.onclick = function(e) { if (e.target === modal) modal.remove(); };
            
            var typeColors = {
                'KINETIC': '#ef4444',
                'MACRO': '#3b82f6',
                'STATECRAFT': '#a855f7',
                'SYSTEMIC': '#f59e0b'
            };
            var typeColor = typeColors[c.type] || '#f59e0b';
            
            var typeLabels = {
                'KINETIC': 'War / Conflict / Physical',
                'MACRO': 'Central Banks / Rates / Data',
                'STATECRAFT': 'Politics / Policy / Trade',
                'SYSTEMIC': 'Liquidity / VIX / Contagion'
            };
            
            var headlineHtml = c.link 
                ? '<a href="' + c.link + '" target="_blank" rel="noopener" style="font-size:0.9rem;color:#e2e8f0;line-height:1.5;font-weight:500;text-decoration:none;transition:color 0.2s;" onmouseover="this.style.color=\'#00D9FF\';this.style.textDecoration=\'underline\';" onmouseout="this.style.color=\'#e2e8f0\';this.style.textDecoration=\'none\';">' + c.text + '</a>'
                : '<div style="font-size:0.9rem;color:#e2e8f0;line-height:1.5;font-weight:500;">' + c.text + '</div>';
            
            modal.innerHTML = '<div class="modal-content" style="max-width:550px;">' +
                '<div class="modal-header">' +
                    '<h3 style="margin:0;color:' + typeColor + ';">CATALYST SCANNER</h3>' +
                    '<button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">[X]</button>' +
                '</div>' +
                '<div class="modal-body" style="padding:15px;">' +
                    '<div style="background:#1a1f2b;padding:12px;border-radius:6px;border-left:4px solid ' + typeColor + ';margin-bottom:15px;">' +
                        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">' +
                            '<span style="font-size:0.65rem;font-weight:700;padding:3px 8px;border-radius:3px;background:' + typeColor + ';color:#0a0e14;">' + (c.type || 'SYSTEMIC') + '</span>' +
                            '<span style="font-size:0.95rem;font-weight:700;color:' + typeColor + ';">' + (typeLabels[c.type] || typeLabels['SYSTEMIC']) + '</span>' +
                        '</div>' +
                        headlineHtml +
                        (c.source ? '<div style="font-size:0.75rem;margin-top:10px;"><span style="color:#6B8BA4;font-weight:600;">SOURCE:</span> <span style="color:#9ca3af;">' + c.source + '</span></div>' : '') +
                    '</div>' +
                    
                    '<div id="catalystCleverHeadline" style="margin-bottom:15px;">' +
                        '<div style="background:linear-gradient(135deg,rgba(168,85,247,0.15),rgba(0,217,255,0.1));padding:12px 15px;border-radius:6px;border-left:3px solid #a855f7;">' +
                            '<div style="font-size:0.65rem;color:#a855f7;font-weight:600;letter-spacing:1px;margin-bottom:4px;">STRATEGIC HEADLINE</div>' +
                            '<div id="cleverHeadlineText" style="font-size:0.95rem;color:#e2e8f0;font-weight:600;line-height:1.4;">Generating strategic headline...</div>' +
                        '</div>' +
                    '</div>' +
                    '<div id="catalystAiSection" style="margin-bottom:15px;">' +
                        '<div style="text-align:center;padding:30px;">' +
                            '<div style="color:#00D9FF;font-size:0.8rem;margin-bottom:8px;">READING FULL ARTICLE...</div>' +
                            '<div style="color:#6a7585;font-size:0.7rem;">AI is generating Michael Every-style analysis</div>' +
                            '<div style="margin-top:12px;"><div class="loading-pulse" style="width:40px;height:40px;margin:0 auto;border-radius:50%;background:rgba(0,217,255,0.3);animation:pulse 1.5s infinite;"></div></div>' +
                        '</div>' +
                    '</div>' +
                    
                '</div>' +
            '</div>';
            
            document.body.appendChild(modal);
            
            // Fetch AI analysis - now includes article link for full content fetching
            fetch('/api/analyze-catalyst', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: c.text, type: c.type, source: c.source, link: c.link })
            })
            .then(res => res.json())
            .then(data => {
                var aiSection = document.getElementById('catalystAiSection');
                var cleverHeadlineText = document.getElementById('cleverHeadlineText');
                if (!aiSection) return;
                
                // Update clever headline with AI-generated strategic headline
                if (cleverHeadlineText) {
                    if (data.cleverHeadline) {
                        cleverHeadlineText.textContent = data.cleverHeadline;
                    } else {
                        // Fallback: if no clever headline, hide the section
                        var cleverSection = document.getElementById('catalystCleverHeadline');
                        if (cleverSection) cleverSection.style.display = 'none';
                    }
                }
                
                if (data.analysis) {
                    // Parse the AI response and format it nicely
                    var formatted = data.analysis
                        .replace(/\*\*UNDER THE HOOD\*\*/gi, '<div style="font-size:11px;font-weight:700;color:#00D9FF;margin-bottom:6px;margin-top:12px;">UNDER THE HOOD</div>')
                        .replace(/\*\*WHY IT MOVES MARKETS\*\*/gi, '<div style="font-size:11px;font-weight:700;color:#ffbb33;margin-bottom:6px;margin-top:12px;">WHY IT MOVES MARKETS</div>')
                        .replace(/\*\*HOW TO POSITION\*\*/gi, '<div style="font-size:11px;font-weight:700;color:#22c55e;margin-bottom:6px;margin-top:12px;">HOW TO POSITION</div>')
                        .replace(/\*\*([^*]+)\*\*/g, '<strong style="color:#e2e8f0;">$1</strong>');
                    
                    aiSection.innerHTML = '<div style="font-size:0.8rem;color:#9ca3af;line-height:1.6;">' + formatted + '</div>' +
                        '<div style="background:rgba(0,0,0,0.3);padding:10px;border-radius:4px;font-size:0.7rem;color:#6a7585;line-height:1.4;margin-top:15px;">' +
                            '<strong style="color:#a855f7;">DISCLAIMER:</strong> AI analysis is for educational purposes only. Not financial advice. Always do your own research.' +
                        '</div>';
                } else {
                    aiSection.innerHTML = '<div style="color:#ef4444;font-size:0.8rem;text-align:center;padding:20px;">Analysis unavailable. Try again later.</div>';
                }
            })
            .catch(err => {
                var aiSection = document.getElementById('catalystAiSection');
                if (aiSection) {
                    aiSection.innerHTML = '<div style="color:#ef4444;font-size:0.8rem;text-align:center;padding:20px;">Failed to load analysis: ' + err.message + '</div>';
                }
            });
        }
        
        // Toggle DEFCON panel expand/collapse
        function toggleDefconPanel() {
            const body = document.getElementById('defconBody');
            const toggle = document.getElementById('defconToggle');
            if (body && toggle) {
                const isHidden = body.style.display === 'none';
                body.style.display = isHidden ? 'block' : 'none';
                toggle.innerHTML = isHidden ? '&#9660;' : '&#9658;';
            }
        }
        
        // Toggle KINETIC THEATERS panel expand/collapse
        function toggleKineticPanel() {
            const body = document.getElementById('kineticBody');
            const toggle = document.getElementById('kineticToggle');
            if (body && toggle) {
                const isHidden = body.style.display === 'none';
                body.style.display = isHidden ? 'block' : 'none';
                toggle.innerHTML = isHidden ? '&#9660;' : '&#9658;';
            }
        }
        
        // Expand kinetic panel and scroll to emerging section
        function expandAndScrollToEmerging() {
            const body = document.getElementById('kineticBody');
            const toggle = document.getElementById('kineticToggle');
            const section = document.getElementById('emergingSection');
            
            // First, expand the panel if collapsed
            if (body && body.style.display === 'none') {
                body.style.display = 'block';
                if (toggle) toggle.innerHTML = '&#9660;';
            }
            
            // Then scroll to emerging section after a brief delay
            setTimeout(() => {
                if (section && body) {
                    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }
        
        // Toggle STATECRAFT body expand/collapse
        function toggleStatecraftBody() {
            const body = document.getElementById('statecraftBody');
            const arrow = document.getElementById('statecraftArrow');
            if (body && arrow) {
                const isHidden = body.style.display === 'none';
                body.style.display = isHidden ? 'block' : 'none';
                arrow.innerHTML = isHidden ? '&#9660;' : '&#9658;';
                // Save state
                localStorage.setItem('statecraftExpanded', isHidden ? 'true' : 'false');
            }
        }
        
        
        // Update DEFCON Panel with tripwires data
        function updateDEFCONPanel(defconData) {
            if (!defconData || !defconData.tripwires) return;
            
            const { tripwires, summary, compound } = defconData;
            
            // Calculate and update header DEFCON level based on breached count
            const headerDefcon = document.getElementById('defcon-level');
            if (headerDefcon && summary) {
                let level = 5; // Default: all safe
                if (summary.breached >= 11) level = 1;
                else if (summary.breached >= 7) level = 2;
                else if (summary.breached >= 4) level = 3;
                else if (summary.breached >= 1 || summary.arming >= 3) level = 4;
                headerDefcon.textContent = level;
                
                // Color based on level
                const indicator = headerDefcon.closest('.defcon-indicator');
                if (indicator) {
                    indicator.classList.remove('level-1', 'level-2', 'level-3', 'level-4', 'level-5');
                    indicator.classList.add('level-' + level);
                }
            }
            
            // Update summary counts with labels
            const summaryEl = document.getElementById('defconSummary');
            if (summaryEl && summary) {
                summaryEl.innerHTML = `
                    <div class="defcon-count-group safe">
                        <span class="defcon-count-number">${summary.safe}</span>
                        <span class="defcon-count-label">SAFE</span>
                    </div>
                    <div class="defcon-count-group arming">
                        <span class="defcon-count-number">${summary.arming}</span>
                        <span class="defcon-count-label">ARMING</span>
                    </div>
                    <div class="defcon-count-group breached">
                        <span class="defcon-count-number">${summary.breached}</span>
                        <span class="defcon-count-label">BREACHED</span>
                    </div>
                `;
                
                // Auto-expand if any breached
                if (summary.breached > 0) {
                    const body = document.getElementById('defconBody');
                    const toggle = document.getElementById('defconToggle');
                    if (body) body.style.display = 'block';
                    if (toggle) toggle.classList.add('expanded');
                }
            }
            
            // Update compound stress indicator
            const compoundEl = document.getElementById('compoundIndicator');
            if (compoundEl && compound) {
                const statusClass = compound.status.toLowerCase();
                compoundEl.innerHTML = `
                    <span class="compound-status ${statusClass}">${compound.status}</span>
                `;
                compoundEl.title = compound.description + (compound.clusters?.length > 0 ? 
                    '\n\nActive clusters:\n' + compound.clusters.map(c => ` ${c.name}: ${c.tripwires.join(', ')}`).join('\n') : '');
                
                // Auto-expand if systemic stress detected
                if (compound.status === 'SYSTEMIC') {
                    const body = document.getElementById('defconBody');
                    const toggle = document.getElementById('defconToggle');
                    if (body) body.style.display = 'block';
                    if (toggle) toggle.classList.add('expanded');
                }
            }
            
            // Render tripwires grid
            const grid = document.getElementById('defconGrid');
            if (!grid) return;
            
            // Sort by status first (BREACHED > ARMING > SAFE), then by beam order (1-14) within each status
            const sorted = [...tripwires].sort((a, b) => {
                const statusOrder = { 'BREACHED': 0, 'ARMING': 1, 'SAFE': 2 };
                const statusDiff = (statusOrder[a.status] || 2) - (statusOrder[b.status] || 2);
                if (statusDiff !== 0) return statusDiff;
                return (a.order || 0) - (b.order || 0);
            });
            
            grid.innerHTML = sorted.map(tw => `
                <div class="defcon-tripwire ${tw.status.toLowerCase()}" onclick="openBeamAnalysis('${tw.id}')" style="cursor: pointer;" title="Click for detailed analysis">
                    <div class="defcon-tripwire-left">
                        <div class="defcon-tripwire-name">${tw.name}</div>
                        <div class="defcon-tripwire-info">${tw.desc}</div>
                    </div>
                    <div class="defcon-tripwire-status">${tw.status}</div>
                </div>
            `).join('');
        }
        
        // ========================================================================
        // EMERGING CONFLICT FUNCTIONS
        // ========================================================================
        
        let emergingQueue = [];
        
        function updateEmergingConflicts(data) {
            if (!data || !data.queue) return;
            
            emergingQueue = data.queue;
            const count = emergingQueue.length;
            
            // Update badge
            const badge = document.getElementById('emergingBadge');
            const badgeCount = document.getElementById('emergingBadgeCount');
            if (badge && badgeCount) {
                badgeCount.textContent = count;
                badge.classList.toggle('visible', count > 0);
            }
            
            // Update kinetic panel emerging count
            const kineticEmergingCount = document.getElementById('kineticEmergingCount');
            if (kineticEmergingCount) {
                kineticEmergingCount.textContent = count;
            }
            
            // Update tooltip with emerging conflicts
            updateEmergingTooltip();
            
            // Update section visibility
            const section = document.getElementById('emergingSection');
            const countEl = document.getElementById('emergingCount');
            if (section && countEl) {
                section.classList.toggle('hidden', count === 0);
                countEl.textContent = `${count} pending`;
            }
            
            // Render proposals
            renderEmergingProposals();
        }
        
        function updateEmergingTooltip() {
            const tooltip = document.getElementById('emergingTooltip');
            if (!tooltip) return;
            
            if (emergingQueue.length === 0) {
                tooltip.innerHTML = '<div class="tooltip-empty">No emerging signals</div>';
                return;
            }
            
            // Group emerging signals by continent/region
            const regionCounts = {};
            emergingQueue.forEach(signal => {
                const region = signal.region || signal.continent || 'GLOBAL';
                regionCounts[region] = (regionCounts[region] || 0) + 1;
            });
            
            // Sort regions by count (highest first)
            const sortedRegions = Object.entries(regionCounts)
                .sort((a, b) => b[1] - a[1]);
            
            const items = sortedRegions.map(([region, count]) => `
                <div class="tooltip-region-row">
                    <span class="tooltip-region-name">${region}</span>
                    <span class="tooltip-region-count">${count}</span>
                </div>
            `).join('');
            
            tooltip.innerHTML = `
                <div class="tooltip-title">Emerging Signals</div>
                ${items}
            `;
        }
        
        function renderEmergingProposals() {
            const container = document.getElementById('emergingProposals');
            if (!container) return;
            
            if (emergingQueue.length === 0) {
                container.innerHTML = '<div style="color:#6a7585;font-size:0.65rem;padding:10px;text-align:center;">No emerging signals detected</div>';
                return;
            }
            
            // Store emerging data for analysis lookup
            emergingQueue.forEach(p => {
                emergingDataStore[p.id] = p;
            });
            
            container.innerHTML = emergingQueue.map(proposal => {
                const confidence = Math.round((proposal.confidence || 0) * 100);
                const headlinePreview = (proposal.headlines || []).slice(0, 1)[0] || 'Analyzing situation...';
                const truncatedHeadline = headlinePreview.length > 70 ? headlinePreview.slice(0, 70) + '...' : headlinePreview;
                
                return `
                    <div class="emerging-card" data-id="${proposal.id}">
                        <div class="game-header">
                            <span class="game-title">${proposal.title || 'Unknown Situation'}</span>
                            <span class="game-phase">${confidence}%</span>
                        </div>
                        <div class="game-players">${(proposal.players || []).join(' vs ')}</div>
                        <div class="game-last-move">
                            <div class="game-move-label">Latest Signal</div>
                            <div class="game-move-text">${truncatedHeadline}</div>
                        </div>
                        <div class="game-equilibrium">
                            <span class="equilibrium-dot"></span>
                            <span class="equilibrium-text" style="color: #ff6b6b;">Unconfirmed - Awaiting Review</span>
                        </div>
                        <div class="game-next-move" style="color:#6a7585;font-size:0.7rem;">${(proposal.headlines || []).length} related headlines detected</div>
                        <div class="game-buttons-row">
                            <div class="game-analyze-btn" onclick="analyzeEmergingSignal('${proposal.id}')">
                                <span>GET AI ANALYSIS</span>
                            </div>
                            <div class="game-map-btn" onclick="openEmergingMap('${proposal.id}')">
                                <span>VIEW MAP</span>
                            </div>
                        </div>
                        <div class="emerging-decision-row">
                            <button class="emerging-btn accept" onclick="acceptEmergingProposal('${proposal.id}')">CONFIRM</button>
                            <button class="emerging-btn dismiss" onclick="dismissEmergingProposal('${proposal.id}')">DISMISS</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Store for emerging signals
        let emergingDataStore = {};
        
        function scrollToEmergingSection() {
            const section = document.getElementById('emergingSection');
            if (section) {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        function toggleEmergingSection() {
            const proposals = document.getElementById('emergingProposals');
            if (proposals) {
                proposals.style.display = proposals.style.display === 'none' ? 'flex' : 'none';
            }
        }
        
        async function acceptEmergingProposal(proposalId) {
            try {
                const response = await fetch('/api/emerging-conflicts/accept', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ proposalId })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to accept');
                }
                
                // Remove from local queue immediately for responsiveness
                emergingQueue = emergingQueue.filter(p => p.id !== proposalId);
                updateEmergingConflicts({ queue: emergingQueue });
                
            } catch (error) {
                console.error('Error accepting proposal:', error);
                alert('Failed to accept proposal: ' + error.message);
            }
        }
        
        async function dismissEmergingProposal(proposalId) {
            try {
                const response = await fetch('/api/emerging-conflicts/dismiss', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ proposalId })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to dismiss');
                }
                
                // Remove from local queue immediately for responsiveness
                emergingQueue = emergingQueue.filter(p => p.id !== proposalId);
                updateEmergingConflicts({ queue: emergingQueue });
                
            } catch (error) {
                console.error('Error dismissing proposal:', error);
                alert('Failed to dismiss proposal: ' + error.message);
            }
        }
        
        // Analyze emerging signal with AI
        function analyzeEmergingSignal(proposalId) {
            const proposal = emergingQueue.find(p => p.id === proposalId);
            if (!proposal) {
                console.error('Emerging signal not found:', proposalId);
                return;
            }

            const modal = document.getElementById('analysisModal');
            const modalHeadline = document.getElementById('modalHeadline');
            const modalBody = document.getElementById('modalBody');
            const modalSource = document.getElementById('modalSource');

            modalHeadline.textContent = proposal.title || 'Emerging Signal';
            modalSource.innerHTML = `<span class="modal-source-label" style="color:#ef4444;">EMERGING SIGNAL</span> ${(proposal.players || []).join(' vs ')}`;
            modalBody.innerHTML = `
                <div class="modal-loading">
                    <div class="modal-spinner"></div>
                    <div class="modal-loading-text">Analyzing emerging signal with Gemini AI...<br><span style="font-size: 0.85em; opacity: 0.8;">Assessing potential conflict formation</span></div>
                </div>
            `;

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            fetch('/api/analyze-emerging', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    proposalId: proposal.id,
                    title: proposal.title,
                    players: proposal.players,
                    headlines: proposal.headlines,
                    confidence: proposal.confidence,
                    location: proposal.location
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.analysis) {
                    modalBody.innerHTML = `
                        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; padding: 10px; margin-bottom: 16px;">
                            <div style="color: #ef4444; font-weight: 700; font-size: 0.8rem; margin-bottom: 6px;">UNCONFIRMED EMERGING SIGNAL</div>
                            <div style="color: #94a3b8; font-size: 0.75rem;">This is a potential conflict detected by AI pattern matching. It has not been confirmed by human review. Confidence: ${Math.round((proposal.confidence || 0) * 100)}%</div>
                        </div>
                        <div class="modal-analysis">${parseMarkdown(data.analysis)}</div>
                    `;
                } else {
                    modalBody.innerHTML = `<div class="modal-error">${data.error || 'Failed to analyze. Please try again.'}</div>`;
                }
            })
            .catch(error => {
                console.error('Analysis error:', error);
                modalBody.innerHTML = `<div class="modal-error">Network error. Please try again.</div>`;
            });
        }
        
        // Show emerging signal on map with distinct EMERGING styling
        function openEmergingMap(proposalId) {
            const proposal = emergingQueue.find(p => p.id === proposalId);
            if (!proposal) {
                console.error('Emerging signal not found:', proposalId);
                return;
            }
            
            const modal = document.getElementById('mapModal');
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            document.body.style.overflow = 'hidden';
            
            // Parse location - can be string or object {lat, lon, city}
            let locName = 'Location Unknown';
            let lat = 0;
            let lon = -30; // Default to Atlantic Ocean (global)
            
            if (proposal.location) {
                if (typeof proposal.location === 'object') {
                    locName = proposal.location.city || 'Global';
                    lat = proposal.location.lat || 0;
                    lon = proposal.location.lon || -30;
                } else {
                    locName = proposal.location;
                }
            }
            
            // Use explicit lat/lon if provided at top level
            if (proposal.lat !== undefined) lat = proposal.lat;
            if (proposal.lon !== undefined) lon = proposal.lon;
            
            // Create a temporary emerging zone for the globe
            const emergingZone = {
                id: proposal.id,
                title: proposal.title || 'Emerging Signal',
                location: locName,
                lat: lat,
                lon: lon,
                color: '#ff6b6b', // Distinct red-pink for emerging
                isEmerging: true,
                confidence: proposal.confidence || 0
            };
            
            currentFocusedZone = emergingZone;
            
            // Update header with EMERGING indicator
            const headerTitle = document.getElementById('globe-header');
            if (headerTitle) {
                headerTitle.innerHTML = `
                    <div style="color: #ef4444; font-size: 0.75rem; font-weight: 700; letter-spacing: 2px; background: rgba(239, 68, 68, 0.2); padding: 4px 10px; border-radius: 4px; display: inline-block; margin-bottom: 6px;">EMERGING SIGNAL</div>
                    <div style="color: #00D9FF; font-size: 1.1rem; font-weight: 700; letter-spacing: 2px;">POTENTIAL THEATER</div>
                    <div style="color: #ff6b6b; font-size: 0.9rem; font-weight: 600; margin-top: 4px;">${emergingZone.title}</div>
                    <div style="color: #888; font-size: 0.75rem;">${emergingZone.location} | ${Math.round((emergingZone.confidence || 0) * 100)}% confidence</div>
                `;
            }

            // Dispose and recreate globe with emerging zone
            if (globeRoot) {
                try { globeRoot.dispose(); } catch(e) {}
                globeRoot = null;
                globeChart = null;
            }
            
            setTimeout(() => {
                initGlobeWithEmergingZone(emergingZone);
            }, 100);
        }
        
        // Initialize globe focused on an emerging zone
        function initGlobeWithEmergingZone(emergingZone) {
            const container = document.getElementById('globe-div');
            if (!container) return;
            
            // Use same globe initialization but with emerging zone styling
            const root = am5.Root.new('globe-div');
            globeRoot = root;
            
            root.setThemes([am5themes_Animated.new(root)]);
            
            const chart = root.container.children.push(am5map.MapChart.new(root, {
                panX: "rotateX",
                panY: "rotateY",
                projection: am5map.geoOrthographic(),
                homeGeoPoint: { latitude: emergingZone.lat, longitude: emergingZone.lon }
            }));
            globeChart = chart;
            
            // Add polygon series for countries
            const polygonSeries = chart.series.push(am5map.MapPolygonSeries.new(root, {
                geoJSON: am5geodata_worldLow
            }));
            
            polygonSeries.mapPolygons.template.setAll({
                fill: am5.color(0x1a1a2e),
                stroke: am5.color(0x333355),
                strokeWidth: 0.5
            });
            
            // Add emerging zone marker with pulsating effect and tooltip
            const pointSeries = chart.series.push(am5map.MapPointSeries.new(root, {}));
            
            pointSeries.bullets.push(() => {
                const hitArea = am5.Container.new(root, {
                    width: 45,
                    height: 45,
                    centerX: am5.p50,
                    centerY: am5.p50,
                    interactive: true,
                    cursorOverStyle: "pointer",
                    tooltipHTML: `
                        <div class="am5-tooltip-container">
                            <div style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); border-radius: 4px; padding: 6px 10px; margin-bottom: 8px; text-align: center;">
                                <span style="color: #ef4444; font-weight: 700; font-size: 0.7rem; letter-spacing: 1px;">EMERGING SIGNAL</span>
                            </div>
                            <div class="gt-title" style="color: #ff6b6b;">${emergingZone.title}</div>
                            <div class="gt-location" style="color: #888; font-size: 0.6rem; margin-bottom: 6px;">${emergingZone.location}</div>
                            <div class="gt-type" style="background: rgba(255, 107, 107, 0.2); color: #ff6b6b;">EMERGING</div>
                            <div class="gt-desc">Unconfirmed signal detected by AI pattern matching</div>
                            <div class="gt-theory">Awaiting human confirmation</div>
                            <div class="gt-why" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); color: #6a7585; font-size: 0.6rem; font-style: italic;">Confidence: ${Math.round((emergingZone.confidence || 0) * 100)}%</div>
                        </div>
                    `
                });
                
                // Invisible hit circle
                hitArea.children.push(am5.Circle.new(root, {
                    radius: 18,
                    fill: am5.color(0x000000),
                    fillOpacity: 0,
                    strokeOpacity: 0,
                    x: am5.p50,
                    y: am5.p50,
                    centerX: am5.p50,
                    centerY: am5.p50
                }));
                
                // Outer pulsing ring
                const outerCircle = hitArea.children.push(am5.Circle.new(root, {
                    radius: 20,
                    fill: am5.color(0xff6b6b),
                    fillOpacity: 0.3,
                    x: am5.p50,
                    y: am5.p50,
                    centerX: am5.p50,
                    centerY: am5.p50
                }));
                
                outerCircle.animate({
                    key: "radius",
                    from: 15,
                    to: 30,
                    duration: 1500,
                    loops: Infinity,
                    easing: am5.ease.out(am5.ease.cubic)
                });
                
                outerCircle.animate({
                    key: "fillOpacity",
                    from: 0.4,
                    to: 0,
                    duration: 1500,
                    loops: Infinity,
                    easing: am5.ease.out(am5.ease.cubic)
                });
                
                // Inner dot
                hitArea.children.push(am5.Circle.new(root, {
                    radius: 8,
                    fill: am5.color(0xff6b6b),
                    x: am5.p50,
                    y: am5.p50,
                    centerX: am5.p50,
                    centerY: am5.p50,
                    stroke: am5.color(0xffffff),
                    strokeWidth: 2
                }));
                
                // EMERGING label
                hitArea.children.push(am5.Label.new(root, {
                    text: "EMERGING",
                    fontSize: 10,
                    fontWeight: "700",
                    fill: am5.color(0xef4444),
                    x: am5.p50,
                    centerX: am5.p50,
                    dy: 18
                }));
                
                return am5.Bullet.new(root, { sprite: hitArea });
            });
            
            pointSeries.data.setAll([{
                geometry: { type: "Point", coordinates: [emergingZone.lon, emergingZone.lat] },
                title: emergingZone.title,
                location: emergingZone.location,
                isEmerging: true
            }]);
            
            // Rotate to show the emerging zone
            chart.animate({
                key: "rotationX",
                to: -emergingZone.lon,
                duration: 1500,
                easing: am5.ease.inOut(am5.ease.cubic)
            });
            chart.animate({
                key: "rotationY",
                to: -emergingZone.lat,
                duration: 1500,
                easing: am5.ease.inOut(am5.ease.cubic)
            });
        }

        function handleInitialData(message) {
            if (message.market) {
                updateMarketData(message.market);
            }
            if (message.macro) {
                updateMacroData(message.macro);
            }
            if (message.fx) {
                updateFXData(message.fx);
            }
            if (message.commodities) {
                updateCommodityData(message.commodities);
            }
            if (message.systemicWatchlist) {
                updateSystemicWatchlist(message.systemicWatchlist);
            }
        }

        function handleNewCard(message) {
            const columnId = getColumnId(message.column);
            const column = document.getElementById(columnId);
            
            if (!column) return;

            const cardHtml = createCardHtml(message.data);
            
            // Insert cards AFTER pinned dashboards to keep them on top
            if (columnId === 'macroColumn') {
                const newsSeparator = column.querySelector('#macroNewsSeparator');
                if (newsSeparator) {
                    newsSeparator.insertAdjacentHTML('afterend', cardHtml);
                } else {
                    // Fallback: insert after baseLayerGrid, then systemicDashboard
                    const baseLayer = column.querySelector('#baseLayerGrid');
                    if (baseLayer) {
                        baseLayer.insertAdjacentHTML('afterend', cardHtml);
                        return;
                    }
                    const systemicDashboard = column.querySelector('#systemicDashboard');
                    if (systemicDashboard) {
                        systemicDashboard.insertAdjacentHTML('afterend', cardHtml);
                    } else {
                        column.insertAdjacentHTML('afterbegin', cardHtml);
                    }
                }
            } else if (columnId === 'commodityColumn') {
                const commodityNewsSeparator = column.querySelector('#commodityNewsSeparator');
                if (commodityNewsSeparator) {
                    commodityNewsSeparator.insertAdjacentHTML('afterend', cardHtml);
                } else {
                    column.insertAdjacentHTML('beforeend', cardHtml);
                }
            } else if (columnId === 'fxColumn') {
                const fxNewsSeparator = column.querySelector('#fxNewsSeparator');
                if (fxNewsSeparator) {
                    fxNewsSeparator.insertAdjacentHTML('afterend', cardHtml);
                } else {
                    column.insertAdjacentHTML('beforeend', cardHtml);
                }
            } else if (columnId === 'predictionColumn') {
                const predictionNewsSeparator = column.querySelector('#predictionNewsSeparator');
                if (predictionNewsSeparator) {
                    predictionNewsSeparator.insertAdjacentHTML('afterend', cardHtml);
                } else {
                    column.insertAdjacentHTML('beforeend', cardHtml);
                }
            } else if (columnId === 'geoColumn') {
                const geoNewsSeparator = column.querySelector('#geoNewsSeparator');
                if (geoNewsSeparator) {
                    geoNewsSeparator.insertAdjacentHTML('afterend', cardHtml);
                } else {
                    column.insertAdjacentHTML('beforeend', cardHtml);
                }
            } else {
                column.insertAdjacentHTML('afterbegin', cardHtml);
            }

            // Only add to ticker if not excluded (opinion/analysis pieces filtered out)
            if (!message.data.excludeFromTicker) {
                addToNewsTicker(
                    message.data.headline, 
                    message.data.impact || 2,
                    formatAssets(message.data),
                    message.data.link || ''
                );
            }

            const cards = column.querySelectorAll('.card');
            if (cards.length > 12) {
                cards[cards.length - 1].remove();
            }

            column.scrollTop = 0;
        }

        function formatAssets(data) {
            if (data.probNudge && data.probNudge.length > 0) {
                return data.probNudge.map(p => 
                    `${p.label.toUpperCase()}${p.dir === 'up' ? '' : ''}`
                ).join(' ');
            }
            return '';
        }

        function getColumnId(category) {
            const mapping = {
                'breaking': 'breakingColumn',
                'macro': 'macroColumn',
                'geo': 'geoColumn',
                'commodity': 'commodityColumn',
                'market': 'breakingColumn',
                'fx': 'fxColumn',
                'prediction': 'predictionColumn'
            };
            return mapping[category] || 'breakingColumn';
        }

        function getRiskEmoji(risk) {
            if (risk <= 30) return '[LOW]';
            if (risk <= 60) return '[MED]';
            if (risk <= 85) return '[HIGH]';
            return '[CRIT]';
        }

        function createCardHtml(data) {
            const impactDots = Array(3).fill(0).map((_, i) => 
                `<div class="impact-dot ${i < (data.impact || 2) ? 'active' : ''}"></div>`
            ).join('');

            const pubDateHtml = data.pubDate ? `  ${data.pubDate}` : '';
            const sourceHtml = data.source ? 
                `<div class="card-source">${data.source}${data.verified ? ' [V]' : ''}${pubDateHtml}</div>` : '';
            
            // Regime badge if detected
            const regimeHtml = data.regime ? 
                `<div class="regime-badge">${data.regime} REGIME</div>` : '';
            
            const implicationsHtml = data.implications && data.implications.length > 0 ?
                `<ul class="card-implications">
                    ${data.implications.map(imp => `<li>${imp}</li>`).join('')}
                </ul>` : '';

            // Enhanced Sentinel Data Panel (The Every Framework - Layer 9)
            // Shows full quant context on news cards including macro state
            let sentinelHtml = '';
            if (data.sentinelData) {
                const s = data.sentinelData;
                const macroColors = {
                    'WRECKING BALL': '#00D9FF',
                    'CHINA DEFLATION': '#ffbb33',
                    'DRAGONBEAR': '#a855f7',
                    'FED TRAP': '#ff4466',
                    'RISK-OFF': '#ff6b6b'
                };
                const regimeColors = {
                    'BULLISH': '#4ade80',
                    'BEARISH': '#ff6b6b',
                    'DISTRIBUTION': '#fbbf24',
                    'ACCUMULATION': '#3b82f6',
                    'NEUTRAL': '#6a7585'
                };
                const macroColor = macroColors[s.macroContext] || '#ffbb33';
                const regimeColor = regimeColors[s.regime] || '#6a7585';
                
                // Macro context badge (if present)
                const macroBadge = s.macroContext ? 
                    `<div style="background:${macroColor}15;border:1px solid ${macroColor};border-radius:3px;padding:3px 6px;color:${macroColor};font-size:0.6rem;font-weight:700;text-align:center;margin-bottom:6px;letter-spacing:0.5px;">${s.macroContext}</div>` : '';
                
                // Signal badge
                let signalHtml = '';
                if (s.signal) {
                    const signalColor = s.signal.includes('BULL') || s.signal.includes('UP') ? '#4ade80' : 
                                       s.signal.includes('BEAR') || s.signal.includes('DOWN') ? '#ff6b6b' : '#00D9FF';
                    signalHtml = `<span style="background:${signalColor}22;color:${signalColor};padding:2px 5px;border-radius:2px;font-size:0.55rem;font-weight:600;">${s.signal}</span>`;
                }
                
                sentinelHtml = `
                    <div style="background:rgba(26, 31, 43, 0.8);border:1px solid rgba(0, 217, 255, 0.3);border-radius:4px;padding:8px;margin:8px 0;">
                        ${macroBadge}
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                            <span style="color:#00D9FF;font-weight:700;font-size:0.75rem;">${s.symbol}</span>
                            <span style="color:#e2e8f0;font-weight:600;font-size:0.8rem;">$${s.current}</span>
                        </div>
                        <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:6px;">
                            <span style="background:${regimeColor}22;color:${regimeColor};padding:2px 5px;border-radius:2px;font-size:0.55rem;font-weight:600;">${s.regime || 'NEUTRAL'}</span>
                            ${s.structure !== 'TRENDING' ? `<span style="background:#00D9FF22;color:#00D9FF;padding:2px 5px;border-radius:2px;font-size:0.55rem;font-weight:600;">${s.structure}</span>` : ''}
                            ${s.momentum && s.momentum !== 'NEUTRAL' ? `<span style="background:${s.momentum.includes('UP') ? '#4ade80' : '#ff6b6b'}22;color:${s.momentum.includes('UP') ? '#4ade80' : '#ff6b6b'};padding:2px 5px;border-radius:2px;font-size:0.55rem;font-weight:600;">${s.momentum}</span>` : ''}
                            ${signalHtml}
                        </div>
                        <div style="display:flex;justify-content:space-between;font-size:0.6rem;color:#9ca3af;">
                            <span style="color:#ff6b6b;">RES: ${s.resistance}</span>
                            <span style="color:#4ade80;">SUP: ${s.support}</span>
                        </div>
                        ${s.zScore ? `<div style="font-size:0.55rem;color:#6a7585;margin-top:4px;text-align:center;">Z-Score: ${s.zScore} (${s.zScoreLabel})</div>` : ''}
                    </div>
                `;
            }
            
            // Technical levels displayed as tripwires (fallback when no Sentinel data)
            const tripwireHtml = (!data.sentinelData && data.tripwires && data.tripwires.length > 0) ? `
                <div class="tripwire-section">
                    <div class="tripwire-title">KEY LEVELS</div>
                    ${data.tripwires.map(tw => `<div class="tripwire-item">${tw}</div>`).join('')}
                </div>
            ` : '';

            const probHtml = data.probNudge && data.probNudge.length > 0 ? `
                <div class="probability-nudge">
                    ${data.probNudge.map(p => `
                        <div class="prob-item">
                            <span>${p.label}</span>
                            <span class="prob-arrow ${p.dir === 'up' ? 'prob-up' : 'prob-down'}">
                                ${p.dir === 'up' ? '' : ''}
                            </span>
                        </div>
                    `).join('')}
                </div>
            ` : '';

            // Next events section
            const nextEventsHtml = data.nextEvents && data.nextEvents.length > 0 ? `
                <div class="next-events">
                    <div class="next-events-title">Watch Next</div>
                    ${data.nextEvents.map(event => `<div class="next-event-item">${event}</div>`).join('')}
                </div>
            ` : '';

            // Market Risk bar (backward compatible with old confidence field)
            const riskValue = data.marketRisk || data.confidence;
            const getRiskClass = (val) => {
                if (val <= 20) return 'risk-low';
                if (val <= 40) return 'risk-medium';
                if (val <= 60) return 'risk-elevated';
                if (val <= 80) return 'risk-high';
                return 'risk-critical';
            };
            const confidenceHtml = riskValue ? `
                <div class="confidence-bar">
                    <div class="confidence-label">Market Risk: ${riskValue}%</div>
                    <div class="confidence-track">
                        <div class="confidence-fill ${getRiskClass(riskValue)}" style="width: ${riskValue}%"></div>
                    </div>
                </div>
            ` : '';

            const filteredTags = data.tags ? data.tags.filter(tag => tag !== 'DEVELOPING') : [];
            
            // Build horizon tag
            const horizon = data.horizon || 'DAYS';
            const horizonClass = 'horizon-' + horizon.toLowerCase().replace(/\//g, '-');
            const horizonTag = horizon ? `<span class="news-tag ${horizonClass}">${horizon}</span>` : '';
            
            const tagsHtml = (filteredTags.length > 0 || horizon) ? `
                <div class="news-tags">
                    ${horizonTag}
                    ${filteredTags.map(tag => {
                        const tagClass = tag.toLowerCase().replace(/[\s-]/g, '-');
                        const emoji = getTagEmoji(tag);
                        return `<span class="news-tag ${tagClass}">${emoji} ${tag}</span>`;
                    }).join('')}
                </div>
            ` : '';

            const cardId = 'card-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            cardDataStore[cardId] = {
                headline: data.headline,
                link: data.link || '',
                source: data.source || '',
                implications: data.implications || []
            };
            
            const displayHeadline = toTitleCase(data.headline);
            const headlineHtml = data.link 
                ? `<a href="${data.link}" target="_blank" rel="noopener noreferrer" class="card-headline">${displayHeadline}</a>`
                : `<div class="card-headline">${displayHeadline}</div>`;
            
            return `
                <div class="card" id="${cardId}">
                    <div class="card-timestamp">${data.time} UTC</div>
                    ${sourceHtml}
                    ${regimeHtml}
                    ${headlineHtml}
                    ${implicationsHtml}
                    ${sentinelHtml}
                    <div class="card-meta">
                        <div class="meta-item deep-analysis-btn" onclick="analyzeHeadline('${cardId}')">
                            <span class="analysis-text">GET DEEP AI ANALYSIS</span>
                        </div>
                    </div>
                    ${tripwireHtml}
                    ${nextEventsHtml}
                    ${probHtml}
                    ${confidenceHtml}
                    ${tagsHtml}
                </div>
            `;
        }

        function getTagEmoji(tag) {
            return '';
        }

        function updateMarketData(marketData) {
            updateMarketTicker(marketData);
        }

        // Central Bank Meeting Schedules - Update these after each meeting
        // Format: [month, day] pairs for the full year
        const cbMeetingSchedules = {
            fed: { 
                rate: '4.50%', 
                currency: 'USD',
                meetings2025: [[1,29],[3,19],[5,7],[6,18],[7,30],[9,17],[11,5],[12,17]],
                meetings2026: [[1,28],[3,18],[5,6],[6,17],[7,29],[9,16],[11,4],[12,16]]
            },
            ecb: { 
                rate: '2.75%', 
                currency: 'EUR',
                meetings2025: [[1,30],[3,6],[4,17],[6,5],[7,17],[9,11],[10,30],[12,18]],
                meetings2026: [[1,22],[3,5],[4,16],[6,4],[7,16],[9,10],[10,29],[12,17]]
            },
            boe: { 
                rate: '4.50%', 
                currency: 'GBP',
                meetings2025: [[2,6],[3,20],[5,8],[6,19],[8,7],[9,18],[11,6],[12,18]],
                meetings2026: [[2,5],[3,19],[5,7],[6,18],[8,6],[9,17],[11,5],[12,17]]
            },
            boj: { 
                rate: '0.50%', 
                currency: 'JPY',
                meetings2025: [[1,24],[3,14],[5,1],[6,17],[7,31],[9,19],[10,31],[12,19]],
                meetings2026: [[1,23],[3,13],[4,30],[6,16],[7,30],[9,18],[10,30],[12,18]]
            },
            rba: { 
                rate: '4.10%', 
                currency: 'AUD',
                meetings2025: [[2,18],[4,1],[5,20],[7,8],[8,12],[9,30],[11,4],[12,9]],
                meetings2026: [[2,17],[4,7],[5,19],[7,7],[8,11],[9,29],[11,3],[12,8]]
            }
        };

        function getNextCBMeeting(bank) {
            const now = new Date();
            const currentYear = now.getFullYear();
            const schedule = cbMeetingSchedules[bank];
            if (!schedule) return 'TBD';
            
            const meetings = currentYear === 2025 ? schedule.meetings2025 : 
                            currentYear === 2026 ? schedule.meetings2026 : schedule.meetings2026;
            
            for (const [month, day] of meetings) {
                const meetingDate = new Date(currentYear, month - 1, day);
                if (meetingDate >= now) {
                    const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                    return `${monthNames[month - 1]} ${day}`;
                }
            }
            // If all meetings passed, get first of next year
            const nextYearMeetings = currentYear === 2025 ? schedule.meetings2026 : schedule.meetings2026;
            if (nextYearMeetings && nextYearMeetings.length > 0) {
                const [month, day] = nextYearMeetings[0];
                const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                return `${monthNames[month - 1]} ${day}`;
            }
            return 'TBD';
        }

        function renderCentralBankRates() {
            const banks = [
                { id: 'fed', name: 'Fed' },
                { id: 'ecb', name: 'ECB' },
                { id: 'boe', name: 'BOE' },
                { id: 'boj', name: 'BOJ' },
                { id: 'rba', name: 'RBA' }
            ];
            
            return banks.map(bank => {
                const schedule = cbMeetingSchedules[bank.id];
                return `
                    <div class="cb-rate-item">
                        <div class="cb-rate-left">
                            <span class="cb-rate-bank">${bank.name}</span>
                            <span class="cb-rate-currency">(${schedule.currency})</span>
                        </div>
                        <div class="cb-rate-right">
                            <span class="cb-rate-value">${schedule.rate}</span>
                            <span class="cb-rate-next"> ${getNextCBMeeting(bank.id)}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateMacroData(macroData) {
            const macroColumn = document.getElementById('macroColumn');
            if (!macroData || (!macroData.yields && !macroData.indicators)) return;

            const getMacroArrow = (dir) => dir === 'up' ? '' : dir === 'down' ? '' : '';
            
            const yieldsHtml = macroData.yields ? macroData.yields.map(item => `
                <div class="macro-grid-item ${item.tripwireHit ? 'tripwire-hit' : ''}" onclick="openChart('${item.tvSymbol || ''}')" style="cursor: pointer;" title="Click to open ${item.label} chart">
                    <div class="macro-item-left" style="width:100%;">
                        <div class="macro-item-label">${item.label}</div>
                        <div style="display:flex;align-items:center;justify-content:space-between;width:100%;">
                            <div style="display:flex;align-items:center;gap:0.2rem;">
                                <div class="macro-item-value">${item.value}</div>
                                <span class="${getMacroClass(item.dir)}" style="font-size:0.55rem;">${getMacroArrow(item.dir)}</span>
                            </div>
                            <div class="macro-item-change ${getMacroClass(item.dir)}">${item.change}</div>
                        </div>
                    </div>
                </div>
            `).join('') : '';

            const indicatorsHtml = macroData.indicators ? macroData.indicators.map(item => `
                <div class="macro-grid-item ${item.tripwireHit ? 'tripwire-hit' : ''}" onclick="${item.fredId ? `window.open('https://fred.stlouisfed.org/series/${item.fredId}', '_blank')` : ''}" style="cursor: pointer;">
                    <div class="macro-item-left" style="width:100%;">
                        <div class="macro-item-label">${item.label}</div>
                        <div style="display:flex;align-items:center;justify-content:space-between;width:100%;">
                            <div style="display:flex;align-items:center;gap:0.2rem;">
                                <div class="macro-item-value">${item.value}</div>
                                <span class="${getMacroClass(item.dir)}" style="font-size:0.55rem;">${getMacroArrow(item.dir)}</span>
                            </div>
                            <div class="macro-item-change ${getMacroClass(item.dir)}">${item.change}</div>
                        </div>
                    </div>
                </div>
            `).join('') : '';

            const cbRatesHtml = renderCentralBankRates();

            // Update the existing BASE LAYER grid with new content
            const baseLayerGrid = macroColumn.querySelector('#baseLayerGrid');
            if (baseLayerGrid) {
                baseLayerGrid.innerHTML = `
                    <div class="macro-dashboard-title" style="color: #3399FF;">BASE LAYER</div>
                    <div class="macro-dashboard-subtitle">Yields  Liquidity</div>
                    <div class="macro-grid">
                        <div class="macro-grid-column">
                            ${yieldsHtml}
                        </div>
                        <div class="macro-grid-column">
                            ${indicatorsHtml}
                        </div>
                    </div>
                    <div style="display:flex;align-items:center;gap:6px;margin-top:8px;padding:4px 8px;font-size:9px;color:#6a7585;border-top:1px solid rgba(255,255,255,0.05);">
                        <span>* Click yields for charts, indicators for FRED data</span>
                    </div>
                    <div style="display:flex;align-items:center;justify-content:space-between;gap:6px;margin-top:6px;padding:4px 8px;font-size:9px;color:#6a7585;">
                        <div style="display:flex;align-items:center;gap:6px;">
                            <span style="display:inline-block;width:12px;height:3px;background:var(--accent-red);border-radius:1px;"></span>
                            <span>Tripwire breached</span>
                        </div>
                        <button class="know-more-btn" onclick="openRatesLegend()">
                            <span>KNOW MORE</span>
                        </button>
                    </div>
                    <div class="cb-rates-section" style="margin-top:10px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.08);">
                        <div class="cb-rates-title" style="font-size:0.7rem;font-weight:700;color:#3b82f6;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;text-align:center;">CENTRAL BANK RATES</div>
                        <div id="cbRates">${cbRatesHtml}</div>
                    </div>
                `;
            }
        }

        function getMacroClass(dir) {
            return dir === 'up' ? 'macro-up' : 
                   dir === 'down' ? 'macro-down' : 
                   'macro-neutral';
        }


        function updateFXData(fxData) {
            if (!fxData || (!fxData.macro && !fxData.geo && !fxData.commodity)) return;
            fxDataStore = fxData;

            const fxMacroContainer = document.getElementById('fxMacro');
            const fxGeoContainer = document.getElementById('fxGeo');
            const fxCommodityContainer = document.getElementById('fxCommodity');

            const renderFXPair = (pair) => `
                <div class="fx-pair-item" onclick="openChart('${pair.tvSymbol || pair.label}')" title="Click to open ${pair.label} chart">
                    <div class="fx-pair-left" style="width:100%;">
                        <div class="fx-pair-label">${pair.label}</div>
                        <div style="display:flex;align-items:center;justify-content:space-between;width:100%;">
                            <div style="display:flex;align-items:center;gap:0.2rem;">
                                <div class="fx-pair-price">${pair.price}</div>
                                <span class="${getFXClass(pair.dir)}" style="font-size:0.55rem;">${getFXArrow(pair.dir)}</span>
                            </div>
                            <div class="fx-pair-change ${getFXClass(pair.dir)}" style="font-size:0.65rem;">${pair.change}%</div>
                        </div>
                    </div>
                </div>
            `;

            // Update MACRO PLUMBING (10 pairs)
            if (fxData.macro && fxMacroContainer) {
                fxMacroContainer.innerHTML = fxData.macro.map(renderFXPair).join('');
            }

            // Update GEOPOLITICS (10 pairs)
            if (fxData.geo && fxGeoContainer) {
                fxGeoContainer.innerHTML = fxData.geo.map(renderFXPair).join('');
            }

            // Update COMMODITIES (10 pairs)
            if (fxData.commodity && fxCommodityContainer) {
                fxCommodityContainer.innerHTML = fxData.commodity.map(renderFXPair).join('');
            }

            updateSuperTicker();
        }

        function getFXClass(dir) {
            return dir === 'up' ? 'fx-up' : 
                   dir === 'down' ? 'fx-down' : 
                   'fx-neutral';
        }

        function getFXArrow(dir) {
            return dir === 'up' ? '' : 
                   dir === 'down' ? '' : 
                   '';
        }

        let commodityDataStore = { metals: [], energy: [], agriculture: [] };

        function updateCommodityData(commodityData) {
            if (!commodityData) return;
            commodityDataStore = commodityData;

            const metalsContainer = document.getElementById('commodityMetals');
            const energyContainer = document.getElementById('commodityEnergy');
            const agricultureContainer = document.getElementById('commodityAgriculture');

            const renderCommodity = (item) => `
                <div class="commodity-item" onclick="openChart('${item.tvSymbol || item.ticker || item.label}')" style="cursor: pointer;" title="Click to open ${item.label} chart">
                    <div class="commodity-item-left" style="width:100%;">
                        <div class="commodity-item-label">${item.label}</div>
                        <div style="display:flex;align-items:center;justify-content:space-between;width:100%;">
                            <div style="display:flex;align-items:center;gap:0.2rem;">
                                <div class="commodity-item-price">${item.price}</div>
                                <span class="${getCommodityClass(item.dir)}" style="font-size:0.55rem;">${getCommodityArrow(item.dir)}</span>
                            </div>
                            <div class="commodity-item-change ${getCommodityClass(item.dir)}" style="font-size:0.65rem;">${item.change}%</div>
                        </div>
                    </div>
                </div>
            `;

            const sortAlpha = (arr) => [...arr].sort((a, b) => a.label.localeCompare(b.label));
            
            // Energy sort: WTI first, then alphabetical
            const sortEnergy = (arr) => {
                const wti = arr.filter(c => c.label === 'WTI');
                const rest = arr.filter(c => c.label !== 'WTI').sort((a, b) => a.label.localeCompare(b.label));
                return [...wti, ...rest];
            };

            if (commodityData.metals && metalsContainer) {
                metalsContainer.innerHTML = sortAlpha(commodityData.metals).map(renderCommodity).join('');
            }
            if (commodityData.energy && energyContainer) {
                energyContainer.innerHTML = sortEnergy(commodityData.energy).map(renderCommodity).join('');
            }
            if (commodityData.agriculture && agricultureContainer) {
                agricultureContainer.innerHTML = sortAlpha(commodityData.agriculture).map(renderCommodity).join('');
            }

            updateSuperTicker();
        }

        function getCommodityClass(dir) {
            return dir === 'up' ? 'commodity-up' : 
                   dir === 'down' ? 'commodity-down' : 
                   'commodity-neutral';
        }

        function getCommodityArrow(dir) {
            return dir === 'up' ? '' : 
                   dir === 'down' ? '' : 
                   '';
        }

        // SYSTEMIC WATCHLIST
        let systemicWatchlistStore = { quadrant1: [], quadrant2: [], quadrant3: [], quadrant4: [] };

        function updateSystemicWatchlist(data) {
            if (!data) return;
            systemicWatchlistStore = data;

            const q1Container = document.getElementById('systemicQuadrant1');
            const q2Container = document.getElementById('systemicQuadrant2');
            const q3Container = document.getElementById('systemicQuadrant3');
            const q4Container = document.getElementById('systemicQuadrant4');

            const getSystemicArrow = (dir) => dir === 'up' ? '' : dir === 'down' ? '' : '';
            
            const renderItem = (item) => `
                <div class="systemic-item" onclick="openChart('${item.tvSymbol || item.symbol}')" title="Click to open ${item.label} chart">
                    <div class="systemic-item-left" style="width:100%;">
                        <div class="systemic-item-label">${item.label}</div>
                        <div style="display:flex;align-items:center;justify-content:space-between;width:100%;">
                            <div style="display:flex;align-items:center;gap:0.2rem;">
                                <div class="systemic-item-price">${item.price}</div>
                                <span class="systemic-item-arrow ${getSystemicClass(item.dir)}">${getSystemicArrow(item.dir)}</span>
                            </div>
                            <div class="systemic-item-change ${getSystemicClass(item.dir)}" style="font-size:0.6rem;">${item.change}%</div>
                        </div>
                    </div>
                </div>
            `;

            if (data.quadrant1 && q1Container) {
                q1Container.innerHTML = data.quadrant1.map(renderItem).join('');
            }
            if (data.quadrant2 && q2Container) {
                q2Container.innerHTML = data.quadrant2.map(renderItem).join('');
            }
            if (data.quadrant3 && q3Container) {
                q3Container.innerHTML = data.quadrant3.map(renderItem).join('');
            }
            if (data.quadrant4 && q4Container) {
                q4Container.innerHTML = data.quadrant4.map(renderItem).join('');
            }

            updateSuperTicker();
        }

        function getSystemicClass(dir) {
            return dir === 'up' ? 'commodity-up' : 
                   dir === 'down' ? 'commodity-down' : 
                   'commodity-neutral';
        }

        function getMarketClass(dir) {
            return dir === 'up' ? 'market-up' : 
                   dir === 'down' ? 'market-down' : 
                   'market-neutral';
        }

        // ========================================================================
        // PREDICTION MARKETS UPDATE
        // ========================================================================
        
        function updatePredictionData(data) {
            if (!data) return;
            
            const polymarketList = document.getElementById('polymarketList');
            
            // Update unified systemic dashboard with sentiment data
            if (data.sentiment) {
                updateSentimentCache(data.sentiment);
            }
            
            // Update Polymarket odds
            if (data.markets && polymarketList) {
                if (data.markets.length === 0) {
                    polymarketList.innerHTML = '<div class="polymarket-empty">Loading prediction markets...</div>';
                    return;
                }
                
                polymarketList.innerHTML = data.markets.map(market => {
                    const probNum = parseFloat(market.probability);
                    const probColor = probNum >= 70 ? '#22c55e' : probNum >= 50 ? '#eab308' : probNum >= 30 ? '#f97316' : '#ef4444';
                    const dirArrow = market.direction === 'up' ? '' : market.direction === 'down' ? '' : '';
                    const categoryClass = market.category.toLowerCase();
                    
                    return `
                        <div class="polymarket-item" onclick="window.open('https://polymarket.com/', '_blank')">
                            <div class="polymarket-header">
                                <span class="polymarket-category cat-${categoryClass}">${market.category}</span>
                                <span class="polymarket-prob" style="color: ${probColor}">${market.probability}% ${dirArrow}</span>
                            </div>
                            <div class="polymarket-question">${market.question}</div>
                        </div>
                    `;
                }).join('');
            }
        }

        // ========================================================================
        // GAME THEORY ENGINE UI
        // ========================================================================
        
        // Store game data for analysis lookup
        const gameDataStore = {};
        
        // Criticality scoring for game theory conflicts - matches globe CRITICALITY_SCORES
        const GAME_CRITICALITY_SCORES = {
            'ESCALATION': 100,
            'BRINKMANSHIP': 90,
            'CRITICAL': 85,
            'CONFLICT': 80,
            'ATTRITION': 75,
            'VOLATILE': 70,
            'SKIRMISHING': 65,
            'SUPPRESSION': 60,
            'FRAGMENTATION': 55,
            'STANDOFF': 50,
            'POSTURING': 45,
            'CAT & MOUSE': 40,
            'COORDINATION': 35,
            'ADAPTATION': 30,
            'TENSE': 25,
            'SHIFTING': 20,
            'STABLE': 10
        };
        
        function getGameCriticalityScore(game) {
            // Try to match currentPhase to criticality score
            const phase = (game.currentPhase || '').toUpperCase();
            return GAME_CRITICALITY_SCORES[phase] || 50;
        }
        
        let cachedGames = [];
        
        function updateGameTheoryData(data) {
            if (!data || !data.games) return;
            
            const gameTheoryList = document.getElementById('gameTheoryList');
            if (!gameTheoryList) return;
            
            const games = Object.values(data.games);
            cachedGames = games;
            
            // Update active badge count
            const activeBadge = document.getElementById('activeBadge');
            const activeBadgeCount = document.getElementById('activeBadgeCount');
            if (activeBadge && activeBadgeCount) {
                activeBadgeCount.textContent = games.length;
            }
            
            // Update kinetic panel active count
            const kineticActiveCount = document.getElementById('kineticActiveCount');
            if (kineticActiveCount) {
                kineticActiveCount.textContent = games.length;
            }
            
            // Update active tooltip
            updateActiveTooltip(games);
            
            if (games.length === 0) {
                gameTheoryList.innerHTML = '<div class="game-theory-loading">No active games tracked</div>';
                return;
            }
            
            // Sort by criticality score (highest severity first)
            games.sort((a, b) => getGameCriticalityScore(b) - getGameCriticalityScore(a));
            
            // Store game data for later lookup
            games.forEach(game => {
                gameDataStore[game.id] = game;
            });
            
            gameTheoryList.innerHTML = games.map(game => {
                const moveTypeClass = game.lastMove.type === 'DEFECT' ? 'move-type-defect' : 
                                     game.lastMove.type === 'COOPERATE' ? 'move-type-cooperate' : 'move-type-signal';
                
                const escalationLevel = game.escalationLevel || 1;
                const escalationColor = escalationLevel <= 2 ? '#22c55e' : escalationLevel === 3 ? '#f59e0b' : '#ef4444';
                const proxies = game.proxies || [];
                const resource = game.resource || 'NONE';
                
                const proxyBadges = proxies.length > 0 ? proxies.map(p => 
                    `<span class="proxy-badge">${p}</span>`
                ).join('') : '';
                
                const resourceBadge = resource && resource !== 'NONE' ? 
                    `<span class="resource-badge">${resource}</span>` : '';
                
                return `
                    <div class="game-card status-${game.statusColor}">
                        <div class="game-header">
                            <span class="game-title">${game.title}</span>
                            <span class="escalation-level" style="background: ${escalationColor}20; color: ${escalationColor}; border: 1px solid ${escalationColor};">LVL ${escalationLevel}</span>
                        </div>
                        ${(proxyBadges || resourceBadge) ? `
                        <div class="proxy-decoder-row">
                            ${proxyBadges}
                            ${resourceBadge}
                        </div>
                        ` : ''}
                        <div class="game-players">${game.players.join(' vs ')}</div>
                        <div class="game-last-move">
                            <div class="game-move-label">Last Move (${game.lastMove.date})</div>
                            <div class="game-move-text">
                                <strong>${game.lastMove.player}:</strong> ${game.lastMove.action}
                                <span class="game-move-type ${moveTypeClass}">${game.lastMove.type}</span>
                            </div>
                        </div>
                        <div class="game-equilibrium">
                            <span class="equilibrium-dot eq-${game.statusColor}"></span>
                            <span class="equilibrium-text" style="color: ${game.statusColor === 'green' ? '#22c55e' : game.statusColor === 'yellow' ? '#f59e0b' : '#ef4444'}">${game.equilibriumStatus}</span>
                        </div>
                        <div class="game-next-move">${game.nextLikelyMove}</div>
                        <div class="game-buttons-row">
                            <div class="game-analyze-btn" onclick="analyzeGameConflict('${game.id}')">
                                <span>GET AI ANALYSIS</span>
                            </div>
                            <div class="game-map-btn" onclick="openConflictMap('${game.id}')">
                                <span>VIEW MAP</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateActiveTooltip(games) {
            const tooltip = document.getElementById('activeTooltip');
            if (!tooltip) return;
            
            if (!games || games.length === 0) {
                tooltip.innerHTML = '<div class="tooltip-empty">No active conflicts</div>';
                return;
            }
            
            // Group conflicts by continent/region
            const regionCounts = {};
            games.forEach(game => {
                const region = game.region || game.continent || 'GLOBAL';
                regionCounts[region] = (regionCounts[region] || 0) + 1;
            });
            
            // Sort regions by count (highest first)
            const sortedRegions = Object.entries(regionCounts)
                .sort((a, b) => b[1] - a[1]);
            
            const items = sortedRegions.map(([region, count]) => `
                <div class="tooltip-region-row">
                    <span class="tooltip-region-name">${region}</span>
                    <span class="tooltip-region-count">${count}</span>
                </div>
            `).join('');
            
            tooltip.innerHTML = `
                <div class="tooltip-title">Active Conflicts</div>
                ${items}
            `;
        }
        
        // ========================================================================
        // GEMINI AI ANALYSIS MODAL
        // ========================================================================
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }


        function analyzeGameConflict(gameId) {
            const game = gameDataStore[gameId];
            if (!game) {
                console.error('Game data not found for:', gameId);
                return;
            }

            const modal = document.getElementById('analysisModal');
            const modalHeadline = document.getElementById('modalHeadline');
            const modalBody = document.getElementById('modalBody');
            const modalSource = document.getElementById('modalSource');

            modalHeadline.textContent = game.title;
            modalSource.innerHTML = `<span class="modal-source-label">Players:</span>${game.players.join(' vs ')}`;
            modalBody.innerHTML = `
                <div class="modal-loading">
                    <div class="modal-spinner"></div>
                    <div class="modal-loading-text">Analyzing strategic conflict with Gemini AI...<br><span style="font-size: 0.85em; opacity: 0.8;">Generating comprehensive game theory analysis</span></div>
                    <div style="margin-top: 1.5rem; padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 6px; max-width: 400px;">
                        <p style="font-size: 0.7rem; color: #6a7585; line-height: 1.4; text-align: center; margin: 0;">
                            <strong>DISCLAIMER:</strong> This is not financial advice. I am not a financial advisor. This content is for informational and educational purposes only. Investing involves risk, and you should always do your own due diligence (DYOR) and consult with a professional financial advisor before making any investment decisions.
                        </p>
                    </div>
                </div>
            `;

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            fetch('/api/analyze-game', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    gameId: game.id,
                    title: game.title,
                    players: game.players,
                    currentPhase: game.currentPhase,
                    lastMove: game.lastMove,
                    equilibriumStatus: game.equilibriumStatus,
                    nextLikelyMove: game.nextLikelyMove
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.analysis) {
                    modalBody.innerHTML = `<div class="modal-analysis">${parseMarkdown(data.analysis)}</div>`;
                } else {
                    modalBody.innerHTML = `<div class="modal-error">${data.error || 'Failed to analyze. Please try again.'}</div>`;
                }
            })
            .catch(error => {
                console.error('Game analysis error:', error);
                modalBody.innerHTML = `<div class="modal-error">Network error. Please try again.</div>`;
            });
        }

        function analyzeHeadline(cardId) {
            const cardData = cardDataStore[cardId];
            if (!cardData) {
                console.error('Card data not found for:', cardId);
                return;
            }

            const headline = cardData.headline;
            const source = cardData.source;
            const link = cardData.link || '';
            const implications = cardData.implications || [];

            const modal = document.getElementById('analysisModal');
            const modalHeadline = document.getElementById('modalHeadline');
            const modalBody = document.getElementById('modalBody');
            const modalSource = document.getElementById('modalSource');

            modalHeadline.textContent = headline;
            modalSource.innerHTML = source ? `<span class="modal-source-label">Source:</span>${source}` : '';
            modalBody.innerHTML = `
                <div class="modal-loading">
                    <div class="modal-spinner"></div>
                    <div class="modal-loading-text">Analyzing with Gemini AI...<br><span style="font-size: 0.85em; opacity: 0.8;">Reading full article for deep analysis...</span></div>
                    <div style="margin-top: 1.5rem; padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 6px; max-width: 400px;">
                        <p style="font-size: 0.7rem; color: #6a7585; line-height: 1.4; text-align: center; margin: 0;">
                            <strong>DISCLAIMER:</strong> This is not financial advice. I am not a financial advisor. This content is for informational and educational purposes only. Investing involves risk, and you should always do your own due diligence (DYOR) and consult with a professional financial advisor before making any investment decisions.
                        </p>
                    </div>
                </div>
            `;

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            fetch('/api/analyze-headline', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ headline, source, link, implications })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.analysis) {
                    modalBody.innerHTML = `<div class="modal-analysis">${parseMarkdown(data.analysis)}</div>`;
                } else {
                    modalBody.innerHTML = `<div class="modal-error">${data.error || 'Failed to analyze. Please try again.'}</div>`;
                }
            })
            .catch(error => {
                console.error('Analysis error:', error);
                modalBody.innerHTML = `<div class="modal-error">Network error. Please try again.</div>`;
            });
        }

        function closeModal() {
            const modal = document.getElementById('analysisModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        document.getElementById('analysisModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
                closeChart();
            }
        });

        // ========================================================================
        // TRADINGVIEW CHART POPUP
        // ========================================================================

        function openChart(tvSymbol) {
            const modal = document.getElementById('chartModal');
            modal.style.display = 'flex';
            
            // Clear previous chart
            document.getElementById('tradingview_widget').innerHTML = '';
            
            // Create TradingView widget
            new TradingView.widget({
                "width": "100%",
                "height": "100%",
                "symbol": tvSymbol,
                "interval": "D",
                "timezone": "Etc/UTC",
                "theme": "dark",
                "style": "1",
                "locale": "en",
                "toolbar_bg": "#131722",
                "enable_publishing": false,
                "allow_symbol_change": true,
                "save_image": false,
                "container_id": "tradingview_widget",
                "hide_top_toolbar": false,
                "hide_legend": false,
                "withdateranges": true,
                "studies": [
                    "MASimple@tv-basicstudies",
                    "RSI@tv-basicstudies"
                ]
            });
        }

        function closeChart(event) {
            document.getElementById('chartModal').style.display = 'none';
        }
        
        function stopChartPropagation(event) {
            event.stopPropagation();
        }

        function openInfoModal() {
            document.getElementById('infoModal').style.display = 'flex';
        }

        function closeInfoModal(event) {
            if (!event || event.target.id === 'infoModal') {
                document.getElementById('infoModal').style.display = 'none';
            }
        }

        // ESC key closes info modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeInfoModal();
            }
        });

        function searchSymbol() {
            const input = document.getElementById('symbolSearchInput');
            const symbol = input.value.trim().toUpperCase();
            if (symbol) {
                openChart(symbol);
                input.value = '';
                document.getElementById('tickerSearchPopup').classList.remove('active');
            }
        }

        (function() {
            const ticker = document.getElementById('marketTicker');
            const popup = document.getElementById('tickerSearchPopup');
            const input = document.getElementById('symbolSearchInput');
            let hoverTimeout;

            if (ticker && popup) {
                ticker.addEventListener('mouseenter', function() {
                    hoverTimeout = setTimeout(function() {
                        popup.classList.add('active');
                    }, 500);
                });

                ticker.addEventListener('mouseleave', function(e) {
                    clearTimeout(hoverTimeout);
                    if (!popup.contains(e.relatedTarget)) {
                        popup.classList.remove('active');
                    }
                });

                popup.addEventListener('mouseleave', function() {
                    popup.classList.remove('active');
                });

                if (input) {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            searchSymbol();
                        }
                    });
                }
            }
        })();

        function parseMarkdown(text) {
            // Section headers like IMPACT, TRADE, 2ND ORDER, KEY LEVELS, TIMELINE, GAME THEORY
            const sectionHeaders = ['IMPACT', 'TRADE', '2ND ORDER', 'KEY LEVELS', 'TIMELINE', 'GAME THEORY', 'SUMMARY', 'RISK', 'OUTLOOK'];
            
            let result = text
                // First, detect standalone section headers (on their own line, possibly with ** around them)
                .replace(/^\*\*(IMPACT|TRADE|2ND ORDER|KEY LEVELS|TIMELINE|GAME THEORY|SUMMARY|RISK|OUTLOOK)\*\*:?$/gim, '<div class="analysis-section-header">$1</div>')
                .replace(/^(IMPACT|TRADE|2ND ORDER|KEY LEVELS|TIMELINE|GAME THEORY|SUMMARY|RISK|OUTLOOK):?$/gim, '<div class="analysis-section-header">$1</div>')
                // Bold text for assets and prices - make them stand out
                .replace(/\*\*(.+?)\*\*/g, '<strong class="asset-highlight">$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/^### (.+)$/gm, '<h3>$1</h3>')
                .replace(/^## (.+)$/gm, '<h2>$1</h2>')
                .replace(/^# (.+)$/gm, '<h1>$1</h1>')
                .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
                .replace(/^- (.+)$/gm, '<li>$1</li>')
                .replace(/^\* (.+)$/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/gs, function(match) {
                    if (match.includes('<ul>') || match.includes('<ol>')) return match;
                    return '<ul>' + match + '</ul>';
                })
                .replace(/<\/ul>\s*<ul>/g, '')
                .replace(/\n\n/g, '</p><p>')
                .replace(/^(.+)$/gm, function(match) {
                    if (match.startsWith('<')) return match;
                    return match;
                });
            
            return result;
        }
    </script>

    <!-- TradingView Chart Modal -->
    <div id="chartModal" class="chart-modal-overlay" style="display: none;" onclick="closeChart(event)">
        <div class="chart-modal-content" onclick="event.stopPropagation()">
            <button class="chart-close-btn" onclick="closeChart(event)"></button>
            <div id="tradingview_widget"></div>
        </div>
    </div>

    <!-- TradingView Widget Library -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

    <!-- Info/Legend Modal -->
    <div id="infoModal" class="chart-modal-overlay" style="display: none;" onclick="closeInfoModal(event)">
        <div class="chart-modal-content" onclick="event.stopPropagation()" style="max-width: 700px;">
            <button class="chart-close-btn" onclick="closeInfoModal()" style="top: 10px; right: 10px; position: absolute;"></button>
            <div class="modal-title">LEGEND & KEY</div>
            <div class="modal-analysis info-modal-scroll" style="max-height: 70vh; overflow-y: auto;">
                
                <h3 style="color: var(--accent-orange); margin-top: 0;">SENTINEL LEVEL (Header Indicator)</h3>
                <p style="margin-bottom: 0.75rem; color: #9ca3af; font-size: 0.9rem;">Real-time systemic risk assessment based on 14 structural beams monitoring global financial and geopolitical stress.</p>
                
                <div style="display: grid; gap: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center; gap: 12px; padding: 8px 12px; background: rgba(34, 197, 94, 0.1); border-radius: 6px; border-left: 3px solid #22c55e;">
                        <span style="font-weight: 800; font-size: 1.1rem; color: #22c55e; min-width: 24px;">5</span>
                        <div>
                            <div style="font-weight: 700; color: #22c55e;">ALL CLEAR</div>
                            <div style="font-size: 0.8rem; color: #6a7585;">All beams stable. No systemic stress detected.</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px; padding: 8px 12px; background: rgba(212, 113, 74, 0.1); border-radius: 6px; border-left: 3px solid var(--accent-orange);">
                        <span style="font-weight: 800; font-size: 1.1rem; color: var(--accent-orange); min-width: 24px;">4</span>
                        <div>
                            <div style="font-weight: 700; color: var(--accent-orange);">ELEVATED</div>
                            <div style="font-size: 0.8rem; color: #6a7585;">1-3 beams breached OR 3+ beams arming. Increased vigilance.</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px; padding: 8px 12px; background: rgba(245, 158, 11, 0.1); border-radius: 6px; border-left: 3px solid #f59e0b;">
                        <span style="font-weight: 800; font-size: 1.1rem; color: #f59e0b; min-width: 24px;">3</span>
                        <div>
                            <div style="font-weight: 700; color: #f59e0b;">HIGH ALERT</div>
                            <div style="font-size: 0.8rem; color: #6a7585;">4-6 beams breached. Multiple stress points active. Risk-off positioning advised.</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px; padding: 8px 12px; background: rgba(239, 68, 68, 0.1); border-radius: 6px; border-left: 3px solid #ef4444;">
                        <span style="font-weight: 800; font-size: 1.1rem; color: #ef4444; min-width: 24px;">2</span>
                        <div>
                            <div style="font-weight: 700; color: #ef4444;">SEVERE</div>
                            <div style="font-size: 0.8rem; color: #6a7585;">7-10 beams breached. Systemic contagion likely. Defensive posture critical.</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px; padding: 8px 12px; background: rgba(220, 38, 38, 0.15); border-radius: 6px; border-left: 3px solid #dc2626;">
                        <span style="font-weight: 800; font-size: 1.1rem; color: #dc2626; min-width: 24px;">1</span>
                        <div>
                            <div style="font-weight: 700; color: #dc2626;">CRITICAL</div>
                            <div style="font-size: 0.8rem; color: #6a7585;">11+ beams breached. Full systemic crisis. Maximum defensive action.</div>
                        </div>
                    </div>
                </div>
                <p style="margin-left:0;color:#6a7585;font-size:0.85em; margin-bottom: 1.5rem;">The 14 structural beams track: VIX, credit spreads, yield curve, dollar strength, liquidity conditions, FX volatility, commodity shocks, sovereign stress, and more. See SYSTEMIC RISK column for full breakdown.</p>
                
                <h3 style="color: var(--accent-orange); margin-top: 1.5rem;">IMPACT DOTS (Ticker)</h3>
                <p><span style="color:#ef4444;"></span> = <strong>HIGH IMPACT</strong> - Major market mover</p>
                <p><span style="color:#ef4444;"></span><span style="color:#6a7585;"></span> = <strong>MEDIUM IMPACT</strong> - Notable event</p>
                <p><span style="color:#ef4444;"></span><span style="color:#6a7585;"></span> = <strong>LOW IMPACT</strong> - Minor news</p>
                <p style="margin-left:24px;color:#6a7585;font-size:0.95em;">Example: Fed rate decision = , earnings beat = </p>
                
                <h3 style="color: var(--accent-orange); margin-top: 1.5rem;">TRIPWIRE ALERTS (Rates Dashboard)</h3>
                <p style="display:flex;align-items:center;gap:8px;font-size:1.05em;"><span style="display:inline-block;width:16px;height:3px;background:var(--accent-red);border-radius:1px;flex-shrink:0;"></span> <strong>Threshold Breached</strong> - Indicator crossed a key level</p>
                <p style="margin-left:24px;color:#6a7585;font-size:0.95em;">Example: U6 Rate >8% signals rising unemployment stress</p>
                <p style="margin-left:24px;color:#6a7585;font-size:0.95em;">Example: SOFR >5.5% signals liquidity tightening</p>
                
                <h3 style="color: var(--accent-orange); margin-top: 1.5rem;">MARKET RISK</h3>
                <div class="legend-item"><span class="legend-icon" style="color:#22c55e;"></span><span class="legend-text"><strong>10-30%</strong> = LOW RISK - Boring news, won't move markets</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#eab308;"></span><span class="legend-text"><strong>30-60%</strong> = MEDIUM RISK - Watch, might matter</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#f97316;"></span><span class="legend-text"><strong>60-85%</strong> = HIGH RISK - Markets reacting, pay attention</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#ef4444;"></span><span class="legend-text"><strong>85-100%</strong> = CRITICAL RISK - Flash alert, all hands on deck</span></div>
                <p style="margin-left:24px;color:#6a7585;font-size:0.95em;">Example: CPI surprise = 75%, routine earnings = 25%</p>
                
                <h3 style="color: var(--accent-orange); margin-top: 1.5rem;">HORIZON (Time to Impact)</h3>
                <div class="legend-item"><span class="legend-icon" style="color:#ef4444;">!</span><span class="legend-text"><strong>NOW</strong> = Immediate impact, act now!</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#eab308;">D</span><span class="legend-text"><strong>DAYS</strong> = Coming days, plan ahead</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#3b82f6;">W</span><span class="legend-text"><strong>WEEKS</strong> = Longer term, structural shift</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#6a7585;">-</span><span class="legend-text"><strong>N/A</strong> = Not market-relevant</span></div>
                <p style="margin-left:24px;color:#6a7585;font-size:0.95em;">Example: Fed pivot = NOW, GDP revision = DAYS, trade deal talks = WEEKS</p>
                
                <h3 style="color: var(--accent-orange); margin-top: 1.5rem;">REGIME INDICATORS</h3>
                <div class="legend-item"><span class="legend-icon" style="color:#22c55e;">G</span><span class="legend-text"><strong>GOLDILOCKS</strong> = Growth Inflation<br><em>Buy: Stocks, Tech, extend duration</em></span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#f97316;">R</span><span class="legend-text"><strong>REFLATIONARY</strong> = Growth Inflation<br><em>Buy: Commodities, Value, cyclicals</em></span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#f59e0b;">S</span><span class="legend-text"><strong>STAGFLATION</strong> = Growth Inflation<br><em>Buy: Gold, TIPS, commodity producers only</em></span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#3b82f6;">D</span><span class="legend-text"><strong>DEFLATIONARY</strong> = Growth Inflation<br><em>Buy: Cash, Treasuries, USD, JPY</em></span></div>
                <p style="margin-left:24px;color:#6a7585;font-size:0.95em;">Example: Strong jobs + falling CPI = GOLDILOCKS, weak PMI + high oil = STAGFLATION</p>
                
                <h3 style="color: var(--accent-orange); margin-top: 1.5rem;">DIRECTION</h3>
                <div class="legend-item"><span class="legend-icon" style="color:#22c55e;"></span><span class="legend-text"><strong>RISK-ON</strong> = Buy risk assets (stocks, commodities, EM)</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#ef4444;"></span><span class="legend-text"><strong>RISK-OFF</strong> = Sell risk assets, buy safe havens</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#6a7585;"></span><span class="legend-text"><strong>NEUTRAL</strong> = Mixed signals, wait and see</span></div>
                <p style="margin-left:24px;color:#6a7585;font-size:0.95em;">Example: Dovish Fed = RISK-ON, war escalation = RISK-OFF</p>
                
                <h3 style="color: var(--accent-orange); margin-top: 1.5rem;">GAME THEORY PATTERNS</h3>
                <div class="legend-item"><span class="legend-icon" style="color:#ef4444;"></span><span class="legend-text"><strong>Prisoner's Dilemma</strong> = Escalation spiral risk (tariffs, retaliation)</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#f59e0b;"></span><span class="legend-text"><strong>Chicken Game</strong> = Brinkmanship, high accident risk</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#22c55e;"></span><span class="legend-text"><strong>Coordination Game</strong> = Collective action multiplies impact (G7/G20)</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#a855f7;"></span><span class="legend-text"><strong>Zero-Sum Conflict</strong> = Winner-take-all confrontation</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#3b82f6;"></span><span class="legend-text"><strong>Reputation Game</strong> = Credibility stakes, precedent-setting</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#00D9FF;"></span><span class="legend-text"><strong>Signaling Game</strong> = Forward guidance, market expectation shaping</span></div>
                <p style="margin-left:24px;color:#6a7585;font-size:0.95em;">Example: US-China tariffs = Prisoner's Dilemma, Taiwan Strait = Chicken Game</p>
                
                <h3 style="color: var(--accent-orange); margin-top: 1.5rem;">ASSET TAGS</h3>
                <div class="legend-item"><span class="legend-icon" style="color:#00D9FF;">FX</span><span class="legend-text"><strong>FX</strong> = Currency markets affected</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#fcd34d;">Au</span><span class="legend-text"><strong>GOLD/SILVER</strong> = Precious metals</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#f97316;">OIL</span><span class="legend-text"><strong>OIL/NATGAS</strong> = Energy commodities</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#3b82f6;">BD</span><span class="legend-text"><strong>BONDS</strong> = Fixed income markets</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#22c55e;">EQ</span><span class="legend-text"><strong>EQUITIES</strong> = Stock markets</span></div>
                <p style="margin-left:24px;color:#6a7585;font-size:0.95em;">Example: BOJ rate hike = FX + BONDS, Strait of Hormuz tension = OIL</p>
                
                <h3 style="color: var(--accent-orange); margin-top: 1.5rem;">Z-SCORE INTERPRETATION</h3>
                <p style="margin-bottom: 0.75rem; color: #9ca3af; font-size: 0.9rem;">Statistical deviation from 20-day mean. Shows how far price has stretched from fair value.</p>
                <div class="legend-item"><span class="legend-icon" style="color:#ef4444; font-weight:700;">+++</span><span class="legend-text"><strong>OVERBOUGHT EXTREME</strong> (Z > 2.0) = 2+ standard deviations above mean. Reversal risk high.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#f59e0b; font-weight:700;">++</span><span class="legend-text"><strong>OVERBOUGHT</strong> (Z 1.0-2.0) = Extended above mean. Watch for distribution.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#22c55e; font-weight:700;">+</span><span class="legend-text"><strong>ABOVE MEAN</strong> (Z 0.3-1.0) = Healthy bullish bias. Trend intact.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#6a7585; font-weight:700;">=</span><span class="legend-text"><strong>FAIR VALUE</strong> (Z -0.3 to 0.3) = Near pivot. Decision zone.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#3b82f6; font-weight:700;">-</span><span class="legend-text"><strong>BELOW MEAN</strong> (Z -0.3 to -1.0) = Mild discount. Accumulation zone if trend up.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#f59e0b; font-weight:700;">--</span><span class="legend-text"><strong>OVERSOLD</strong> (Z -1.0 to -2.0) = Stretched below mean. Watch for accumulation.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#ef4444; font-weight:700;">---</span><span class="legend-text"><strong>OVERSOLD EXTREME</strong> (Z < -2.0) = 2+ standard deviations below. Bounce potential high.</span></div>
                <p style="margin-left:24px;color:#6a7585;font-size:0.95em;">Example: Gold at +++ = consider taking profits, Oil at --- = watch for reversal setup</p>
                
                <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    <p style="font-size: 0.75rem; color: #6a7585; line-height: 1.5; text-align: center;">
                        <strong>DISCLAIMER:</strong> This is not financial advice. I am not a financial advisor. This content is for informational and educational purposes only. Investing involves risk, and you should always do your own due diligence (DYOR) and consult with a professional financial advisor before making any investment decisions.
                    </p>
                </div>
                
            </div>
        </div>
    </div>

    <!-- Game Theory Legend Modal -->
    <div id="gameLegendModal" class="chart-modal-overlay" style="display: none;" onclick="closeGameLegend(event)">
        <div class="chart-modal-content" onclick="event.stopPropagation()" style="max-width: 700px; border-color: #9333ea;">
            <button class="chart-close-btn" onclick="closeGameLegend()" style="top: 15px; right: 15px; position: absolute; color: #a855f7;"></button>
            <div class="modal-title" style="color: #a855f7; padding: 0.5rem 0;">GAME THEORY LEGEND</div>
            <div class="modal-analysis info-modal-scroll">
                
                <h3 style="color: #a855f7; margin-top: 0;">WHAT IS THE ACTIVE GAMES TRACKER?</h3>
                <p style="line-height: 1.6;">A living game theory engine that monitors 20 global strategic conflicts in real-time. AI scans news every 30 minutes to detect "moves" - actions by key players that shift the equilibrium of each game. Think of it as a chess board for geopolitics and macro.</p>
                <p style="margin-left:24px;color:#6a7585;font-size:0.95em;">Example: US announces new chip export controls  "DEFECT" move in US-China Tech War</p>
                
                <h3 style="color: #a855f7; margin-top: 1.5rem;">EQUILIBRIUM STATUS</h3>
                <div class="legend-item"><span class="legend-icon" style="color:#22c55e;"></span><span class="legend-text"><strong>STABLE</strong> = Nash equilibrium holding - both sides have found a balance where neither benefits from changing strategy. Low volatility expected.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#f59e0b;"></span><span class="legend-text"><strong>SHIFTING</strong> = Players repositioning - one or more actors considering a strategy change. Watch for moves that could tip the balance.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#ef4444;"></span><span class="legend-text"><strong>UNSTABLE</strong> = Equilibrium breaking down - no stable outcome, high probability of sudden moves. Maximum volatility risk.</span></div>
                <p style="margin-left:24px;color:#6a7585;font-size:0.95em;">Example: Taiwan Strait = UNSTABLE when military exercises announced, STABLE during diplomatic summits</p>
                
                <h3 style="color: #a855f7; margin-top: 1.5rem;">PHASE PROGRESSION</h3>
                <div class="legend-item"><span class="legend-icon" style="color:#6a7585;">1</span><span class="legend-text"><strong>SETUP</strong> = Initial positioning phase. Stakes being defined, alliances forming, red lines being drawn. Markets largely ignore.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#f59e0b;">2</span><span class="legend-text"><strong>ESCALATION</strong> = Tensions rising with tit-for-tat moves. Each side responds to the other. Markets start pricing risk.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#f97316;">3</span><span class="legend-text"><strong>BRINKMANSHIP</strong> = Red lines being tested. High accident risk, miscalculation possible. Markets on edge, VIX elevated.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#ef4444;">4</span><span class="legend-text"><strong>CONFLICT</strong> = Open confrontation. Maximum market impact, safe haven flows, sector dislocations.</span></div>
                <p style="margin-left:24px;color:#6a7585;font-size:0.95em;">Example: Russia-Ukraine moved SETUP (2014)  ESCALATION (2021)  BRINKMANSHIP (Jan 2022)  CONFLICT (Feb 2022)</p>
                
                <h3 style="color: #a855f7; margin-top: 1.5rem;">MOVE CLASSIFICATION</h3>
                <div class="legend-item"><span class="legend-icon" style="color:#ef4444;"></span><span class="legend-text"><strong>DEFECT</strong> = Aggressive/competitive action that breaks cooperation. Sanctions, tariffs, military moves, export bans. Typically risk-off.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#22c55e;"></span><span class="legend-text"><strong>COOPERATE</strong> = De-escalation or collaborative action. Diplomatic outreach, deal-making, tension reduction. Typically risk-on.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#3b82f6;"></span><span class="legend-text"><strong>SIGNAL</strong> = Communication without concrete action. Rhetoric, warnings, posturing. Tests opponent's resolve without commitment.</span></div>
                <p style="margin-left:24px;color:#6a7585;font-size:0.95em;">Example: China restricts rare earth exports = DEFECT, Biden-Xi phone call = SIGNAL, trade deal signed = COOPERATE</p>
                
                <h3 style="color: #a855f7; margin-top: 1.5rem;">GAME THEORY PATTERNS (Detailed)</h3>
                
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #f59e0b;">
                    <div style="font-weight: 700; color: #f59e0b; margin-bottom: 4px;">CHICKEN GAME (Game of Brinkmanship)</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">Two players accelerate toward collision. First to "swerve" loses face but avoids disaster. Neither wants to back down, but collision destroys both.</p>
                    <p style="margin: 8px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Market:</strong> De-escalation = massive relief rally. Collision = crash. Watch for last-minute deals.</p>
                    <p style="margin: 4px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Example:</strong> Taiwan Strait tensions, US debt ceiling standoffs, Cuban Missile Crisis</p>
                </div>
                
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #ef4444;">
                    <div style="font-weight: 700; color: #ef4444; margin-bottom: 4px;">PRISONER'S DILEMMA (Escalation Trap)</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">Both sides would be better off cooperating, but each has an incentive to defect. Leads to suboptimal outcomes where both lose.</p>
                    <p style="margin: 8px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Market:</strong> Watch for defection spirals - once one side defects, retaliation follows. Tariff wars are classic examples.</p>
                    <p style="margin: 4px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Example:</strong> US-China trade war, OPEC production cuts (cheating incentive), arms races</p>
                </div>
                
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #22c55e;">
                    <div style="font-weight: 700; color: #22c55e; margin-bottom: 4px;">COORDINATION GAME (Focal Point)</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">Multiple equilibria exist - players benefit from coordinating on the same choice, but must agree which one. Success depends on finding a "focal point."</p>
                    <p style="margin: 8px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Market:</strong> Clear statements from leaders create focal points. G7/G20 communiqus, OPEC+ agreements.</p>
                    <p style="margin: 4px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Example:</strong> Currency intervention coordination, climate accords, sanctions coalitions</p>
                </div>
                
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #8b5cf6;">
                    <div style="font-weight: 700; color: #8b5cf6; margin-bottom: 4px;">ZERO-SUM CONFLICT (Winner Take All)</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">One side's gain is exactly the other's loss. No win-win possible. Pure competition with no room for mutual benefit.</p>
                    <p style="margin: 8px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Market:</strong> Territory disputes, market share wars. Clear winners and losers. Sector rotation based on who's winning.</p>
                    <p style="margin: 4px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Example:</strong> Russia-Ukraine territory, South China Sea islands, semiconductor market share</p>
                </div>
                
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #3b82f6;">
                    <div style="font-weight: 700; color: #3b82f6; margin-bottom: 4px;">SIGNALING GAME (Credibility Test)</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">Actions reveal private information. Players send signals to influence beliefs. Costly signals are more credible than cheap talk.</p>
                    <p style="margin: 8px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Market:</strong> Central bank forward guidance, diplomatic warnings. Watch if words match actions.</p>
                    <p style="margin: 4px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Example:</strong> Fed dot plots, China military exercises, nuclear tests as capability signals</p>
                </div>
                
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #ec4899;">
                    <div style="font-weight: 700; color: #ec4899; margin-bottom: 4px;">REPUTATION GAME (Precedent Setting)</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">Current actions affect future expectations. Players sacrifice short-term gains to build long-term credibility. Backing down once makes future threats less credible.</p>
                    <p style="margin: 8px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Market:</strong> Watch for "red line" enforcement. If crossed without consequence, future threats are discounted.</p>
                    <p style="margin: 4px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Example:</strong> Fed credibility on inflation, US security guarantees, sanctions enforcement</p>
                </div>
                
                <h3 style="color: #a855f7; margin-top: 1.5rem;">THE 20 ACTIVE GAMES</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 0.85rem; color: #94a3b8; padding: 8px 0;">
                    <div> US-China Tech War</div>
                    <div> Strait of Hormuz</div>
                    <div> Fed vs Markets</div>
                    <div> OPEC vs Shale</div>
                    <div> Taiwan Strait</div>
                    <div> Russia-Ukraine</div>
                    <div> Iran-Israel Shadow War</div>
                    <div> EU Energy Security</div>
                    <div> ECB vs Inflation</div>
                    <div> US Tariff War</div>
                    <div> India-Pakistan Kashmir</div>
                    <div> Sudan Civil War</div>
                    <div> North Korea Nuclear</div>
                    <div> Syria Power Vacuum</div>
                    <div> Russia Shadow Fleet</div>
                    <div> BRICS De-Dollarization</div>
                    <div> Arctic Resource Race</div>
                    <div> South China Sea</div>
                    <div> Venezuela Crisis</div>
                    <div> Iran Regime Stability</div>
                </div>
                
                <div style="margin-top: 2rem; padding: 1rem; border-top: 1px solid rgba(147, 51, 234, 0.2); background: rgba(147, 51, 234, 0.05); border-radius: 6px;">
                    <p style="font-size: 0.8rem; color: #a78bfa; line-height: 1.6; text-align: center; margin: 0;">
                        <strong>HOW TO USE:</strong> Track equilibrium status for early warning signals. When games shift from GREEN to YELLOW to RED, expect increased volatility. DEFECT moves typically trigger risk-off; COOPERATE moves trigger relief rallies. Phase progression helps time entries.
                    </p>
                </div>
                
                <div style="margin-top: 1.5rem; padding: 1rem; border: 1px solid rgba(147, 51, 234, 0.3); background: rgba(0,0,0,0.3); border-radius: 6px;">
                    <p style="font-size: 0.75rem; color: #6a7585; line-height: 1.5; text-align: center; margin: 0;">
                        <strong>DISCLAIMER:</strong> This is not financial advice. I am not a financial advisor. This content is for informational and educational purposes only. Investing involves risk, and you should always do your own due diligence (DYOR) and consult with a professional financial advisor before making any investment decisions.
                    </p>
                </div>
                
            </div>
        </div>
    </div>

    <!-- Beam Analysis Modal -->
    <div id="beamAnalysisModal" class="chart-modal-overlay" style="display: none;" onclick="closeBeamModal(event)">
        <div class="chart-modal-content" onclick="event.stopPropagation()" style="max-width: 680px; border-color: #f59e0b; padding: 1.75rem;">
            <button class="chart-close-btn" onclick="closeBeamModal()" style="top: 18px; right: 18px; position: absolute; color: #f59e0b; font-size: 1.5rem;"></button>
            <div id="beamModalHeader" style="padding: 0 0 1rem 0; border-bottom: 1px solid rgba(245, 158, 11, 0.2); margin-bottom: 1.25rem;">
                <div class="modal-title" style="color: #f59e0b; font-size: 1.2rem; letter-spacing: 1.5px;" id="beamModalTitle">BEAM ANALYSIS</div>
                <div id="beamModalStatus" style="margin-top: 12px; font-size: 0.9rem;"></div>
            </div>
            <div class="modal-analysis info-modal-scroll" id="beamModalBody" style="max-height: 65vh; overflow-y: auto; padding-right: 8px;">
                <div class="modal-loading" id="beamLoading">
                    <div class="modal-spinner"></div>
                    <div class="modal-loading-text">Analyzing with Gemini AI...<br><span style="font-size: 0.85em; opacity: 0.8;">Loading beam intelligence...</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statecraft Explainer Modal -->
    <div id="statecraftExplainerModal" class="chart-modal-overlay" style="display: none;" onclick="closeStatecraftExplainer(event)">
        <div class="chart-modal-content" onclick="event.stopPropagation()" style="max-width: 750px; border-color: #9333ea;">
            <button class="chart-close-btn" onclick="closeStatecraftExplainer()" style="top: 15px; right: 15px; position: absolute; color: #a855f7;"></button>
            <div class="modal-title" style="color: #a855f7; padding: 0.5rem 0;">WHAT IS STATECRAFT?</div>
            <div class="modal-analysis info-modal-scroll">
                
                <p style="line-height: 1.7; font-size: 1rem;">Statecraft is the art of conducting state affairs - the strategies, tactics, and maneuvers that nations, leaders, and institutions use to advance their interests, project power, and shape the global order.</p>
                
                <h3 style="color: #a855f7; margin-top: 1.5rem;">WHY STATECRAFT MATTERS TO MARKETS</h3>
                <p style="line-height: 1.6;">Every major market move has a statecraft dimension. Central banks conduct monetary statecraft. Governments wage economic warfare through sanctions. Trade negotiations reshape supply chains. Understanding statecraft gives you an edge - you see the chess moves before they appear in headlines.</p>
                
                <h3 style="color: #a855f7; margin-top: 1.5rem;">THE TOOLS OF STATECRAFT</h3>
                
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #3b82f6;">
                    <div style="font-weight: 700; color: #3b82f6; margin-bottom: 4px;">ECONOMIC STATECRAFT</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">Sanctions, tariffs, trade deals, currency manipulation, debt diplomacy. The weaponization of economic interdependence. China's Belt & Road, US dollar hegemony, Russian energy leverage - all economic statecraft.</p>
                </div>
                
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #ef4444;">
                    <div style="font-weight: 700; color: #ef4444; margin-bottom: 4px;">COERCIVE STATECRAFT</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">Military positioning, arms sales, security guarantees, gray zone operations. The threat or use of force to achieve political ends. NATO expansion, South China Sea patrols, Iranian proxy networks.</p>
                </div>
                
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #22c55e;">
                    <div style="font-weight: 700; color: #22c55e; margin-bottom: 4px;">DIPLOMATIC STATECRAFT</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">Alliances, treaties, summits, international institutions. The art of building coalitions and isolating adversaries. BRICS expansion, G7 coordination, UN Security Council maneuvering.</p>
                </div>
                
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #f59e0b;">
                    <div style="font-weight: 700; color: #f59e0b; margin-bottom: 4px;">INFORMATION STATECRAFT</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">Propaganda, narrative warfare, strategic leaks, perception management. Shaping how populations and markets interpret events. State media, troll farms, controlled disclosures.</p>
                </div>
                
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #a855f7;">
                    <div style="font-weight: 700; color: #a855f7; margin-bottom: 4px;">MONETARY STATECRAFT</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">Central bank policy as geopolitical tool. Dollar swap lines, reserve currency status, SWIFT access, CBDC development. The Fed doesn't just manage inflation - it manages the global financial order.</p>
                </div>
                
                <h3 style="color: #a855f7; margin-top: 1.5rem;">STATECRAFT ARCHETYPES</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div style="background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 6px; border: 1px solid rgba(59, 130, 246, 0.3);">
                        <div style="font-weight: 700; color: #3b82f6; margin-bottom: 6px;">THE HEGEMON</div>
                        <p style="margin: 0; font-size: 0.85rem; color: #94a3b8; line-height: 1.5;">Maintains order through overwhelming power and institutional control. Sets the rules, enforces compliance. (US post-WWII, British Empire 1815-1914)</p>
                    </div>
                    <div style="background: rgba(239, 68, 68, 0.1); padding: 12px; border-radius: 6px; border: 1px solid rgba(239, 68, 68, 0.3);">
                        <div style="font-weight: 700; color: #ef4444; margin-bottom: 6px;">THE REVISIONIST</div>
                        <p style="margin: 0; font-size: 0.85rem; color: #94a3b8; line-height: 1.5;">Seeks to overturn the existing order. Challenges the hegemon's rules, builds alternative institutions. (China, Russia, Iran today)</p>
                    </div>
                    <div style="background: rgba(34, 197, 94, 0.1); padding: 12px; border-radius: 6px; border: 1px solid rgba(34, 197, 94, 0.3);">
                        <div style="font-weight: 700; color: #22c55e; margin-bottom: 6px;">THE BALANCER</div>
                        <p style="margin: 0; font-size: 0.85rem; color: #94a3b8; line-height: 1.5;">Plays both sides to maximize leverage. Never fully commits, extracts concessions from all. (India, Saudi Arabia, Turkey today)</p>
                    </div>
                    <div style="background: rgba(245, 158, 11, 0.1); padding: 12px; border-radius: 6px; border: 1px solid rgba(245, 158, 11, 0.3);">
                        <div style="font-weight: 700; color: #f59e0b; margin-bottom: 6px;">THE SPOILER</div>
                        <p style="margin: 0; font-size: 0.85rem; color: #94a3b8; line-height: 1.5;">Disrupts to create leverage. Uses chaos as a bargaining chip. Too dangerous to ignore, too weak to dominate. (North Korea, Iran proxies)</p>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div style="background: rgba(168, 85, 247, 0.1); padding: 12px; border-radius: 6px; border: 1px solid rgba(168, 85, 247, 0.3);">
                        <div style="font-weight: 700; color: #a855f7; margin-bottom: 6px;">THE VASSAL</div>
                        <p style="margin: 0; font-size: 0.85rem; color: #94a3b8; line-height: 1.5;">Trades sovereignty for protection. Aligns policies with patron state. Limited independence but guaranteed security. (Japan, South Korea, NATO states)</p>
                    </div>
                    <div style="background: rgba(20, 184, 166, 0.1); padding: 12px; border-radius: 6px; border: 1px solid rgba(20, 184, 166, 0.3);">
                        <div style="font-weight: 700; color: #14b8a6; margin-bottom: 6px;">THE MERCHANT</div>
                        <p style="margin: 0; font-size: 0.85rem; color: #94a3b8; line-height: 1.5;">Prioritizes commerce over ideology. Neutral in great power conflicts, trades with everyone. Wealth over warfare. (Singapore, Switzerland, UAE)</p>
                    </div>
                </div>
                
                <h3 style="color: #a855f7; margin-top: 1.5rem;">DICTATOR'S PLAYBOOK</h3>
                <p style="line-height: 1.6; margin-bottom: 12px;">Autocrats use distinct statecraft patterns that create trading opportunities:</p>
                
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px;">
                    <div style="font-weight: 700; color: #ef4444; margin-bottom: 4px;">MANUFACTURED CRISIS</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5; color: #94a3b8;">Create external threat to consolidate domestic power. Erdogan's coups, Putin's NATO narrative, Xi's Taiwan rhetoric. Markets spike on headlines, then normalize.</p>
                </div>
                
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px;">
                    <div style="font-weight: 700; color: #f59e0b; margin-bottom: 4px;">HOSTAGE ECONOMICS</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5; color: #94a3b8;">Use economic interdependence as leverage. Russia's gas cutoffs, China's rare earth threats, OPEC+ supply manipulation. Creates volatility spikes.</p>
                </div>
                
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px;">
                    <div style="font-weight: 700; color: #3b82f6; margin-bottom: 4px;">SUCCESSION THEATER</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5; color: #94a3b8;">Authoritarian transitions create uncertainty windows. Saudi MBS consolidation, North Korea Kim Jong Un's rise, Chinese politburo reshuffles. Policy continuity unclear.</p>
                </div>
                
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px;">
                    <div style="font-weight: 700; color: #a855f7; margin-bottom: 4px;">STRATEGIC AMBIGUITY</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5; color: #94a3b8;">Keep intentions unclear to maximize leverage. China on Taiwan, Russia on nuclear doctrine, Iran on nuclear weapons. Markets hate uncertainty - they exploit it.</p>
                </div>
                
                <h3 style="color: #a855f7; margin-top: 1.5rem;">READING STATECRAFT SIGNALS</h3>
                <div style="background: rgba(168, 85, 247, 0.1); border-radius: 6px; padding: 12px; border: 1px solid rgba(168, 85, 247, 0.2);">
                    <div style="display: flex; gap: 12px; margin-bottom: 8px;"><span style="color: #ef4444; font-weight: 700; min-width: 90px; flex-shrink: 0;">DEFECT</span><span style="color: #94a3b8;">Aggressive move. Break agreements, escalate tensions, impose costs. Risk-off signal.</span></div>
                    <div style="display: flex; gap: 12px; margin-bottom: 8px;"><span style="color: #22c55e; font-weight: 700; min-width: 90px; flex-shrink: 0;">COOPERATE</span><span style="color: #94a3b8;">De-escalation. Honor commitments, seek dialogue, reduce tensions. Risk-on signal.</span></div>
                    <div style="display: flex; gap: 12px; margin-bottom: 8px;"><span style="color: #f59e0b; font-weight: 700; min-width: 90px; flex-shrink: 0;">SIGNAL</span><span style="color: #94a3b8;">Posturing without action. Rhetoric, military exercises, symbolic moves. Watch for follow-through.</span></div>
                    <div style="display: flex; gap: 12px;"><span style="color: #a855f7; font-weight: 700; min-width: 90px; flex-shrink: 0;">BLUFF</span><span style="color: #94a3b8;">Threat without capability or intent. Markets often overreact. Fade the move.</span></div>
                </div>
                
                <div style="margin-top: 2rem; padding: 1rem; border-top: 1px solid rgba(147, 51, 234, 0.2); background: rgba(147, 51, 234, 0.05); border-radius: 6px;">
                    <p style="font-size: 0.8rem; color: #a78bfa; line-height: 1.6; text-align: center; margin: 0;">
                        <strong>HOW TO USE:</strong> Every headline has a statecraft dimension. Ask: Who benefits? What's the real game? What move comes next? Our Game Theory Dashboard tracks 20 active statecraft games in real-time.
                    </p>
                </div>
                
                <div style="margin-top: 1.5rem; padding: 1rem; border: 1px solid rgba(147, 51, 234, 0.3); background: rgba(0,0,0,0.3); border-radius: 6px;">
                    <p style="font-size: 0.75rem; color: #6a7585; line-height: 1.5; text-align: center; margin: 0;">
                        <strong>DISCLAIMER:</strong> This is not financial advice. I am not a financial advisor. This content is for informational and educational purposes only. Investing involves risk, and you should always do your own due diligence (DYOR) and consult with a professional financial advisor before making any investment decisions.
                    </p>
                </div>
                
            </div>
        </div>
    </div>

    <!-- Strategic Intelligence Legend Modal -->
    <div id="intelLegendModal" class="chart-modal-overlay" style="display: none;" onclick="closeIntelLegend(event)">
        <div class="chart-modal-content" onclick="event.stopPropagation()" style="max-width: 700px; border-color: #9333ea;">
            <button class="chart-close-btn" onclick="closeIntelLegend()" style="top: 15px; right: 15px; position: absolute; color: #a855f7;"></button>
            <div class="modal-title" style="color: #a855f7; padding: 0.5rem 0;">STRATEGIC INTELLIGENCE LEGEND</div>
            <div class="modal-analysis info-modal-scroll">
                
                <h3 style="color: #a855f7; margin-top: 0;">WHAT IS STRATEGIC INTELLIGENCE?</h3>
                <p style="line-height: 1.6;">Five real-time macro indicators that track systemic geopolitical and economic risks. These are "second-order" signals that most traders miss - they detect regime shifts before they hit headlines.</p>
                <p style="margin-left:24px;color:#6a7585;font-size:0.95em;">Updated every 60 seconds using live market data.</p>
                
                <h3 style="color: #a855f7; margin-top: 1.5rem;">THE 5 METRICS</h3>
                
                <div id="intel-rev-risk" style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #ef4444;">
                    <div style="font-weight: 700; color: #ef4444; margin-bottom: 4px;">REVOLUTION RISK (Bread + Fuel Index)</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">Formula: (Wheat/550 + Oil/70)  (DXY/100). Tracks the classic triggers of social unrest - food and energy costs, amplified by dollar strength crushing EM purchasing power.</p>
                    <p style="margin: 8px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Levels:</strong> STABLE (green) < 1.5 | RISING (yellow) 1.5-2.0 | ELEVATED (orange) 2.0-2.5 | CRITICAL (red) > 2.5</p>
                    <p style="margin: 4px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Trade signal:</strong> CRITICAL readings preceded Arab Spring (2011), Sri Lanka collapse (2022), and Egypt protests (2023). Watch EM FX, defense stocks.</p>
                    <p style="margin: 8px 0 0 0; color: #94a3b8; font-size: 0.85rem;"><strong>Why it matters:</strong> When bread and fuel become unaffordable, revolutions follow. The Arab Spring started with a Tunisian fruit vendor. Sri Lanka's government fell when people couldn't afford cooking gas. This index captures the economic preconditions for political instability.</p>
                </div>
                
                <div id="intel-liar" style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #f59e0b;">
                    <div style="font-weight: 700; color: #f59e0b; margin-bottom: 4px;">LIAR'S POKER (Narrative vs Money)</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">Compares Fear & Greed sentiment against Polymarket war odds. When narrative diverges from what money is actually betting on, someone is lying.</p>
                    <p style="margin: 8px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Levels:</strong> REALITY (aligned) | WATCH (drifting) | HOPIUM (sentiment too bullish vs bets) | FEAR PORN (sentiment too bearish vs bets)</p>
                    <p style="margin: 4px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Trade signal:</strong> HOPIUM = retail overexposed, smart money hedging. FEAR PORN = contrarian buy opportunity. REALITY = trend intact.</p>
                    <p style="margin: 8px 0 0 0; color: #94a3b8; font-size: 0.85rem;"><strong>Why it matters:</strong> Media narratives often diverge from where real money is flowing. When CNN says "markets are calm" but prediction markets show rising war odds, someone's lying. This metric catches the gap between the story and the bets.</p>
                </div>
                
                <div id="intel-paper-rock" style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #3b82f6;">
                    <div style="font-weight: 700; color: #3b82f6; margin-bottom: 4px;">PAPER VS ROCK (Financialization Ratio)</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">Formula: SPX / (Gold + Oil30 + Copper500). Measures whether the world is rotating into financial assets (Paper) or hard assets (Rock).</p>
                    <p style="margin: 8px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Levels:</strong> FINANCIALIZED (blue, high) = Risk-on, QE regime | TRANSITIONING = Rotation happening | WAR ECONOMY (red, low) = Hard assets winning</p>
                    <p style="margin: 4px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Trade signal:</strong> WAR ECONOMY readings = overweight commodities, gold, defense. PEAK PAPER = mean reversion risk, reduce equity exposure.</p>
                    <p style="margin: 8px 0 0 0; color: #94a3b8; font-size: 0.85rem;"><strong>Why it matters:</strong> In peaceful times, financial assets outperform. In wartime or stagflation, hard assets win. This ratio tells you which regime we're in. Post-WWII was all Paper. The 1970s were all Rock. We may be transitioning again.</p>
                </div>
                
                <div id="intel-mercantilism" style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #22c55e;">
                    <div style="font-weight: 700; color: #22c55e; margin-bottom: 4px;">MERCANTILISM COUNTER (Trade Fragmentation)</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">Scans recent headlines for keywords: tariff, sanction, ban, blockade, friend-shoring, decouple. Quantifies the speed of deglobalization.</p>
                    <p style="margin: 8px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Levels:</strong> OPEN TRADE (0-2 signals) | FRICTION (3-5) | FRACTURING (6-9) | TRADE WAR (10+)</p>
                    <p style="margin: 4px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Trade signal:</strong> Rising mercantilism = inflation, supply chain plays, domestic manufacturing. Favor onshoring beneficiaries.</p>
                    <p style="margin: 8px 0 0 0; color: #94a3b8; font-size: 0.85rem;"><strong>Why it matters:</strong> Globalization is reversing. Every "sanction" headline, every "friend-shoring" announcement, every "decouple" speech adds friction to the system. This counter tracks how fast we're moving from free trade back to mercantilism - and the investment implications are profound.</p>
                </div>
                
                <div id="intel-vassal" style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #a855f7;">
                    <div style="font-weight: 700; color: #a855f7; margin-bottom: 4px;">VASSAL STATE DETECTOR (Currency Correlation)</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">Tracks KRW (Korean Won) correlation with USD vs CNH. Korea is the geopolitical bellwether - as it goes, so goes the Pacific order.</p>
                    <p style="margin: 8px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Levels:</strong> US SPHERE (KRW tracks USD) | NEUTRAL (uncorrelated) | CHINA SPHERE (KRW tracks CNH)</p>
                    <p style="margin: 4px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Trade signal:</strong> Shifts toward CHINA SPHERE = Asia decoupling from dollar system. Watch for BRICS momentum, gold accumulation.</p>
                    <p style="margin: 8px 0 0 0; color: #94a3b8; font-size: 0.85rem;"><strong>Why it matters:</strong> South Korea is the ultimate swing state - economically tied to China, security-guaranteed by the US. When KRW starts tracking CNH more than USD, it signals a tectonic shift in the Pacific order. This is the canary in the coal mine for de-dollarization.</p>
                </div>
                
                <h3 style="color: #a855f7; margin-top: 1.5rem;">INTERPRETING THE SIGNALS</h3>
                <div style="background: rgba(168, 85, 247, 0.1); border-radius: 6px; padding: 12px; border: 1px solid rgba(168, 85, 247, 0.2);">
                    <div style="display: flex; gap: 12px; margin-bottom: 8px;"><span style="color: #ef4444; font-weight: 700; min-width: 70px; flex-shrink: 0;">RED</span><span style="color: #94a3b8;"><strong>Multiple Red Signals</strong> = Systemic risk rising. Reduce exposure, favor defensive positioning.</span></div>
                    <div style="display: flex; gap: 12px; margin-bottom: 8px;"><span style="color: #f59e0b; font-weight: 700; min-width: 70px; flex-shrink: 0;">YELLOW</span><span style="color: #94a3b8;"><strong>Mixed Signals</strong> = Transition phase. Watch for confirmation before major moves.</span></div>
                    <div style="display: flex; gap: 12px; margin-bottom: 8px;"><span style="color: #22c55e; font-weight: 700; min-width: 70px; flex-shrink: 0;">GREEN</span><span style="color: #94a3b8;"><strong>All Green</strong> = Risk-on environment. Trend following works, carry trades attractive.</span></div>
                    <div style="display: flex; gap: 12px;"><span style="color: #a855f7; font-weight: 700; min-width: 70px; flex-shrink: 0;">DIVERGE</span><span style="color: #94a3b8;"><strong>Divergences</strong> = Most valuable. When one metric screams while others are calm, dig deeper.</span></div>
                </div>
                
                <div style="margin-top: 2rem; padding: 1rem; border-top: 1px solid rgba(147, 51, 234, 0.2); background: rgba(147, 51, 234, 0.05); border-radius: 6px;">
                    <p style="font-size: 0.8rem; color: #a78bfa; line-height: 1.6; text-align: center; margin: 0;">
                        <strong>HOW TO USE:</strong> These are early warning indicators, not trade signals. When multiple metrics shift together, expect regime change within 1-3 months. Use alongside Game Theory Dashboard for complete geopolitical picture.
                    </p>
                </div>
                
                <div style="margin-top: 1.5rem; padding: 1rem; border: 1px solid rgba(147, 51, 234, 0.3); background: rgba(0,0,0,0.3); border-radius: 6px;">
                    <p style="font-size: 0.75rem; color: #6a7585; line-height: 1.5; text-align: center; margin: 0;">
                        <strong>DISCLAIMER:</strong> This is not financial advice. I am not a financial advisor. This content is for informational and educational purposes only. Investing involves risk, and you should always do your own due diligence (DYOR) and consult with a professional financial advisor before making any investment decisions.
                    </p>
                </div>
                
            </div>
        </div>
    </div>

    <!-- Tactical Structure Legend Modal -->
    <div id="tacticalLegendModal" class="chart-modal-overlay" style="display: none;" onclick="closeTacticalLegend(event)">
        <div class="chart-modal-content" onclick="event.stopPropagation()" style="max-width: 700px;">
            <button class="chart-close-btn" onclick="closeTacticalLegend()" aria-label="Close modal"></button>
            <div class="modal-title" style="color: #22c55e; padding: 0.5rem 0;">TACTICAL STRUCTURE LEGEND</div>
            <div class="modal-analysis info-modal-scroll">
                
                <h3 style="color: var(--accent-orange); margin-top: 0;">WHAT IS THE TACTICAL STRUCTURE?</h3>
                <p style="line-height: 1.6;">The <strong>Tactical Structure</strong> is your 8-layer quantitative navigation system. It calculates live distances to key price levels, quarterly regime classification, and provides AI-powered analysis for 62 global assets.</p>
                <p style="line-height: 1.6;">Each asset shows: <strong>Current Price | Distance to Key Level | Regime Status</strong>. Click any asset for deep Gemini AI analysis including statecraft implications.</p>
                
                <h3 style="color: var(--accent-orange);">THE 8-LAYER ENGINE</h3>
                <div class="legend-item"><span class="legend-icon" style="color:#22c55e;">1</span><span class="legend-text"><strong>QUARTERLY OPEN</strong> = Q1 2026 opening price. The strategic anchor - where institutions positioned at quarter start.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#22c55e;">2</span><span class="legend-text"><strong>QUARTERLY HIGH/LOW</strong> = Expected Q1 range boundaries. Derived from historical volatility and macro regime.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#22c55e;">3</span><span class="legend-text"><strong>PIVOT LEVEL</strong> = (qHigh + qLow + qOpen) / 3. The fair value anchor for mean reversion analysis.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#22c55e;">4</span><span class="legend-text"><strong>SUPPORT/RESISTANCE</strong> = Dynamic S1/R1 levels calculated from pivot. Key decision zones.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#22c55e;">5</span><span class="legend-text"><strong>PARKINSON VOLATILITY</strong> = Real High/Low-based volatility measure (more accurate than close-to-close).</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#22c55e;">6</span><span class="legend-text"><strong>Z-SCORE</strong> = Statistical deviation from pivot. Shows overbought/oversold on -3 to +3 scale.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#22c55e;">7</span><span class="legend-text"><strong>NARRATIVE SCANNER</strong> = AI checks if news headlines mention this price level (confirms market focus).</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#22c55e;">8</span><span class="legend-text"><strong>QUARTERLY REGIME</strong> = BULLISH / DISTRIBUTION / BEARISH / ACCUMULATION classification.</span></div>
                
                <h3 style="color: var(--accent-orange);">ASSET CATEGORIES</h3>
                <div class="legend-item"><span class="category-badge" style="background:#3b82f6; color:white;">GENERALS</span><span class="legend-text">Yield curve (2Y/5Y/10Y/30Y), S&P 500, NASDAQ, VIX, DXY - the macro command structure</span></div>
                <div class="legend-item"><span class="category-badge" style="background:#f59e0b; color:white;">METALS</span><span class="legend-text">Gold, Silver, Copper, Platinum, Palladium, Aluminum, Zinc, Nickel - hard money and industrial demand</span></div>
                <div class="legend-item"><span class="category-badge" style="background:#ef4444; color:white;">ENERGY</span><span class="legend-text">WTI, Brent, Nat Gas, Gasoline, Heating Oil, ICLN, URA, XLE - energy security and transition</span></div>
                <div class="legend-item"><span class="category-badge" style="background:#22c55e; color:white;">AGRICULTURE</span><span class="legend-text">16 softs/grains/proteins - food security, weather risk, inflation transmission</span></div>
                <div class="legend-item"><span class="category-badge" style="background:#a855f7; color:white;">FX/CRYPTO</span><span class="legend-text">29 currency pairs in 3 groups: MACRO (G7+crypto), GEO (flashpoints), COMMODITY (resource-linked)</span></div>
                
                <h3 style="color: var(--accent-orange);">QUARTERLY REGIME CLASSIFICATION</h3>
                <div class="legend-item"><span class="legend-icon" style="color:#22c55e;">^</span><span class="legend-text"><strong>BULLISH</strong> = Price above pivot AND above quarterly open. Momentum + position aligned upward.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#f59e0b;">~</span><span class="legend-text"><strong>DISTRIBUTION</strong> = Price above pivot but below quarterly open. Smart money potentially exiting.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#ef4444;">v</span><span class="legend-text"><strong>BEARISH</strong> = Price below pivot AND below quarterly open. Momentum + position aligned downward.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#3b82f6;">+</span><span class="legend-text"><strong>ACCUMULATION</strong> = Price below pivot but above quarterly open. Smart money potentially entering.</span></div>
                
                <h3 style="color: var(--accent-orange);">Z-SCORE INTERPRETATION</h3>
                <div class="legend-item"><span class="legend-icon" style="color:#ef4444;">+++</span><span class="legend-text"><strong>OVERBOUGHT EXTREME</strong> (Z > 2.0) = 3+ standard deviations above fair value. Reversal risk high.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#f59e0b;">++</span><span class="legend-text"><strong>OVERBOUGHT</strong> (Z 1.0-2.0) = Extended above mean. Watch for distribution signals.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#22c55e;">+</span><span class="legend-text"><strong>ABOVE MEAN</strong> (Z 0.3-1.0) = Healthy bullish bias. Trend intact.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#6a7585;">=</span><span class="legend-text"><strong>FAIR VALUE</strong> (Z -0.3 to 0.3) = Near pivot. Decision zone for directional plays.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#22c55e;">-</span><span class="legend-text"><strong>BELOW MEAN</strong> (Z -0.3 to -1.0) = Mild discount. Accumulation opportunity if trend up.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#f59e0b;">--</span><span class="legend-text"><strong>OVERSOLD</strong> (Z -1.0 to -2.0) = Stretched below mean. Watch for accumulation signals.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#ef4444;">---</span><span class="legend-text"><strong>OVERSOLD EXTREME</strong> (Z < -2.0) = 3+ standard deviations below fair value. Bounce potential high.</span></div>
                
                <h3 style="color: var(--accent-orange);">FX SUB-CATEGORIES</h3>
                <div class="legend-item"><span class="legend-icon" style="color:#3b82f6;">M</span><span class="legend-text"><strong>MACRO (9)</strong> = BTC, ETH, EUR/USD, USD/JPY, GBP/USD, USD/CHF, EUR/JPY, EUR/CHF, CHF/JPY - core liquidity pairs</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#ef4444;">G</span><span class="legend-text"><strong>GEO (10)</strong> = USD/CNH, USD/ILS, USD/MXN, USD/PLN, USD/TRY, USD/KRW, USD/INR, USD/SGD, EUR/GBP, GBP/JPY - geopolitical flashpoints</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#22c55e;">C</span><span class="legend-text"><strong>COMMODITY (10)</strong> = USD/CAD, AUD/USD, USD/NOK, NZD/USD, USD/BRL, USD/ZAR, CAD/JPY, AUD/JPY, AUD/NZD, EUR/AUD - resource currencies</span></div>
                
                <h3 style="color: var(--accent-orange);">HOW TO USE</h3>
                <p style="line-height: 1.6;"><strong>1. Click category headers</strong> to expand/collapse asset lists.</p>
                <p style="line-height: 1.6;"><strong>2. Click any asset row</strong> to trigger deep AI analysis including statecraft context.</p>
                <p style="line-height: 1.6;"><strong>3. Watch the distance percentages</strong> - approaching 0% means price is at the key level.</p>
                <p style="line-height: 1.6;"><strong>4. Cross-reference with news</strong> - when Z-score is extreme AND news mentions the level, expect volatility.</p>
                
            </div>
        </div>
    </div>

    <!-- Unified Command Briefing Modal -->
    <div id="commandBriefingModal" class="chart-modal-overlay" style="display: none;" onclick="closeCommandBriefing(event)">
        <div class="chart-modal-content" onclick="event.stopPropagation()" style="max-width: 700px;">
            <button class="chart-close-btn" onclick="closeCommandBriefing()"></button>
            <div class="modal-title" style="color: #a855f7; padding: 0.5rem 0;">COMMAND BRIEFING</div>
            <div class="modal-analysis info-modal-scroll">
                
                <h3 style="color: var(--accent-orange); margin-top: 0;">WHAT IS STATECRAFT?</h3>
                <p style="line-height: 1.6;"><strong>Statecraft</strong> is the art of conducting state affairs - the strategies, tactics, and maneuvers that nations, leaders, and institutions use to advance their interests, project power, and shape the global order.</p>
                <p style="line-height: 1.6;">Every major market move has a statecraft dimension. Central banks conduct monetary statecraft. Governments wage economic warfare through sanctions. Trade negotiations reshape supply chains. <strong>Understanding statecraft gives you an edge - you see the chess moves before they appear in headlines.</strong></p>
                
                <h3 style="color: var(--accent-orange);">THE TOOLS OF STATECRAFT</h3>
                <div class="legend-item"><span class="legend-icon">$</span><span class="legend-text"><strong>ECONOMIC</strong> = Sanctions, tariffs, trade deals, currency manipulation, debt diplomacy. China's Belt & Road, US dollar hegemony, Russian energy leverage.</span></div>
                <div class="legend-item"><span class="legend-icon"></span><span class="legend-text"><strong>COERCIVE</strong> = Military positioning, arms sales, security guarantees, gray zone operations. NATO expansion, South China Sea patrols.</span></div>
                <div class="legend-item"><span class="legend-icon"></span><span class="legend-text"><strong>DIPLOMATIC</strong> = Alliances, treaties, summits, international institutions. BRICS expansion, G7 coordination, UN maneuvering.</span></div>
                <div class="legend-item"><span class="legend-icon"></span><span class="legend-text"><strong>INFORMATION</strong> = Propaganda, narrative warfare, strategic leaks, perception management. State media, controlled disclosures.</span></div>
                <div class="legend-item"><span class="legend-icon"></span><span class="legend-text"><strong>MONETARY</strong> = Central bank policy as geopolitical tool. Dollar swap lines, SWIFT access, CBDC development. The Fed manages the global financial order.</span></div>
                
                <h3 style="color: var(--accent-orange);">STATECRAFT ARCHETYPES</h3>
                <div class="legend-item"><span class="legend-icon"></span><span class="legend-text"><strong>HEGEMON</strong> = Maintains order through power and institutional control. Sets and enforces rules. (US post-WWII)</span></div>
                <div class="legend-item"><span class="legend-icon"></span><span class="legend-text"><strong>REVISIONIST</strong> = Seeks to overturn existing order, builds alternative institutions. (China, Russia, Iran)</span></div>
                <div class="legend-item"><span class="legend-icon"></span><span class="legend-text"><strong>BALANCER</strong> = Plays both sides to maximize leverage, never fully commits. (India, Saudi Arabia, Turkey)</span></div>
                <div class="legend-item"><span class="legend-icon"></span><span class="legend-text"><strong>SPOILER</strong> = Disrupts to create leverage. Uses chaos as bargaining chip. (North Korea)</span></div>
                <div class="legend-item"><span class="legend-icon"></span><span class="legend-text"><strong>VASSAL</strong> = Trades sovereignty for protection, aligns with patron state. (Japan, NATO states)</span></div>
                <div class="legend-item"><span class="legend-icon"></span><span class="legend-text"><strong>MERCHANT</strong> = Prioritizes commerce over ideology, trades with everyone. (Singapore, Switzerland)</span></div>
                
                <h3 style="color: var(--accent-orange);">DICTATOR'S PLAYBOOK</h3>
                <p style="margin-left:24px;color:#6a7585;font-size:0.95em;line-height:1.5;">Autocrats use distinct patterns that create trading opportunities:</p>
                <div class="legend-item"><span class="legend-icon">!</span><span class="legend-text"><strong>MANUFACTURED CRISIS</strong> = Create external threat to consolidate domestic power. Markets spike on headlines, then normalize.</span></div>
                <div class="legend-item"><span class="legend-icon">X</span><span class="legend-text"><strong>HOSTAGE ECONOMICS</strong> = Use economic interdependence as leverage. Gas cutoffs, rare earth threats. Creates volatility spikes.</span></div>
                <div class="legend-item"><span class="legend-icon">?</span><span class="legend-text"><strong>STRATEGIC AMBIGUITY</strong> = Keep intentions unclear to maximize leverage. Markets hate uncertainty - they exploit it.</span></div>
                
                <h3 style="color: #00D9FF;">CATALYST SCANNER (4-Pillar Watch System)</h3>
                <p style="line-height: 1.6;">The Catalyst Scanner is your <strong>"Watch Next"</strong> radar. It continuously scans RSS feeds, breaking news, and scheduled events to surface upcoming catalysts that could move markets.</p>
                <p style="line-height: 1.6;">Every catalyst is classified into one of <strong>4 pillars</strong> based on how it affects markets:</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 12px 0;">
                    <div style="background: rgba(239, 68, 68, 0.15); padding: 10px; border-radius: 4px; border-left: 3px solid #ef4444;">
                        <strong style="color: #ef4444;">KINETIC</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #9ca3af;">War, borders, strikes, military action. Immediate volatility. Flight to safety.</p>
                    </div>
                    <div style="background: rgba(59, 130, 246, 0.15); padding: 10px; border-radius: 4px; border-left: 3px solid #3b82f6;">
                        <strong style="color: #3b82f6;">MACRO</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #9ca3af;">Fed, yields, inflation, growth. The rates market. Structural regime shifts.</p>
                    </div>
                    <div style="background: rgba(168, 85, 247, 0.15); padding: 10px; border-radius: 4px; border-left: 3px solid #a855f7;">
                        <strong style="color: #a855f7;">STATECRAFT</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #9ca3af;">Elections, summits, sanctions, tech bans. Political decisions reshaping trade.</p>
                    </div>
                    <div style="background: rgba(245, 158, 11, 0.15); padding: 10px; border-radius: 4px; border-left: 3px solid #f59e0b;">
                        <strong style="color: #f59e0b;">SYSTEMIC</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #9ca3af;">Liquidity, VIX, contagion. When plumbing breaks, correlations go to 1.</p>
                    </div>
                </div>
                
                <p style="line-height: 1.6; margin-top: 12px;"><strong>How to use:</strong> Click any Horizon Scanner item to see a detailed explanation of why it matters and how to position. The scanner shows the 6 most recent catalysts - fresh signals that haven't yet been fully priced in.</p>
                
                <h3 style="color: #ef4444;">STRUCTURAL BEAMS (SENTINEL System)</h3>
                <p style="line-height: 1.6;">This is where statecraft becomes measurable. Our 14 tripwires detect systemic stress before it hits headlines - the structural pressures that statecraft creates:</p>
                <p style="line-height: 1.6;">14 tripwires that detect systemic stress before it hits headlines. These are the <strong>early warning signals</strong> - the structural pressures building beneath the surface.</p>
                
                <div class="legend-item"><span class="legend-icon" style="color:#22c55e;"></span><span class="legend-text"><strong>SAFE</strong> = Normal conditions, no stress detected</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#f59e0b;"></span><span class="legend-text"><strong>ARMING</strong> = Approaching threshold, watch closely</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#ef4444;"></span><span class="legend-text"><strong>BREACHED</strong> = Alert triggered, stress confirmed</span></div>
                <p style="margin-left:24px;color:#6a7585;font-size:0.95em;">The 14 Tripwires: Yield Curve, Credit Stress, Fragmentation, Paper vs Rock, Dollar Weaponization, Revolution Risk, Eurodollar Squeeze, Liar's Poker, Mercantilist War, De-Dollarization, Vassal State, Taiwan Tension, Migration Pressure, Secular Stagnation</p>
                
                <h3 style="color: #f87171;"> COMPOUND STRESS (Meta-Tripwire)</h3>
                <p style="line-height: 1.6;">When multiple tripwires stress together, it signals a NEW conflict may be forming. The AI analyzes correlated stress and proposes emerging situations.</p>
                
                <div class="legend-item"><span class="legend-icon" style="color:#6a7585;"></span><span class="legend-text"><strong>ISOLATED</strong> = Signals not correlating</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#3b82f6;"></span><span class="legend-text"><strong>CORRELATING</strong> = Multiple stressed but scattered</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#f59e0b;"></span><span class="legend-text"><strong>CLUSTERING</strong> = Theme cluster active (2+ in same category)</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#ef4444;"></span><span class="legend-text"><strong>SYSTEMIC</strong> = 2+ clusters resonating - regime shift forming</span></div>
                <p style="margin-left:24px;color:#6a7585;font-size:0.95em;">Clusters: FINANCIAL (liquidity, Fed, BOJ, Euro)  GEOPOLITICAL (Taiwan, kinetic, liar's poker)  COMMODITY (energy, revolution, mercantilism)  MONETARY (fiat, deflation, paper vs rock)</p>
                
                <h3 style="color: #a855f7;"> ACTIVE KINETIC THEATERS</h3>
                <p style="line-height: 1.6;">Where structural stress becomes action. A living game theory engine tracking 20+ global conflicts. AI detects "moves" - actions by players that shift equilibrium.</p>
                
                <div class="legend-item"><span class="legend-icon" style="color:#22c55e;"></span><span class="legend-text"><strong>STABLE</strong> = Nash equilibrium holding, balance maintained</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#f59e0b;"></span><span class="legend-text"><strong>SHIFTING</strong> = Players repositioning, strategy changes</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#ef4444;"></span><span class="legend-text"><strong>UNSTABLE</strong> = Equilibrium breaking down, volatility risk</span></div>
                <p style="margin-left:24px;color:#6a7585;font-size:0.95em;">Phase Progression: SETUP  ESCALATION  BRINKMANSHIP  CONFLICT</p>
                
                <h3 style="color: #00D9FF;"> PROXY DECODER (The Invisible Hand)</h3>
                <p style="line-height: 1.6;">Every conflict has hidden sponsors and strategic prizes. The Proxy Decoder reveals <strong>who is really behind each flashpoint</strong> and <strong>what's actually at stake</strong> - the intelligence layer that transforms headlines into actionable insight.</p>
                
                <div style="background: rgba(107, 139, 164, 0.15); padding: 12px; border-radius: 6px; margin: 12px 0; border-left: 3px solid #6B8BA4;">
                    <div style="font-weight: 700; color: #6B8BA4; margin-bottom: 8px;">GREAT POWER SPONSORS</div>
                    <p style="margin: 0; font-size: 0.85rem; color: #9ca3af; line-height: 1.5;">Identifies the major powers backing each side of a conflict. Displayed as grey sponsor badges (USA, CHN, RUS, IRN, GBR, FRA, EU, etc.). When Sudan burns, it's UAE vs Iran. When Taiwan escalates, it's NATO vs DragonBear. Know the puppet masters.</p>
                </div>
                
                <div style="background: rgba(245, 158, 11, 0.15); padding: 12px; border-radius: 6px; margin: 12px 0; border-left: 3px solid #f59e0b;">
                    <div style="font-weight: 700; color: #f59e0b; margin-bottom: 8px;">STRATEGIC RESOURCES (The Prize)</div>
                    <p style="margin: 0; font-size: 0.85rem; color: #9ca3af; line-height: 1.5;">What's actually at stake - the strategic asset that makes the conflict worth fighting. Displayed as amber resource tags: CHIPS (semiconductors), OIL, GAS, SHIPPING (chokepoints), TERRITORY, RATES (monetary policy), NUCLEAR, INFLUENCE, RARE EARTHS, URANIUM, TRADE ROUTES.</p>
                </div>
                
                <div style="background: rgba(239, 68, 68, 0.15); padding: 12px; border-radius: 6px; margin: 12px 0; border-left: 3px solid #ef4444;">
                    <div style="font-weight: 700; color: #ef4444; margin-bottom: 8px;">ESCALATION LEVELS (1-5 Heat Scale)</div>
                    <p style="margin: 0 0 8px 0; font-size: 0.85rem; color: #9ca3af; line-height: 1.5;">How hot is the conflict? A 5-tier scale measuring intensity:</p>
                    <div style="display: grid; gap: 4px; font-size: 0.8rem;">
                        <div><span style="color: #22c55e; font-weight: 700;">Level 1</span> <span style="color: #6a7585;">= Rhetoric (diplomatic tensions, statements)</span></div>
                        <div><span style="color: #22c55e; font-weight: 700;">Level 2</span> <span style="color: #6a7585;">= Hybrid/Cyber (sanctions, hacking, economic warfare)</span></div>
                        <div><span style="color: #f59e0b; font-weight: 700;">Level 3</span> <span style="color: #6a7585;">= Proxy Kinetic (armed proxies, drones, militia action)</span></div>
                        <div><span style="color: #ef4444; font-weight: 700;">Level 4</span> <span style="color: #6a7585;">= Direct State (military forces engaged)</span></div>
                        <div><span style="color: #ef4444; font-weight: 700;">Level 5</span> <span style="color: #6a7585;">= Systemic/Nuclear (global order at risk)</span></div>
                    </div>
                </div>
                
                <p style="margin-left:24px;color:#6a7585;font-size:0.9em;font-style:italic;margin-top:12px;">Click VIEW MAP on any conflict to see its location on the 3D globe with enhanced pulsating animation.</p>
                
                <h3 style="color: var(--accent-orange);"> MOVE CLASSIFICATION</h3>
                <div class="legend-item"><span class="legend-icon" style="color:#ef4444;"></span><span class="legend-text"><strong>DEFECT</strong> = Aggressive/competitive action (sanctions, tariffs, military moves)</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#22c55e;"></span><span class="legend-text"><strong>COOPERATE</strong> = De-escalation or collaborative action (deals, diplomacy)</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#3b82f6;"></span><span class="legend-text"><strong>SIGNAL</strong> = Communication without action (rhetoric, posturing, warnings)</span></div>
                
                <h3 style="color: var(--accent-orange);"> GAME THEORY PATTERNS</h3>
                <div class="legend-item"><span class="legend-icon"></span><span class="legend-text"><strong>Chicken Game</strong> = Brinkmanship, high accident risk (first to swerve loses)</span></div>
                <div class="legend-item"><span class="legend-icon"></span><span class="legend-text"><strong>Prisoner's Dilemma</strong> = Escalation spiral risk (tariffs, retaliation)</span></div>
                <div class="legend-item"><span class="legend-icon"></span><span class="legend-text"><strong>Coordination Game</strong> = Finding focal points together (G7/G20)</span></div>
                <div class="legend-item"><span class="legend-icon"></span><span class="legend-text"><strong>Zero-Sum</strong> = Winner-take-all confrontation</span></div>
                <div class="legend-item"><span class="legend-icon"></span><span class="legend-text"><strong>Signaling Game</strong> = Forward guidance, market expectation shaping</span></div>
                <div class="legend-item"><span class="legend-icon"></span><span class="legend-text"><strong>Reputation Game</strong> = Credibility stakes, precedent-setting</span></div>
                
                <h3 style="color: #ef4444;"> EMERGING SIGNALS</h3>
                <p style="line-height: 1.6;">The system continuously scans for NEW conflicts forming - situations not yet tracked in Active Theaters.</p>
                
                <p style="font-weight:600;color:#a78bfa;margin-top:12px;margin-bottom:8px;">How it works:</p>
                <div class="legend-item"><span class="legend-icon">1</span><span class="legend-text">Headlines not matching existing conflicts are tagged as "orphans"</span></div>
                <div class="legend-item"><span class="legend-icon">2</span><span class="legend-text">AI clusters similar orphans (needs 3+ headlines from 2+ sources)</span></div>
                <div class="legend-item"><span class="legend-icon">3</span><span class="legend-text">Gemini analyzes: "Is this a genuine emerging strategic situation?"</span></div>
                <div class="legend-item"><span class="legend-icon">4</span><span class="legend-text">If confidence >60%, a proposal appears with title, players, phase, and location</span></div>
                
                <p style="font-weight:600;color:#a78bfa;margin-top:12px;margin-bottom:8px;">Your decision:</p>
                <div class="legend-item"><span class="legend-icon" style="color:#22c55e;">+</span><span class="legend-text"><strong>ACCEPT</strong> = Adds to Active Theaters, starts tracking moves, appears on globe, AI monitors for updates</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#ef4444;">-</span><span class="legend-text"><strong>DISMISS</strong> = Removes from queue, similar headlines suppressed temporarily (can reappear with new evidence)</span></div>
                
                <p style="margin-left:24px;color:#6a7585;font-size:0.95em;margin-top:8px;">Compound Stress signals also feed here - when tripwires cluster together, AI proposes conflicts forming from structural stress patterns, not just headlines.</p>
                
                <h3 style="color: #22c55e;"> AUTO-ARCHIVE (Conflict Resolution)</h3>
                <p style="line-height: 1.6;">Conflicts automatically leave the active list and map when resolved:</p>
                
                <div class="legend-item"><span class="legend-icon"></span><span class="legend-text"><strong>STABLE 7+ days</strong> = Phase stays STABLE/COORDINATION for a week  archived</span></div>
                <div class="legend-item"><span class="legend-icon"></span><span class="legend-text"><strong>INACTIVE 30+ days</strong> = No new moves detected for a month  archived</span></div>
                <div class="legend-item"><span class="legend-icon"></span><span class="legend-text"><strong>PEACE DETECTED</strong> = Headlines mention ceasefire, peace deal, treaty  archived</span></div>
                
                <p style="margin-left:24px;color:#6a7585;font-size:0.95em;margin-top:8px;">Archived conflicts are preserved for history but removed from active tracking. The system self-cleans so you only see what matters NOW.</p>
                
                <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    <p style="font-size: 0.75rem; color: #6a7585; line-height: 1.5; text-align: center;">
                        <strong>DISCLAIMER:</strong> This is not financial advice. This content is for informational and educational purposes only. Always do your own due diligence and consult with a professional before making investment decisions.
                    </p>
                </div>
                
            </div>
        </div>
    </div>

    <!-- RISK BRIEFING Modal -->
    <div id="riskBriefingModal" class="chart-modal-overlay" style="display: none;" onclick="closeRiskBriefing(event)">
        <div class="chart-modal-content" onclick="event.stopPropagation()" style="max-width: 700px; border-color: #3b82f6;">
            <button class="chart-close-btn" onclick="closeRiskBriefing()" style="color: #3b82f6;"></button>
            <div class="modal-title" style="color: #60a5fa; padding: 0.5rem 0;">RISK BRIEFING</div>
            <div class="modal-analysis info-modal-scroll">
                
                <h3 style="color: var(--accent-orange); margin-top: 0;">WHY SYSTEMIC RISK MATTERS</h3>
                <p style="line-height: 1.6;">Markets don't crash in isolation - they fail systemically. <strong>Systemic risk</strong> is the hidden wiring beneath the surface: the plumbing that moves money, the collateral that backs loans, and the sentiment that drives herds. When this infrastructure breaks, everything correlates to 1.</p>
                <p style="line-height: 1.6;">This column gives you a real-time view into the <strong>structural health</strong> of global markets - the early warning signs that professionals watch before headlines catch up.</p>
                
                <h3 style="color: #3b82f6;">SYSTEMIC CONDITIONS DASHBOARD</h3>
                
                <div style="background: rgba(59, 130, 246, 0.1); border-radius: 6px; padding: 12px; margin-bottom: 12px; border-left: 3px solid #3b82f6;">
                    <div style="font-weight: 700; color: #60a5fa; margin-bottom: 8px;">PLUMBING & COLLATERAL</div>
                    
                    <div style="margin-bottom: 12px;">
                        <strong style="color: #93c5fd;">Yield Curve (10Y-2Y)</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">The spread between 10-year and 2-year Treasury yields. Inversion (negative) historically precedes recessions by 12-18 months. "NORMAL" means the curve is positive and healthy. "INVERTED" signals economic contraction risk.</p>
                    </div>
                    
                    <div style="margin-bottom: 8px;">
                        <strong style="color: #93c5fd;">Curve Dynamics (Real-Time Detection)</strong>
                        <p style="margin: 4px 0 8px 0; font-size: 0.85rem; color: #94a3b8;">The system tracks <em>how</em> the curve is moving - not just where it is. Four regimes tell you what's driving the market:</p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 0.8rem;">
                            <div style="background: rgba(74, 222, 128, 0.1); padding: 8px; border-radius: 4px; border-left: 3px solid #4ade80;">
                                <strong style="color: #4ade80;">BULL STEEPENER</strong>
                                <p style="margin: 4px 0 0 0; color: #94a3b8; font-size: 0.75rem;">Short rates falling faster. Fed cutting, recession fears.</p>
                                <p style="margin: 6px 0 0 0; font-size: 0.7rem; font-family: 'IBM Plex Mono', monospace;">
                                    <span style="color: #4ade80;">2Y: 5.0%  4.5%</span> <span style="color: #6a7585;">(-50bp)</span><br>
                                    <span style="color: #4ade80;">10Y: 5.5%  5.3%</span> <span style="color: #6a7585;">(-20bp)</span><br>
                                    <span style="color: #fff;">Spread: +30bp wider</span>
                                </p>
                            </div>
                            <div style="background: rgba(255, 68, 102, 0.1); padding: 8px; border-radius: 4px; border-left: 3px solid #ff4466;">
                                <strong style="color: #ff4466;">BEAR STEEPENER</strong>
                                <p style="margin: 4px 0 0 0; color: #94a3b8; font-size: 0.75rem;">Long rates rising faster. Inflation fears, growth expectations.</p>
                                <p style="margin: 6px 0 0 0; font-size: 0.7rem; font-family: 'IBM Plex Mono', monospace;">
                                    <span style="color: #ff4466;">2Y: 4.0%  4.2%</span> <span style="color: #6a7585;">(+20bp)</span><br>
                                    <span style="color: #ff4466;">10Y: 4.5%  5.0%</span> <span style="color: #6a7585;">(+50bp)</span><br>
                                    <span style="color: #fff;">Spread: +30bp wider</span>
                                </p>
                            </div>
                            <div style="background: rgba(0, 217, 255, 0.1); padding: 8px; border-radius: 4px; border-left: 3px solid #00D9FF;">
                                <strong style="color: #00D9FF;">BULL FLATTENER</strong>
                                <p style="margin: 4px 0 0 0; color: #94a3b8; font-size: 0.75rem;">Long rates falling faster. Flight to safety, slowdown fears.</p>
                                <p style="margin: 6px 0 0 0; font-size: 0.7rem; font-family: 'IBM Plex Mono', monospace;">
                                    <span style="color: #00D9FF;">2Y: 5.0%  4.8%</span> <span style="color: #6a7585;">(-20bp)</span><br>
                                    <span style="color: #00D9FF;">10Y: 5.5%  5.0%</span> <span style="color: #6a7585;">(-50bp)</span><br>
                                    <span style="color: #fff;">Spread: -30bp narrower</span>
                                </p>
                            </div>
                            <div style="background: rgba(255, 187, 51, 0.1); padding: 8px; border-radius: 4px; border-left: 3px solid #ffbb33;">
                                <strong style="color: #ffbb33;">BEAR FLATTENER</strong>
                                <p style="margin: 4px 0 0 0; color: #94a3b8; font-size: 0.75rem;">Short rates rising faster. Fed hiking, fighting inflation.</p>
                                <p style="margin: 6px 0 0 0; font-size: 0.7rem; font-family: 'IBM Plex Mono', monospace;">
                                    <span style="color: #ffbb33;">2Y: 4.0%  4.5%</span> <span style="color: #6a7585;">(+50bp)</span><br>
                                    <span style="color: #ffbb33;">10Y: 4.5%  4.7%</span> <span style="color: #6a7585;">(+20bp)</span><br>
                                    <span style="color: #fff;">Spread: -30bp narrower</span>
                                </p>
                            </div>
                        </div>
                        
                        <p style="margin: 10px 0 0 0; font-size: 0.8rem; color: #6a7585;"><strong>The Cycle:</strong> Bear Flattening (Fed hikes)  Bull Flattening (slowdown)  Bull Steepening (Fed cuts)  Bear Steepening (recovery). Understanding where we are in this cycle is key to positioning.</p>
                    </div>
                    
                    <div style="margin-bottom: 8px;">
                        <strong style="color: #93c5fd;">Global Collateral (HYG/TLT)</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Ratio of high-yield bonds to long Treasuries. "FLOWING" means risk appetite is healthy and collateral is being created. "DRAINING" means credit stress - bonds are being sold, collateral shrinking.</p>
                    </div>
                    
                    <div style="margin-bottom: 8px;">
                        <strong style="color: #93c5fd;">Plumbing Health (VIX Proxy)</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">VIX below 15 = "HEALTHY" markets, options cheap, no stress. 15-25 = "STRESSED", elevated uncertainty. Above 25 = "CLOGGED", fear rising, liquidity drying up.</p>
                    </div>
                    
                    <div>
                        <strong style="color: #93c5fd;">Credit Spread (LQD/HYG)</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Investment grade vs junk bond ratio. Rising spread = flight to quality, credit stress building. Widening spreads often precede market selloffs.</p>
                    </div>
                </div>
                
                <div style="background: rgba(59, 130, 246, 0.1); border-radius: 6px; padding: 12px; margin-bottom: 12px; border-left: 3px solid #60a5fa;">
                    <div style="font-weight: 700; color: #60a5fa; margin-bottom: 8px;">MARKET SENTIMENT</div>
                    
                    <div style="margin-bottom: 8px;">
                        <strong style="color: #93c5fd;">VIX Regime</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">The "fear gauge". LOW (<15): Complacency, potential for surprise shocks. NORMAL (15-20): Healthy caution. ELEVATED (20-30): Fear rising. EXTREME (>30): Panic territory.</p>
                    </div>
                    
                    <div style="margin-bottom: 8px;">
                        <strong style="color: #93c5fd;">Fear & Greed Index</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">CNN's 0-100 sentiment gauge. EXTREME GREED (75-100): Market euphoria, correction risk. GREED (55-75): Bullish sentiment. NEUTRAL (45-55): Balanced. FEAR (25-45): Pessimism. EXTREME FEAR (0-25): Capitulation - often a buy signal.</p>
                    </div>
                    
                    <div style="margin-bottom: 8px;">
                        <strong style="color: #93c5fd;">Dollar Strength (DXY)</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">US Dollar Index measuring strength against major currencies. Strong dollar (>105) = emerging market stress, commodity pressure, global liquidity tightening.</p>
                    </div>
                    
                    <div>
                        <strong style="color: #93c5fd;">Fed Cut Odds</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Market-implied probability of rate cuts at next Fed meeting. Rising odds = market pricing in economic weakness. Falling odds = confidence in growth.</p>
                    </div>
                </div>
                
                <div style="background: rgba(147, 51, 234, 0.1); border-radius: 6px; padding: 12px; margin-bottom: 12px; border-left: 3px solid #a855f7;">
                    <div style="font-weight: 700; color: #a855f7; margin-bottom: 8px;">BIFURCATION MONITOR</div>
                    
                    <div>
                        <strong style="color: #c4b5fd;">DragonBear Split (USD/CNH)</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Named after Velina Tchakarova's thesis. Tracks the China-Russia axis vs Western order through USD/CNH (offshore yuan). "STABLE" = global order holding. "DECOUPLING" = bifurcation accelerating, two economic blocs forming.</p>
                    </div>
                </div>
                
                <h3 style="color: #3b82f6;">BASE LAYER (Yields & Liquidity)</h3>
                <p style="line-height: 1.6;">Treasury yields are the foundation of all asset pricing. The 30Y, 10Y, 5Y, and 2Y yields show the term structure of interest rates:</p>
                
                <div class="legend-item"><span class="legend-icon" style="color:#3b82f6;">30Y</span><span class="legend-text"><strong>Long Bond</strong> = Long-term inflation expectations. Rising = inflation fears. Falling = deflation/recession fears.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#3b82f6;">10Y</span><span class="legend-text"><strong>Benchmark</strong> = The most important rate in global finance. Mortgages, corporate bonds, all priced off this.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#3b82f6;">5Y</span><span class="legend-text"><strong>Middle</strong> = Where the curve often inverts first. Sensitive to Fed policy shifts.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#3b82f6;">2Y</span><span class="legend-text"><strong>Fed Proxy</strong> = Most sensitive to Fed policy changes. When 2Y exceeds 10Y, the curve inverts.</span></div>
                
                <h3 style="color: var(--accent-orange);">DATA SOURCES</h3>
                <p style="line-height: 1.6;">All data is real-time from live market feeds:</p>
                <div class="legend-item"><span class="legend-icon">-</span><span class="legend-text"><strong>Treasury Yields</strong> - Yahoo Finance (real-time quotes)</span></div>
                <div class="legend-item"><span class="legend-icon">-</span><span class="legend-text"><strong>VIX</strong> - CBOE Volatility Index (real-time)</span></div>
                <div class="legend-item"><span class="legend-icon">-</span><span class="legend-text"><strong>Fear & Greed</strong> - CNN Business API</span></div>
                <div class="legend-item"><span class="legend-icon">-</span><span class="legend-text"><strong>DXY</strong> - US Dollar Index (Yahoo Finance)</span></div>
                <div class="legend-item"><span class="legend-icon">-</span><span class="legend-text"><strong>Fed Odds</strong> - CME FedWatch Tool implied probabilities</span></div>
                <div class="legend-item"><span class="legend-icon">-</span><span class="legend-text"><strong>HYG/TLT/LQD</strong> - ETF price ratios (Yahoo Finance)</span></div>
                
                <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    <p style="font-size: 0.75rem; color: #6a7585; line-height: 1.5; text-align: center;">
                        <strong>DISCLAIMER:</strong> This is not financial advice. This content is for informational and educational purposes only. Always do your own due diligence and consult with a professional before making investment decisions.
                    </p>
                </div>
                
            </div>
        </div>
    </div>

    <!-- SUPPLY BRIEFING Modal -->
    <div id="supplyBriefingModal" class="chart-modal-overlay" style="display: none;" onclick="closeSupplyBriefing(event)">
        <div class="chart-modal-content" onclick="event.stopPropagation()" style="max-width: 750px; border-color: var(--accent-yellow);">
            <button class="chart-close-btn" onclick="closeSupplyBriefing()" style="color: var(--accent-yellow);"></button>
            <div class="modal-title" style="color: var(--accent-yellow); padding: 0.5rem 0;">SUPPLY BRIEFING</div>
            <div class="modal-analysis info-modal-scroll">
                
                <h3 style="color: var(--accent-orange); margin-top: 0;">WHY COMMODITIES MATTER</h3>
                <p style="line-height: 1.6;">Commodities are the <strong>physical layer of the global economy</strong> - the raw inputs that everything is built from. When commodity prices move, they send signals about inflation, growth, supply chains, and geopolitical stress long before those forces appear in GDP data or corporate earnings.</p>
                <p style="line-height: 1.6;"><strong>Resource scarcity drives conflict.</strong> Wars are fought over oil, food prices topple governments, and supply chain disruptions cascade through the global economy. Understanding commodities means understanding the material constraints on civilization.</p>
                
                <h3 style="color: var(--accent-yellow);">METALS (8 Assets)</h3>
                
                <div style="background: rgba(255, 193, 7, 0.1); border-radius: 6px; padding: 12px; margin-bottom: 12px; border-left: 3px solid var(--accent-yellow);">
                    <div style="display: grid; gap: 10px;">
                        <div>
                            <strong style="color: #fcd34d;">GOLD (GC)</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">The ultimate safe haven. 5,000 years as money. Central banks hold it, nations hoard it. Rises during uncertainty, inflation, and currency crises. The "anti-fiat" trade.</p>
                        </div>
                        <div>
                            <strong style="color: #fcd34d;">SILVER (SI)</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Both precious and industrial. Solar panels, electronics, EVs all need it. More volatile than gold but higher beta. "Poor man's gold" with industrial upside.</p>
                        </div>
                        <div>
                            <strong style="color: #fcd34d;">COPPER (HG)</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">"Dr. Copper" - the metal with a PhD in economics. Essential for wiring, construction, EVs. Rising copper = economic growth. Falling copper = slowdown warning.</p>
                        </div>
                        <div>
                            <strong style="color: #fcd34d;">PLATINUM (PL)</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Catalytic converters, hydrogen fuel cells, jewelry. Rarer than gold. South Africa produces 70%. Labor disputes and power outages create supply shocks.</p>
                        </div>
                        <div>
                            <strong style="color: #fcd34d;">PALLADIUM (PA)</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Auto catalysts (gasoline engines). Russia produces 40% - sanctions matter. EV transition threatens long-term demand. Extremely volatile.</p>
                        </div>
                        <div>
                            <strong style="color: #fcd34d;">ALUMINUM (ALI)</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Packaging, aerospace, construction. Energy-intensive to produce - electricity prices drive costs. China dominates production. Trade wars impact prices.</p>
                        </div>
                        <div>
                            <strong style="color: #fcd34d;">NICKEL</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">EV batteries, stainless steel. Indonesia controls 50% of production. Critical for the energy transition. Prone to short squeezes (2022 LME crisis).</p>
                        </div>
                        <div>
                            <strong style="color: #fcd34d;">ZINC</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Galvanizing steel (rust prevention). Construction bellwether. China is biggest producer and consumer. Infrastructure spending indicator.</p>
                        </div>
                    </div>
                </div>
                
                <h3 style="color: #f97316;">ENERGY (8 Assets)</h3>
                
                <div style="background: rgba(249, 115, 22, 0.1); border-radius: 6px; padding: 12px; margin-bottom: 12px; border-left: 3px solid #f97316;">
                    <div style="display: grid; gap: 10px;">
                        <div>
                            <strong style="color: #fdba74;">WTI CRUDE (CL)</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">West Texas Intermediate - US benchmark oil. Cushing, Oklahoma delivery. Most traded commodity in the world. Geopolitics, OPEC, shale production all matter.</p>
                        </div>
                        <div>
                            <strong style="color: #fdba74;">BRENT CRUDE (BZ)</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Global benchmark for 2/3 of world oil. North Sea origin. Usually trades $3-5 above WTI. Better reflects global supply/demand.</p>
                        </div>
                        <div>
                            <strong style="color: #fdba74;">NATURAL GAS (NG)</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Heating, electricity, fertilizers. Henry Hub benchmark (Louisiana). Weather-driven volatility. LNG exports connect US prices to global markets.</p>
                        </div>
                        <div>
                            <strong style="color: #fdba74;">GASOLINE (RB)</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">RBOB - reformulated gasoline. Consumer pain point. Politicians watch it closely. Seasonal patterns (summer driving). Refinery margins matter.</p>
                        </div>
                        <div>
                            <strong style="color: #fdba74;">HEATING OIL (HO)</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Diesel proxy. Trucking, shipping, heating. Winter demand spikes. Northeast US dependent. Distillate inventories signal economic activity.</p>
                        </div>
                        <div>
                            <strong style="color: #fdba74;">URANIUM (URA ETF)</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Nuclear fuel. Clean energy revival driving demand. Kazatomprom (Kazakhstan) dominates supply. Multi-year bull market as nuclear expands.</p>
                        </div>
                        <div>
                            <strong style="color: #fdba74;">CLEAN ENERGY (ICLN ETF)</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Solar, wind, green hydrogen companies. Policy-sensitive. Inflation Reduction Act beneficiary. Interest rate sensitive (growth stocks).</p>
                        </div>
                        <div>
                            <strong style="color: #fdba74;">ENERGY SELECT (XLE)</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Major oil & gas stocks (Exxon, Chevron). Dividends matter. Value vs growth trade. Leverage to oil prices with operational hedging.</p>
                        </div>
                    </div>
                </div>
                
                <h3 style="color: #22c55e;">AGRICULTURE (16 Assets)</h3>
                
                <div style="background: rgba(34, 197, 94, 0.1); border-radius: 6px; padding: 12px; margin-bottom: 12px; border-left: 3px solid #22c55e;">
                    <div style="display: grid; gap: 8px;">
                        <div>
                            <strong style="color: #86efac;">WHEAT (ZW)</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Global bread staple. Black Sea conflict critical - Ukraine/Russia = 30% of exports. Food security flashpoint. Rising wheat = revolution risk in EM.</p>
                        </div>
                        <div>
                            <strong style="color: #86efac;">CORN (ZC)</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Feed grain, ethanol, sweeteners. US Midwest dominates. Weather-dependent. Ethanol mandate links to gasoline. Protein feed chain starts here.</p>
                        </div>
                        <div>
                            <strong style="color: #86efac;">SOYBEANS (ZS)</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Protein, oil, feed. China imports heavily - trade war weapon. Brazil competing with US. Crushing margins signal processing demand.</p>
                        </div>
                        <div>
                            <strong style="color: #86efac;">SOY MEAL (ZM) / SOY OIL (ZL)</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Crushing products. Meal = animal feed (poultry, pork). Oil = cooking, biodiesel. Crush spread = processing profit indicator.</p>
                        </div>
                        <div>
                            <strong style="color: #86efac;">RICE (ZR)</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">3 billion people depend on it daily. Asia-centric. Export bans cause price spikes. India (40% of exports) policy matters enormously.</p>
                        </div>
                        <div>
                            <strong style="color: #86efac;">COFFEE (KC)</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Second most traded commodity after oil. Brazil, Vietnam dominate. Climate-sensitive (frost, drought). Consumer staple with inelastic demand.</p>
                        </div>
                        <div>
                            <strong style="color: #86efac;">COCOA (CC)</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Chocolate's input. West Africa (Ivory Coast, Ghana) = 60%. Disease, weather, child labor concerns. Luxury demand driver.</p>
                        </div>
                        <div>
                            <strong style="color: #86efac;">SUGAR (SB)</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Brazil dominates. Ethanol alternative (sugar cane). Health trends vs EM demand growth. Weather in Brazil/India drives supply.</p>
                        </div>
                        <div>
                            <strong style="color: #86efac;">COTTON (CT)</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Textile input. China, India, US are key. Fast fashion demand driver. Xinjiang production controversial (forced labor).</p>
                        </div>
                        <div>
                            <strong style="color: #86efac;">CATTLE (LE) / HOGS (HE)</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Protein cycle. Feed costs (corn) matter. Disease outbreaks (ASF in China 2018) cause massive price swings. Consumer spending indicator.</p>
                        </div>
                        <div>
                            <strong style="color: #86efac;">LUMBER (LBS)</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Housing market indicator. COVID showed extreme volatility (10x moves). Canadian supply, US demand. Housing starts correlation.</p>
                        </div>
                        <div>
                            <strong style="color: #86efac;">ORANGE JUICE (OJ)</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Florida citrus disease, Brazil weather. Small market, high volatility. "Trading Places" made it famous.</p>
                        </div>
                    </div>
                </div>
                
                <h3 style="color: var(--accent-orange);">READING THE SIGNALS</h3>
                <p style="line-height: 1.6;"><strong>Rising commodities broadly</strong> = Inflation pressure, economic growth, or supply constraints</p>
                <p style="line-height: 1.6;"><strong>Falling commodities broadly</strong> = Demand destruction, recession fears, deflation</p>
                <p style="line-height: 1.6;"><strong>Energy up, metals down</strong> = Geopolitical risk without growth</p>
                <p style="line-height: 1.6;"><strong>Agricultural spikes</strong> = Weather events, export bans, food security crisis</p>
                
                <h3 style="color: var(--accent-orange);">DATA SOURCES</h3>
                <p style="line-height: 1.6;">All commodity data is real-time from live market feeds:</p>
                <div class="legend-item"><span class="legend-icon">-</span><span class="legend-text"><strong>Futures Prices</strong> - Yahoo Finance (real-time quotes for CME, NYMEX, ICE contracts)</span></div>
                <div class="legend-item"><span class="legend-icon">-</span><span class="legend-text"><strong>ETF Prices</strong> - Yahoo Finance (URA, ICLN, XLE)</span></div>
                <div class="legend-item"><span class="legend-icon">-</span><span class="legend-text"><strong>TradingView Charts</strong> - Click any asset for detailed technical analysis</span></div>
                
                <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    <p style="font-size: 0.75rem; color: #6a7585; line-height: 1.5; text-align: center;">
                        <strong>DISCLAIMER:</strong> This is not financial advice. This content is for informational and educational purposes only. Always do your own due diligence and consult with a professional before making investment decisions.
                    </p>
                </div>
                
            </div>
        </div>
    </div>

    <!-- FLOWS BRIEFING Modal -->
    <div id="flowsBriefingModal" class="chart-modal-overlay" style="display: none;" onclick="closeFlowsBriefing(event)">
        <div class="chart-modal-content" onclick="event.stopPropagation()" style="max-width: 750px; border-color: #00D9FF;">
            <button class="chart-close-btn" onclick="closeFlowsBriefing()" style="color: #00D9FF;"></button>
            <div class="modal-title" style="color: #00D9FF; padding: 0.5rem 0;">FLOWS BRIEFING</div>
            <div class="modal-analysis info-modal-scroll">
                
                <h3 style="color: var(--accent-orange); margin-top: 0;">WHY CURRENCIES MATTER</h3>
                <p style="line-height: 1.6;">Currencies are the <strong>blood of the global economy</strong> - every trade, every investment, every debt flows through FX markets. With $7.5 trillion traded daily, currencies are the most liquid market on Earth and often the first to react to macro shifts.</p>
                <p style="line-height: 1.6;">Currency movements reveal <strong>capital flows, interest rate expectations, trade balances, and geopolitical risk</strong> in real-time. A currency crisis can bankrupt nations and trigger contagion across continents.</p>
                
                <h3 style="color: #00D9FF;">RESERVES (Core Liquidity Pairs)</h3>
                
                <div style="background: rgba(0, 217, 255, 0.1); border-radius: 6px; padding: 12px; margin-bottom: 12px; border-left: 3px solid #00D9FF;">
                    <div style="display: grid; gap: 8px;">
                        <div>
                            <strong style="color: #67e8f9;">EUR/USD</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">The world's most traded pair. Europe vs America. ECB vs Fed. Trade balance, rate differentials, and risk appetite all matter.</p>
                        </div>
                        <div>
                            <strong style="color: #67e8f9;">USD/JPY</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Dollar-Yen. BOJ yield curve control makes this policy-sensitive. Carry trade favorite. Yen weakness = Japan exporting deflation.</p>
                        </div>
                        <div>
                            <strong style="color: #67e8f9;">GBP/USD</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">"Cable" - named after transatlantic telegraph. Brexit impacts persist. BOE policy, UK gilt crisis memories (2022 LDI).</p>
                        </div>
                        <div>
                            <strong style="color: #67e8f9;">USD/CHF</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Swiss Franc - ultimate safe haven. SNB interventions. Negative rates history. Flight-to-safety during European stress.</p>
                        </div>
                    </div>
                </div>
                
                <h3 style="color: #ef4444;">FRICTION (Geopolitical Flashpoints)</h3>
                
                <div style="background: rgba(239, 68, 68, 0.1); border-radius: 6px; padding: 12px; margin-bottom: 12px; border-left: 3px solid #ef4444;">
                    <div style="display: grid; gap: 8px;">
                        <div>
                            <strong style="color: #fca5a5;">USD/CNH</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Offshore Yuan - the DragonBear proxy. PBOC managed rate. Trade war barometer. De-dollarization indicator. Breaking 7.30 signals stress.</p>
                        </div>
                        <div>
                            <strong style="color: #fca5a5;">USD/TRY</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Turkish Lira - poster child of EM currency crisis. Erdogan vs orthodox policy. Inflation >60%. Strategic NATO member.</p>
                        </div>
                        <div>
                            <strong style="color: #fca5a5;">USD/ILS</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Israeli Shekel. Middle East conflict proxy. Tech sector strength. BOI interventions during Gaza escalations.</p>
                        </div>
                        <div>
                            <strong style="color: #fca5a5;">USD/PLN</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Polish Zloty. NATO eastern flank. Ukraine war proximity. EU tensions, rule of law disputes.</p>
                        </div>
                        <div>
                            <strong style="color: #fca5a5;">USD/KRW</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Korean Won. North Korea risk proxy. Tech/semiconductor exposure. China trade dependence.</p>
                        </div>
                    </div>
                </div>
                
                <h3 style="color: #22c55e;">RESOURCE BLOC (Commodity Currencies)</h3>
                
                <div style="background: rgba(34, 197, 94, 0.1); border-radius: 6px; padding: 12px; margin-bottom: 12px; border-left: 3px solid #22c55e;">
                    <div style="display: grid; gap: 8px;">
                        <div>
                            <strong style="color: #86efac;">AUD/USD</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">"Aussie" - China growth proxy via iron ore, coal. Risk-on/risk-off bellwether. RBA policy. Housing bubble concerns.</p>
                        </div>
                        <div>
                            <strong style="color: #86efac;">USD/CAD</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">"Loonie" - oil correlation strong. US trade partner. BOC tracks Fed closely. Housing market fragility.</p>
                        </div>
                        <div>
                            <strong style="color: #86efac;">NZD/USD</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">"Kiwi" - dairy exports to China. Smaller and more volatile than AUD. RBNZ often first mover on rates.</p>
                        </div>
                        <div>
                            <strong style="color: #86efac;">USD/NOK</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Norwegian Krone - oil and gas. Sovereign wealth fund. European energy security. Brent crude correlation.</p>
                        </div>
                        <div>
                            <strong style="color: #86efac;">USD/ZAR</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">South African Rand - gold, platinum. Load shedding (power crisis). EM risk proxy. High carry but high vol.</p>
                        </div>
                        <div>
                            <strong style="color: #86efac;">USD/BRL</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Brazilian Real - agriculture, iron ore. Political volatility. High interest rates. LatAm bellwether.</p>
                        </div>
                    </div>
                </div>
                
                <h3 style="color: #f59e0b;">DIGITAL CURRENCIES: THE NEW FRONTIER</h3>
                
                <div style="background: rgba(245, 158, 11, 0.1); border-radius: 6px; padding: 12px; margin-bottom: 12px; border-left: 3px solid #f59e0b;">
                    <div style="margin-bottom: 12px;">
                        <strong style="color: #fcd34d;">BITCOIN (BTC)</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Digital gold. Fixed 21 million supply. Institutional adoption accelerating (ETFs approved 2024). Halving cycles drive supply dynamics. Correlates with liquidity, not inflation (yet). Nation-state adoption beginning (El Salvador, potential US strategic reserve). Volatility decreasing as market matures. The "exit from fiat" trade.</p>
                    </div>
                    <div>
                        <strong style="color: #fcd34d;">ETHEREUM (ETH)</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Programmable money. Smart contracts power DeFi, NFTs, tokenization. Proof-of-stake transition complete. Layer 2 scaling expanding capacity. Institutional interest in staking yields. Real yield vs inflationary tokens. The "infrastructure of Web3" trade.</p>
                    </div>
                </div>
                
                <h3 style="color: #a855f7;">THE DIGITAL FUTURE</h3>
                <p style="line-height: 1.6;">We are witnessing a <strong>monetary regime change</strong>. Central Bank Digital Currencies (CBDCs) are being developed by 130+ countries. China's digital yuan is operational. The Fed is researching a digital dollar.</p>
                <p style="line-height: 1.6;">Meanwhile, Bitcoin and Ethereum offer <strong>alternative rails</strong> outside state control. The battle between sovereign digital currencies and decentralized networks will define the next monetary era.</p>
                <p style="line-height: 1.6;"><strong>Key questions for traders:</strong> Will Bitcoin become digital reserve asset? Will stablecoins replace correspondent banking? Will CBDCs enable surveillance or efficiency? These are the macro themes of the 2020s.</p>
                
                <h3 style="color: var(--accent-orange);">DATA SOURCES</h3>
                <p style="line-height: 1.6;">All FX and crypto data is real-time from verified sources:</p>
                <div class="legend-item"><span class="legend-icon">-</span><span class="legend-text"><strong>FX Rates</strong> - Yahoo Finance real-time quotes (major and exotic pairs)</span></div>
                <div class="legend-item"><span class="legend-icon">-</span><span class="legend-text"><strong>Crypto Prices</strong> - Yahoo Finance (BTC-USD, ETH-USD)</span></div>
                <div class="legend-item"><span class="legend-icon">-</span><span class="legend-text"><strong>DXY Index</strong> - Yahoo Finance (US Dollar Index)</span></div>
                <div class="legend-item"><span class="legend-icon">-</span><span class="legend-text"><strong>TradingView Charts</strong> - Click any pair for detailed technical analysis</span></div>
                
                <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    <p style="font-size: 0.75rem; color: #6a7585; line-height: 1.5; text-align: center;">
                        <strong>DISCLAIMER:</strong> This is not financial advice. This content is for informational and educational purposes only. Always do your own due diligence and consult with a professional before making investment decisions.
                    </p>
                </div>
                
            </div>
        </div>
    </div>

    <!-- SIGNALS BRIEFING Modal -->
    <div id="signalsBriefingModal" class="chart-modal-overlay" style="display: none;" onclick="closeSignalsBriefing(event)">
        <div class="chart-modal-content" onclick="event.stopPropagation()" style="max-width: 750px; border-color: #22c55e;">
            <button class="chart-close-btn" onclick="closeSignalsBriefing()" style="color: #22c55e;"></button>
            <div class="modal-title" style="color: #22c55e; padding: 0.5rem 0;">SIGNALS BRIEFING</div>
            <div class="modal-analysis info-modal-scroll">
                
                <h3 style="color: var(--accent-orange); margin-top: 0;">WHY PROBABILITIES MATTER</h3>
                <p style="line-height: 1.6;">Markets are <strong>probability machines</strong>. Every price is a bet on the future. Understanding where assets sit relative to their statistical norms - and what the crowd expects - gives you an edge that pure fundamental analysis cannot.</p>
                <p style="line-height: 1.6;"><strong>Tail risk</strong> is where fortunes are made and lost. The events that "shouldn't happen" - 3+ standard deviation moves - occur far more often than models predict. Tracking extremes helps you prepare for the unexpected.</p>
                
                <h3 style="color: #22c55e;">TACTICAL STRUCTURE ENGINE</h3>
                <p style="line-height: 1.6;">Our proprietary 8-layer quantitative engine processes 67 assets in real-time, calculating key levels, volatility regimes, and strategic signals.</p>
                
                <div style="background: rgba(34, 197, 94, 0.1); border-radius: 6px; padding: 12px; margin-bottom: 12px; border-left: 3px solid #22c55e;">
                    <div style="font-weight: 700; color: #22c55e; margin-bottom: 8px;">THE 8 LAYERS</div>
                    
                    <div class="legend-item"><span class="legend-icon" style="color:#22c55e;">1</span><span class="legend-text"><strong>MARKET DATA</strong> = Real-time prices from Yahoo Finance, validated against bad ticks.</span></div>
                    <div class="legend-item"><span class="legend-icon" style="color:#22c55e;">2</span><span class="legend-text"><strong>VOLATILITY ENGINE</strong> = 20-day Parkinson volatility (uses high/low, more accurate than close-to-close).</span></div>
                    <div class="legend-item"><span class="legend-icon" style="color:#22c55e;">3</span><span class="legend-text"><strong>STRUCTURE DETECTOR</strong> = ATR-normalized distance from pivot. Identifies "P-Shape" (trending) vs "Coiling" (compression).</span></div>
                    <div class="legend-item"><span class="legend-icon" style="color:#22c55e;">4</span><span class="legend-text"><strong>QUARTERLY ANCHORS</strong> = Q1 high/low creates strategic reference. Breakouts above = bullish, below = bearish.</span></div>
                    <div class="legend-item"><span class="legend-icon" style="color:#22c55e;">5</span><span class="legend-text"><strong>REGIME CLASSIFIER</strong> = BULLISH/BEARISH/DISTRIBUTION/ACCUMULATION based on price position and volatility.</span></div>
                    <div class="legend-item"><span class="legend-icon" style="color:#22c55e;">6</span><span class="legend-text"><strong>Z-SCORE NORMALIZER</strong> = Standard deviations from 20-day mean. Extreme readings signal reversal risk.</span></div>
                    <div class="legend-item"><span class="legend-icon" style="color:#22c55e;">7</span><span class="legend-text"><strong>SIGNAL GENERATOR</strong> = VOL SQUEEZE (low vol breakout setup), MOMENTUM (trend strength), REVERSAL (extreme extension).</span></div>
                    <div class="legend-item"><span class="legend-icon" style="color:#22c55e;">8</span><span class="legend-text"><strong>KEY LEVELS</strong> = Resistance (Q1 high + buffer) and Support (Q1 low - buffer). Distance % shows proximity.</span></div>
                </div>
                
                <h3 style="color: var(--accent-orange);">REGIME CLASSIFICATION</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                    <div style="background: rgba(34, 197, 94, 0.15); padding: 10px; border-radius: 4px; border-left: 3px solid #22c55e;">
                        <strong style="color: #22c55e;">BULLISH</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #6a7585;">Above Q1 high. Trend is up. Buy dips to support.</p>
                    </div>
                    <div style="background: rgba(239, 68, 68, 0.15); padding: 10px; border-radius: 4px; border-left: 3px solid #ef4444;">
                        <strong style="color: #ef4444;">BEARISH</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #6a7585;">Below Q1 low. Trend is down. Sell rallies to resistance.</p>
                    </div>
                    <div style="background: rgba(249, 115, 22, 0.15); padding: 10px; border-radius: 4px; border-left: 3px solid #f97316;">
                        <strong style="color: #f97316;">DISTRIBUTION</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #6a7585;">Near highs but losing momentum. Smart money selling to retail.</p>
                    </div>
                    <div style="background: rgba(59, 130, 246, 0.15); padding: 10px; border-radius: 4px; border-left: 3px solid #3b82f6;">
                        <strong style="color: #3b82f6;">ACCUMULATION</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #6a7585;">Near lows but stabilizing. Smart money buying from panicked sellers.</p>
                    </div>
                </div>
                
                <h3 style="color: var(--accent-orange);">Z-SCORE INTERPRETATION</h3>
                <div class="legend-item"><span class="legend-icon" style="color:#ef4444;">+++</span><span class="legend-text"><strong>OVERBOUGHT EXTREME</strong> (Z > 2.0) = 2+ standard deviations above mean. Reversal risk high.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#f59e0b;">++</span><span class="legend-text"><strong>OVERBOUGHT</strong> (Z 1.0-2.0) = Extended above mean. Watch for distribution.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#22c55e;">+</span><span class="legend-text"><strong>ABOVE MEAN</strong> (Z 0.3-1.0) = Healthy bullish bias. Trend intact.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#6a7585;">=</span><span class="legend-text"><strong>FAIR VALUE</strong> (Z -0.3 to 0.3) = Near pivot. Decision zone.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#22c55e;">-</span><span class="legend-text"><strong>BELOW MEAN</strong> (Z -0.3 to -1.0) = Mild discount. Accumulation zone if trend up.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#f59e0b;">--</span><span class="legend-text"><strong>OVERSOLD</strong> (Z -1.0 to -2.0) = Stretched below mean. Watch for accumulation.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#ef4444;">---</span><span class="legend-text"><strong>OVERSOLD EXTREME</strong> (Z < -2.0) = 2+ standard deviations below. Bounce potential high.</span></div>
                
                <h3 style="color: #a855f7;">POLYMARKET ODDS</h3>
                <p style="line-height: 1.6;">Prediction markets aggregate crowd wisdom with real money at stake. Unlike polls or pundits, traders lose money when wrong. Polymarket prices reflect the <strong>true probability</strong> the market assigns to events.</p>
                
                <div style="background: rgba(147, 51, 234, 0.1); border-radius: 6px; padding: 12px; margin-bottom: 12px; border-left: 3px solid #a855f7;">
                    <div class="legend-item"><span class="legend-icon" style="color:#a855f7;">-</span><span class="legend-text"><strong>MACRO</strong> = Fed rate decisions, recession odds, inflation outcomes</span></div>
                    <div class="legend-item"><span class="legend-icon" style="color:#a855f7;">-</span><span class="legend-text"><strong>CRYPTO</strong> = Bitcoin price targets, ETF approvals, regulatory actions</span></div>
                    <div class="legend-item"><span class="legend-icon" style="color:#a855f7;">-</span><span class="legend-text"><strong>POLITICS</strong> = Elections, policy changes, geopolitical events</span></div>
                </div>
                
                <h3 style="color: var(--accent-orange);">ASSET CATEGORIES</h3>
                <div class="legend-item"><span class="legend-icon" style="color:#ef4444;">G</span><span class="legend-text"><strong>GENERALS (8)</strong> = Major indices and VIX. The "generals" lead the market.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#fcd34d;">M</span><span class="legend-text"><strong>METALS (7)</strong> = Precious and base metals. Safe haven and industrial indicators.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#f97316;">E</span><span class="legend-text"><strong>ENERGY (9)</strong> = Oil, gas, uranium, clean energy. Geopolitical sensitivity high.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#22c55e;">A</span><span class="legend-text"><strong>AGRICULTURE (16)</strong> = Grains, softs, livestock. Food security and inflation.</span></div>
                <div class="legend-item"><span class="legend-icon" style="color:#00D9FF;">F</span><span class="legend-text"><strong>FX/CRYPTO (27)</strong> = Currencies and digital assets. Capital flows and sentiment.</span></div>
                
                <h3 style="color: var(--accent-orange);">HOW TO USE</h3>
                <p style="line-height: 1.6;"><strong>1. Click category headers</strong> to expand/collapse asset lists.</p>
                <p style="line-height: 1.6;"><strong>2. Click any asset row</strong> to trigger deep AI analysis with statecraft context.</p>
                <p style="line-height: 1.6;"><strong>3. Watch distance percentages</strong> - approaching 0% means price is at the key level.</p>
                <p style="line-height: 1.6;"><strong>4. Cross-reference with news</strong> - when Z-score is extreme AND news mentions the asset, expect volatility.</p>
                
                <h3 style="color: var(--accent-orange);">DATA SOURCES</h3>
                <p style="line-height: 1.6;">All data is real-time from verified sources:</p>
                <div class="legend-item"><span class="legend-icon">-</span><span class="legend-text"><strong>Asset Prices</strong> - Yahoo Finance real-time quotes</span></div>
                <div class="legend-item"><span class="legend-icon">-</span><span class="legend-text"><strong>Polymarket</strong> - Live prediction market odds from gamma-api.polymarket.com</span></div>
                <div class="legend-item"><span class="legend-icon">-</span><span class="legend-text"><strong>Quarterly Anchors</strong> - Calculated from Q1 historical data</span></div>
                <div class="legend-item"><span class="legend-icon">-</span><span class="legend-text"><strong>Z-Scores</strong> - Computed using 20-period Parkinson volatility</span></div>
                
                <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    <p style="font-size: 0.75rem; color: #6a7585; line-height: 1.5; text-align: center;">
                        <strong>DISCLAIMER:</strong> This is not financial advice. This content is for informational and educational purposes only. Always do your own due diligence and consult with a professional before making investment decisions.
                    </p>
                </div>
                
            </div>
        </div>
    </div>

    <!-- Individual Intel Widget Modals -->
    <!-- Revolution Risk Deep Dive Modal -->
    <div id="revRiskModal" class="chart-modal-overlay" style="display: none;" onclick="closeIntelModal('revRiskModal', event)">
        <div class="chart-modal-content" onclick="event.stopPropagation()" style="max-width: 650px; border-color: #ef4444;">
            <button class="chart-close-btn" onclick="closeIntelModal('revRiskModal')" style="top: 15px; right: 15px; position: absolute; color: #ef4444;">x</button>
            <div class="modal-title" style="color: #ef4444; padding: 0.5rem 0;">REVOLUTION RISK INDEX</div>
            <div class="modal-analysis info-modal-scroll">
                <p style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 1rem;"><em>Bread + Fuel Index - Tracking the Economic Preconditions of Social Unrest</em></p>
                
                <h3 style="color: #ef4444; margin-top: 0;">THE FORMULA</h3>
                <div style="background: rgba(239, 68, 68, 0.1); padding: 12px; border-radius: 6px; font-family: monospace; text-align: center; margin-bottom: 1rem;">
                    Revolution Risk = (Wheat / 550 + WTI Oil / 70) x (DXY / 100)
                </div>
                <p style="line-height: 1.6;">This formula captures the three forces that historically precede social upheaval: <strong>food costs</strong> (wheat), <strong>energy costs</strong> (oil), and <strong>currency strength</strong> (DXY amplifies EM pain).</p>
                
                <h3 style="color: #ef4444; margin-top: 1.5rem;">WHY THESE INPUTS?</h3>
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #fca5a5;">
                    <div style="font-weight: 700; color: #fca5a5; margin-bottom: 4px;">WHEAT (Bread Proxy)</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">Bread is the foundational staple. When wheat prices spike, food inflation cascades through economies. The $550/bushel normalization reflects the 10-year average. Above that = stress.</p>
                </div>
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #fca5a5;">
                    <div style="font-weight: 700; color: #fca5a5; margin-bottom: 4px;">WTI CRUDE OIL (Fuel Proxy)</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">Energy powers everything - transport, heating, cooking, manufacturing. The $70/barrel normalization reflects the post-shale equilibrium. Above that = inflation accelerates.</p>
                </div>
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #fca5a5;">
                    <div style="font-weight: 700; color: #fca5a5; margin-bottom: 4px;">DXY (Dollar Multiplier)</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">Commodities price in USD. When the dollar strengthens, EM countries must pay more in local currency for the same food and fuel. This crushes purchasing power for billions.</p>
                </div>
                
                <h3 style="color: #ef4444; margin-top: 1.5rem;">RISK LEVELS</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <div style="background: rgba(34, 197, 94, 0.15); padding: 10px; border-radius: 4px; border-left: 3px solid #22c55e;">
                        <strong style="color: #22c55e;">STABLE (< 1.5)</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #6a7585;">Normal conditions. No elevated unrest risk.</p>
                    </div>
                    <div style="background: rgba(234, 179, 8, 0.15); padding: 10px; border-radius: 4px; border-left: 3px solid #eab308;">
                        <strong style="color: #eab308;">RISING (1.5 - 2.0)</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #6a7585;">Pressure building. Monitor EM stress.</p>
                    </div>
                    <div style="background: rgba(249, 115, 22, 0.15); padding: 10px; border-radius: 4px; border-left: 3px solid #f97316;">
                        <strong style="color: #f97316;">ELEVATED (2.0 - 2.5)</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #6a7585;">Danger zone. Social tensions likely rising.</p>
                    </div>
                    <div style="background: rgba(239, 68, 68, 0.15); padding: 10px; border-radius: 4px; border-left: 3px solid #ef4444;">
                        <strong style="color: #ef4444;">CRITICAL (> 2.5)</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #6a7585;">Revolution territory. Historical precedent for regime change.</p>
                    </div>
                </div>
                
                <h3 style="color: #ef4444; margin-top: 1.5rem;">HISTORICAL PRECEDENTS</h3>
                <ul style="color: #94a3b8; line-height: 1.8; padding-left: 1.5rem;">
                    <li><strong>Arab Spring (2011)</strong> - Wheat prices doubled in 6 months. Tunisia, Egypt, Libya, Syria all fell.</li>
                    <li><strong>Sri Lanka Collapse (2022)</strong> - Fuel shortages led to PM fleeing the country by helicopter.</li>
                    <li><strong>Egypt Protests (2023)</strong> - Bread price subsidies cut, currency devalued. Riots followed.</li>
                    <li><strong>French Revolution (1789)</strong> - The original "let them eat cake" moment. Bread prices had doubled.</li>
                </ul>
                
                <h3 style="color: #ef4444; margin-top: 1.5rem;">TRADE IMPLICATIONS</h3>
                <div style="background: rgba(239, 68, 68, 0.1); padding: 12px; border-radius: 6px; border: 1px solid rgba(239, 68, 68, 0.3);">
                    <p style="margin: 0; line-height: 1.6;"><strong>When CRITICAL:</strong> Long defense stocks (LMT, RTX, NOC), short EM FX (ZAR, TRY, EGP), long gold as flight-to-safety. Consider food security plays (ADM, BG, MOS).</p>
                </div>
                
                <div style="margin-top: 1.5rem; padding: 1rem; border: 1px solid rgba(239, 68, 68, 0.3); background: rgba(0,0,0,0.3); border-radius: 6px;">
                    <p style="font-size: 0.75rem; color: #6a7585; line-height: 1.5; text-align: center; margin: 0;">
                        <strong>DISCLAIMER:</strong> This is not financial advice. This content is for informational and educational purposes only. Always do your own research.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Liar's Poker Deep Dive Modal -->
    <div id="liarModal" class="chart-modal-overlay" style="display: none;" onclick="closeIntelModal('liarModal', event)">
        <div class="chart-modal-content" onclick="event.stopPropagation()" style="max-width: 650px; border-color: #f59e0b;">
            <button class="chart-close-btn" onclick="closeIntelModal('liarModal')" style="top: 15px; right: 15px; position: absolute; color: #f59e0b;">x</button>
            <div class="modal-title" style="color: #f59e0b; padding: 0.5rem 0;">LIAR'S POKER</div>
            <div class="modal-analysis info-modal-scroll">
                <p style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 1rem;"><em>Narrative vs Money - Detecting When Someone Is Lying</em></p>
                
                <h3 style="color: #f59e0b; margin-top: 0;">THE CONCEPT</h3>
                <p style="line-height: 1.6;">Media narratives and market positioning often diverge. When CNN says "markets are calm" but prediction markets are pricing in escalation, <strong>someone is lying</strong>. This metric catches the gap between the story being told and where money is actually flowing.</p>
                
                <h3 style="color: #f59e0b; margin-top: 1.5rem;">THE INPUTS</h3>
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #fbbf24;">
                    <div style="font-weight: 700; color: #fbbf24; margin-bottom: 4px;">FEAR & GREED INDEX (Narrative Proxy)</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">CNN's Fear & Greed captures retail sentiment and media tone. It reflects what people <em>feel</em> based on headlines they consume. Range: 0 (Extreme Fear) to 100 (Extreme Greed).</p>
                </div>
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #fbbf24;">
                    <div style="font-weight: 700; color: #fbbf24; margin-bottom: 4px;">POLYMARKET WAR ODDS (Money Proxy)</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">Prediction markets where people bet real money on outcomes. If war odds are rising but sentiment says "greed," smart money sees something retail doesn't.</p>
                </div>
                
                <h3 style="color: #f59e0b; margin-top: 1.5rem;">THE SIGNALS</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <div style="background: rgba(34, 197, 94, 0.15); padding: 10px; border-radius: 4px; border-left: 3px solid #22c55e;">
                        <strong style="color: #22c55e;">REALITY</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #6a7585;">Narrative aligns with money. No divergence. Trend is authentic.</p>
                    </div>
                    <div style="background: rgba(234, 179, 8, 0.15); padding: 10px; border-radius: 4px; border-left: 3px solid #eab308;">
                        <strong style="color: #eab308;">WATCH</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #6a7585;">Slight drift forming. Could normalize or widen.</p>
                    </div>
                    <div style="background: rgba(147, 51, 234, 0.15); padding: 10px; border-radius: 4px; border-left: 3px solid #9333ea;">
                        <strong style="color: #9333ea;">HOPIUM</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #6a7585;">Sentiment too bullish vs bets. Retail overexposed, smart money hedging.</p>
                    </div>
                    <div style="background: rgba(239, 68, 68, 0.15); padding: 10px; border-radius: 4px; border-left: 3px solid #ef4444;">
                        <strong style="color: #ef4444;">FEAR PORN</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #6a7585;">Sentiment too bearish vs bets. Contrarian buy opportunity.</p>
                    </div>
                </div>
                
                <h3 style="color: #f59e0b; margin-top: 1.5rem;">EXAMPLES IN THE WILD</h3>
                <ul style="color: #94a3b8; line-height: 1.8; padding-left: 1.5rem;">
                    <li><strong>Jan 2022:</strong> "Inflation is transitory" narrative while bonds were getting crushed. HOPIUM signal - inflation was real.</li>
                    <li><strong>Oct 2022:</strong> "Recession imminent" headlines while Polymarket showed recovery bets. FEAR PORN signal - market bottomed.</li>
                    <li><strong>Feb 2024:</strong> "War spreading" media frenzy but war odds falling. FEAR PORN signal - de-escalation coming.</li>
                </ul>
                
                <h3 style="color: #f59e0b; margin-top: 1.5rem;">TRADE IMPLICATIONS</h3>
                <div style="background: rgba(245, 158, 11, 0.1); padding: 12px; border-radius: 6px; border: 1px solid rgba(245, 158, 11, 0.3);">
                    <p style="margin: 0; line-height: 1.6;"><strong>HOPIUM:</strong> Reduce long exposure, add hedges. Retail is the exit liquidity.<br><strong>FEAR PORN:</strong> Contrarian entry point. Buy what everyone fears when money says otherwise.</p>
                </div>
                
                <div style="margin-top: 1.5rem; padding: 1rem; border: 1px solid rgba(245, 158, 11, 0.3); background: rgba(0,0,0,0.3); border-radius: 6px;">
                    <p style="font-size: 0.75rem; color: #6a7585; line-height: 1.5; text-align: center; margin: 0;">
                        <strong>DISCLAIMER:</strong> This is not financial advice. This content is for informational and educational purposes only. Always do your own research.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Paper vs Rock Deep Dive Modal -->
    <div id="paperRockModal" class="chart-modal-overlay" style="display: none;" onclick="closeIntelModal('paperRockModal', event)">
        <div class="chart-modal-content" onclick="event.stopPropagation()" style="max-width: 650px; border-color: #3b82f6;">
            <button class="chart-close-btn" onclick="closeIntelModal('paperRockModal')" style="top: 15px; right: 15px; position: absolute; color: #3b82f6;">x</button>
            <div class="modal-title" style="color: #3b82f6; padding: 0.5rem 0;">PAPER VS ROCK</div>
            <div class="modal-analysis info-modal-scroll">
                <p style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 1rem;"><em>Financialization Ratio - Are We in a Paper Economy or War Economy?</em></p>
                
                <h3 style="color: #3b82f6; margin-top: 0;">THE FORMULA</h3>
                <div style="background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 6px; font-family: monospace; text-align: center; margin-bottom: 1rem;">
                    Paper/Rock = S&P 500 / (Gold + Oil x 30 + Copper x 500)
                </div>
                <p style="line-height: 1.6;">This ratio measures whether capital is flowing into <strong>financial assets</strong> (Paper: stocks, bonds, derivatives) or <strong>hard assets</strong> (Rock: commodities, gold, real things). The answer determines the entire investment regime.</p>
                
                <h3 style="color: #3b82f6; margin-top: 1.5rem;">THE MACRO REGIMES</h3>
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #60a5fa;">
                    <div style="font-weight: 700; color: #60a5fa; margin-bottom: 4px;">FINANCIALIZED (High Ratio)</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">QE regime. Central banks suppress volatility, liquidity floods into financial assets. Stocks beat commodities. Tech outperforms energy. This was 2010-2020.</p>
                </div>
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #f59e0b;">
                    <div style="font-weight: 700; color: #f59e0b; margin-bottom: 4px;">TRANSITIONING (Mid Ratio)</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">Regime shift in progress. Rotation from growth to value, from tech to commodities. High volatility, unclear winners. This is the messy middle.</p>
                </div>
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #ef4444;">
                    <div style="font-weight: 700; color: #ef4444; margin-bottom: 4px;">WAR ECONOMY (Low Ratio)</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">Hard assets dominate. Inflation, conflict, deglobalization favor real things over paper claims. Commodities crush stocks. This was the 1970s and 1940s.</p>
                </div>
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #a855f7;">
                    <div style="font-weight: 700; color: #a855f7; margin-bottom: 4px;">PEAK PAPER (Extreme High)</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">Financialization has gone too far. Mean reversion risk is elevated. The system is fragile. Dot-com 2000, 2007 housing bubble vibes.</p>
                </div>
                
                <h3 style="color: #3b82f6; margin-top: 1.5rem;">HISTORICAL CONTEXT</h3>
                <ul style="color: #94a3b8; line-height: 1.8; padding-left: 1.5rem;">
                    <li><strong>1945-1965:</strong> Post-WWII financialization. Paper wins as global trade expands.</li>
                    <li><strong>1968-1982:</strong> Stagflation era. Rock crushes Paper. Gold up 24x, stocks flat for 15 years.</li>
                    <li><strong>1982-2000:</strong> Disinflation bull market. Paper wins again. Stocks up 10x.</li>
                    <li><strong>2000-2011:</strong> Commodities supercycle. Rock outperforms. Oil, gold, copper all surge.</li>
                    <li><strong>2011-2020:</strong> QE infinity. Paper dominates. FAANG crushes energy.</li>
                    <li><strong>2020-???:</strong> Are we transitioning again? Watch this ratio.</li>
                </ul>
                
                <h3 style="color: #3b82f6; margin-top: 1.5rem;">TRADE IMPLICATIONS</h3>
                <div style="background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 6px; border: 1px solid rgba(59, 130, 246, 0.3);">
                    <p style="margin: 0; line-height: 1.6;"><strong>WAR ECONOMY:</strong> Long commodities (XLE, GLD, COPX), defense (ITA), short growth (QQQ). Value over growth.<br><strong>FINANCIALIZED:</strong> Long growth, long duration, short commodities. Momentum works.</p>
                </div>
                
                <div style="margin-top: 1.5rem; padding: 1rem; border: 1px solid rgba(59, 130, 246, 0.3); background: rgba(0,0,0,0.3); border-radius: 6px;">
                    <p style="font-size: 0.75rem; color: #6a7585; line-height: 1.5; text-align: center; margin: 0;">
                        <strong>DISCLAIMER:</strong> This is not financial advice. This content is for informational and educational purposes only. Always do your own research.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Mercantilism Counter Deep Dive Modal -->
    <div id="mercantilismModal" class="chart-modal-overlay" style="display: none;" onclick="closeIntelModal('mercantilismModal', event)">
        <div class="chart-modal-content" onclick="event.stopPropagation()" style="max-width: 650px; border-color: #22c55e;">
            <button class="chart-close-btn" onclick="closeIntelModal('mercantilismModal')" style="top: 15px; right: 15px; position: absolute; color: #22c55e;">x</button>
            <div class="modal-title" style="color: #22c55e; padding: 0.5rem 0;">MERCANTILISM COUNTER</div>
            <div class="modal-analysis info-modal-scroll">
                <p style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 1rem;"><em>Trade Fragmentation Scanner - Tracking the Death of Globalization</em></p>
                
                <h3 style="color: #22c55e; margin-top: 0;">THE CONCEPT</h3>
                <p style="line-height: 1.6;">For 40 years, globalization was the dominant paradigm - free trade, open borders, integrated supply chains. That era is ending. This counter tracks how fast we're reverting to <strong>mercantilism</strong> - the 17th century system where nations prioritize domestic production over global trade.</p>
                
                <h3 style="color: #22c55e; margin-top: 1.5rem;">WHAT WE SCAN FOR</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 1rem;">
                    <div style="background: rgba(34, 197, 94, 0.1); padding: 8px; border-radius: 4px; text-align: center; font-size: 0.85rem; font-weight: 600; color: #22c55e;">TARIFF</div>
                    <div style="background: rgba(34, 197, 94, 0.1); padding: 8px; border-radius: 4px; text-align: center; font-size: 0.85rem; font-weight: 600; color: #22c55e;">SANCTION</div>
                    <div style="background: rgba(34, 197, 94, 0.1); padding: 8px; border-radius: 4px; text-align: center; font-size: 0.85rem; font-weight: 600; color: #22c55e;">BAN</div>
                    <div style="background: rgba(34, 197, 94, 0.1); padding: 8px; border-radius: 4px; text-align: center; font-size: 0.85rem; font-weight: 600; color: #22c55e;">BLOCKADE</div>
                    <div style="background: rgba(34, 197, 94, 0.1); padding: 8px; border-radius: 4px; text-align: center; font-size: 0.85rem; font-weight: 600; color: #22c55e;">FRIEND-SHORING</div>
                    <div style="background: rgba(34, 197, 94, 0.1); padding: 8px; border-radius: 4px; text-align: center; font-size: 0.85rem; font-weight: 600; color: #22c55e;">DECOUPLE</div>
                </div>
                <p style="line-height: 1.6; color: #6a7585;">Each headline containing these keywords represents friction being added to the global trading system.</p>
                
                <h3 style="color: #22c55e; margin-top: 1.5rem;">FRAGMENTATION LEVELS</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <div style="background: rgba(34, 197, 94, 0.15); padding: 10px; border-radius: 4px; border-left: 3px solid #22c55e;">
                        <strong style="color: #22c55e;">OPEN TRADE (0-2)</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #6a7585;">Normal headline noise. Globalization intact.</p>
                    </div>
                    <div style="background: rgba(234, 179, 8, 0.15); padding: 10px; border-radius: 4px; border-left: 3px solid #eab308;">
                        <strong style="color: #eab308;">FRICTION (3-5)</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #6a7585;">Elevated tensions. Supply chains adapting.</p>
                    </div>
                    <div style="background: rgba(249, 115, 22, 0.15); padding: 10px; border-radius: 4px; border-left: 3px solid #f97316;">
                        <strong style="color: #f97316;">FRACTURING (6-9)</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #6a7585;">Serious fragmentation. Regional blocs forming.</p>
                    </div>
                    <div style="background: rgba(239, 68, 68, 0.15); padding: 10px; border-radius: 4px; border-left: 3px solid #ef4444;">
                        <strong style="color: #ef4444;">TRADE WAR (10+)</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #6a7585;">Full mercantilism. Expect inflation, supply shocks.</p>
                    </div>
                </div>
                
                <h3 style="color: #22c55e; margin-top: 1.5rem;">INVESTMENT IMPLICATIONS</h3>
                <ul style="color: #94a3b8; line-height: 1.8; padding-left: 1.5rem;">
                    <li><strong>Rising mercantilism = inflation:</strong> More friction = higher costs = higher prices</li>
                    <li><strong>Onshoring beneficiaries:</strong> US manufacturing (CAT, DE), construction (VMC, MLM)</li>
                    <li><strong>Supply chain rewiring:</strong> Mexico nearshoring (EWW), Vietnam (VNM)</li>
                    <li><strong>Commodity volatility:</strong> Fragmented supply = price swings. Favor producers.</li>
                    <li><strong>Losers:</strong> Global logistics (FDX, UPS long-term), pure exporters, assembly hubs</li>
                </ul>
                
                <h3 style="color: #22c55e; margin-top: 1.5rem;">THE BIG PICTURE</h3>
                <div style="background: rgba(34, 197, 94, 0.1); padding: 12px; border-radius: 6px; border: 1px solid rgba(34, 197, 94, 0.3);">
                    <p style="margin: 0; line-height: 1.6;">We are living through the end of the post-1980 globalization era. This counter helps you track the speed of that transition. The faster it moves, the more inflationary and volatile markets become.</p>
                </div>
                
                <div style="margin-top: 1.5rem; padding: 1rem; border: 1px solid rgba(34, 197, 94, 0.3); background: rgba(0,0,0,0.3); border-radius: 6px;">
                    <p style="font-size: 0.75rem; color: #6a7585; line-height: 1.5; text-align: center; margin: 0;">
                        <strong>DISCLAIMER:</strong> This is not financial advice. This content is for informational and educational purposes only. Always do your own research.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Vassal State Detector Deep Dive Modal -->
    <div id="vassalModal" class="chart-modal-overlay" style="display: none;" onclick="closeIntelModal('vassalModal', event)">
        <div class="chart-modal-content" onclick="event.stopPropagation()" style="max-width: 650px; border-color: #a855f7;">
            <button class="chart-close-btn" onclick="closeIntelModal('vassalModal')" style="top: 15px; right: 15px; position: absolute; color: #a855f7;">x</button>
            <div class="modal-title" style="color: #a855f7; padding: 0.5rem 0;">VASSAL STATE DETECTOR</div>
            <div class="modal-analysis info-modal-scroll">
                <p style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 1rem;"><em>Currency Correlation Analysis - Tracking the Great Power Realignment</em></p>
                
                <h3 style="color: #a855f7; margin-top: 0;">THE CONCEPT</h3>
                <p style="line-height: 1.6;">In a multipolar world, currencies reveal allegiances. We track the <strong>Korean Won (KRW)</strong> because South Korea is the ultimate swing state - economically tied to China, security-guaranteed by the US. Where KRW correlates tells us which pole is winning.</p>
                
                <h3 style="color: #a855f7; margin-top: 1.5rem;">WHY SOUTH KOREA?</h3>
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #c084fc;">
                    <div style="font-weight: 700; color: #c084fc; margin-bottom: 4px;">THE PIVOT STATE</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">South Korea is the 10th largest economy. Samsung, Hyundai, SK Hynix are global players. China is Korea's largest trading partner. The US guarantees Korea's security. This tension makes KRW the perfect barometer.</p>
                </div>
                
                <h3 style="color: #a855f7; margin-top: 1.5rem;">THE METHODOLOGY</h3>
                <p style="line-height: 1.6;">We calculate the <strong>Pearson correlation coefficient</strong> between KRW and both USD and CNH (offshore yuan) over rolling windows. Whichever correlation is stronger indicates which sphere of influence Korea is drifting toward.</p>
                
                <h3 style="color: #a855f7; margin-top: 1.5rem;">THE SIGNALS</h3>
                <div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                    <div style="background: rgba(59, 130, 246, 0.15); padding: 10px; border-radius: 4px; border-left: 3px solid #3b82f6;">
                        <strong style="color: #3b82f6;">US SPHERE</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #6a7585;">KRW tracks USD more closely. Dollar system intact. US security umbrella holding. Traditional risk-on/risk-off dynamics apply.</p>
                    </div>
                    <div style="background: rgba(168, 85, 247, 0.15); padding: 10px; border-radius: 4px; border-left: 3px solid #a855f7;">
                        <strong style="color: #a855f7;">NEUTRAL</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #6a7585;">KRW uncorrelated with either. Transition period. Maximum uncertainty. Watch for policy shifts.</p>
                    </div>
                    <div style="background: rgba(239, 68, 68, 0.15); padding: 10px; border-radius: 4px; border-left: 3px solid #ef4444;">
                        <strong style="color: #ef4444;">CHINA SPHERE</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #6a7585;">KRW tracks CNH more closely. De-dollarization accelerating. Asia realigning. Major geopolitical shift in progress.</p>
                    </div>
                </div>
                
                <h3 style="color: #a855f7; margin-top: 1.5rem;">WHAT A SHIFT MEANS</h3>
                <ul style="color: #94a3b8; line-height: 1.8; padding-left: 1.5rem;">
                    <li><strong>Reserve currency implications:</strong> If Korea drifts to China, other Asian nations may follow</li>
                    <li><strong>BRICS momentum:</strong> More countries considering alternatives to dollar system</li>
                    <li><strong>Gold accumulation:</strong> Central banks hedge against dollar decline</li>
                    <li><strong>US Treasury demand:</strong> Foreign buying may decrease, yields may rise</li>
                    <li><strong>Regional trade:</strong> More bilateral currency agreements, less USD settlement</li>
                </ul>
                
                <h3 style="color: #a855f7; margin-top: 1.5rem;">TRADE IMPLICATIONS</h3>
                <div style="background: rgba(168, 85, 247, 0.1); padding: 12px; border-radius: 6px; border: 1px solid rgba(168, 85, 247, 0.3);">
                    <p style="margin: 0; line-height: 1.6;"><strong>CHINA SPHERE:</strong> Long gold (GLD, PHYS), long EM ex-China, short US Treasuries duration. Watch for BRICS currency developments.<br><strong>US SPHERE:</strong> Traditional correlations hold. Risk-on = USD down, risk-off = USD up.</p>
                </div>
                
                <div style="margin-top: 1.5rem; padding: 1rem; border: 1px solid rgba(168, 85, 247, 0.3); background: rgba(0,0,0,0.3); border-radius: 6px;">
                    <p style="font-size: 0.75rem; color: #6a7585; line-height: 1.5; text-align: center; margin: 0;">
                        <strong>DISCLAIMER:</strong> This is not financial advice. This content is for informational and educational purposes only. Always do your own research.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Rates Dashboard Legend Modal -->
    <div id="ratesLegendModal" class="chart-modal-overlay" style="display: none;" onclick="closeRatesLegend(event)">
        <div class="chart-modal-content" onclick="event.stopPropagation()" style="max-width: 700px; border-color: #3b82f6;">
            <button class="chart-close-btn" onclick="closeRatesLegend()" style="top: 15px; right: 15px; position: absolute; color: #3b82f6;"></button>
            <div class="modal-title" style="color: #3b82f6; padding: 0.5rem 0;">BASE LAYER LEGEND</div>
            <div class="modal-analysis info-modal-scroll">
                
                <h3 style="color: #3b82f6; margin-top: 0;">WHY THESE 8 INDICATORS MATTER</h3>
                <p style="line-height: 1.6;">These 8 metrics form the core plumbing of global financial markets. They tell you whether money is flowing freely, where stress is building, and what the Fed's next move might be. Master these, and you'll read the market's pulse before most traders.</p>
                
                <h3 style="color: #3b82f6; margin-top: 1.5rem;">TREASURY YIELDS</h3>
                
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #60a5fa;">
                    <div style="font-weight: 700; color: #60a5fa; margin-bottom: 4px;">US 2Y (2-Year Treasury Yield)</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">The market's best guess at Fed policy for the next 2 years. Moves faster than any other yield because it's directly tied to rate expectations.</p>
                    <p style="margin: 8px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Watch for:</strong> 2Y spiking = market expects hawkish Fed. 2Y crashing = recession fears, rate cut bets surging.</p>
                    <p style="margin: 4px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Trade signal:</strong> 2Y above 10Y = inverted curve = recession warning (historically 100% accurate within 6-18 months).</p>
                </div>
                
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #60a5fa;">
                    <div style="font-weight: 700; color: #60a5fa; margin-bottom: 4px;">US 5Y (5-Year Treasury Yield)</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">The "belly" of the curve. Balances near-term Fed policy with longer-term growth expectations. Most sensitive to inflation expectations.</p>
                    <p style="margin: 8px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Watch for:</strong> 5Y breakevens (vs TIPS) reveal inflation expectations. If 5Y nominal rises but breakevens flat = real rates rising = risk-off.</p>
                    <p style="margin: 4px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Trade signal:</strong> 5Y often leads 10Y moves. Watch 5s30s spread for curve steepening/flattening bets.</p>
                </div>
                
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #60a5fa;">
                    <div style="font-weight: 700; color: #60a5fa; margin-bottom: 4px;">US 10Y (10-Year Treasury Yield)</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">THE global benchmark. Sets mortgage rates, corporate borrowing costs, and equity valuations. Every asset in the world is priced off this.</p>
                    <p style="margin: 8px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Watch for:</strong> Key levels: 4% = psychological, 4.5% = pain for equities, 5% = danger zone. Each 50bp move reshapes portfolios.</p>
                    <p style="margin: 4px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Trade signal:</strong> 10Y rising + stocks rising = healthy. 10Y rising + stocks falling = tightening financial conditions, risk-off.</p>
                </div>
                
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #60a5fa;">
                    <div style="font-weight: 700; color: #60a5fa; margin-bottom: 4px;">US 30Y (30-Year Treasury Yield)</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">Long-duration barometer. Reflects fiscal sustainability concerns, inflation expectations, and term premium demands. Pension funds and insurers live here.</p>
                    <p style="margin: 8px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Watch for:</strong> 30Y above 5% = fiscal alarm bells. Steepening 2s30s = curve normalizing (often precedes easing cycle).</p>
                    <p style="margin: 4px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Trade signal:</strong> 30Y selling off while 2Y stable = "bear steepener" = fiscal concerns or foreign selling (China/Japan).</p>
                </div>
                
                <h3 style="color: #3b82f6; margin-top: 1.5rem;">INFLATION & LABOR</h3>
                
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #22c55e;">
                    <div style="font-weight: 700; color: #22c55e; margin-bottom: 4px;">TRUFLATION (Real-Time Inflation Index)</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">Daily blockchain-verified inflation reading from 10M+ data points. Leads official CPI by 30-45 days. The future of inflation tracking.</p>
                    <p style="margin: 8px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Watch for:</strong> Divergence from CPI = trading opportunity. If Truflation falling while CPI sticky, bond rally coming.</p>
                    <p style="margin: 4px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Trade signal:</strong> Truflation below 3% = Fed's target zone. Above 4% = hawkish pressure. Currently at 2.84% = near target.</p>
                </div>
                
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #f59e0b;">
                    <div style="font-weight: 700; color: #f59e0b; margin-bottom: 4px;">U6 RATE (Broad Unemployment)</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">The REAL unemployment rate. Includes part-time workers wanting full-time and discouraged workers. Shows true labor market slack.</p>
                    <p style="margin: 8px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Watch for:</strong> U6 above 8% = labor market stress (tripwire). Gap between U3 and U6 widening = hidden weakness.</p>
                    <p style="margin: 4px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Trade signal:</strong> U6 rising while U3 stable = cracks forming. Fed watches this closely for "dual mandate" calibration.</p>
                </div>
                
                <h3 style="color: #3b82f6; margin-top: 1.5rem;">MONEY MARKETS (The Plumbing)</h3>
                
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #a855f7;">
                    <div style="font-weight: 700; color: #a855f7; margin-bottom: 4px;">FED RRP (Reverse Repo Facility)</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">Where excess cash parks overnight at the Fed. High RRP = too much liquidity chasing safety. Draining RRP = liquidity leaving the system.</p>
                    <p style="margin: 8px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Watch for:</strong> RRP dropping toward zero = liquidity stress ahead. QT is "working." May force Fed to pause balance sheet runoff.</p>
                    <p style="margin: 4px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Trade signal:</strong> RRP collapse + reserves falling = repo market stress risk (flashback to Sept 2019). Watch for funding spikes.</p>
                </div>
                
                <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #ec4899;">
                    <div style="font-weight: 700; color: #ec4899; margin-bottom: 4px;">SOFR (Secured Overnight Financing Rate)</div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">The new LIBOR. Trillions in derivatives, loans, and mortgages tied to this rate. Shows real cost of overnight secured lending.</p>
                    <p style="margin: 8px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Watch for:</strong> SOFR spiking above Fed Funds = funding stress. Gap widening = banks hoarding reserves. Red flag.</p>
                    <p style="margin: 4px 0 0 0; color: #6a7585; font-size: 0.85rem;"><strong>Trade signal:</strong> SOFR = 3.64%, Fed RRP = 3.50%  healthy spread. If SOFR > 4% while Fed at 3.5% = plumbing problem.</p>
                </div>
                
                <h3 style="color: #3b82f6; margin-top: 1.5rem;">HOW TO READ THEM TOGETHER</h3>
                <div style="background: rgba(59, 130, 246, 0.1); border-radius: 6px; padding: 12px; border: 1px solid rgba(59, 130, 246, 0.2);">
                    <div class="legend-item"><span class="legend-icon" style="color:#22c55e;"></span><span class="legend-text"><strong>Bull Steepener</strong> = 2Y falling faster than 10Y  Fed cutting, growth concerns  Long bonds, short dollar</span></div>
                    <div class="legend-item"><span class="legend-icon" style="color:#ef4444;"></span><span class="legend-text"><strong>Bear Flattener</strong> = 2Y rising faster than 10Y  Fed hiking expectations  Risk-off, USD strength</span></div>
                    <div class="legend-item"><span class="legend-icon" style="color:#f59e0b;">!</span><span class="legend-text"><strong>Curve Inversion</strong> = 2Y > 10Y  Recession signal (6-18 months lead time)  Reduce risk exposure</span></div>
                    <div class="legend-item"><span class="legend-icon" style="color:#ef4444;"></span><span class="legend-text"><strong>Funding Stress</strong> = SOFR spiking, RRP draining  Liquidity crisis brewing  Watch for Fed intervention</span></div>
                    <div class="legend-item"><span class="legend-icon" style="color:#22c55e;"></span><span class="legend-text"><strong>Goldilocks</strong> = Yields stable, Truflation ~2-3%, U6 < 8%  Risk-on, carry trades work</span></div>
                </div>
                
                <div style="margin-top: 2rem; padding: 1rem; border-top: 1px solid rgba(59, 130, 246, 0.2); background: rgba(59, 130, 246, 0.05); border-radius: 6px;">
                    <p style="font-size: 0.8rem; color: #60a5fa; line-height: 1.6; text-align: center; margin: 0;">
                        <strong>PRO TIP:</strong> The yield curve is a movie, not a snapshot. Track direction of change (+bp/-bp) more than absolute levels. A 4% 10Y rising is different from 4% and falling. Context is everything.
                    </p>
                </div>
                
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    <p style="font-size: 0.75rem; color: #6a7585; line-height: 1.5; text-align: center;">
                        <strong>DISCLAIMER:</strong> This is not financial advice. These indicators are educational context for understanding macro conditions. Always do your own research and consult professionals before trading.
                    </p>
                </div>
                
            </div>
        </div>
    </div>

    <!-- 3D Holographic Globe Modal -->
    <div id="mapModal" class="chart-modal-overlay" style="display: none;" onclick="closeMapModal(event)">
        <div class="globe-modal-content" onclick="event.stopPropagation()">
            <button class="chart-close-btn" onclick="closeMapModal(event)" style="z-index: 100;"></button>
            
            <!-- Header -->
            <div id="globe-header" style="padding: 15px 20px; border-bottom: 1px solid rgba(212, 113, 74, 0.2);">
                <div style="color: #00D9FF; font-size: 1.1rem; font-weight: 700; letter-spacing: 2px;">ACTIVE KINETIC THEATERS</div>
                <div style="color: #888; font-size: 0.75rem;">LIVE PROJECTION: ORTHOGRAPHIC  20 ACTIVE CONFLICTS</div>
            </div>
            
            <!-- Globe Container - centered, overflow visible for tooltips -->
            <div style="flex: 1; display: flex; justify-content: center; align-items: center; padding: 20px; overflow: visible; position: relative;" onclick="window.closeGlobeTooltip && window.closeGlobeTooltip()">
                <div id="globe-div" style="width: 100%; height: 100%; max-width: 600px; max-height: 600px; overflow: visible;"></div>
                
                <!-- Mobile-friendly info panel that appears on tap -->
                <div id="globe-marker-info" class="globe-marker-info" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // ========================================================================
        // 3D ORTHOGRAPHIC STRATEGY GLOBE ENGINE
        // ========================================================================
        
        let globeRoot = null;
        let globeChart = null;
        let globeAnimation = null;
        let currentFocusedZone = null;
        
        // CRITICALITY SCORING - Higher score = more critical conflict
        // Used to rank and order conflicts by severity
        const CRITICALITY_SCORES = {
            'ESCALATION': 100,
            'BRINKMANSHIP': 90,
            'CRITICAL': 85,
            'CONFLICT': 80,
            'ATTRITION': 75,
            'VOLATILE': 70,
            'SKIRMISHING': 65,
            'SUPPRESSION': 60,
            'FRAGMENTATION': 55,
            'STANDOFF': 50,
            'POSTURING': 45,
            'CAT & MOUSE': 40,
            'COORDINATION': 35,
            'ADAPTATION': 30,
            'TENSE': 25,
            'SHIFTING': 20,
            'STABLE': 10
        };
        
        // Helper to get criticality score for a conflict
        function getCriticalityScore(conflict) {
            return CRITICALITY_SCORES[conflict.type] || 50;
        }
        
        // CANONICAL COORDINATES - Hardcoded source of truth for all zone locations
        // These values can NEVER be modified by any runtime code
        const CANONICAL_COORDS = Object.freeze({
            'us-china-tech': { lat: 37.3861, lon: -122.0839 },      // Silicon Valley
            'fed-vs-markets': { lat: 38.8951, lon: -77.0364 },      // Washington DC
            'taiwan-strait': { lat: 24.1500, lon: 120.6700 },       // Taiwan Strait
            'russia-ukraine': { lat: 48.3794, lon: 37.5000 },       // Donbas
            'eu-energy': { lat: 52.5200, lon: 13.4050 },            // Berlin
            'ecb-inflation': { lat: 50.1109, lon: 8.6821 },         // Frankfurt
            'shadow-fleet': { lat: 59.9343, lon: 30.3351 },         // St. Petersburg
            'brics-dedollar': { lat: 31.2304, lon: 121.4737 },      // Shanghai
            'arctic-race': { lat: 76.0000, lon: 80.0000 },          // Arctic
            'south-china-sea': { lat: 9.8966, lon: 114.7766 },      // Spratly Islands
            'venezuela': { lat: 10.4806, lon: -66.9036 },           // Caracas
            'hormuz': { lat: 26.5667, lon: 56.2500 },               // Strait of Hormuz
            'opec-shale': { lat: 24.7136, lon: 46.6753 },           // Riyadh
            'iran-israel': { lat: 31.7683, lon: 35.2137 },          // Jerusalem
            'us-tariffs': { lat: 40.7128, lon: -74.0060 },          // New York
            'kashmir': { lat: 34.0837, lon: 74.7973 },              // Kashmir
            'sudan': { lat: 15.5007, lon: 32.5599 },                // Khartoum
            'north-korea': { lat: 39.0392, lon: 125.7625 },         // Pyongyang
            'syria-vacuum': { lat: 36.2021, lon: 37.1343 },         // Aleppo
            'iran-regime': { lat: 35.6892, lon: 51.3890 },          // Tehran
            'red-sea': { lat: 12.5833, lon: 43.3333 },              // Bab el-Mandeb Strait
            'sahel': { lat: 15.0000, lon: 3.0000 },                 // Mali/Niger border
            'monroe-doctrine': { lat: 8.5000, lon: -77.5000 },      // Panama-Colombia border (Western Hemisphere)
            'global': { lat: 0.0000, lon: -30.0000 },               // Atlantic Ocean - global/systemic events
            'global-systemic': { lat: 0.0000, lon: -30.0000 },      // Atlantic Ocean - systemic risk
            'global-monetary': { lat: 0.0000, lon: -30.0000 },      // Atlantic Ocean - monetary regime
            'global-crisis': { lat: 0.0000, lon: -30.0000 }         // Atlantic Ocean - worldwide crisis
        });
        
        // Get fresh, deep-cloned conflict data sorted by criticality
        // Uses CANONICAL_COORDS as the source of truth for all coordinates
        function getFreshConflictData() {
            return BASE_ZONES.map(z => {
                // Get coordinates from CANONICAL source - ignores any runtime mutations
                const coords = CANONICAL_COORDS[z.id] || { lat: z.latitude, lon: z.longitude };
                const fresh = {
                    id: z.id,
                    title: z.title,
                    latitude: coords.lat,
                    longitude: coords.lon,
                    location: z.location,
                    type: z.type,
                    color: z.color,
                    desc: z.desc,
                    theory: z.theory,
                    locationWhy: z.locationWhy,
                    criticalityScore: getCriticalityScore(z)
                };
                return fresh;
            }).sort((a, b) => b.criticalityScore - a.criticalityScore);
        }
        
        // Deep freeze helper to make objects truly immutable
        function deepFreeze(obj) {
            Object.keys(obj).forEach(prop => {
                if (typeof obj[prop] === 'object' && obj[prop] !== null) {
                    deepFreeze(obj[prop]);
                }
            });
            return Object.freeze(obj);
        }
        
        // THE 20 STRATEGIC CONFLICT ZONES - DEEPLY IMMUTABLE BASE DATA
        // Each zone object is frozen to prevent any mutation
        // Always use getFreshConflictData() for operations
        const BASE_ZONES = Object.freeze([
            { 
                id: "us-china-tech", title: "US-China Tech War", 
                latitude: 37.3861, longitude: -122.0839, // Silicon Valley
                location: "Silicon Valley, USA",
                type: "STANDOFF", color: "#ffbb33",
                desc: "LAST MOVE: US new export controls on AI chips to China (DEFECT).",
                theory: "COLD WAR: China restricts rare earth exports or retaliates on US firms.",
                locationWhy: "Silicon Valley is ground zero for the tech war - home to NVIDIA, AMD, and AI chip designers targeted by export controls."
            },
            { 
                id: "fed-vs-markets", title: "Fed vs Markets", 
                latitude: 38.8951, longitude: -77.0364, // Washington DC
                location: "Washington DC, USA",
                type: "STANDOFF", color: "#ffbb33",
                desc: "LAST MOVE: Fed hawkish hold, pushback on rate cuts (SIGNAL).",
                theory: "SHIFTING: Markets test Fed resolve with rally or yields repricing.",
                locationWhy: "The Federal Reserve headquarters in DC sets global monetary policy. Every word from this building moves trillions."
            },
            { 
                id: "taiwan-strait", title: "Taiwan Strait", 
                latitude: 24.1500, longitude: 120.6700, // Taiwan Strait
                location: "Taiwan Strait",
                type: "POSTURING", color: "#ffbb33",
                desc: "LAST MOVE: PLA large-scale military drills near Taiwan (SIGNAL).",
                theory: "TENSE: US Freedom of Navigation op or arms sale announcement.",
                locationWhy: "The 110-mile strait is the world's most dangerous flashpoint - 90% of advanced chips pass through here."
            },
            { 
                id: "russia-ukraine", title: "Russia-Ukraine War", 
                latitude: 48.3794, longitude: 37.5000, // Donbas
                location: "Donbas Region, Ukraine",
                type: "CONFLICT", color: "#ff4466",
                desc: "LAST MOVE: Russia winter offensive push in Donbas (DEFECT).",
                theory: "ACTIVE HOT WAR: Trump peace deal pressure or continued attrition.",
                locationWhy: "The industrial heartland of Ukraine. Control of Donbas determines energy routes and Europe's security architecture."
            },
            { 
                id: "eu-energy", title: "EU Energy Security", 
                latitude: 52.5200, longitude: 13.4050, // Berlin
                location: "Berlin, Germany",
                type: "ADAPTATION", color: "#00D9FF",
                desc: "LAST MOVE: EU LNG import diversification mandates (COOPERATE).",
                theory: "STABILIZING: Winter demand spike test or new pipeline disputes.",
                locationWhy: "Germany is the EU's energy policy anchor. Berlin's decisions on LNG terminals reshape Europe's energy map."
            },
            { 
                id: "ecb-inflation", title: "ECB vs Inflation", 
                latitude: 50.1109, longitude: 8.6821, // Frankfurt
                location: "Frankfurt, Germany",
                type: "STANDOFF", color: "#bb66ff",
                desc: "LAST MOVE: ECB held rates, signaled data-dependency (SIGNAL).",
                theory: "SHIFTING: Markets price rate cuts, ECB pushback on dovish expectations.",
                locationWhy: "ECB headquarters in Frankfurt. Rate decisions here ripple across 20 eurozone economies and beyond."
            },
            { 
                id: "shadow-fleet", title: "Russia Shadow Fleet", 
                latitude: 59.9343, longitude: 30.3351, // St. Petersburg
                location: "St. Petersburg, Russia",
                type: "CAT & MOUSE", color: "#00D9FF",
                desc: "LAST MOVE: G7 sanctioned 183 vessels & lowered price cap (DEFECT).",
                theory: "SHIFTING: Russia uses new intermediaries or insurance workarounds.",
                locationWhy: "Russia's Baltic gateway. Shadow tankers dock here to evade sanctions and export crude above price caps."
            },
            { 
                id: "brics-dedollar", title: "BRICS De-Dollarization", 
                latitude: 31.2304, longitude: 121.4737, // Shanghai
                location: "Shanghai, China",
                type: "COORDINATION", color: "#bb66ff",
                desc: "LAST MOVE: Central bank gold purchases hit 900 tons (COOPERATE).",
                theory: "SHIFTING: New bilateral currency swap deals or SWIFT alternative expansion.",
                locationWhy: "Shanghai's financial district leads the yuan internationalization push. BRICS currency discussions start here."
            },
            { 
                id: "arctic-race", title: "Arctic Resource Race", 
                latitude: 76.0000, longitude: 80.0000, // Arctic
                location: "Northern Sea Route, Arctic",
                type: "POSTURING", color: "#00D9FF",
                desc: "LAST MOVE: Russia new military base on Northern Sea Route (DEFECT).",
                theory: "TENSE: NATO Arctic exercise or territorial claim disputes.",
                locationWhy: "Melting ice opens shipping lanes and vast oil reserves. Russia claims 2 million sq km of Arctic seabed."
            },
            { 
                id: "south-china-sea", title: "South China Sea", 
                latitude: 9.8966, longitude: 114.7766, // Spratly Islands
                location: "Spratly Islands",
                type: "SKIRMISHING", color: "#ff4466",
                desc: "LAST MOVE: China water cannon attacks on Philippine vessels (DEFECT).",
                theory: "TENSE: US freedom of navigation patrol or new base construction.",
                locationWhy: "$3 trillion in annual trade passes through here. China's artificial islands threaten regional stability."
            },
            { 
                id: "venezuela", title: "Venezuela Crisis", 
                latitude: 10.4806, longitude: -66.9036, // Caracas
                location: "Caracas, Venezuela",
                type: "STANDOFF", color: "#ffbb33",
                desc: "LAST MOVE: US threatened military intervention on fraud (SIGNAL).",
                theory: "UNSTABLE: Maduro seeks Russia/China backing or refugee exodus accelerates.",
                locationWhy: "Venezuela has the world's largest oil reserves. Political collapse here sends 7M refugees across the Americas."
            },
            { 
                id: "hormuz", title: "Strait of Hormuz", 
                latitude: 26.5667, longitude: 56.2500, // Strait of Hormuz
                location: "Strait of Hormuz",
                type: "BRINKMANSHIP", color: "#ff4466",
                desc: "LAST MOVE: Iran harassment of commercial tankers (DEFECT).",
                theory: "CRITICAL: US Naval convoy escorts or sanctions tightening.",
                locationWhy: "21% of global oil transits this 21-mile chokepoint. Any closure spikes oil to $150+ instantly."
            },
            { 
                id: "opec-shale", title: "OPEC+ vs Shale", 
                latitude: 24.7136, longitude: 46.6753, // Riyadh
                location: "Riyadh, Saudi Arabia",
                type: "COORDINATION", color: "#bb66ff",
                desc: "LAST MOVE: OPEC+ extended production cuts through Q1 (COOPERATE).",
                theory: "STABLE: Hold pattern unless demand shock or shale ramp-up.",
                locationWhy: "Saudi Arabia's capital dictates global oil supply. OPEC+ meetings here set energy prices for 8 billion people."
            },
            { 
                id: "iran-israel", title: "Iran-Israel Shadow War", 
                latitude: 31.7683, longitude: 35.2137, // Jerusalem (offset from Damascus)
                location: "Jerusalem, Israel",
                type: "BRINKMANSHIP", color: "#ff4466",
                desc: "LAST MOVE: Israel strikes on Iranian proxy positions in Syria (DEFECT).",
                theory: "VOLATILE: Proxy retaliation or Iranian nuclear program acceleration.",
                locationWhy: "Israel's strategic command directs strikes against Iranian proxies. Jerusalem is the decision center for regional operations."
            },
            { 
                id: "us-tariffs", title: "US Tariff War", 
                latitude: 40.7128, longitude: -74.0060, // New York (offset from DC)
                location: "New York, USA",
                type: "ESCALATION", color: "#ffbb33",
                desc: "LAST MOVE: US Liberation Day tariffs: 60%+ on China (DEFECT).",
                theory: "CRITICAL: Retaliatory tariffs from China/EU or negotiation pivot.",
                locationWhy: "Wall Street feels the tariff war first. Import costs hit corporate earnings and consumer prices here."
            },
            { 
                id: "kashmir", title: "India-Pakistan Kashmir", 
                latitude: 34.0837, longitude: 74.7973, // Kashmir
                location: "Line of Control, Kashmir",
                type: "BRINKMANSHIP", color: "#ff4466",
                desc: "LAST MOVE: Pakistan-linked Kashmir attack on Indian forces (DEFECT).",
                theory: "CRITICAL: Indian surgical strike or diplomatic ultimatum.",
                locationWhy: "Two nuclear powers face off across this disputed border. Any escalation risks global catastrophe."
            },
            { 
                id: "sudan", title: "Sudan Civil War", 
                latitude: 15.5007, longitude: 32.5599, // Khartoum
                location: "Khartoum, Sudan",
                type: "CONFLICT", color: "#ff4466",
                desc: "LAST MOVE: RSF gold mining region seizure for war funding (DEFECT).",
                theory: "UNSTABLE: SAF counteroffensive or external powers arm both sides.",
                locationWhy: "Sudan's capital is a warzone. Gold mines fund militias while 25M face famine in Africa's largest displacement crisis."
            },
            { 
                id: "north-korea", title: "North Korea Nuclear", 
                latitude: 39.0392, longitude: 125.7625, // Pyongyang
                location: "Pyongyang, North Korea",
                type: "ESCALATION", color: "#ff4466",
                desc: "LAST MOVE: DPRK ICBM test launch with new warhead design (DEFECT).",
                theory: "CRITICAL: US-Japan-SK joint exercises or new sanctions package.",
                locationWhy: "Kim's regime controls 50+ nuclear warheads. Pyongyang's provocations destabilize all of Northeast Asia."
            },
            { 
                id: "syria-vacuum", title: "Syria Power Vacuum", 
                latitude: 36.2021, longitude: 37.1343, // Aleppo
                location: "Aleppo, Syria",
                type: "FRAGMENTATION", color: "#ffbb33",
                desc: "LAST MOVE: Israel expanded buffer zone operations post-Assad (DEFECT).",
                theory: "VOLATILE: Turkish-Kurdish clashes or Iran proxy repositioning.",
                locationWhy: "Syria's largest city remains contested. Post-Assad vacuum invites Turkish, Iranian, and Israeli intervention."
            },
            { 
                id: "iran-regime", title: "Iran Regime Stability", 
                latitude: 35.6892, longitude: 51.3890, // Tehran
                location: "Tehran, Iran",
                type: "SUPPRESSION", color: "#ffbb33",
                desc: "LAST MOVE: Regime crackdown on Women Life Freedom protests (DEFECT).",
                theory: "CRITICAL: Economic collapse accelerates unrest or regime consolidates.",
                locationWhy: "Iran's capital faces unprecedented protests. Regime survival determines Middle East power balance for decades."
            },
            { 
                id: "red-sea", title: "Red Sea / Houthis", 
                latitude: 12.5833, longitude: 43.3333, // Bab el-Mandeb Strait
                location: "Bab el-Mandeb Strait, Yemen",
                type: "CONFLICT", color: "#ff4466",
                desc: "LAST MOVE: Houthi drone and missile attacks on commercial shipping (DEFECT).",
                theory: "CRITICAL: US/UK airstrikes or global shipping reroutes via Cape of Good Hope.",
                locationWhy: "The Bab el-Mandeb Strait is the chokepoint where Houthi attacks threaten 12% of global trade transiting to Suez Canal."
            },
            { 
                id: "sahel", title: "Sahel Insurgency", 
                latitude: 15.0000, longitude: 3.0000, // Mali/Niger border
                location: "Sahel Region, West Africa",
                type: "FRAGMENTATION", color: "#ff4466",
                desc: "LAST MOVE: Islamist attacks across Mali, Niger, and Burkina Faso (DEFECT).",
                theory: "UNSTABLE: Military junta realignment or Wagner/Russian intervention expansion.",
                locationWhy: "The Sahel is the world's fastest-growing jihadist theater. Wagner presence and French withdrawal reshape African security."
            },
            { 
                id: "monroe-doctrine", title: "Monroe Doctrine Revival", 
                latitude: 8.5000, longitude: -77.5000, // Panama-Colombia border
                location: "Western Hemisphere",
                type: "ESCALATION", color: "#ff4466",
                desc: "LAST MOVE: Trump demands Greenland purchase, threatens Canada, Panama Canal (DEFECT).",
                theory: "VOLATILE: NATO allies respond, Denmark rejects, trade tensions escalate.",
                locationWhy: "The Panama-Colombia border symbolizes US hemispheric influence. Control of the Canal and regional trade routes echo 19th century expansionism."
            }
        ].map(zone => deepFreeze(zone)));
        
        // STRATEGIC_ZONES - always computed fresh from immutable BASE_ZONES
        // Sorted by criticality score (highest first)
        let STRATEGIC_ZONES = getFreshConflictData();
        
        // Map from game IDs (server) to zone IDs (client)
        const GAME_TO_ZONE_MAP = {
            'chip_war': 'us-china-tech',
            'fed_vs_markets': 'fed-vs-markets',
            'taiwan_strait': 'taiwan-strait',
            'russia_ukraine': 'russia-ukraine',
            'eu_energy_crisis': 'eu-energy',
            'ecb_inflation': 'ecb-inflation',
            'russia_shadow_fleet': 'shadow-fleet',
            'brics_dedollarization': 'brics-dedollar',
            'arctic_resource_race': 'arctic-race',
            'south_china_sea': 'south-china-sea',
            'venezuela_crisis': 'venezuela',
            'hormuz_standoff': 'hormuz',
            'opec_price_war': 'opec-shale',
            'iran_israel': 'iran-israel',
            'us_tariff_war': 'us-tariffs',
            'india_pakistan': 'kashmir',
            'sudan_civil_war': 'sudan',
            'north_korea_nuclear': 'north-korea',
            'syria_power_vacuum': 'syria-vacuum',
            'iran_regime_unrest': 'iran-regime',
            'red_sea_houthis': 'red-sea',
            'sahel_islamism': 'sahel',
            'monroe_doctrine': 'monroe-doctrine'
        };

        function openConflictMap(gameId) {
            const modal = document.getElementById('mapModal');
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            document.body.style.overflow = 'hidden';
            
            // Always get fresh conflict data to ensure accurate coordinates
            STRATEGIC_ZONES = getFreshConflictData();
            
            // Find the zone to focus on using fresh data
            const zoneId = GAME_TO_ZONE_MAP[gameId] || gameId;
            const targetZone = STRATEGIC_ZONES.find(z => z.id === zoneId);
            currentFocusedZone = targetZone;
            
            
            // Update header with focused conflict
            const headerTitle = document.getElementById('globe-header');
            if (headerTitle && targetZone) {
                headerTitle.innerHTML = `
                    <div style="color: #00D9FF; font-size: 1.1rem; font-weight: 700; letter-spacing: 2px;">ACTIVE KINETIC THEATERS</div>
                    <div style="color: ${targetZone.color}; font-size: 0.9rem; font-weight: 600; margin-top: 4px;">${targetZone.title}</div>
                    <div style="color: #888; font-size: 0.75rem;">${targetZone.location}</div>
                `;
            }

            // Always dispose and recreate globe to ensure fresh coordinates
            if (globeRoot) {
                try { globeRoot.dispose(); } catch(e) {}
                globeRoot = null;
                globeChart = null;
            }
            
            // Check if amCharts library is loaded
            if (typeof am5 === 'undefined' || typeof am5map === 'undefined' || typeof am5geodata_worldLow === 'undefined' || typeof am5themes_Animated === 'undefined') {
                console.error('amCharts libraries not loaded yet. am5:', typeof am5, 'am5map:', typeof am5map, 'geodata:', typeof am5geodata_worldLow, 'themes:', typeof am5themes_Animated);
                const globeDiv = document.getElementById('globe-div');
                if (globeDiv) {
                    globeDiv.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #00D9FF; font-size: 1rem;">Loading globe data...</div>';
                }
                // Retry after a short delay
                setTimeout(() => {
                    if (typeof am5 !== 'undefined' && typeof am5themes_Animated !== 'undefined') {
                        initializeGlobe(targetZone);
                    } else {
                        const gDiv = document.getElementById('globe-div');
                        if (gDiv) gDiv.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #ff4466;">Globe library failed to load. Please refresh.</div>';
                    }
                }, 2000);
                return;
            }
            
            // Small delay to ensure modal is fully rendered
            setTimeout(() => initializeGlobe(targetZone), 100);
        }
        
        // Cluster conflicts that are within threshold distance (in degrees)
        function clusterConflicts(zones, threshold = 2.0) {
            const clusters = [];
            const used = new Set();
            
            zones.forEach((zone, i) => {
                if (used.has(zone.id)) return;
                
                // Find all zones within threshold of this one
                const nearby = zones.filter((other, j) => {
                    if (i === j || used.has(other.id)) return false;
                    const latDiff = Math.abs(zone.latitude - other.latitude);
                    const lonDiff = Math.abs(zone.longitude - other.longitude);
                    return latDiff < threshold && lonDiff < threshold;
                });
                
                if (nearby.length > 0) {
                    // Create a cluster
                    const clusterMembers = [zone, ...nearby];
                    clusterMembers.forEach(z => used.add(z.id));
                    
                    // Use highest criticality conflict as cluster center
                    const primary = clusterMembers.sort((a, b) => b.criticalityScore - a.criticalityScore)[0];
                    
                    clusters.push({
                        isCluster: true,
                        count: clusterMembers.length,
                        members: clusterMembers,
                        latitude: primary.latitude,
                        longitude: primary.longitude,
                        id: `cluster_${primary.id}`,
                        title: clusterMembers.length + ' CONFLICTS',
                        location: primary.location + ' region',
                        type: 'CLUSTER',
                        color: primary.color,
                        desc: clusterMembers.map(m => m.title).join(' | '),
                        theory: 'Multiple strategic situations converging',
                        locationWhy: 'Multiple conflicts are occurring in this geographic region',
                        criticalityScore: primary.criticalityScore
                    });
                } else {
                    // Single conflict - not clustered
                    used.add(zone.id);
                    clusters.push({ ...zone, isCluster: false, count: 1 });
                }
            });
            
            return clusters;
        }
        
        // Track active sticky tooltip for closing
        let activeGlobeTooltip = null;
        
        // Global function to close all globe tooltips (called by X button)
        window.closeGlobeTooltip = function() {
            if (activeGlobeTooltip && activeGlobeTooltip.tooltip) {
                activeGlobeTooltip.tooltip._isSticky = false;
                activeGlobeTooltip.tooltip.hide();
                activeGlobeTooltip = null;
            }
        };
        
        function initializeGlobe(targetZone) {
            try {
                // Verify DOM element exists
                const globeDiv = document.getElementById('globe-div');
                if (!globeDiv) {
                    console.error('Globe container not found');
                    return;
                }
                
                // Reset active tooltip when reinitializing
                activeGlobeTooltip = null;
                
                // Create new globe
                globeRoot = am5.Root.new("globe-div");
                globeRoot.setThemes([am5themes_Animated.new(globeRoot)]);
            
            // Set initial focus point
            const initialPoint = targetZone 
                ? { latitude: targetZone.latitude, longitude: targetZone.longitude }
                : { latitude: 20, longitude: 10 };

            globeChart = globeRoot.container.children.push(am5map.MapChart.new(globeRoot, {
                panX: "rotateX",
                panY: "rotateY",
                projection: am5map.geoOrthographic(),
                homeGeoPoint: initialPoint,
                // Set initial rotation DIRECTLY so globe doesn't start at 0,0
                rotationX: -initialPoint.longitude,
                rotationY: -initialPoint.latitude
            }));
            
            console.log('Globe initialized at:', initialPoint.latitude, initialPoint.longitude);

            // 0. OCEAN - Blue-grey background sphere
            let backgroundSeries = globeChart.series.push(am5map.MapPolygonSeries.new(globeRoot, {}));
            backgroundSeries.mapPolygons.template.setAll({
                fill: am5.color(0x6B8BA4),
                fillOpacity: 0.3,
                stroke: am5.color(0x6B8BA4),
                strokeOpacity: 0.1
            });
            backgroundSeries.data.push({
                geometry: am5map.getGeoRectangle(90, 180, -90, -180)
            });

            // 1. EARTH - Create polygon series for countries
            let polygonSeries = globeChart.series.push(am5map.MapPolygonSeries.new(globeRoot, {
                geoJSON: am5geodata_worldLow,
                fill: am5.color(0xD4714A),
                stroke: am5.color(0x4a5568)
            }));

            // Style polygons - NO tooltip to avoid mouse event conflicts with markers
            polygonSeries.mapPolygons.template.setAll({
                fill: am5.color(0xD4714A),
                fillOpacity: 0.25,
                stroke: am5.color(0x4a5568),
                strokeWidth: 0.3,
                interactive: false
            });

            // 3. CONFLICT MARKERS WITH COLOR-CODED PULSATING DOTS
            let pointSeries = globeChart.series.push(am5map.MapPointSeries.new(globeRoot, {}));

            pointSeries.bullets.push(function(root, series, dataItem) {
                const data = dataItem.dataContext;
                const markerColor = am5.color(data.color);
                const isCluster = data.isCluster;
                const isFocused = data.isFocused;
                const count = data.count || 1;
                
                // Focused markers get enhanced size
                const baseRadius = isFocused ? 10 : (isCluster ? 12 : 6);
                const hitRadius = isCluster ? 28 : 20;
                const containerSize = isFocused ? 80 : (isCluster ? 60 : 45);
                
                // Build tooltip HTML - different for clusters vs single (with X close button)
                const closeButtonStyle = "position: absolute; top: 6px; right: 8px; background: transparent; border: none; color: #6a7585; font-size: 16px; cursor: pointer; padding: 2px 6px; line-height: 1; border-radius: 3px; transition: all 0.2s;";
                const closeButtonHover = "onmouseover=\"this.style.color='#ef4444';this.style.background='rgba(239,68,68,0.15)'\" onmouseout=\"this.style.color='#6a7585';this.style.background='transparent'\"";
                
                let tooltipHTML;
                if (isCluster && data.members) {
                    const memberList = data.members.map(m => 
                        `<div class="gt-cluster-item">
                            <div class="gt-cluster-item-title" style="color: ${m.color};">${m.title}</div>
                            <div class="gt-cluster-item-type">${m.type}</div>
                        </div>`
                    ).join('');
                    tooltipHTML = `
                        <div class="am5-tooltip-container" style="max-width: 340px; padding: 16px; position: relative;">
                            <button class="tooltip-close-btn" style="${closeButtonStyle}" ${closeButtonHover} onclick="window.closeGlobeTooltip && window.closeGlobeTooltip()">X</button>
                            <div style="background: ${data.color}; color: #fff; padding: 8px 14px; border-radius: 4px; font-weight: 700; font-size: 1rem; margin-bottom: 12px; text-align: center; margin-right: 24px;">${count} CONFLICTS IN REGION</div>
                            <div style="color: #888; font-size: 0.85rem; margin-bottom: 12px; text-align: center;">{location}</div>
                            <div class="gt-cluster-list">${memberList}</div>
                            <div style="margin-top: 12px; color: #6a7585; font-size: 0.75rem; font-style: italic; text-align: center;">Click marker or X to close</div>
                        </div>
                    `;
                } else {
                    tooltipHTML = `
                        <div class="am5-tooltip-container" style="position: relative; padding: 14px;">
                            <button class="tooltip-close-btn" style="${closeButtonStyle}" ${closeButtonHover} onclick="window.closeGlobeTooltip && window.closeGlobeTooltip()">X</button>
                            <div class="gt-title" style="margin-right: 24px;">{title}</div>
                            <div class="gt-location" style="color: #888; font-size: 0.85rem; margin-bottom: 8px;">{location}</div>
                            <div class="gt-type" style="background: {color}20; color: {color}">{type}</div>
                            <div class="gt-desc">{desc}</div>
                            <div class="gt-theory">{theory}</div>
                            <div class="gt-why" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); color: #9ca3af; font-size: 0.8rem; font-style: italic; line-height: 1.4;">{locationWhy}</div>
                        </div>
                    `;
                }
                
                // Create a sticky tooltip that stays visible on click
                let markerTooltip = am5.Tooltip.new(globeRoot, {
                    getFillFromSprite: false,
                    getStrokeFromSprite: false,
                    autoTextColor: false,
                    labelHTML: tooltipHTML,
                    keepTargetHover: true,
                    pointerOrientation: "vertical"
                });
                
                markerTooltip.get("background").setAll({
                    fill: am5.color(0x1a1a2e),
                    fillOpacity: 0.98,
                    stroke: am5.color(0x3b82f6),
                    strokeWidth: 1,
                    cornerRadius: 8,
                    shadowBlur: 15,
                    shadowColor: am5.color(0x000000),
                    shadowOpacity: 0.5,
                    shadowOffsetX: 0,
                    shadowOffsetY: 4
                });
                
                // Larger hit area container for better hover detection
                // NOTE: Tooltip disabled - using globe-marker-info panel for ALL devices
                let hitArea = am5.Container.new(globeRoot, {
                    width: containerSize,
                    height: containerSize,
                    centerX: am5.p50,
                    centerY: am5.p50,
                    interactive: true,
                    cursorOverStyle: "pointer"
                    // tooltip: markerTooltip  -- DISABLED: Using globe-marker-info panel instead
                });
                
                // Click event removed - now handled by unified click handler below that uses showMarkerInfo
                /* OLD TOOLTIP LOGIC - DISABLED
                hitArea.events.on("click", function(ev) {
                    ev.originalEvent.stopPropagation();
                    const tooltip = hitArea.get("tooltip");
                    if (tooltip) {
                        // Close any existing active tooltip first
                        if (activeGlobeTooltip && activeGlobeTooltip.tooltip !== tooltip) {
                            activeGlobeTooltip.tooltip._isSticky = false;
                            activeGlobeTooltip.tooltip.hide();
                        }
                        
                        if (tooltip._isSticky) {
                            tooltip._isSticky = false;
                            tooltip.hide();
                            activeGlobeTooltip = null;
                        } else {
                            tooltip._isSticky = true;
                            tooltip.show();
                            activeGlobeTooltip = { tooltip: tooltip, hitArea: hitArea };
                        }
                    }
                });
                
                // Override hide behavior when sticky
                markerTooltip.events.on("pointerout", function(ev) {
                    if (markerTooltip._isSticky) {
                        markerTooltip.show();
                    }
                });
                END OF OLD TOOLTIP LOGIC */
                
                // Invisible hit circle for reliable hover detection
                hitArea.children.push(am5.Circle.new(globeRoot, {
                    radius: hitRadius,
                    fill: am5.color(0x000000),
                    fillOpacity: 0,
                    strokeOpacity: 0,
                    x: am5.p50,
                    y: am5.p50,
                    centerX: am5.p50,
                    centerY: am5.p50
                }));

                // Drop shadow circle (offset slightly for floating effect)
                hitArea.children.push(am5.Circle.new(globeRoot, {
                    radius: baseRadius * 1.1,
                    fill: am5.color(0x000000),
                    fillOpacity: 0.35,
                    strokeOpacity: 0,
                    x: am5.p50,
                    y: am5.p50,
                    centerX: am5.p50,
                    centerY: am5.percent(45),
                    blur: 4
                }));
                
                // Center Dot - larger for clusters with subtle glow
                hitArea.children.push(am5.Circle.new(globeRoot, {
                    radius: baseRadius,
                    fill: markerColor,
                    stroke: isCluster ? am5.color(0xffffff) : markerColor,
                    strokeWidth: isCluster ? 2 : 1,
                    strokeOpacity: isCluster ? 0.9 : 0.5,
                    x: am5.p50,
                    y: am5.p50,
                    centerX: am5.p50,
                    centerY: am5.p50,
                    shadowBlur: 8,
                    shadowColor: markerColor,
                    shadowOpacity: 0.6,
                    shadowOffsetX: 0,
                    shadowOffsetY: 2
                }));
                
                // Cluster count badge
                if (isCluster && count > 1) {
                    hitArea.children.push(am5.Label.new(globeRoot, {
                        text: String(count),
                        fontSize: 9,
                        fontWeight: "700",
                        fill: am5.color(0xffffff),
                        x: am5.p50,
                        y: am5.p50,
                        centerX: am5.p50,
                        centerY: am5.p50
                    }));
                }

                // Pulse Animation Ring
                let ring = hitArea.children.push(am5.Circle.new(globeRoot, {
                    radius: baseRadius,
                    fill: markerColor,
                    fillOpacity: 0.3,
                    strokeOpacity: 0,
                    x: am5.p50,
                    y: am5.p50,
                    centerX: am5.p50,
                    centerY: am5.p50
                }));

                ring.animate({
                    key: "scale",
                    from: 1,
                    to: isFocused ? 4 : (isCluster ? 3 : 2.5),
                    duration: isFocused ? 1200 : (isCluster ? 2000 : 2500),
                    loops: Infinity,
                    easing: am5.ease.out(am5.ease.cubic)
                });
                
                ring.animate({
                    key: "opacity",
                    from: isFocused ? 0.8 : (isCluster ? 0.6 : 0.5),
                    to: 0,
                    duration: isFocused ? 1200 : (isCluster ? 2000 : 2500),
                    loops: Infinity,
                    easing: am5.ease.out(am5.ease.cubic)
                });
                
                // FOCUSED CONFLICT: Add additional pulsating rings for dramatic effect
                if (isFocused) {
                    // Second ring - slightly delayed
                    let ring2 = hitArea.children.push(am5.Circle.new(globeRoot, {
                        radius: baseRadius,
                        fill: markerColor,
                        fillOpacity: 0.2,
                        strokeOpacity: 0,
                        x: am5.p50,
                        y: am5.p50,
                        centerX: am5.p50,
                        centerY: am5.p50
                    }));
                    
                    setTimeout(() => {
                        ring2.animate({
                            key: "scale",
                            from: 1,
                            to: 5,
                            duration: 1500,
                            loops: Infinity,
                            easing: am5.ease.out(am5.ease.cubic)
                        });
                        ring2.animate({
                            key: "opacity",
                            from: 0.6,
                            to: 0,
                            duration: 1500,
                            loops: Infinity,
                            easing: am5.ease.out(am5.ease.cubic)
                        });
                    }, 400);
                    
                    // Third ring - more delayed for wave effect
                    let ring3 = hitArea.children.push(am5.Circle.new(globeRoot, {
                        radius: baseRadius,
                        fill: markerColor,
                        fillOpacity: 0.15,
                        strokeOpacity: 0,
                        x: am5.p50,
                        y: am5.p50,
                        centerX: am5.p50,
                        centerY: am5.p50
                    }));
                    
                    setTimeout(() => {
                        ring3.animate({
                            key: "scale",
                            from: 1,
                            to: 6,
                            duration: 1800,
                            loops: Infinity,
                            easing: am5.ease.out(am5.ease.cubic)
                        });
                        ring3.animate({
                            key: "opacity",
                            from: 0.4,
                            to: 0,
                            duration: 1800,
                            loops: Infinity,
                            easing: am5.ease.out(am5.ease.cubic)
                        });
                    }, 800);
                    
                    // Glowing outer ring (static glow)
                    hitArea.children.push(am5.Circle.new(globeRoot, {
                        radius: baseRadius + 4,
                        fill: am5.color(0x000000),
                        fillOpacity: 0,
                        stroke: markerColor,
                        strokeWidth: 2,
                        strokeOpacity: 0.6,
                        x: am5.p50,
                        y: am5.p50,
                        centerX: am5.p50,
                        centerY: am5.p50
                    }));
                }
                
                // Click/Touch event handlers for mobile - shows info in panel
                // Use multiple event types for better mobile compatibility
                hitArea.events.on("click", function(ev) {
                    if (ev.originalEvent) ev.originalEvent.stopPropagation();
                    showMarkerInfo(data);
                });
                
                // Handle hit event which works better on amCharts touch
                hitArea.events.on("hit", function(ev) {
                    showMarkerInfo(data);
                });
                
                // Add tap handler via pointerdown + pointerup tracking
                let tapStart = 0;
                hitArea.events.on("pointerdown", function(ev) {
                    tapStart = Date.now();
                });
                hitArea.events.on("pointerup", function(ev) {
                    // If touch was quick (< 300ms), treat as tap
                    if (Date.now() - tapStart < 300) {
                        showMarkerInfo(data);
                    }
                });

                return am5.Bullet.new(globeRoot, {
                    sprite: hitArea
                });
            });

            // Load conflict markers using FRESH coordinates from immutable CANONICAL_COORDS
            // Always deep-clone to prevent any stale/mutated data from affecting display
            const freshZones = getFreshConflictData();
            
            // Add emerging signals to the zones
            const emergingZones = (emergingQueue || []).map(proposal => {
                // Parse location - can be string or object {lat, lon, city}
                let locName = 'Global';
                let lat = 0;
                let lon = -30; // Default to Atlantic Ocean (global)
                
                if (proposal.location) {
                    if (typeof proposal.location === 'object') {
                        locName = proposal.location.city || 'Global';
                        lat = proposal.location.lat || 0;
                        lon = proposal.location.lon || -30;
                    } else {
                        locName = proposal.location;
                    }
                }
                
                // Use explicit lat/lon if provided at top level
                if (proposal.lat !== undefined) lat = proposal.lat;
                if (proposal.lon !== undefined) lon = proposal.lon;
                
                return {
                    id: proposal.id,
                    title: proposal.title || 'Emerging Signal',
                    location: locName,
                    latitude: lat,
                    longitude: lon,
                    type: 'EMERGING',
                    color: '#ff6b6b',
                    desc: proposal.summary || 'Unconfirmed emerging signal',
                    theory: 'Awaiting confirmation',
                    locationWhy: 'AI-detected pattern requiring human review',
                    criticalityScore: 95, // High priority for emerging
                    isEmerging: true,
                    confidence: proposal.confidence || 0
                };
            });
            
            // Combine confirmed and emerging zones
            const allZones = [...freshZones, ...emergingZones];
            
            // Cluster conflicts that are geographically close (within 2 degrees)
            const clusteredZones = clusterConflicts(allZones, 2.0);
            
            // DEBUG: Log clustering info
            const clusterCount = clusteredZones.filter(z => z.isCluster).length;
            const emergingCount = emergingZones.length;
            console.log(`Globe: ${freshZones.length} confirmed + ${emergingCount} emerging -> ${clusteredZones.length} markers (${clusterCount} clusters)`);
            
            // Determine focused zone ID for special highlighting
            const focusedId = targetZone ? (targetZone.id || null) : null;
            
            pointSeries.data.setAll(clusteredZones.map(z => ({
                geometry: { type: "Point", coordinates: [z.longitude, z.latitude] },
                id: z.id,
                title: z.title,
                location: z.location,
                type: z.type,
                color: z.color,
                desc: z.desc,
                theory: z.theory,
                locationWhy: z.locationWhy,
                criticalityScore: z.criticalityScore,
                isCluster: z.isCluster,
                count: z.count,
                members: z.members || null,
                isFocused: z.id === focusedId
            })));

            // Center on target zone after globe appears
            if (targetZone) {
                globeChart.events.once("appeared", function() {
                    globeChart.animate({
                        key: "rotationX",
                        to: -targetZone.longitude,
                        duration: 800,
                        easing: am5.ease.inOut(am5.ease.cubic)
                    });
                    globeChart.animate({
                        key: "rotationY",
                        to: -targetZone.latitude,
                        duration: 800,
                        easing: am5.ease.inOut(am5.ease.cubic)
                    });
                });
            }
            
            globeChart.appear(800, 50);
            } catch (error) {
                console.error('Failed to initialize globe:', error.message || error.toString(), error.stack || '');
                const globeDiv = document.getElementById('globe-div');
                if (globeDiv) {
                    globeDiv.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #ff4466; font-size: 0.9rem; text-align: center; padding: 20px;">Unable to load globe. Please try again.</div>';
                }
                // Clean up on error
                if (globeRoot) {
                    try { globeRoot.dispose(); } catch(e) {}
                    globeRoot = null;
                    globeChart = null;
                }
            }
        }
        
        // Show marker info in the globe info panel when tapped (mobile-friendly)
        function showMarkerInfo(data) {
            console.log('showMarkerInfo called:', data.title, 'isCluster:', data.isCluster, 'count:', data.count);
            const infoPanel = document.getElementById('globe-marker-info');
            if (!infoPanel) {
                console.error('globe-marker-info panel not found!');
                return;
            }
            
            // Close button - NO onclick, we use event delegation
            const closeBtn = `<button class="globe-marker-info-close" data-action="close-info" aria-label="Close"><svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="2" y1="2" x2="12" y2="12"/><line x1="12" y1="2" x2="2" y2="12"/></svg></button>`;
            
            let infoHTML;
            if (data.isCluster && data.members) {
                // Cluster info with clean styling
                const memberList = data.members.map(m => `
                    <div class="globe-marker-info-cluster-item">
                        <span style="color: ${m.color}; font-weight: 600; font-size: 0.78rem;">${m.title}</span>
                        <span style="color: #6a7585; font-size: 0.65rem;">${m.type}</span>
                    </div>
                `).join('');
                
                infoHTML = `
                    ${closeBtn}
                    <div class="globe-marker-info-cluster-header" style="background: ${data.color}; color: #fff;">${data.count} CONFLICTS IN REGION</div>
                    <div class="globe-marker-info-location" style="text-align: center;">${data.location}</div>
                    <div class="globe-marker-info-cluster-list">${memberList}</div>
                `;
            } else {
                // Single conflict info with clean styling
                infoHTML = `
                    ${closeBtn}
                    <div class="globe-marker-info-title" style="color: ${data.color};">${data.title}</div>
                    <div class="globe-marker-info-location">${data.location}</div>
                    <div class="globe-marker-info-type" style="background: ${data.color}18; color: ${data.color}; border: 1px solid ${data.color}40;">${data.type}</div>
                    <div class="globe-marker-info-desc">${data.desc}</div>
                    ${data.theory ? `<div class="globe-marker-info-theory">${data.theory}</div>` : ''}
                `;
            }
            
            infoPanel.innerHTML = infoHTML;
            infoPanel.style.display = 'block';
            // Small delay to trigger CSS transition
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    infoPanel.classList.add('visible');
                });
            });
        }
        
        function hideMarkerInfo() {
            const infoPanel = document.getElementById('globe-marker-info');
            if (infoPanel && infoPanel.classList.contains('visible')) {
                infoPanel.classList.remove('visible');
                setTimeout(() => {
                    if (!infoPanel.classList.contains('visible')) {
                        infoPanel.style.display = 'none';
                    }
                }, 300);
            }
        }
        
        // UNIFIED EVENT HANDLER for info panel - works on all devices
        // Using event delegation on the document for maximum reliability
        (function() {
            // Handle close button clicks and taps
            document.addEventListener('click', handleInfoPanelInteraction, true);
            document.addEventListener('touchend', handleInfoPanelInteraction, true);
            
            function handleInfoPanelInteraction(e) {
                const infoPanel = document.getElementById('globe-marker-info');
                const mapModal = document.getElementById('mapModal');
                
                // Only process if map modal is visible
                if (!mapModal || mapModal.style.display === 'none') return;
                
                // Check if clicking the close button
                const closeBtn = e.target.closest('[data-action="close-info"]');
                if (closeBtn) {
                    e.preventDefault();
                    e.stopPropagation();
                    hideMarkerInfo();
                    return;
                }
                
                // Check if info panel is visible
                if (!infoPanel || !infoPanel.classList.contains('visible')) return;
                
                // If clicking inside the info panel, do nothing
                if (infoPanel.contains(e.target)) return;
                
                // If clicking on a marker, let it handle showing new info
                if (e.target.closest('.am5-layer') || e.target.tagName === 'circle') return;
                
                // Click outside - close the panel
                hideMarkerInfo();
            }
        })();
        
        function focusOnZone(zone) {
            if (!globeChart) return;
            
            // Stop current animation
            if (globeAnimation) globeAnimation.stop();
            
            // Animate to the target location
            globeChart.animate({
                key: "rotationX",
                to: -zone.longitude,
                duration: 1000,
                easing: am5.ease.inOut(am5.ease.cubic)
            });
            globeChart.animate({
                key: "rotationY",
                to: -zone.latitude,
                duration: 1000,
                easing: am5.ease.inOut(am5.ease.cubic)
            });
            
            // Update header
            const headerDiv = document.getElementById('globe-header');
            if (headerDiv) {
                headerDiv.innerHTML = `
                    <div style="color: #00D9FF; font-size: 1.1rem; font-weight: 700; letter-spacing: 2px;">ACTIVE KINETIC THEATERS</div>
                    <div style="color: ${zone.color}; font-size: 0.9rem; font-weight: 600; margin-top: 4px;">${zone.title}</div>
                    <div style="color: #888; font-size: 0.75rem;">${zone.location}</div>
                `;
            }
        }

        function closeMapModal(event) {
            if (!event || event.target.id === 'mapModal' || event.target.classList.contains('chart-close-btn')) {
                document.getElementById('mapModal').style.display = 'none';
                document.body.style.overflow = '';
                if (globeAnimation) globeAnimation.stop();
                currentFocusedZone = null;
                hideMarkerInfo();
            }
        }
        
        function openGameLegend() {
            document.getElementById('gameLegendModal').style.display = 'flex';
            document.getElementById('gameLegendModal').style.justifyContent = 'center';
            document.getElementById('gameLegendModal').style.alignItems = 'flex-start';
            document.getElementById('gameLegendModal').style.paddingTop = '3rem';
            document.body.style.overflow = 'hidden';
        }
        
        function closeGameLegend(event) {
            if (!event || event.target.id === 'gameLegendModal' || event.target.classList.contains('chart-close-btn')) {
                document.getElementById('gameLegendModal').style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        // ========================================================================
        // BEAM ANALYSIS MODAL FUNCTIONS
        // ========================================================================
        
        async function openBeamAnalysis(beamId) {
            const modal = document.getElementById('beamAnalysisModal');
            const title = document.getElementById('beamModalTitle');
            const status = document.getElementById('beamModalStatus');
            const body = document.getElementById('beamModalBody');
            
            // Show modal with loading state
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'flex-start';
            modal.style.paddingTop = '3rem';
            document.body.style.overflow = 'hidden';
            
            title.textContent = 'LOADING BEAM DATA...';
            status.innerHTML = '';
            body.innerHTML = `
                <div class="modal-loading">
                    <div class="modal-spinner"></div>
                    <div class="modal-loading-text">Analyzing structural beam with Gemini AI...<br><span style="font-size: 0.85em; opacity: 0.8;">Gathering market data and generating insights</span></div>
                    <div style="margin-top: 1.5rem; padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 6px; max-width: 400px;">
                        <p style="font-size: 0.7rem; color: #6a7585; line-height: 1.4; text-align: center; margin: 0;">
                            <strong>DISCLAIMER:</strong> This is not financial advice. I am not a financial advisor. This content is for informational and educational purposes only. Always do your own due diligence before making any investment decisions.
                        </p>
                    </div>
                </div>
            `;
            
            try {
                const response = await fetch(`/api/beam/${beamId}`);
                const data = await response.json();
                
                if (data.error) {
                    body.innerHTML = `<div style="color: #ef4444; padding: 20px; text-align: center;">${data.error}</div>`;
                    return;
                }
                
                const { metadata, current, aiAnalysis } = data;
                
                // Status color mapping
                const statusColors = {
                    'BREACHED': '#ef4444',
                    'ARMING': '#f59e0b',
                    'SAFE': '#22c55e'
                };
                const statusColor = statusColors[current.status] || '#6a7585';
                
                // Update header
                title.innerHTML = metadata.name;
                status.innerHTML = `
                    <span style="display: inline-block; padding: 4px 12px; border-radius: 4px; background: ${statusColor}20; color: ${statusColor}; font-weight: 600; margin-right: 10px;">
                        ${current.status}
                    </span>
                    <span style="color: #94a3b8;">Value: ${current.value} ${current.unit} | Threshold: ${current.threshold} ${current.unit}</span>
                `;
                
                // Build tags HTML
                const tagsHtml = metadata.tags.map(tag => `
                    <span style="display: inline-block; padding: 3px 8px; margin: 2px; border-radius: 12px; background: rgba(147, 51, 234, 0.2); color: #a78bfa; font-size: 0.75rem; font-weight: 500;">${tag}</span>
                `).join('');
                
                // Build factors HTML if available
                const factorsHtml = current.factors ? current.factors.map(f => `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: ${f.active ? 'rgba(239, 68, 68, 0.15)' : 'rgba(0,0,0,0.2)'}; border-radius: 6px; border-left: 3px solid ${f.active ? '#ef4444' : '#4a5568'};">
                        <span style="width: 10px; height: 10px; border-radius: 50%; background: ${f.active ? '#ef4444' : '#4a5568'}; box-shadow: ${f.active ? '0 0 6px #ef4444' : 'none'};"></span>
                        <div style="flex: 1;">
                            <div style="color: ${f.active ? '#ef4444' : '#94a3b8'}; font-weight: ${f.active ? '600' : '400'}; font-size: 0.85rem;">${f.label}</div>
                        </div>
                        <div style="color: ${f.active ? '#fca5a5' : '#6b7280'}; font-size: 0.8rem; font-family: 'IBM Plex Mono', monospace;">${f.value}</div>
                    </div>
                `).join('') : '';
                
                const activeCount = current.factors ? current.factors.filter(f => f.active).length : 0;
                const totalCount = current.factors ? current.factors.length : 4;
                
                // Build body content
                body.innerHTML = `
                    <div style="margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 6px;">
                        ${tagsHtml}
                        <span style="display: inline-block; padding: 4px 10px; border-radius: 12px; background: rgba(59, 130, 246, 0.2); color: #60a5fa; font-size: 0.75rem; font-weight: 600;">${metadata.archetype}</span>
                    </div>
                    
                    ${current.factors ? `
                    <div style="background: rgba(0,0,0,0.25); border-radius: 8px; padding: 16px; margin-bottom: 20px; border: 1px solid rgba(245, 158, 11, 0.2);">
                        <h3 style="color: #f59e0b; margin: 0 0 12px 0; font-size: 0.9rem; letter-spacing: 0.5px; display: flex; justify-content: space-between; align-items: center;">
                            <span>ACTIVE FACTORS</span>
                            <span style="background: ${activeCount >= 3 ? '#ef4444' : activeCount >= 2 ? '#f59e0b' : '#22c55e'}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.8rem;">${activeCount}/${totalCount}</span>
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            ${factorsHtml}
                        </div>
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.75rem; color: #6a7585; text-align: center;">
                            2/4 = ARMING | 3+/4 = BREACHED
                        </div>
                    </div>
                    ` : ''}
                    
                    <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                        <h3 style="color: #f59e0b; margin: 0 0 10px 0; font-size: 0.9rem; letter-spacing: 0.5px;">WHAT THIS BEAM MEASURES</h3>
                        <p style="line-height: 1.75; color: #e5e5e5; margin: 0; font-size: 0.95rem;">${metadata.fullExplanation}</p>
                    </div>
                    
                    <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                        <h3 style="color: #f59e0b; margin: 0 0 10px 0; font-size: 0.9rem; letter-spacing: 0.5px;">SCORING RULES</h3>
                        <div style="background: rgba(0,0,0,0.4); padding: 14px; border-radius: 6px; font-family: 'IBM Plex Mono', monospace; font-size: 0.85rem; color: #94a3b8; white-space: pre-wrap; border-left: 3px solid #f59e0b;">${metadata.calculation}</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 14px;">
                            <h3 style="color: #f59e0b; margin: 0 0 8px 0; font-size: 0.85rem; letter-spacing: 0.5px;">DATA SOURCES</h3>
                            <p style="color: #94a3b8; margin: 0; font-size: 0.9rem; line-height: 1.6;">${metadata.dataSources.join('<br>')}</p>
                        </div>
                        <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 14px;">
                            <h3 style="color: #f59e0b; margin: 0 0 8px 0; font-size: 0.85rem; letter-spacing: 0.5px;">HISTORICAL CONTEXT</h3>
                            <p style="color: #94a3b8; margin: 0; font-size: 0.9rem; line-height: 1.6; font-style: italic;">${metadata.historicalContext}</p>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.05)); padding: 18px; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 20px;">
                        <h3 style="color: #f59e0b; margin: 0 0 12px 0; font-size: 0.9rem; letter-spacing: 0.5px;">AI ANALYSIS (Live)</h3>
                        <p style="line-height: 1.75; color: #e5e5e5; margin: 0; font-size: 0.95rem;">${aiAnalysis || 'Analysis unavailable'}</p>
                    </div>
                    
                    <div style="padding: 12px 16px; border: 1px solid rgba(245, 158, 11, 0.15); background: rgba(0,0,0,0.15); border-radius: 6px;">
                        <p style="font-size: 0.7rem; color: #6a7585; line-height: 1.5; text-align: center; margin: 0;">
                            <strong>DISCLAIMER:</strong> This is not financial advice. For informational and educational purposes only.
                        </p>
                    </div>
                `;
                
            } catch (error) {
                console.error('Beam analysis error:', error);
                body.innerHTML = `<div style="color: #ef4444; padding: 20px; text-align: center;">Failed to load beam analysis. Please try again.</div>`;
            }
        }
        
        function closeBeamModal(event) {
            if (!event || event.target.id === 'beamAnalysisModal' || event.target.classList.contains('chart-close-btn')) {
                document.getElementById('beamAnalysisModal').style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        function openIntelLegend() {
            document.getElementById('intelLegendModal').style.display = 'flex';
            document.getElementById('intelLegendModal').style.justifyContent = 'center';
            document.getElementById('intelLegendModal').style.alignItems = 'flex-start';
            document.getElementById('intelLegendModal').style.paddingTop = '3rem';
            document.body.style.overflow = 'hidden';
        }
        
        function closeIntelLegend(event) {
            if (!event || event.target.id === 'intelLegendModal' || event.target.classList.contains('chart-close-btn')) {
                document.getElementById('intelLegendModal').style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        function openStatecraftExplainer() {
            document.getElementById('statecraftExplainerModal').style.display = 'flex';
            document.getElementById('statecraftExplainerModal').style.justifyContent = 'center';
            document.getElementById('statecraftExplainerModal').style.alignItems = 'flex-start';
            document.getElementById('statecraftExplainerModal').style.paddingTop = '3rem';
            document.body.style.overflow = 'hidden';
        }
        
        function openTacticalLegend() {
            document.getElementById('tacticalLegendModal').style.display = 'flex';
            document.getElementById('tacticalLegendModal').style.justifyContent = 'center';
            document.getElementById('tacticalLegendModal').style.alignItems = 'flex-start';
            document.getElementById('tacticalLegendModal').style.paddingTop = '3rem';
            document.body.style.overflow = 'hidden';
        }
        
        function closeTacticalLegend(event) {
            if (!event || event.target.id === 'tacticalLegendModal' || event.target.classList.contains('chart-close-btn')) {
                document.getElementById('tacticalLegendModal').style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        // Keyboard support for Tactical Legend modal (Escape to close)
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const tacticalModal = document.getElementById('tacticalLegendModal');
                if (tacticalModal && tacticalModal.style.display === 'flex') {
                    closeTacticalLegend();
                }
            }
        });
        
        function openCommandBriefing() {
            document.getElementById('commandBriefingModal').style.display = 'flex';
            document.getElementById('commandBriefingModal').style.justifyContent = 'center';
            document.getElementById('commandBriefingModal').style.alignItems = 'flex-start';
            document.getElementById('commandBriefingModal').style.paddingTop = '3rem';
            document.body.style.overflow = 'hidden';
        }
        
        function closeCommandBriefing(event) {
            if (!event || event.target.id === 'commandBriefingModal' || event.target.classList.contains('chart-close-btn')) {
                document.getElementById('commandBriefingModal').style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        function openRiskBriefing() {
            document.getElementById('riskBriefingModal').style.display = 'flex';
            document.getElementById('riskBriefingModal').style.justifyContent = 'center';
            document.getElementById('riskBriefingModal').style.alignItems = 'flex-start';
            document.getElementById('riskBriefingModal').style.paddingTop = '3rem';
            document.body.style.overflow = 'hidden';
        }
        
        function closeRiskBriefing(event) {
            if (!event || event.target.id === 'riskBriefingModal' || event.target.classList.contains('chart-close-btn')) {
                document.getElementById('riskBriefingModal').style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        function openSupplyBriefing() {
            document.getElementById('supplyBriefingModal').style.display = 'flex';
            document.getElementById('supplyBriefingModal').style.justifyContent = 'center';
            document.getElementById('supplyBriefingModal').style.alignItems = 'flex-start';
            document.getElementById('supplyBriefingModal').style.paddingTop = '3rem';
            document.body.style.overflow = 'hidden';
        }
        
        function closeSupplyBriefing(event) {
            if (!event || event.target.id === 'supplyBriefingModal' || event.target.classList.contains('chart-close-btn')) {
                document.getElementById('supplyBriefingModal').style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        function openFlowsBriefing() {
            document.getElementById('flowsBriefingModal').style.display = 'flex';
            document.getElementById('flowsBriefingModal').style.justifyContent = 'center';
            document.getElementById('flowsBriefingModal').style.alignItems = 'flex-start';
            document.getElementById('flowsBriefingModal').style.paddingTop = '3rem';
            document.body.style.overflow = 'hidden';
        }
        
        function closeFlowsBriefing(event) {
            if (!event || event.target.id === 'flowsBriefingModal' || event.target.classList.contains('chart-close-btn')) {
                document.getElementById('flowsBriefingModal').style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        function openSignalsBriefing() {
            document.getElementById('signalsBriefingModal').style.display = 'flex';
            document.getElementById('signalsBriefingModal').style.justifyContent = 'center';
            document.getElementById('signalsBriefingModal').style.alignItems = 'flex-start';
            document.getElementById('signalsBriefingModal').style.paddingTop = '3rem';
            document.body.style.overflow = 'hidden';
        }
        
        function closeSignalsBriefing(event) {
            if (!event || event.target.id === 'signalsBriefingModal' || event.target.classList.contains('chart-close-btn')) {
                document.getElementById('signalsBriefingModal').style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        function closeStatecraftExplainer(event) {
            if (!event || event.target.id === 'statecraftExplainerModal' || event.target.classList.contains('chart-close-btn')) {
                document.getElementById('statecraftExplainerModal').style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        function openIntelLegendSection(sectionId) {
            openIntelLegend();
            setTimeout(() => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    section.style.animation = 'highlight-pulse 1.5s ease-out';
                    setTimeout(() => { section.style.animation = ''; }, 1500);
                }
            }, 100);
        }
        
        function openIntelDetailModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
            document.getElementById(modalId).style.justifyContent = 'center';
            document.getElementById(modalId).style.alignItems = 'flex-start';
            document.getElementById(modalId).style.paddingTop = '3rem';
            document.body.style.overflow = 'hidden';
        }
        
        function closeIntelModal(modalId, event) {
            if (!event || event.target.id === modalId || event.target.classList.contains('chart-close-btn')) {
                document.getElementById(modalId).style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        function openRatesLegend() {
            document.getElementById('ratesLegendModal').style.display = 'flex';
            document.getElementById('ratesLegendModal').style.justifyContent = 'center';
            document.getElementById('ratesLegendModal').style.alignItems = 'flex-start';
            document.getElementById('ratesLegendModal').style.paddingTop = '3rem';
            document.body.style.overflow = 'hidden';
        }
        
        function closeRatesLegend(event) {
            if (!event || event.target.id === 'ratesLegendModal' || event.target.classList.contains('chart-close-btn')) {
                document.getElementById('ratesLegendModal').style.display = 'none';
                document.body.style.overflow = '';
            }
        }
    </script>

</body>
</html>
